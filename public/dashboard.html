<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StellarRec — Recommender Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Roboto',sans-serif; background:#f6f9fc; color:#0f172a; }
    a { color:inherit; }

    /* Header */
    .header {
      background:linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color:#fff; padding:1.1rem 2rem; position:sticky; top:0; z-index:1000;
      box-shadow:0 4px 22px rgba(25,118,210,.3);
    }
    .header-content { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    .logo { display:flex; align-items:center; gap:.5rem; font-weight:800; font-size:1.6rem; text-decoration:none; }
    .right-controls { display:flex; align-items:center; gap:.75rem; }
    .user-info { position:relative; }
    .user-avatar {
      width:42px; height:42px; border-radius:50%; border:2px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.18); display:grid; place-items:center; cursor:pointer;
      transition:.2s;
    }
    .user-avatar:hover { transform:translateY(-1px); background:rgba(255,255,255,.28); }
    .user-dropdown {
      position:absolute; top:calc(100% + .5rem); right:0; min-width:300px; max-width:min(92vw,340px);
      background:#fff; color:#0f172a; border-radius:12px; border:1px solid #e5e7eb;
      box-shadow:0 16px 40px rgba(0,0,0,.16); padding:.25rem 0; display:none; z-index:1001;
    }
    .user-dropdown.show { display:block; }
    .dropdown-item {
      display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem; cursor:pointer;
    }
    .dropdown-item:hover { background:#f8fafc; }
    .dropdown-item .material-icons { color:#64748b; font-size:20px; }

    /* Shell */
    .container { max-width:1200px; margin:1.25rem auto; padding:0 1rem; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    @media (max-width: 980px){ .grid { grid-template-columns:1fr; } }

    /* Cards */
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 8px 28px rgba(0,0,0,.06); }
    .card-hd { padding:1rem 1.25rem; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
    .card-hd h2 { font-size:1.15rem; }
    .card-bd { padding:1.25rem; }
    .card-ft { padding:1rem 1.25rem; border-top:1px solid #e5e7eb; }

    /* Upload */
    .drop { border:2px dashed #d0d7de; border-radius:16px; padding:2rem; text-align:center; transition:.2s; }
    .drop.dragover { background:#f3f8ff; border-color:#1976d2; }
    .drop .material-icons { font-size:44px; color:#1976d2; }
    .file-input { display:none; }
    .btn {
      display:inline-flex; align-items:center; gap:.5rem; cursor:pointer;
      border-radius:10px; border:1px solid #e5e7eb; padding:.6rem 1rem; font-weight:700; background:#fff;
    }
    .btn:hover { transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.08); }
    .btn-primary { color:#fff; background:linear-gradient(135deg,#1976d2,#7c4dff); border:none; }
    .btn-danger { background:#fee2e2; color:#991b1b; border-color:#fecaca; }
    .btn-muted { background:#f8fafc; }
    .file-pill {
      display:flex; align-items:center; gap:1rem; background:#eef7ee; border:1px solid #cfe8d1;
      padding:1rem; border-radius:12px; margin-top:1rem;
    }
    .file-pill .material-icons { color:#2e7d32; }

    /* Writer */
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .toolbar .btn { border:2px solid #e5e7eb; }
    .writer-title, .writer-box {
      width:100%; padding:.7rem .9rem; border:2px solid #e5e7eb; border-radius:12px; font:inherit;
    }
    .writer-box { min-height:240px; margin-top:.5rem; line-height:1.55; }
    .writer-box:focus { outline:none; border-color:#1976d2; }
    .meta { margin-left:auto; color:#64748b; font-size:.9rem; display:flex; gap:.75rem; align-items:center; }

    /* Selected */
    .selected-list { display:flex; flex-wrap:wrap; gap:.5rem; }
    .tag {
      display:inline-flex; align-items:center; gap:.4rem; background:#eef2ff; color:#1e40af;
      border:1px solid #c7d2fe; padding:.35rem .7rem; border-radius:999px; font-weight:700; font-size:.85rem;
    }
    .count { color:#1976d2; font-weight:700; margin:.5rem 0 1rem; }
    .send-btn { font-size:1.05rem; }

    /* Progress */
    .progress { height:12px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .fill { height:100%; width:0%; background:linear-gradient(135deg,#4caf50,#66bb6a); transition:width .4s ease; }
    .delivery-list { margin-top:.75rem; display:grid; gap:.5rem; }
    .delivery-item { display:flex; align-items:center; gap:.6rem; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:.6rem .8rem; }
    .status { width:18px; height:18px; border-radius:50%; }
    .status.pending { background:#ffedd5; }
    .status.success { background:#dcfce7; }
    .status.error { background:#fee2e2; }

    /* Modals */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:1200; }
    .overlay.show { display:flex; }
    .modal { width:min(760px,92vw); background:#fff; border-radius:16px; border:1px solid #e5e7eb; box-shadow:0 18px 60px rgba(0,0,0,.25); overflow:hidden; }
    .modal-hd { padding:1rem 1.25rem; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; }
    .modal-bd { padding:1rem 1.25rem; max-height:62vh; overflow:auto; }
    .modal-ft { padding:1rem 1.25rem; border-top:1px solid #e5e7eb; display:flex; gap:.5rem; justify-content:flex-end; }

    /* Toasts */
    .toast-wrap { position:fixed; right:16px; bottom:16px; z-index:1400; display:grid; gap:8px; }
    .toast { min-width:240px; max-width:420px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:.75rem .9rem;
      box-shadow:0 10px 28px rgba(0,0,0,.15); display:flex; gap:.55rem; }
    .toast .icon{ color:#1976d2; }
    .toast.success{ border-color:#c8e6c9; background:#f1f8f3; }
    .toast.error{ border-color:#ffcdd2; background:#fff2f2; }
    .toast .x{ margin-left:auto; border:none; background:transparent; cursor:pointer; }

    /* Footer */
    .site-footer { margin:2rem 0 1rem; text-align:center; color:#64748b; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo">
        <span class="material-icons" aria-hidden="true">star</span>
        stellarrec
      </a>
      <div class="right-controls">
        <div class="user-info">
          <button class="user-avatar" id="userAvatarBtn" aria-haspopup="true" aria-expanded="false" title="Menu">
            <span class="material-icons">person</span>
          </button>
          <div class="user-dropdown" id="userDropdown" role="menu" aria-hidden="true">
            <!-- ONLY Contact admin (per request) -->
            <div class="dropdown-item" id="contactAdminItem" role="menuitem" tabindex="0">
              <span class="material-icons">support_agent</span>
              <div>
                <div style="font-weight:700;">Contact admin</div>
                <div style="font-size:.85rem; color:#64748b;">Send a message</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container">
    <div class="grid">
      <!-- Upload PDF -->
      <section class="card">
        <div class="card-hd">
          <h2>Upload Recommendation Letter (PDF)</h2>
          <div></div>
        </div>
        <div class="card-bd">
          <div id="pdfDrop" class="drop" aria-label="PDF drop zone">
            <div class="material-icons" aria-hidden="true">cloud_upload</div>
            <div style="margin:.35rem 0 .15rem; font-weight:700;">Drag & drop your PDF here</div>
            <div style="color:#64748b; font-size:.95rem;">or</div>
            <button id="choosePdfBtn" class="btn btn-primary" type="button">
              <span class="material-icons">upload_file</span> Choose PDF
            </button>
            <input id="pdfInput" class="file-input" type="file" accept=".pdf,application/pdf" />
            <div style="margin-top:.5rem; color:#64748b; font-size:.9rem;">PDF only • Recommended ≤ 10 MB</div>
          </div>

          <div id="pdfPill" class="file-pill" style="display:none;">
            <span class="material-icons" aria-hidden="true">description</span>
            <div>
              <div id="pdfName" style="font-weight:700;">letter.pdf</div>
              <div id="pdfSize" style="font-size:.9rem; color:#2e7d32;">—</div>
            </div>
            <button id="removePdfBtn" class="btn btn-danger" type="button">
              <span class="material-icons">close</span> Remove
            </button>
          </div>
        </div>
      </section>

      <!-- Upload Video -->
      <section class="card">
        <div class="card-hd">
          <h2>Upload Intro/Context Video (optional)</h2>
          <div></div>
        </div>
        <div class="card-bd">
          <div id="vidDrop" class="drop" aria-label="Video drop zone">
            <div class="material-icons" aria-hidden="true">videocam</div>
            <div style="margin:.35rem 0 .15rem; font-weight:700;">Drag & drop your video here</div>
            <div style="color:#64748b; font-size:.95rem;">or</div>
            <button id="chooseVidBtn" class="btn btn-primary" type="button">
              <span class="material-icons">video_file</span> Choose Video
            </button>
            <input id="vidInput" class="file-input" type="file" accept="video/mp4,video/quicktime,video/webm" />
            <div style="margin-top:.5rem; color:#64748b; font-size:.9rem;">MP4 / MOV / WEBM • Keep it short (≤ 2–3 min)</div>
          </div>

          <div id="vidPill" class="file-pill" style="display:none; align-items:flex-start;">
            <span class="material-icons" aria-hidden="true">smart_display</span>
            <div style="flex:1;">
              <div id="vidName" style="font-weight:700;">intro.mp4</div>
              <div id="vidSize" style="font-size:.9rem; color:#2e7d32;">—</div>
              <video id="vidPreview" controls playsinline style="display:none; margin-top:.6rem; width:100%; max-height:240px; border-radius:10px; background:#000;"></video>
            </div>
            <button id="removeVidBtn" class="btn btn-danger" type="button">
              <span class="material-icons">close</span> Remove
            </button>
          </div>
        </div>
      </section>
    </div>

    <!-- Writer -->
    <section class="card" style="margin-top:1rem;">
      <div class="card-hd">
        <h2>Write Letter</h2>
        <div class="meta">
          <span id="writerCount">0 words • 0 chars</span>
          <span id="writerSaved">Not saved</span>
        </div>
      </div>
      <div class="card-bd">
        <input id="writerTitle" class="writer-title" placeholder="Letter title (optional, e.g., 'Recommendation for Jane Doe')" />
        <div class="toolbar" style="margin:.6rem 0 .5rem;">
          <button class="btn btn-muted" data-cmd="bold" title="Bold (Ctrl/Cmd+B)"><b>B</b></button>
          <button class="btn btn-muted" data-cmd="italic" title="Italic (Ctrl/Cmd+I)"><i>I</i></button>
          <button class="btn btn-muted" data-cmd="underline" title="Underline (Ctrl/Cmd+U)"><u>U</u></button>
          <div style="flex:1;"></div>
          <button id="saveDraftBtn" class="btn btn-primary" type="button">Save draft</button>
          <button id="restoreDraftBtn" class="btn" type="button">Restore</button>
          <button id="clearDraftBtn" class="btn btn-danger" type="button">Clear</button>
          <button id="copyDraftBtn" class="btn" type="button">Copy</button>
          <button id="downloadDraftBtn" class="btn" type="button">Download .txt</button>
          <button id="attachDraftBtn" class="btn btn-muted" type="button">Attach draft</button>
        </div>
        <div id="writerBox" class="writer-box" contenteditable="true" aria-label="Letter editor"
             placeholder="Write your recommendation letter here..."></div>
      </div>
    </section>

    <!-- Selected -->
    <section class="card" style="margin-top:1rem;">
      <div class="card-hd">
        <h2>Selected Universities</h2>
        <div>
          <button class="btn" id="copyLinkBtn" type="button" title="Copy shareable link">
            <span class="material-icons">link</span> Copy link
          </button>
        </div>
      </div>
      <div class="card-bd">
        <div id="selectedCount" class="count">0 universities selected</div>
        <div id="selectedList" class="selected-list" role="list" aria-live="polite"></div>
      </div>
      <div class="card-ft" style="display:flex; justify-content:flex-end; gap:.5rem;">
        <button class="btn btn-primary send-btn" id="sendBtn" type="button" disabled>
          <span class="material-icons">send</span> Send to Selected Universities
        </button>
      </div>
    </section>

    <!-- Progress -->
    <section id="progressCard" class="card" style="margin-top:1rem; display:none;">
      <div class="card-hd">
        <h2>Sending Letters...</h2>
        <div></div>
      </div>
      <div class="card-bd">
        <div class="progress" aria-label="Overall progress">
          <div id="progressFill" class="fill" style="width:0%"></div>
        </div>
        <div id="progressText" style="margin-top:.6rem; color:#64748b; font-size:.95rem;">Preparing to send...</div>
        <div id="deliveryList" class="delivery-list"></div>
      </div>
    </section>

    <!-- Success -->
    <section id="successCard" class="card" style="margin-top:1rem; display:none; border-color:#a7f3d0;">
      <div class="card-bd" style="text-align:center;">
        <div class="material-icons" style="font-size:48px; color:#16a34a;">check_circle</div>
        <h3 style="margin:.5rem 0 0; color:#166534;">Letters Sent Successfully!</h3>
        <p style="color:#166534;">Your recommendation letter has been delivered to all selected universities.</p>
        <button id="newUploadBtn" class="btn btn-primary" type="button">
          <span class="material-icons">add</span> Send Another Letter
        </button>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">&copy; 2025 <strong>StellarRec™</strong>. All rights reserved.</div>
  </footer>

  <!-- Confirm Modal -->
  <div id="confirmOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal">
      <div class="modal-hd">
        <div id="confirmTitle" style="font-weight:700;">Confirm recipients</div>
        <button id="confirmClose" class="btn" type="button" aria-label="Close">✕</button>
      </div>
      <div class="modal-bd">
        <div id="confirmSummary" style="margin-bottom:1rem;"></div>
        <div style="display:grid; gap:1rem;">
          <div>
            <div style="font-weight:700;">Included (<span id="incCount">0</span>)</div>
            <div id="incList"></div>
          </div>
        </div>
      </div>
      <div class="modal-ft">
        <button id="confirmCancel" class="btn" type="button">Cancel</button>
        <button id="confirmSend" class="btn btn-primary" type="button">Send now</button>
      </div>
    </div>
  </div>

  <!-- Contact Admin Modal -->
  <div id="contactOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <div class="modal" style="width:min(560px,92vw);">
      <div class="modal-hd">
        <div id="contactTitle" style="font-weight:700;">Contact admin</div>
        <button id="contactClose" class="btn" type="button" aria-label="Close">✕</button>
      </div>
      <form id="contactForm" class="modal-bd" style="display:grid; gap:.75rem;">
        <div>
          <label for="cFirst" style="display:block; font-weight:600; margin-bottom:.25rem;">First name</label>
          <input id="cFirst" name="first" class="writer-title" type="text" required placeholder="Your first name" />
        </div>
        <div>
          <label for="cEmail" style="display:block; font-weight:600; margin-bottom:.25rem;">Email</label>
          <input id="cEmail" name="email" class="writer-title" type="email" required placeholder="you@example.com" />
        </div>
        <div>
          <label for="cQuery" style="display:block; font-weight:600; margin-bottom:.25rem;">Query</label>
          <textarea id="cQuery" name="query" class="writer-box" style="min-height:120px;" required placeholder="How can we help?"></textarea>
        </div>
      </form>
      <div class="modal-ft">
        <button id="contactCancel" class="btn" type="button">Cancel</button>
        <button id="contactSend" class="btn btn-primary" type="button">Send</button>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* Tiny toast helper */
    (function(){
      const wrap = document.getElementById('toastWrap');
      window.toast = function(msg, type='info'){
        const el = document.createElement('div');
        el.className = 'toast ' + (type==='success'?'success':type==='error'?'error':'');
        el.innerHTML = '<span class="material-icons icon" aria-hidden="true">'
          + (type==='success'?'check_circle':type==='error'?'error':'info') +
          '</span><div class="msg">'+msg+'</div><button class="x" aria-label="Dismiss">✕</button>';
        wrap.appendChild(el);
        const onClose = ()=> el.remove();
        el.querySelector('.x').addEventListener('click', onClose);
        setTimeout(onClose, 3200);
      };
    })();

    /* Safe localStorage */
    const safeLS = {
      get(k, d){ try { return localStorage.getItem(k) ?? d; } catch { return d; } },
      set(k, v){ try { localStorage.setItem(k, v); } catch {} },
      del(k){ try { localStorage.removeItem(k); } catch {} }
    };

    /* Header menu: only Contact admin */
    (function(){
      const btn = document.getElementById('userAvatarBtn');
      const dd  = document.getElementById('userDropdown');
      const toggle = (open)=> {
        dd.classList.toggle('show', open);
        btn.setAttribute('aria-expanded', open ? 'true':'false');
        dd.setAttribute('aria-hidden', open ? 'false':'true');
      };
      btn?.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(!dd.classList.contains('show')); });
      document.addEventListener('click', (e)=>{ if(!dd.contains(e.target) && !btn.contains(e.target)) toggle(false); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggle(false); });

      const contactItem = document.getElementById('contactAdminItem');
      const cOv = document.getElementById('contactOverlay');
      contactItem?.addEventListener('click', ()=>{ toggle(false); cOv.classList.add('show'); });
      document.getElementById('contactClose')?.addEventListener('click', ()=> cOv.classList.remove('show'));
      document.getElementById('contactCancel')?.addEventListener('click', ()=> cOv.classList.remove('show'));
      document.getElementById('contactSend')?.addEventListener('click', ()=>{
        const first = document.getElementById('cFirst').value.trim();
        const email = document.getElementById('cEmail').value.trim();
        const query = document.getElementById('cQuery').value.trim();
        if(!first || !email || !query){ toast('Please complete all fields.', 'error'); return; }
        toast('Message sent. We\'ll get back to you shortly.', 'success');
        cOv.classList.remove('show');
        document.getElementById('contactForm').reset();
      });
    })();

    /* Upload helpers (PDF + Video) */
    (function(){
      function fmt(bytes){
        if(!bytes && bytes!==0) return '—';
        const k=1024, sizes=['B','KB','MB','GB']; let i = Math.floor(Math.log(bytes)/Math.log(k));
        return (bytes/Math.pow(k,i)).toFixed(i?1:0)+' '+sizes[i];
      }
      // PDF
      const pdfDrop = document.getElementById('pdfDrop');
      const pdfInput= document.getElementById('pdfInput');
      const choosePdfBtn = document.getElementById('choosePdfBtn');
      const pdfPill = document.getElementById('pdfPill');
      const pdfName = document.getElementById('pdfName');
      const pdfSize = document.getElementById('pdfSize');
      const removePdfBtn = document.getElementById('removePdfBtn');

      function acceptPdf(file){
        if(!file) return;
        if(file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')){
          toast('Please upload a PDF file.', 'error'); return;
        }
        pdfName.textContent = file.name;
        pdfSize.textContent = fmt(file.size);
        pdfPill.style.display = 'flex';
        safeLS.set('sr_pdf_name', file.name);
        safeLS.set('sr_pdf_size', String(file.size||0));
        // We store only metadata for demo; actual upload would go to storage
        toast('PDF attached.', 'success');
      }
      choosePdfBtn?.addEventListener('click', ()=> pdfInput.click());
      pdfInput?.addEventListener('change', (e)=> acceptPdf(e.target.files?.[0]));
      ['dragenter','dragover'].forEach(ev => pdfDrop?.addEventListener(ev, e=>{ e.preventDefault(); pdfDrop.classList.add('dragover'); }));
      ['dragleave','drop'].forEach(ev => pdfDrop?.addEventListener(ev, e=>{ e.preventDefault(); pdfDrop.classList.remove('dragover'); }));
      pdfDrop?.addEventListener('drop', (e)=> acceptPdf(e.dataTransfer?.files?.[0]));
      removePdfBtn?.addEventListener('click', ()=>{
        pdfPill.style.display='none'; pdfInput.value='';
        safeLS.del('sr_pdf_name'); safeLS.del('sr_pdf_size');
        toast('PDF removed.', 'info');
      });

      // Video
      const vidDrop = document.getElementById('vidDrop');
      const vidInput= document.getElementById('vidInput');
      const chooseVidBtn = document.getElementById('chooseVidBtn');
      const vidPill = document.getElementById('vidPill');
      const vidName = document.getElementById('vidName');
      const vidSize = document.getElementById('vidSize');
      const removeVidBtn = document.getElementById('removeVidBtn');
      const vidPreview = document.getElementById('vidPreview');

      function acceptVideo(file){
        if(!file) return;
        const ok = /video\/(mp4|quicktime|webm)/.test(file.type) || /\.(mp4|mov|webm)$/i.test(file.name);
        if(!ok){ toast('Unsupported video type. Use MP4 / MOV / WEBM.', 'error'); return; }
        vidName.textContent = file.name;
        vidSize.textContent = fmt(file.size);
        vidPill.style.display = 'flex';
        // Inline preview
        const url = URL.createObjectURL(file);
        vidPreview.src = url; vidPreview.style.display = 'block';
        safeLS.set('sr_video_name', file.name);
        safeLS.set('sr_video_size', String(file.size||0));
        toast('Video attached.', 'success');
      }
      chooseVidBtn?.addEventListener('click', ()=> vidInput.click());
      vidInput?.addEventListener('change', (e)=> acceptVideo(e.target.files?.[0]));
      ['dragenter','dragover'].forEach(ev => vidDrop?.addEventListener(ev, e=>{ e.preventDefault(); vidDrop.classList.add('dragover'); }));
      ['dragleave','drop'].forEach(ev => vidDrop?.addEventListener(ev, e=>{ e.preventDefault(); vidDrop.classList.remove('dragover'); }));
      vidDrop?.addEventListener('drop', (e)=> acceptVideo(e.dataTransfer?.files?.[0]));
      removeVidBtn?.addEventListener('click', ()=>{
        vidPill.style.display='none'; vidInput.value=''; vidPreview.removeAttribute('src'); vidPreview.style.display='none';
        safeLS.del('sr_video_name'); safeLS.del('sr_video_size');
        toast('Video removed.', 'info');
      });

      // Restore from any saved metadata
      (function restoreAttached(){
        const pn = safeLS.get('sr_pdf_name',''); const ps = Number(safeLS.get('sr_pdf_size',''));
        if(pn){ pdfName.textContent = pn; pdfSize.textContent = fmt(ps); pdfPill.style.display='flex'; }
        const vn = safeLS.get('sr_video_name',''); const vs = Number(safeLS.get('sr_video_size',''));
        if(vn){ vidName.textContent = vn; vidSize.textContent = fmt(vs); vidPill.style.display='flex'; /* no blob to preview after refresh */ }
      })();
    })();

    /* Writer actions */
    (function(){
      const box = document.getElementById('writerBox');
      const title = document.getElementById('writerTitle');
      const savedEl = document.getElementById('writerSaved');
      const countEl = document.getElementById('writerCount');

      function updateCount(){
        const text = box.innerText || '';
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        countEl.textContent = words + ' words • ' + text.length + ' chars';
      }
      box.addEventListener('input', ()=>{ updateCount(); savedEl.textContent='Unsaved'; });

      document.querySelectorAll('.toolbar [data-cmd]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const cmd = btn.getAttribute('data-cmd');
          document.execCommand(cmd, false, null);
          box.focus();
        });
      });

      function draftKey(){ return 'sr_writer_draft'; }
      function saveDraft(){
        const data = { title: title.value || '', html: box.innerHTML || '' };
        safeLS.set(draftKey(), JSON.stringify(data));
        savedEl.textContent = 'Saved';
        toast('Draft saved.', 'success');
      }
      function restoreDraft(){
        try {
          const raw = safeLS.get(draftKey(), '');
          if(!raw){ toast('No saved draft found.', 'error'); return; }
          const data = JSON.parse(raw);
          title.value = data.title || '';
          box.innerHTML = data.html || '';
          updateCount();
          savedEl.textContent = 'Restored';
          toast('Draft restored.', 'success');
        } catch { toast('Could not restore draft.', 'error'); }
      }
      function clearDraft(){
        box.innerHTML = ''; title.value = '';
        updateCount();
        savedEl.textContent = 'Cleared';
      }
      function copyDraft(){
        const text = (title.value ? (title.value+'\n\n') : '') + (box.innerText || '');
        navigator.clipboard.writeText(text).then(()=> toast('Copied to clipboard.', 'success'), ()=> toast('Copy failed.', 'error'));
      }
      function downloadDraft(){
        const text = (title.value ? (title.value+'\n\n') : '') + (box.innerText || '');
        const blob = new Blob([text], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (title.value ? title.value.replace(/[^\w\-]+/g,'_') : 'recommendation') + '.txt';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      function attachDraft(){
        // If no PDF chosen yet, attach the draft as a .txt “letter attachment”
        if(!safeLS.get('sr_pdf_name','')){
          const name = (title.value ? title.value.replace(/[^\w\-]+/g,'_') : 'recommendation') + '.txt';
          const text = (title.value ? (title.value+'\n\n') : '') + (box.innerText || '');
          safeLS.set('sr_pdf_name', name);
          safeLS.set('sr_pdf_size', String(text.length));
          // reflect in UI
          const pdfName = document.getElementById('pdfName');
          const pdfSize = document.getElementById('pdfSize');
          const pdfPill = document.getElementById('pdfPill');
          pdfName.textContent = name;
          pdfSize.textContent = text.length + ' bytes (draft)';
          pdfPill.style.display = 'flex';
          toast('Draft attached as text file.', 'success');
        } else {
          toast('A PDF is already attached. Remove it first to attach draft text.', 'info');
        }
      }

      document.getElementById('saveDraftBtn')?.addEventListener('click', saveDraft);
      document.getElementById('restoreDraftBtn')?.addEventListener('click', restoreDraft);
      document.getElementById('clearDraftBtn')?.addEventListener('click', clearDraft);
      document.getElementById('copyDraftBtn')?.addEventListener('click', copyDraft);
      document.getElementById('downloadDraftBtn')?.addEventListener('click', downloadDraft);
      document.getElementById('attachDraftBtn')?.addEventListener('click', attachDraft);

      // Restore autosaved draft on load if present
      try {
        const raw = safeLS.get('sr_writer_draft','');
        if(raw){ const d=JSON.parse(raw); title.value=d.title||''; box.innerHTML=d.html||''; updateCount(); savedEl.textContent='Restored'; }
      } catch {}
      updateCount();
    })();

    /* Selected Universities: read from student selections */
    (function(){
      const listEl  = document.getElementById('selectedList');
      const countEl = document.getElementById('selectedCount');
      const sendBtn = document.getElementById('sendBtn');

      // Try sr_referral.unitids first; fallback to window.studentUnitIds
      function getSelectedIds(){
        try {
          const raw = safeLS.get('sr_referral','');
          if(raw){
            const data = JSON.parse(raw);
            if(Array.isArray(data.unitids) && data.unitids.length) return data.unitids.map(String);
          }
        } catch {}
        if (window.studentUnitIds && window.studentUnitIds.size) return Array.from(window.studentUnitIds).map(String);
        return [];
      }

      // Optionally map IDs -> names if a dataset exists on window.universities
      function idToName(id){
        if(Array.isArray(window.universities)){
          const hit = window.universities.find(u => String(u.unitid)===String(id));
          if(hit) return hit.name + (hit.state ? ` (${hit.state})` : '');
        }
        return `UnitID ${id}`;
      }

      function render(){
        const ids = getSelectedIds();
        listEl.innerHTML='';
        ids.forEach(id=>{
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = idToName(id);
          listEl.appendChild(tag);
        });
        countEl.textContent = ids.length + ' ' + (ids.length===1?'university selected':'universities selected');
        sendBtn.disabled = ids.length === 0;
      }

      // Expose for other scripts if needed
      window.getSelectedUniversityIds = getSelectedIds;
      window.refreshSelectedList = render;

      render();

      // Copy shareable link (if sr_referral_raw exists)
      document.getElementById('copyLinkBtn')?.addEventListener('click', ()=>{
        try {
          const raw = safeLS.get('sr_referral_raw','');
          const base = location.origin + location.pathname;
          if(raw){
            const obj = JSON.parse(raw);
            const q = new URLSearchParams();
            if(obj.studentFirst) q.set('sf', obj.studentFirst);
            if(obj.studentLast)  q.set('sl', obj.studentLast);
            if(obj.studentEmail) q.set('se', obj.studentEmail);
            if(obj.waiveAccess!=null) q.set('waive', obj.waiveAccess ? '1':'0');
            if(Array.isArray(obj.unitids) && obj.unitids.length) q.set('unis', obj.unitids.join(','));
            const share = base + '?' + q.toString();
            navigator.clipboard.writeText(share).then(()=> toast('Link copied.', 'success'));
          } else {
            toast('No student link data available to copy.', 'error');
          }
        } catch { toast('Could not copy link.', 'error'); }
      });
    })();

    /* Send flow: confirm -> progress -> success */
    (function(){
      const sendBtn = document.getElementById('sendBtn');
      const overlay = document.getElementById('confirmOverlay');
      const closeBtn= document.getElementById('confirmClose');
      const cancel  = document.getElementById('confirmCancel');
      const confirm = document.getElementById('confirmSend');
      const incList = document.getElementById('incList');
      const incCount= document.getElementById('incCount');
      const summary = document.getElementById('confirmSummary');

      const progressCard = document.getElementById('progressCard');
      const successCard  = document.getElementById('successCard');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const deliveryList = document.getElementById('deliveryList');
      const newUploadBtn = document.getElementById('newUploadBtn');

      function idToName(id){
        if(Array.isArray(window.universities)){
          const hit = window.universities.find(u => String(u.unitid)===String(id));
          if(hit) return hit.name + (hit.state ? ` (${hit.state})` : '');
        }
        return `UnitID ${id}`;
      }

      function openConfirm(){
        const ids = (window.getSelectedUniversityIds && window.getSelectedUniversityIds()) || [];
        if (!ids.length){ toast('No universities selected.', 'error'); return; }

        incList.innerHTML = '';
        ids.forEach(id=>{
          const row = document.createElement('div');
          row.textContent = idToName(id);
          incList.appendChild(row);
        });
        incCount.textContent = String(ids.length);

        // Pull student + recommender meta if present
        let stu = {}, rec = {};
        try { const o = JSON.parse(safeLS.get('sr_referral','{}')); stu=o.student||{}; rec=o.recommender||{}; } catch {}
        const title = document.getElementById('writerTitle')?.value?.trim() || '';
        summary.innerHTML = `
          <div><b>Letter</b>: ${title || '<em>Untitled</em>'}</div>
          <div><b>Student</b>: ${(stu.first||'') + ' ' + (stu.last||'') || '<em>—</em>'} ${stu.email?('• '+stu.email):''}</div>
          <div><b>Recommender</b>: ${rec.name||'<em>—</em>'} ${rec.email?('• '+rec.email):''}</div>
          <div style="color:#64748b; margin-top:.25rem;">Ready to send to ${ids.length} destination${ids.length>1?'s':''}.</div>
        `;
        overlay.classList.add('show');
      }

      function closeConfirm(){ overlay.classList.remove('show'); }

      sendBtn?.addEventListener('click', openConfirm);
      closeBtn?.addEventListener('click', closeConfirm);
      cancel?.addEventListener('click', closeConfirm);

      confirm?.addEventListener('click', ()=>{
        closeConfirm();
        // Start progress
        progressCard.style.display='block';
        successCard.style.display='none';
        deliveryList.innerHTML='';
        progressFill.style.width='0%';
        progressText.textContent='Starting deliveries...';

        const ids = (window.getSelectedUniversityIds && window.getSelectedUniversityIds()) || [];
        const rows = ids.map(id=>{
          const el = document.createElement('div');
          el.className='delivery-item';
          el.innerHTML = `<span class="status pending" aria-hidden="true"></span>
                          <div style="flex:1">${idToName(id)}</div>
                          <div class="state" style="font-weight:700; color:#9a3412;">Pending</div>`;
          deliveryList.appendChild(el);
          return el;
        });

        // Simulate per-university sends
        let done = 0;
        function step(i){
          if(i>=rows.length){
            progressFill.style.width='100%';
            progressText.textContent='All deliveries completed.';
            setTimeout(()=>{
              progressCard.style.display='none';
              successCard.style.display='block';
            }, 350);
            return;
          }
          progressText.textContent=`Sending to ${idToName(ids[i])}...`;
          setTimeout(()=>{
            const row = rows[i];
            row.querySelector('.status').className = 'status success';
            row.querySelector('.state').textContent = 'Delivered';
            row.querySelector('.state').style.color = '#166534';
            done++;
            progressFill.style.width = Math.round(done/rows.length*100)+'%';
            step(i+1);
          }, 550 + Math.random()*450);
        }
        // slight delay to show initial state
        setTimeout(()=> step(0), 250);
      });

      newUploadBtn?.addEventListener('click', ()=>{
        successCard.style.display='none';
        // Reset attachments but keep selections
        try {
          safeLS.del('sr_pdf_name'); safeLS.del('sr_pdf_size');
          document.getElementById('pdfPill').style.display='none';
          document.getElementById('pdfInput').value='';
          safeLS.del('sr_video_name'); safeLS.del('sr_video_size');
          document.getElementById('vidPill').style.display='none';
          const v = document.getElementById('vidPreview'); v.removeAttribute('src'); v.style.display='none';
        } catch {}
        toast('You can upload a new letter now.', 'info');
        window.scrollTo({top:0, behavior:'smooth'});
      });
    })();
  </script>
</body>
</html>
