<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StellarRec - One upload. Unlimited reach.</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Roboto',sans-serif;
      background:linear-gradient(135deg,var(--bg-grad-1,#f8f9fa) 0%,var(--bg-grad-2,#e9ecef) 100%);
      color:var(--text,#333);
      min-height:100vh;
    }
    /* Header */
    .header {
      background:linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color:#fff;
      padding:1.1rem 2rem;
      box-shadow:0 4px 20px rgba(25,118,210,0.3);
    }
    .header-content {
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
    }
    .logo {
      display:flex;
      align-items:center;
      gap:.5rem;
      font-size:1.8rem;
      font-weight:700;
      text-decoration:none;
      color:#fff;
      transition:.3s;
    }
    .logo:hover { opacity:.85; transform:translateY(-1px); }
    /* Header nav (Student left, Recommender right) */
    .header-nav {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      flex:1;
      margin:0 1rem;
    }
    .nav-left, .nav-right { display:flex; gap:1.25rem; align-items:center; }
    [hidden] { display:none !important; }
    .nav-link{
      color:#fff;
      text-decoration:none;
      font-weight:700;
      opacity:.95;
      padding:.35rem .75rem;
      border-radius:10px;
      transition:opacity .15s, transform .15s;
    }
    .nav-link:hover{ opacity:1; transform:translateY(-1px); }
    .nav-link[aria-current="page"]{ background:#ffffff22; }

    /* Center header tabs (A) */
    .hdr-tabs {
      display:flex;
      align-items:center;
      gap:.4rem;
      background:#ffffff22;
      border:1px solid #ffffff55;
      border-radius:999px;
      padding:.2rem;
      min-height:40px;
    }
    .hdr-tab {
      appearance:none;
      border:0;
      background:transparent;
      color:#fff;
      padding:.45rem .9rem;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      letter-spacing:.2px;
      font-size:.95rem;
      opacity:.9;
    }
    .hdr-tab[aria-selected="true"] {
      background:#fff;
      color:#1976d2;
      box-shadow:0 6px 20px rgba(0,0,0,.12);
      opacity:1;
    }
    .hdr-tab:focus-visible {
      outline:3px solid rgba(255,255,255,.5);
      outline-offset:2px;
    }
    /* Right controls (theme + avatar) */
    .right-controls { display:flex; align-items:center; gap:.75rem; }
    /* Avatar + dropdown */
    .user-info { position:relative; display:flex; align-items:center; gap:1rem; }
    .user-avatar {
      width:45px; height:45px;
      background:rgba(255,255,255,.2);
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:1.2rem;
      cursor:pointer;
      transition:.2s;
      border:2px solid rgba(255,255,255,0.1);
    }
    .user-avatar:hover { background:rgba(255,255,255,.3); transform:scale(1.05); border-color:rgba(255,255,255,.3); }
    .user-avatar:focus { outline:none; box-shadow:0 0 0 3px rgba(255,255,255,.3); }
    .user-dropdown {
      position:absolute;
      top:100%; right:0; margin-top:.5rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,.15);
      min-width:260px; max-width:min(92vw,360px);
      opacity:0; visibility:hidden;
      transform:translateY(-10px) scale(.95);
      transition:all .2s cubic-bezier(0.4,0,0.2,1);
      z-index:1000;
      border:1px solid rgba(0,0,0,.08);
    }
    .user-dropdown.show { opacity:1; visibility:visible; transform:translateY(0) scale(1); }
    .user-dropdown::before{
      content:''; position:absolute; top:-8px; right:16px;
      width:16px; height:16px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-bottom:none; border-right:none;
      transform:rotate(45deg);
    }
    .dropdown-header { padding:1rem; border-bottom:1px solid #f0f0f0; color:#333; font-weight:600; font-size:.9rem; }
    .dropdown-item {
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem;
      color:#333; cursor:pointer;
      transition:.15s;
    }
    .dropdown-item:hover, .dropdown-item:focus { background:#f8f9fa; outline:none; }
    .dropdown-item .material-icons { font-size:1.2rem; color:#666; }
    .dropdown-item.active { background:#e3f2fd; color:#1976d2; }
    .dropdown-item.active .material-icons { color:#1976d2; }
    .view-label { display:flex; flex-direction:column; }
    .view-name { font-weight:600; font-size:.9rem; }
    .view-description { font-size:.8rem; color:#666; margin-top:.1rem; }

    .container { max-width:1200px; margin:0 auto; padding:1.25rem; }
    .hero-section { text-align:center; margin:1rem 0 1.5rem; }
    .hero-title { font-size:2.3rem; font-weight:700; color:#1976d2; margin-bottom:.6rem; }
    .hero-subtitle { font-size:1.1rem; color:#666; margin-bottom:1.25rem; }

    /* Two-column layout */
    .compose-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
      margin-bottom:2rem;
    }
    @media (max-width: 980px) { .compose-grid { grid-template-columns:1fr; } }

    .upload-section, .writer-section, .university-section, .selected-section, .progress-section {
      background:#fff;
      border-radius:16px;
      padding:2rem;
      box-shadow:0 8px 32px rgba(0,0,0,.1);
      margin-bottom:0;
    }
    .upload-section { border:2px dashed #e0e0e0; transition:.3s; }
    .upload-section.dragover { border-color:#1976d2; background:#f3f8ff; }
    .upload-area { text-align:center; padding:2rem; }
    .upload-icon { font-size:4rem; color:#1976d2; margin-bottom:1rem; }
    .upload-title { font-size:1.5rem; font-weight:600; margin-bottom:.5rem; color:#333; }
    .upload-subtitle { color:#666; margin-bottom:2rem; }
    .file-input { display:none; }
    .upload-btn {
      background:linear-gradient(135deg,#1976d2,#7c4dff);
      color:#fff;
      padding:1rem 2rem;
      border:none;
      border-radius:12px;
      font-size:1.1rem;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
      display:inline-flex;
      align-items:center;
      gap:.5rem;
    }
    .upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    .uploaded-file {
      display:none;
      background:#e8f5e8;
      border:2px solid #4caf50;
      border-radius:12px;
      padding:1.5rem;
      margin-top:1rem;
    }
    .file-info { display:flex; align-items:center; gap:1rem; }
    .file-icon { font-size:2rem; color:#4caf50; }
    .file-details h3 { color:#2e7d32; margin-bottom:.25rem; }
    .file-details p { color:#4caf50; font-size:.9rem; }
    .remove-file {
      margin-left:auto;
      background:none;
      border:none;
      color:#666;
      cursor:pointer;
      padding:.5rem;
      border-radius:50%;
      transition:.2s;
    }
    .remove-file:hover { background:rgba(244,67,54,.1); color:#f44336; }
    .section-title {
      font-size:1.5rem;
      font-weight:600;
      color:#333;
      margin-bottom:1rem;
      display:flex; align-items:center; gap:.5rem;
    }
    .section-title .material-icons { color:#1976d2; }
    .letter-writer textarea {
      width:100%; min-height:220px;
      padding:1.25rem;
      border:1px solid #ddd;
      border-radius:12px;
      font-size:1rem;
      line-height:1.6;
      resize:vertical;
    }
    .letter-writer textarea:focus {
      outline:none; border-color:#1976d2;
      box-shadow:0 0 0 3px rgba(25,118,210,.2);
    }
    .letter-writer button {
      margin-top:1rem;
      background:linear-gradient(135deg,#1976d2,#7c4dff);
      color:#fff;
      border:none;
      padding:.9rem 1.8rem;
      border-radius:12px;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
    }
    .letter-writer button:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    .university-search { display:flex; gap:.75rem; margin-bottom:1rem; }
    .university-search input {
      flex:1;
      padding:.85rem 1.2rem;
      border:1px solid #ddd;
      border-radius:10px;
      font-size:1rem;
    }
    .university-search button {
      padding:.75rem 1.5rem;
      background:#1976d2;
      color:#fff;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    .filters { display:flex; gap:.75rem; margin-bottom:1.25rem; flex-wrap:wrap; }
    .filter-btn {
      padding:.6rem 1.2rem;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fff;
      cursor:pointer;
      font-size:.9rem;
      transition:.2s;
    }
    .filter-btn.active { background:#1976d2; color:#fff; border-color:#1976d2; }
    .university-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:1rem;
    }
    .university-card {
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 16px rgba(0,0,0,.08);
      padding:1rem;
      transition:.2s;
      display:flex; flex-direction:column; gap:.5rem;
    }
    .university-card:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,.12); }
    .university-card h3 { font-size:1.1rem; font-weight:600; margin-bottom:.25rem; }
    .university-card p { font-size:.9rem; color:#555; }
    .select-btn {
      margin-top:auto;
      padding:.6rem 1rem;
      background:#7c4dff;
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      font-size:.9rem;
    }
    .select-btn:hover { background:#6a1b9a; }
    .selected-list { margin-top:1rem; display:flex; flex-direction:column; gap:.75rem; }
    .selected-item {
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem;
      background:#f8f9fa;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .selected-item .remove-btn {
      margin-left:auto;
      background:none;
      border:none;
      color:#f44336;
      cursor:pointer;
      font-size:1.2rem;
    }
    .send-section {
      text-align:center;
      margin-top:2rem;
    }
    .send-btn {
      background:linear-gradient(135deg,#1976d2,#7c4dff);
      color:#fff;
      border:none;
      padding:1rem 2rem;
      border-radius:12px;
      font-size:1.1rem;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
    }
    .send-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    .progress-tracker { margin-top:1rem; }
    .progress-tracker table { width:100%; border-collapse:collapse; }
    .progress-tracker th, .progress-tracker td {
      padding:.75rem 1rem;
      text-align:left;
      border-bottom:1px solid #ddd;
      font-size:.95rem;
    }
    .track-pill {
      padding:.3rem .6rem;
      border-radius:999px;
      font-size:.85rem;
      font-weight:600;
    }
    .track-pill.pending { background:#fff3cd; color:#856404; }
    .track-pill.sent { background:#d1ecf1; color:#0c5460; }
    .track-pill.received { background:#d4edda; color:#155724; }

    /* Toast notifications */
    .toast-wrap {
      position:fixed;
      bottom:1rem; right:1rem;
      display:flex; flex-direction:column; gap:.5rem;
      z-index:9999;
    }
    .toast {
      display:flex; align-items:center; gap:.5rem;
      padding:.75rem 1.25rem;
      border-radius:10px;
      background:#333; color:#fff;
      font-size:.9rem;
      animation:fadeIn .3s ease;
    }
    .toast.success { background:#4caf50; }
    .toast.error { background:#f44336; }
    .toast.info { background:#1976d2; }
    .toast .x {
      margin-left:.5rem;
      background:none;
      border:none;
      color:#fff;
      font-size:1rem;
      cursor:pointer;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    /* Theme support */
    :root[data-theme='dark'] {
      --bg-grad-1:#1a1a1a;
      --bg-grad-2:#121212;
      --text:#f1f1f1;
    }
    :root[data-theme='dark'] body { background:linear-gradient(135deg,#1a1a1a,#121212); color:#f1f1f1; }
    :root[data-theme='dark'] .upload-section,
    :root[data-theme='dark'] .writer-section,
    :root[data-theme='dark'] .university-section,
    :root[data-theme='dark'] .selected-section,
    :root[data-theme='dark'] .progress-section {
      background:#1e1e1e; color:#f1f1f1; border:1px solid #333;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo"><span class="material-icons">star</span> StellarRec</a>
      <nav class="header-nav">
        <div class="nav-left">
          <button id="hdrStuTab" class="hdr-tab" data-view="student" aria-selected="true">Student</button>
        </div>
        <div class="nav-right">
          <button id="hdrRecTab" class="hdr-tab" data-view="recommender" aria-selected="false">Recommender</button>
        </div>
      </nav>
      <div class="right-controls">
        <button id="headerThemeBtn" aria-pressed="false" class="material-icons" title="Toggle theme">brightness_6</button>
        <div class="user-info">
          <div id="userAvatarBtn" class="user-avatar" tabindex="0" aria-expanded="false">
            <span class="material-icons">person</span>
          </div>
          <div id="userDropdown" class="user-dropdown" role="menu" aria-hidden="true">
            <div class="dropdown-header">Quick Actions</div>
            <div class="dropdown-item" id="contactAdminItem">
              <span class="material-icons">support_agent</span><span class="view-label"><span class="view-name">Contact Admin</span><span class="view-description">Get help with your account</span></span>
            </div>
            <div class="dropdown-item" id="bulkImportBtn">
              <span class="material-icons">file_upload</span><span class="view-label"><span class="view-name">Bulk Import</span><span class="view-description">Add many universities at once</span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
  <!-- Student Panel -->
  <div class="container" id="panel-student">
    <!-- Upload Section -->
    <div class="upload-section">
      <h2 class="section-title"><span class="material-icons">upload_file</span> Upload Your Documents</h2>
      <div id="uploadArea" class="upload-box">
        <p>Drag & drop your PDF here or</p>
        <button id="chooseFileBtn">Choose File</button>
        <input id="fileInput" type="file" accept="application/pdf" hidden />
      </div>
      <div id="uploadedFile" class="uploaded-file" style="display:none;">
        <p><strong id="fileName"></strong> <span id="fileSize"></span></p>
        <button id="removeFileBtn">Remove</button>
      </div>
    </div>

    <!-- Video Upload Section -->
    <div class="upload-section">
      <h2 class="section-title"><span class="material-icons">videocam</span> Upload a Video</h2>
      <div id="videoUploadArea" class="upload-box">
        <p>Drag & drop your video here or</p>
        <button id="chooseVideoBtn">Choose Video</button>
        <input id="videoInput" type="file" accept="video/*" hidden />
      </div>
      <div id="uploadedVideo" class="uploaded-file" style="display:none;">
        <p><strong id="videoName"></strong> <span id="videoSize"></span></p>
        <button id="removeVideoBtn">Remove</button>
      </div>
    </div>

    <!-- University Selection Section -->
    <div class="university-section">
      <h2 class="section-title"><span class="material-icons">school</span> Select Universities</h2>
      <div class="university-search">
        <input type="text" id="universitySearchInput" placeholder="Search universities..." />
        <button id="searchBtn">Search</button>
      </div>
      <div class="filters">
        <button class="filter-btn" data-filter="all">All</button>
        <button class="filter-btn" data-filter="us">U.S.</button>
        <button class="filter-btn" data-filter="intl">International</button>
      </div>
      <div id="universityGrid" class="university-grid"></div>
    </div>

    <!-- Selected Universities Section -->
    <div class="selected-section">
      <h2 class="section-title"><span class="material-icons">check_circle</span> Selected Universities</h2>
      <div id="selectedList" class="selected-list"></div>
      <div class="send-section">
        <button id="sendBtn" class="send-btn" disabled>Send to Recommender</button>
      </div>
    </div>

    <!-- Track Progress Section -->
    <div class="progress-section">
      <h2 class="section-title"><span class="material-icons">track_changes</span> Track Progress</h2>
      <div class="progress-tracker">
        <table>
          <thead>
            <tr>
              <th>Recommender</th>
              <th>Email</th>
              <th>Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="stuTrackBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Recommender Panel -->
  <div class="container" id="panel-recommender" hidden>
    <!-- Only Selected Universities Section (no search to avoid duplicates) -->
    <div class="selected-section">
      <h2 class="section-title"><span class="material-icons">check_circle</span> Selected Universities</h2>
      <div id="recSelectedList" class="selected-list"></div>
    </div>

    <!-- Letter Writer Section -->
    <div class="writer-section">
      <h2 class="section-title"><span class="material-icons">edit</span> Write a Letter</h2>
      <div class="letter-writer">
        <textarea id="letterContent" placeholder="Write your recommendation letter here..."></textarea>
        <button id="saveLetterBtn">Save Letter</button>
      </div>
    </div>
  </div>

  <!-- Contact Overlay -->
  <div id="contactOverlay" class="overlay" style="display:none;">
    <div class="overlay-content" style="transform:translateY(50px); opacity:0; transition:.3s;">
      <h3>Contact Admin</h3>
      <p>If you need assistance, please write to support@stellarrec.com</p>
      <div style="margin-top:1rem;">
        <button id="contactCloseBtn2">Close</button>
        <button id="contactCancelBtn2">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Bulk Import Modal -->
  <div id="importModal" class="overlay" style="display:none;">
    <div class="overlay-content" style="transform:translateY(50px); opacity:0; transition:.3s;">
      <h3>Bulk Import Universities</h3>
      <textarea id="importTextarea" placeholder="Paste university names, one per line..."></textarea>
      <div id="importPreview" style="margin:.5rem 0; font-size:.9rem; color:#555;"></div>
      <div style="margin-top:1rem;">
        <button id="importConfirmBtn">Import</button>
        <button id="importCancelBtn">Cancel</button>
        <button id="importCloseBtn">Close</button>
      </div>
    </div>
  </div>
  <!-- Scripts -->
  <script src="/assets/js/fuse.min.js"></script>
  <script src="/assets/js/localforage.min.js"></script>
  <script src="/assets/js/dashboard.js"></script>

  <!-- Tab Switching Script -->
  <script>
    (function(){
      const studentPanel = document.getElementById('panel-student');
      const recPanel     = document.getElementById('panel-recommender');
      const toggles      = document.querySelectorAll('.header-nav .nav-link');

      if (!studentPanel || !recPanel || !toggles.length) return;

      // Safe localStorage helpers
      const safeLS = {
        get(k, d){ try { return localStorage.getItem(k) ?? d; } catch(e){ return d; } },
        set(k, v){ try { localStorage.setItem(k, v); } catch(e){} }
      };

      function setActive(view){
        const isStudent = (view === 'student');
        studentPanel.hidden = !isStudent;
        recPanel.hidden     =  isStudent;
        studentPanel.style.display = isStudent ? '' : 'none';
        recPanel.style.display     = isStudent ? 'none' : '';

        toggles.forEach(btn => {
          const on = btn.dataset.view === view;
          btn.setAttribute('aria-selected', on ? 'true' : 'false');
          if (on) btn.setAttribute('aria-current','page');
          else btn.removeAttribute('aria-current');
        });

        history.replaceState(null, '', '#' + view);
        safeLS.set('sr_current_view', view);
      }

      // Click handlers
      toggles.forEach(btn => btn.addEventListener('click', () => setActive(btn.dataset.view)));

      // Initial state
      const fromHash = (location.hash || '').replace('#','');
      const saved    = safeLS.get('sr_current_view', '');
      const initial  = (fromHash === 'recommender' || fromHash === 'student') ? fromHash
                      : (saved === 'recommender' || saved === 'student') ? saved
                      : 'student';
      setActive(initial);

      // Sync with hash
      window.addEventListener('hashchange', () => {
        const v = (location.hash || '#student').slice(1);
        setActive(v === 'recommender' ? 'recommender' : 'student');
      });
    })();
  </script>

  <!-- Sanity checks + header interactions -->
  <script>
    (function(){
      if (typeof Fuse !== 'function') console.warn('[SR] Fuse.js not loaded');
      if (typeof localforage === 'undefined') console.warn('[SR] localForage not loaded');
      else localforage.config({ name: 'StellarRec' });

      // Avatar dropdown toggling
      const btn = document.getElementById('userAvatarBtn');
      const dd  = document.getElementById('userDropdown');
      function closeDD(e){
        if (!dd) return;
        if (e && (dd.contains(e.target) || btn.contains(e.target))) return;
        dd.classList.remove('show');
        btn?.setAttribute('aria-expanded','false');
        document.removeEventListener('click', closeDD);
      }
      btn?.addEventListener('click', (e)=>{
        e.stopPropagation();
        dd?.classList.toggle('show');
        btn.setAttribute('aria-expanded', dd?.classList.contains('show') ? 'true' : 'false');
        if (dd?.classList.contains('show')) setTimeout(()=>document.addEventListener('click', closeDD), 0);
      });

      // Theme button fallback
      document.getElementById('headerThemeBtn')?.addEventListener('click', ()=>{
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme') === 'dark';
        root.setAttribute('data-theme', isDark ? 'light' : 'dark');
      });
    })();
  </script>
  <!-- Link Intake Parser (Recommender) -->
  <script>
    (function () {
      const els = {
        input:  document.getElementById('linkInput'),
        parse:  document.getElementById('linkParseBtn'),
        status: document.getElementById('linkStatus'),
        sum:    document.getElementById('linkSummary'),
        help:   document.getElementById('linkHelpBtn'),
      };

      // Safe localStorage helpers
      const safeLS = {
        get(k, d){ try { return localStorage.getItem(k) ?? d; } catch(e){ return d; } },
        set(k, v){ try { localStorage.setItem(k, v); } catch(e){} }
      };

      const norm = s => (s||'').toString().trim().toLowerCase();

      // Help button opens the details
      els.help?.addEventListener('click', () => {
        const det = document.getElementById('linkFormatDetails');
        if (!det) return;
        det.open = true;
        det.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });

      function setStatus(msg, type='info'){
        if (!els.status) return;
        const color = type==='error' ? '#b91c1c' : type==='success' ? '#166534' : '#334155';
        els.status.innerHTML = `<span style="color:${color}">${msg}</span>`;
      }

      function summarize(data, matchedCount){
        const lines = [];
        if (data.studentFirst || data.studentLast) {
          lines.push(
            `<div><b>Student</b>: ${
              [data.studentFirst, data.studentLast].filter(Boolean).join(' ') || '<span class="muted">—</span>'
            }</div>`
          );
        }
        if (data.studentEmail || data.studentPhone) {
          lines.push(
            `<div><b>Contact</b>: ${
              [data.studentEmail, data.studentPhone].filter(Boolean).join(' • ') || '<span class="muted">—</span>'
            }</div>`
          );
        }
        if (typeof data.waiveAccess !== 'undefined') {
          lines.push(`<div><b>Waive access</b>: ${data.waiveAccess ? '<span class="ok">Yes</span>' : 'No'}</div>`);
        }
        if (data.recommenderName || data.recommenderEmail || data.recommenderPhone) {
          lines.push(
            `<div><b>Recommender</b>: ${data.recommenderName || ''}${
              data.recommenderEmail ? ' • ' + data.recommenderEmail : ''
            }${data.recommenderPhone ? ' • ' + data.recommenderPhone : ''}</div>`
          );
        }
        if (Array.isArray(data.unitids) && data.unitids.length) {
          lines.push(
            `<div><b>Universities (unitids)</b>: ${data.unitids.length} ${
              matchedCount != null
                ? `<span class="${matchedCount>0?'ok':'warn'}">(matched ${matchedCount})</span>`
                : ''
            }</div>`
          );
        } else if (Array.isArray(data.unames) && data.unames.length) {
          lines.push(`<div><b>Universities (by name)</b>: ${data.unames.length} (will match)</div>`);
        }
        els.sum.innerHTML = lines.join('') || '<div class="muted">No details found.</div>';
        els.sum.hidden = false;
      }

      function parseLink(raw){
        try {
          const url = new URL(raw);
          const q   = url.searchParams;
          const data = {
            studentFirst:    q.get('sf') || q.get('sfn') || '',
            studentLast:     q.get('sl') || q.get('sln') || '',
            studentEmail:    q.get('se') || q.get('semail') || '',
            studentPhone:    q.get('sp') || q.get('sphone') || '',
            waiveAccess:     q.get('waive') === '1' || q.get('waive') === 'true',
            recommenderName: q.get('rname') || '',
            recommenderEmail:q.get('remail') || '',
            recommenderPhone:q.get('rphone') || '',
            unitids: [],
            unames:  [],
          };
          const unis = q.get('unis');
          if (unis) data.unitids = unis.split(',').map(s => s.trim()).filter(Boolean);
          const unames = q.get('unames');
          if (unames) data.unames = unames.split(',').map(s => s.trim()).filter(Boolean);
          return data;
        } catch {
          return null;
        }
      }

      async function applyReferralData(data){
        // Save raw
        safeLS.set('sr_referral_raw', JSON.stringify(data));

        // Preselect sets (globals consumed by dashboard.js)
        window.studentUnitIds       = new Set();
        window.addedByRecommender   = new Set();
        window.removedByRecommender = new Set();

        let matchedCount = 0;

        // Prefer unitids if provided
        if (Array.isArray(data.unitids) && data.unitids.length && Array.isArray(window.universities)) {
          const master = new Map(window.universities.map(u => [String(u.unitid), u]));
          data.unitids.forEach(id => {
            const uid = String(id);
            if (master.has(uid)) {
              window.studentUnitIds.add(uid);
              matchedCount++;
            }
          });
        }

        // Fuzzy-match by names if needed
        if ((!data.unitids || !data.unitids.length) && Array.isArray(data.unames) && data.unames.length && Array.isArray(window.universities)) {
          const names = data.unames.map(norm);
          for (const u of window.universities) {
            const n = norm(u.name);
            if (names.some(q => n.includes(q))) {
              window.studentUnitIds.add(String(u.unitid));
              matchedCount++;
            }
          }
        }

        // Update UI if helpers exist (provided by dashboard.js)
        if (typeof window.updateSelectedList === 'function') window.updateSelectedList();
        if (typeof window.updateSendButton  === 'function') window.updateSendButton();

        // Persist normalized summary for refresh durability
        const save = {
          student: {
            first: data.studentFirst, last: data.studentLast,
            email: data.studentEmail, phone: data.studentPhone,
            waive: !!data.waiveAccess
          },
          recommender: {
            name: data.recommenderName, email: data.recommenderEmail, phone: data.recommenderPhone
          },
          unitids: Array.from(window.studentUnitIds),
        };
        safeLS.set('sr_referral', JSON.stringify(save));

        return matchedCount;
      }

      async function handleImport(){
        const raw = (els.input?.value || '').trim();
        if (!raw) {
          setStatus('Please paste a link first.', 'error');
          return;
        }
        const data = parseLink(raw);
        if (!data) {
          setStatus('That doesn’t look like a valid link. Make sure it includes query parameters.', 'error');
          return;
        }

        setStatus('Parsing link and applying data…');

        // Ensure dataset present before matching (dashboard.js exposes loadDataset)
        if (typeof window.loadDataset === 'function' && (!Array.isArray(window.universities) || !window.universities.length)) {
          try { await window.loadDataset(); } catch {}
        }

        const matched = await applyReferralData(data);
        summarize(data, matched);

        // Auto-fill letter title
        const titleEl = document.getElementById('writerTitle');
        if (titleEl) {
          const full = [data.studentFirst, data.studentLast].filter(Boolean).join(' ');
          if (full) titleEl.value = `Recommendation for ${full}`;
        }

        // Notify
        if (window.toast) {
          window.toast(`Imported ${matched} universit${matched===1?'y':'ies'} from the link.`, matched ? 'success' : 'info');
        }
        setStatus('Link imported successfully.', 'success');

        // Switch to Recommender view (if not already there)
        const recPanel = document.getElementById('panel-recommender');
        const stuPanel = document.getElementById('panel-student');
        if (recPanel && stuPanel) {
          stuPanel.hidden = true;
          recPanel.hidden = false;
          recPanel.style.display = '';
          stuPanel.style.display = 'none';

          const toggles = document.querySelectorAll('.header-nav .nav-link');
          toggles.forEach(b=>{
            const on = b.dataset.view === 'recommender';
            b.setAttribute('aria-selected', on ? 'true' : 'false');
            if (on) b.setAttribute('aria-current','page'); else b.removeAttribute('aria-current');
          });

          try { localStorage.setItem('sr_current_view','recommender'); } catch {}
          history.replaceState(null,'','#recommender');
        }
      }

      els.parse?.addEventListener('click', handleImport);
      els.input?.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') { e.preventDefault(); handleImport(); }
      });
    })();
  </script>

  <!-- Minimal toast utility (used by parser if dashboard.js toast not yet used) -->
  <script>
    (function(){
      if (window.toast) return;
      const wrap = document.getElementById('toastWrap') || (() => {
        const d = document.createElement('div');
        d.id = 'toastWrap'; d.className = 'toast-wrap';
        document.body.appendChild(d);
        return d;
      })();
      window.toast = function(msg, type='info'){
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = `
          <div class="icon">${type==='success'?'✅':type==='error'?'⛔':'ℹ️'}</div>
          <div class="msg">${msg}</div>
          <button class="x" aria-label="Dismiss">✕</button>
        `;
        wrap.appendChild(el);
        const remove = ()=> { el.style.opacity='0'; setTimeout(()=>el.remove(), 180); };
        el.querySelector('.x').addEventListener('click', remove);
        setTimeout(remove, 3500);
      };
    })();
  </script>

  <!-- Inline handlers for PDF/Video uploads & writer autosave (complements dashboard.js) -->
  <script>
    (function(){
      // PDF
      const fileInput      = document.getElementById('fileInput');
      const chooseFileBtn  = document.getElementById('chooseFileBtn');
      const uploadedFile   = document.getElementById('uploadedFile');
      const fileNameEl     = document.getElementById('fileName');
      const fileSizeEl     = document.getElementById('fileSize');
      const removeFileBtn  = document.getElementById('removeFileBtn');
      const uploadArea     = document.getElementById('uploadArea');

      function humanSize(b){
        if (!b && b!==0) return '—';
        const u = ['B','KB','MB','GB']; let i=0, n=b;
        while (n>=1024 && i<u.length-1){ n/=1024; i++; }
        return `${n.toFixed(1)} ${u[i]}`;
        }

      function showPDF(file){
        if (!file) return;
        fileNameEl.textContent = file.name;
        fileSizeEl.textContent = humanSize(file.size);
        uploadedFile.style.display = 'block';
        window.toast?.('PDF attached.', 'success');
      }

      chooseFileBtn?.addEventListener('click', ()=> fileInput?.click());
      fileInput?.addEventListener('change', (e)=>{
        const f = e.target.files?.[0];
        if (f && (f.type==='application/pdf' || /\.pdf$/i.test(f.name))) showPDF(f);
        else window.toast?.('Please select a PDF file.', 'error');
      });

      removeFileBtn?.addEventListener('click', ()=>{
        if (fileInput) fileInput.value = '';
        uploadedFile.style.display = 'none';
      });

      // Drag & drop for PDF
      ['dragenter','dragover'].forEach(evt =>
        uploadArea?.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); uploadArea.classList.add('dragover'); })
      );
      ['dragleave','drop'].forEach(evt =>
        uploadArea?.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); uploadArea.classList.remove('dragover'); })
      );
      uploadArea?.addEventListener('drop', (e)=>{
        const f = e.dataTransfer?.files?.[0];
        if (f && (f.type==='application/pdf' || /\.pdf$/i.test(f.name))) showPDF(f);
        else window.toast?.('Please drop a PDF file.', 'error');
      });

      // Video
      const videoInput     = document.getElementById('videoInput');
      const chooseVideoBtn = document.getElementById('chooseVideoBtn');
      const uploadedVideo  = document.getElementById('uploadedVideo');
      const videoNameEl    = document.getElementById('videoName');
      const videoSizeEl    = document.getElementById('videoSize');
      const removeVideoBtn = document.getElementById('removeVideoBtn');
      const videoArea      = document.getElementById('videoUploadArea');
      const videoPreview   = document.getElementById('videoPreview');

      function showVideo(file){
        if (!file) return;
        videoNameEl.textContent = file.name;
        videoSizeEl.textContent = humanSize(file.size);
        uploadedVideo.style.display = 'block';
        if (videoPreview) {
          const url = URL.createObjectURL(file);
          videoPreview.src = url;
          videoPreview.style.display = 'block';
        }
        window.toast?.('Video attached.', 'success');
      }

      chooseVideoBtn?.addEventListener('click', ()=> videoInput?.click());
      videoInput?.addEventListener('change', (e)=>{
        const f = e.target.files?.[0];
        if (f && /video\/(mp4|quicktime|webm)/.test(f.type)) showVideo(f);
        else window.toast?.('Please select a valid video (MP4/MOV/WEBM).', 'error');
      });

      removeVideoBtn?.addEventListener('click', ()=>{
        if (videoInput) videoInput.value = '';
        if (videoPreview) { videoPreview.pause(); videoPreview.removeAttribute('src'); videoPreview.load(); videoPreview.style.display='none'; }
        uploadedVideo.style.display = 'none';
      });

      // Simple writer autosave
      const writerBox   = document.getElementById('writerBox');
      const writerTitle = document.getElementById('writerTitle');
      const writerCount = document.getElementById('writerCount');
      const writerSaved = document.getElementById('writerSaved');
      const autosaveTgl = document.getElementById('writerAutosaveToggle');

      function updateCount(){
        const text = (writerBox?.innerText || '').trim();
        const words = text ? text.split(/\s+/).length : 0;
        const chars = text.length;
        if (writerCount) writerCount.textContent = `${words} words • ${chars} chars`;
      }

      const saveDraftBtn   = document.getElementById('saveDraftBtn');
      const restoreDraftBtn= document.getElementById('restoreDraftBtn');
      const clearDraftBtn  = document.getElementById('clearDraftBtn');
      const copyDraftBtn   = document.getElementById('copyDraftBtn');
      const downloadBtn    = document.getElementById('downloadDraftBtn');
      const attachDraftBtn = document.getElementById('attachDraftBtn');

      function saveDraft(){
        try {
          localStorage.setItem('sr_writer_title', writerTitle?.value || '');
          localStorage.setItem('sr_writer_body',  writerBox?.innerHTML || '');
          if (writerSaved) writerSaved.textContent = 'Saved ✓';
          window.toast?.('Draft saved.', 'success');
        } catch { /* ignore */ }
      }
      function restoreDraft(){
        try {
          const t = localStorage.getItem('sr_writer_title') || '';
          const b = localStorage.getItem('sr_writer_body')  || '';
          if (writerTitle) writerTitle.value = t;
          if (writerBox)   writerBox.innerHTML = b;
          updateCount();
          if (writerSaved) writerSaved.textContent = 'Restored';
          window.toast?.('Draft restored.', 'info');
        } catch { /* ignore */ }
      }

      saveDraftBtn?.addEventListener('click', saveDraft);
      restoreDraftBtn?.addEventListener('click', restoreDraft);
      clearDraftBtn?.addEventListener('click', ()=>{
        if (writerTitle) writerTitle.value = '';
        if (writerBox)   writerBox.innerHTML = '';
        updateCount();
        window.toast?.('Draft cleared.', 'info');
      });
      copyDraftBtn?.addEventListener('click', async ()=>{
        try {
          const plain = writerBox?.innerText || '';
          await navigator.clipboard.writeText(plain);
          window.toast?.('Copied to clipboard.', 'success');
        } catch { window.toast?.('Copy failed.', 'error'); }
      });
      downloadBtn?.addEventListener('click', ()=>{
        const title = (writerTitle?.value || 'recommendation').replace(/[^\w\- ]+/g,'').trim() || 'recommendation';
        const blob  = new Blob([writerBox?.innerText || ''], { type: 'text/plain' });
        const url   = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${title}.txt`; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 0);
      });
      attachDraftBtn?.addEventListener('click', ()=>{
        window.toast?.('Draft attached to submission (local demo).', 'success');
      });

      writerBox?.addEventListener('input', ()=>{
        updateCount();
        if (autosaveTgl?.checked) saveDraft();
      });
      writerTitle?.addEventListener('input', ()=>{
        if (autosaveTgl?.checked) saveDraft();
      });

      // Init counts & maybe restore on load
      updateCount();
      try {
        const autoRestore = localStorage.getItem('sr_autorestored_once') !== '1';
        if (autoRestore) {
          restoreDraft();
          localStorage.setItem('sr_autorestored_once','1');
        }
      } catch { /* ignore */ }
    })();
  </script>

</body>
</html>

