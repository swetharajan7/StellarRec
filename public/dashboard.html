<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StellarRec - One upload. Unlimited reach.</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Roboto',sans-serif;
      background:linear-gradient(135deg,var(--bg-grad-1,#f8f9fa) 0%,var(--bg-grad-2,#e9ecef) 100%);
      color:var(--text,#333);
      min-height:100vh;
    }
    /* Header */
    .header {
      background:linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color:#fff; padding:1.1rem 2rem; /* tighter to bring hero closer */
      box-shadow:0 4px 20px rgba(25,118,210,0.3);
    }
    .header-content {
      max-width:1200px; margin:0 auto;
      display:flex; justify-content:space-between; align-items:center; gap:1rem;
    }
    .logo {
      display:flex; align-items:center; gap:.5rem;
      font-size:1.8rem; font-weight:700;
      text-decoration:none; color:#fff; transition:.3s;
    }
    .logo:hover { opacity:.85; transform:translateY(-1px); }
    /* Header nav (Student left, Recommender right) */
    .header-nav { display:flex; justify-content:space-between; align-items:center; gap:1rem; flex:1; margin:0 1rem; }
    .nav-left, .nav-right { display:flex; gap:1.25rem; align-items:center; }
    [hidden] { display: none !important; }

    .nav-link{
      color:#fff; text-decoration:none; font-weight:700; opacity:.95;
      padding:.35rem .75rem; border-radius:10px; transition:opacity .15s, transform .15s;
    }
    .nav-link:hover{ opacity:1; transform:translateY(-1px); }
    .nav-link[aria-current="page"]{ background:#ffffff22; }
    /* Center header tabs (A) */
    .hdr-tabs {
      display:flex; align-items:center; gap:.4rem;
      background:#ffffff22; border:1px solid #ffffff55; border-radius:999px;
      padding:.2rem; min-height:40px;
    }
    .hdr-tab {
      appearance:none; border:0; background:transparent; color:#fff;
      padding:.45rem .9rem; border-radius:999px; font-weight:700; cursor:pointer;
      letter-spacing:.2px; font-size:.95rem; opacity:.9;
    }
    .hdr-tab[aria-selected="true"] {
      background:#fff; color:#1976d2; box-shadow:0 6px 20px rgba(0,0,0,.12);
      opacity:1;
    }
    .hdr-tab:focus-visible { outline:3px solid rgba(255,255,255,.5); outline-offset:2px; }
    /* Right controls (theme + avatar) */
    .right-controls { display:flex; align-items:center; gap:.75rem; }
    /* Avatar + dropdown */
    .user-info { position:relative; display:flex; align-items:center; gap:1rem; }
    .user-avatar {
      width:45px; height:45px;
      background:rgba(255,255,255,.2); border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:1.2rem; cursor:pointer; transition:.2s;
      border:2px solid rgba(255,255,255,0.1);
    }
    .user-avatar:hover { background:rgba(255,255,255,.3); transform:scale(1.05); border-color:rgba(255,255,255,.3); }
    .user-avatar:focus { outline:none; box-shadow:0 0 0 3px rgba(255,255,255,.3); }
    .user-dropdown {
      position:absolute; top:100%; right:0; margin-top:.5rem;
      background:#fff; border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,.15);
      min-width:260px; max-width:min(92vw,360px);
      opacity:0; visibility:hidden;
      transform:translateY(-10px) scale(.95);
      transition:all .2s cubic-bezier(0.4,0,0.2,1); z-index:1000;
      border:1px solid rgba(0,0,0,.08);
    }
    .user-dropdown.show { opacity:1; visibility:visible; transform:translateY(0) scale(1); }
    .user-dropdown::before{
      content:''; position:absolute; top:-8px; right:16px; width:16px; height:16px;
      background:#fff; border:1px solid rgba(0,0,0,.08); border-bottom:none; border-right:none;
      transform:rotate(45deg);
    }
    .dropdown-header { padding:1rem; border-bottom:1px solid #f0f0f0; color:#333; font-weight:600; font-size:.9rem; }
    .dropdown-item {
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem; color:#333; cursor:pointer; transition:.15s;
    }
    .dropdown-item:hover, .dropdown-item:focus { background:#f8f9fa; outline:none; }
    .dropdown-item .material-icons { font-size:1.2rem; color:#666; }
    .dropdown-item.active { background:#e3f2fd; color:#1976d2; }
    .dropdown-item.active .material-icons { color:#1976d2; }
    .view-label { display:flex; flex-direction:column; }
    .view-name { font-weight:600; font-size:.9rem; }
    .view-description { font-size:.8rem; color:#666; margin-top:.1rem; }
    .container { max-width:1200px; margin:0 auto; padding:1.25rem; }
    .hero-section { text-align:center; margin:1rem 0 1.5rem; }
    .hero-title { font-size:2.3rem; font-weight:700; color:#1976d2; margin-bottom:.6rem; }
    .hero-subtitle { font-size:1.1rem; color:#666; margin-bottom:1.25rem; }
    /* Two-column layout */
    .compose-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:2rem; }
    @media (max-width: 980px) { .compose-grid { grid-template-columns:1fr; } }

    .upload-section, .writer-section, .university-section,
    .selected-section, .progress-section {
      background:#fff; border-radius:16px; padding:2rem;
      box-shadow:0 8px 32px rgba(0,0,0,.1); margin-bottom:0;
    }
    .upload-section { border:2px dashed #e0e0e0; transition:.3s; }
    .upload-section.dragover { border-color:#1976d2; background:#f3f8ff; }
    .upload-area { text-align:center; padding:2rem; }
    .upload-icon { font-size:4rem; color:#1976d2; margin-bottom:1rem; }
    .upload-title { font-size:1.5rem; font-weight:600; margin-bottom:.5rem; color:#333; }
    .upload-subtitle { color:#666; margin-bottom:2rem; }
    .file-input { display:none; }
    .upload-btn {
      background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff;
      padding:1rem 2rem; border:none; border-radius:12px;
      font-size:1.1rem; font-weight:600; cursor:pointer;
      transition:.3s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    .uploaded-file {
      display:none; background:#e8f5e8; border:2px solid #4caf50;
      border-radius:12px; padding:1.5rem; margin-top:1rem;
    }
    .file-info { display:flex; align-items:center; gap:1rem; }
    .file-icon { font-size:2rem; color:#4caf50; }
    .file-details h3 { color:#2e7d32; margin-bottom:.25rem; }
    .file-details p { color:#4caf50; font-size:.9rem; }
    .remove-file {
      margin-left:auto; background:none; border:none; color:#666;
      cursor:pointer; padding:.5rem; border-radius:50%; transition:.2s;
    }
    .remove-file:hover { background:rgba(244,67,54,.1); color:#f44336; }
    .section-title {
      font-size:1.5rem; font-weight:600; color:#333;
      margin-bottom:1rem; display:flex; align-items:center; gap:.5rem;
    }
    /* Writer */
    .writer-toolbar { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.75rem; align-items:center; }
    .writer-toolbar .btn {
      background:#fff; border:2px solid #e5e7eb; border-radius:10px;
      padding:.45rem .75rem; cursor:pointer; font-weight:600;
    }
    .writer-toolbar .btn:hover { background:#f8f9fa; }
    .writer-toolbar .meta { margin-left:auto; font-size:.9rem; color:#667; display:flex; gap:.75rem; align-items:center; }
    .writer-title {
      width:100%; padding:.7rem .9rem;
      border:2px solid #e0e0e0; border-radius:12px;
      font-size:1rem; margin-bottom:.6rem;
    }
    .writer-box {
      border:2px solid #e0e0e0; border-radius:12px;
      min-height:280px; padding:1rem; line-height:1.55;
    }
    .writer-box:focus { outline:none; border-color:#1976d2; }
    .writer-actions { display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap; }
    .btn-primary { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; border:none; }
    .btn-success { background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; border:none; }
    .btn-danger  { background:linear-gradient(135deg,#e53935,#ef5350); color:#fff; border:none; }
    .btn-muted   { background:#fff; color:#333; }
    .filter-meta { font-size:.9rem; color:#666; margin:.25rem 0 .5rem; }
    .filter-bar { display:grid; grid-template-columns: repeat(8, minmax(140px, 1fr)); gap:.5rem; margin-bottom:.75rem; align-items:center; }
    .filter-select { width:100%; padding:.7rem .9rem; border:2px solid #e0e0e0; border-radius:12px; background:#fff; font-size:.95rem; }
    .university-grid {
      display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:1rem;
      max-height:480px; overflow-y:auto; padding:1rem; border:1px solid #f0f0f0; border-radius:12px;
    }
    .university-card { background:#f8f9fa; border:2px solid transparent; border-radius:12px; padding:1rem; cursor:pointer; transition:.2s; }
    .university-card:hover { border-color:#1976d2; background:#f3f8ff; }
    .university-card.selected { border-color:#1976d2; background:#e3f2fd; }
    .university-header { display:flex; align-items:center; gap:1rem; margin-bottom:.5rem; }
    .university-logo { width:40px; height:40px; background:#1976d2; color:#fff; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:600; }
    .university-name { font-weight:600; color:#333; }
    .university-location { color:#666; font-size:.9rem; }
    .university-pill { margin-top:.25rem; display:inline-block; font-size:.75rem; color:#555; background:#eef3ff; border:1px solid #dbe7ff; padding:.15rem .5rem; border-radius:999px; }
    .pagination { display:flex; justify-content:space-between; align-items:center; margin-top:.75rem; }
    .pager { display:flex; gap:.5rem; }
    .page-btn { background:#fff; border:2px solid #e0e0e0; border-radius:10px; padding:.5rem .9rem; cursor:pointer; font-weight:600; }
    .page-btn[disabled] { opacity:.5; cursor:not-allowed; }
    .page-size { margin-left:auto; display:flex; align-items:center; gap:.5rem; }
    .selected-count { color:#1976d2; font-weight:600; margin-bottom:1rem; }
    .selected-list { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:2rem; }
    .selected-tag { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:.5rem 1rem; border-radius:20px; font-size:.9rem; display:flex; align-items:center; gap:.5rem; }
    .remove-tag { cursor:pointer; background:rgba(255,255,255,.2); border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .remove-tag:hover { background:rgba(255,255,255,.3); }
    .send-section { text-align:center; }
    .send-btn {
      background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; padding:1.2rem 3rem; border:none; border-radius:12px;
      font-size:1.2rem; font-weight:600; cursor:pointer; transition:.2s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .send-btn:disabled { background:#ccc; cursor:not-allowed; }
    .send-btn:not(:disabled):hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(76,175,80,.3); }
    .progress-section { display:none; }
    .progress-title { font-size:1.3rem; font-weight:600; color:#333; margin-bottom:1rem; text-align:center; }
    .progress-bar { width:100%; height:12px; background:#e0e0e0; border-radius:6px; overflow:hidden; margin-bottom:1rem; }
    .progress-fill { height:100%; background:linear-gradient(135deg,#4caf50,#66bb6a); border-radius:6px; transition:width .5s ease; width:0%; }
    .progress-text { text-align:center; color:#666; font-size:.9rem; }
    .delivery-list { margin-top:1rem; }
    .delivery-item { display:flex; align-items:center; gap:1rem; padding:.75rem; border-radius:8px; margin-bottom:.5rem; background:#f8f9fa; }
    .delivery-status { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .delivery-status.pending { background:#fff3e0; color:#ff9800; }
    .delivery-status.success { background:#e8f5e8; color:#4caf50; }
    .delivery-status.error { background:#ffebee; color:#f44336; }
    .success-section {
      display:none; background:linear-gradient(135deg,#e8f5e8,#f1f8e9);
      border:2px solid #4caf50; border-radius:16px; padding:2rem; text-align:center; box-shadow:0 8px 32px rgba(76,175,80,.2);
    }
    .success-icon { font-size:4rem; color:#4caf50; margin-bottom:1rem; }
    .success-title { font-size:1.8rem; font-weight:600; color:#2e7d32; margin-bottom:1rem; }
    .success-subtitle { color:#4caf50; margin-bottom:2rem; }
    .new-upload-btn { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:1rem 2rem; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition:.2s; }
    .new-upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    @keyframes flash { 0%{box-shadow:0 0 0 rgba(25,118,210,0);} 25%{box-shadow:0 0 0 6px rgba(25,118,210,.25);} 100%{box-shadow:0 0 0 rgba(25,118,210,0);} }
    .flash { animation: flash 1.2s ease; }
    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; font-size:.75rem; border-radius:999px; border:1px solid; }
    .badge-student { background:#f1f8ff; color:#0d47a1; border-color:#bbdefb; }
    .badge-added   { background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9; }
    .badge-removed { background:#ffebee; color:#b71c1c; border-color:#ffcdd2; }
    .toast-wrap { position: fixed; right: 16px; bottom: 16px; z-index: 99999; display: grid; gap: 8px; }
    .toast { min-width: 240px; max-width: 420px; padding: .75rem .9rem; border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.15); color:#0f172a; background:#fff; border:1px solid #e5e7eb;
      display:flex; align-items:flex-start; gap:.6rem; animation: toast-in .18s ease; }
    .toast.success { border-color:#c8e6c9; background:#f1f8f3; }
    .toast.error   { border-color:#ffcdd2; background:#fff2f2; }
    .toast.info    { border-color:#bbdefb; background:#f3f8ff; }
    .toast .icon { font-size: 1.1rem; line-height:1; margin-top:.1rem; }
    .toast .msg  { flex:1; font-size:.95rem; }
    .toast .x    { border:none; background:transparent; cursor:pointer; font-size:1rem; opacity:.6; }
    .toast .x:hover { opacity:.9; }
    @keyframes toast-in { from { transform: translateY(6px); opacity:0; } to { transform: translateY(0); opacity:1; } }
    .empty-state { display:none; background:#fff; border:1px dashed #d0d7de; border-radius:12px; padding:1.25rem; color:#445; text-align:center; }
    .empty-state .actions { margin-top:.75rem; display:flex; gap:.5rem; justify-content:center; }
    /* Student view (B) */
    .student-card {
      background:#fff; border-radius:16px; padding:1.25rem 1.5rem;
      box-shadow:0 8px 32px rgba(0,0,0,.08);
    }
    .student-tabs {
      display:flex; gap:.4rem; background:#f1f5f9; border-radius:999px; padding:.2rem;
      border:1px solid #e5e7eb; margin-bottom:.9rem;
      justify-content: space-between;
      width: 100%;
    }
    .student-tab {
      appearance:none; background:transparent; border:0; cursor:pointer;
      padding:.5rem 1rem; border-radius:999px; font-weight:700; color:#334155;
    }
    .student-tab[aria-selected="true"] {
      background:#fff; color:#0f172a; box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    .student-panels > section { display:block; }
  
    .student-panels > section[hidden] { display: none !important; }

    .table { width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
      border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
    .table th, .table td { padding:.7rem .8rem; text-align:left; border-bottom:1px solid #eef2f7; }
    .table th { background:#f8fafc; color:#334155; font-weight:700; }
    .table tr:last-child td { border-bottom:none; }
    .track-pill { display:inline-block; padding:.2rem .6rem; border-radius:999px; font-weight:700; font-size:.8rem; }
    .track-pill.pending { background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
    .track-pill.sent    { background:#ecfeff; color:#155e75; border:1px solid #a5f3fc; }
    .track-pill.received{ background:#ecfdf5; color:#166534; border:1px solid #bbf7d0; }
    @media (max-width:768px) {
      .container { padding:1rem; }
      .hero-title { font-size:2rem; }
      .university-grid { grid-template-columns:1fr; }
      .header-content { flex-direction:column; gap:1rem; }
      .filter-bar { grid-template-columns:1fr 1fr; }
    }
    /* Dark theme basics (CSS side) */
    :root[data-theme="dark"] {
      --bg:#0b1220; --panel:#111a2a; --text:#e5eefc; --muted:#93a3bc; --primary:#7aa2ff; --border:#24324a;
    }
    :root[data-theme="dark"] body { background: linear-gradient(135deg,#0b1220 0%,#0f1729 100%); color: var(--text); }
    :root[data-theme="dark"] .upload-section,
    :root[data-theme="dark"] .writer-section,
    :root[data-theme="dark"] .university-section,
    :root[data-theme="dark"] .selected-section,
    :root[data-theme="dark"] .progress-section { background: var(--panel); box-shadow:none; }
    :root[data-theme="dark"] .filter-select,
    :root[data-theme="dark"] .writer-title,
    :root[data-theme="dark"] .writer-box,
    :root[data-theme="dark"] .page-btn { background:#0f1729; color:var(--text); border-color: var(--border); }
    :root[data-theme="dark"] .university-card { background:#0f1729; }
    :root[data-theme="dark"] .university-card:hover { background:#12203a; border-color:#274780; }
    :root[data-theme="dark"] .university-card.selected { background:#13254a; }
    :root[data-theme="dark"] .hero-subtitle, :root[data-theme="dark"] .university-location { color: var(--muted); }
    :root[data-theme="dark"] .hdr-tabs { background:#ffffff11; border-color:#ffffff33; }
    :root[data-theme="dark"] .hdr-tab { color:#e5eefc; }
    :root[data-theme="dark"] .hdr-tab[aria-selected="true"] { background:#0f1729; color:#7aa2ff; }
    :root[data-theme="dark"] .student-card,
    :root[data-theme="dark"] .table,
    :root[data-theme="dark"] .student-tabs { background:#111a2a; border-color:#24324a; }
    :root[data-theme="dark"] .table th { background:#0f1729; color:#e5eefc; }
    :root[data-theme="dark"] .student-tab { color:#c9d6ee; }
    :root[data-theme="dark"] .student-tab[aria-selected="true"] { background:#0f1729; color:#7aa2ff; }
    /* Footer (match header) */
    .site-footer {
      background: linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color: #fff;
      padding: 1.5rem 0;
      text-align: center;
    }
    .site-footer p { margin: 0; font-size: 0.95rem; }
    .theme-btn {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.55rem 1rem; border-radius:999px;
      border:1px solid #ffffff55; background:#ffffff22; color:#fff; font-weight:600;
      cursor:pointer; transition: transform .15s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .theme-btn:hover { transform: translateY(-1px); background:#ffffff33; border-color:#ffffff88; }
    .theme-btn:focus-visible { outline:3px solid rgba(255,255,255,.5); outline-offset:2px; }
    .theme-btn .material-icons { font-size:18px; }
    .apply-btn {
      background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; border:none;
      padding:.6rem 1rem; border-radius:10px; font-weight:700; cursor:pointer;
    }
    .apply-btn:hover { transform:translateY(-1px); box-shadow:0 8px 20px rgba(25,118,210,.25); }
    /* Intake card (link paste) */
    .intake-card {
      background:#fff; border-radius:16px; padding:1.25rem 1.5rem;
      box-shadow:0 8px 32px rgba(0,0,0,.08); margin:1rem auto 1.25rem;
      border:1px solid #e5e7eb; max-width:1200px;
    }
    .intake-row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .intake-title { display:flex; align-items:center; gap:.5rem; font-size:1.25rem; font-weight:700; color:#0f172a; }
    .intake-actions { display:flex; gap:.5rem; }
    .intake-sub { color:#475569; margin:.35rem 0 .75rem; }
    .intake-inputs { display:flex; gap:.5rem; align-items:center; }
    .intake-inputs .filter-select { flex:1; }
    .intake-status { margin-top:.6rem; font-size:.95rem; color:#334155; }
    .intake-details { margin-top:.5rem; }
    .intake-help { background:#f8fafc; padding:.75rem; border-radius:10px; border:1px solid #e5e7eb; color:#334155; }
    .intake-summary {
      margin-top:.75rem; border-top:1px dashed #e5e7eb; padding-top:.6rem;
      font-size:.95rem; color:#0f172a; display:grid; gap:.35rem;
    }
    .intake-summary .ok { color:#166534; }
    .intake-summary .warn { color:#9a3412; }
    .intake-summary .muted { color:#64748b; }

    :root[data-theme="dark"] .intake-card { background:#111a2a; border-color:#24324a; box-shadow:none; }
    :root[data-theme="dark"] .intake-sub, 
    :root[data-theme="dark"] .intake-help { color:#c9d6ee; background:#0f1729; border-color:#24324a; }
    :root[data-theme="dark"] .intake-summary { color:#e5eefc; border-color:#24324a; }

    /* NEW: autosuggest popover styling */
    .suggest-popover{
      position:absolute; top:100%; left:0; right:0; z-index:50; margin-top:.25rem;
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 12px 24px rgba(0,0,0,.08);
      max-height:320px; overflow:auto; padding:.25rem;
    }
    .suggest-item{
      padding:.5rem .6rem; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;
    }
    .suggest-item:hover{ background:#f8fafc; }
    :root[data-theme="dark"] .suggest-popover{ background:#0f1729; border-color:#24324a; }
    :root[data-theme="dark"] .suggest-item:hover{ background:#111f38; }
  </style>

  <style id="sr-recommender-patch-css">
    /* Writer guidance card */
    .writer-guide {
      border: 1px dashed #cbd5e1; background:#f8fafc;
      color:#0f172a; border-radius:12px; padding:1rem; margin:.6rem 0 0;
      font-size:.95rem; line-height:1.45;
    }
    .writer-guide b { color:#0b4fb1; }
    .writer-guide ul { margin:.4rem 0 0 1.2rem; }
    .writer-guide li { margin:.25rem 0; }
    /* dark mode harmony */
    :root[data-theme="dark"] .writer-guide {
      background:#0f1729; border-color:#24324a; color:#e5eefc;
    }
    /* Send button pulse (enabled only) */
    @keyframes srPulse {
      0% { transform: translateY(0) scale(1); box-shadow: 0 0 0 rgba(76,175,80,0); }
      50%{ transform: translateY(-1px) scale(1.01); box-shadow: 0 8px 20px rgba(76,175,80,.25); }
      100%{ transform: translateY(0) scale(1); box-shadow: 0 0 0 rgba(76,175,80,0); }
    }
    .send-btn.sr-pulse:not(:disabled) { animation: srPulse 1.6s ease-in-out infinite; }
    /* tiny nudge when newly enabled */
    .send-btn.sr-flash { animation: srPulse .9s ease-in-out 1; }
    /* make dropdown scrolling obvious when auto-scrolling to Contact admin */
    .user-dropdown.sr-highlight { outline: 2px solid #1976d2; outline-offset: 2px; }
    
    /* Hide bulk import elements in recommender view */
    #panel-recommender .bulk-import-btn,
    #panel-recommender [data-action="bulk-import"],
    #panel-recommender button[title*="Bulk"],
    #panel-recommender button[title*="Import"],
    #panel-recommender .import-btn { 
      display: none !important; 
    }
    
    /* Hide bulk import modal completely when in recommender view */
    body:has(#panel-recommender:not([hidden])) #bulkImportModal {
      display: none !important;
    }
    /* --- Recommender compact mode: hide intake and tighten spacing --- */
#panel-recommender.is-compact #linkIntake { display: none !important; }
#panel-recommender.is-compact .hero-section { margin-top: .5rem !important; }
#panel-recommender.is-compact .compose-grid { margin-top: .25rem !important; }

  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <div class="header-content">
      <!-- Left: Logo -->
      <a href="/" class="logo" target="_self" aria-label="Go to homepage">
        <span class="material-icons">star</span>
        stellarrec
      </a>
      <!-- Center: Student / Recommender toggles -->
      <nav class="header-nav" role="tablist" aria-label="Choose portal">
        <div class="nav-left">
          <button class="nav-link" data-view="student" role="tab" aria-selected="true" type="button">Student</button>
        </div>
        <div class="nav-right">
          <button class="nav-link" data-view="recommender" role="tab" aria-selected="false" type="button">Recommender</button>
        </div>
      </nav>
      <!-- Right: Theme + Avatar -->
      <div class="right-controls">
        <button id="headerThemeBtn" class="theme-btn" type="button" aria-pressed="false" title="Toggle theme">
          <span class="material-icons" aria-hidden="true">dark_mode</span>
          Light / Dark
        </button>
        <div class="user-info">
          <button class="user-avatar" id="userAvatarBtn" aria-haspopup="true" aria-expanded="false" type="button">
            <span class="material-icons">person</span>
          </button>
          <div class="user-dropdown" id="userDropdown" role="menu" aria-hidden="true">
            <div class="dropdown-header">Quick actions</div>
            <div class="dropdown-item" id="contactAdminItem" role="menuitem" tabindex="0">
              <span class="material-icons">support_agent</span>
              <div class="view-label">
                <div class="view-name">Contact admin</div>
                <div class="view-description">Send a message</div>
              </div>
            </div>
          </div>
        </div><!-- /.user-info -->
      </div><!-- /.right-controls -->
    </div><!-- /.header-content -->
  </div><!-- /.header -->
  <!-- MAIN — RECOMMENDER VIEW (hidden by default) -->
  <div class="container" id="panel-recommender" hidden>
    <!-- Student Link Intake -->
    <div class="intake-card" id="linkIntake">
      <div class="intake-row">
        <h2 class="intake-title">
          <span class="material-icons" aria-hidden="true">link</span>
          Paste student link
        </h2>
        <div class="intake-actions">
          <button class="page-btn" id="linkHelpBtn" type="button" title="What does this do?">What’s this?</button>
        </div>
      </div>

      <p class="intake-sub">Paste the link you received by email from the student. We’ll import their details and selected universities.</p>

      <div class="intake-inputs">
        <input id="linkInput" class="filter-select" type="url" placeholder="Paste the student link here… e.g. https://example.com/reco?sf=Jane&sl=Doe&se=jane@email.com&waive=1&unis=166027,110635" />
        <button id="linkParseBtn" class="apply-btn" type="button">Import</button>
      </div>

      <div id="linkStatus" class="intake-status" aria-live="polite"></div>

      <details id="linkFormatDetails" class="intake-details">
        <summary>Expected link format (examples)</summary>
        <div class="intake-help">
          <div><b>With unit IDs (best):</b><br>
            <code>?sf=Jane&sl=Doe&se=jane@email.com&sp=2065551212&waive=1&unis=166027,110635&rname=Prof%20Smith&remail=smith@uni.edu&rphone=2125559876</code>
          </div>
          <div><b>With names (we’ll match):</b><br>
            <code>?sf=Jane&sl=Doe&se=jane@email.com&waive=0&unames=Harvard%20University,Stanford%20University</code>
          </div>
          <div style="margin-top:.35rem;">
            <small>
              Params: <code>sf</code>=student first, <code>sl</code>=student last, <code>se</code>=student email, <code>sp</code>=student phone,
              <code>waive</code>=1/0, <code>unis</code>=CSV of unitids, <code>unames</code>=CSV of names,
              <code>rname</code>=recommender name, <code>remail</code>=recommender email, <code>rphone</code>=recommender phone.
            </small>
          </div>
        </div>
      </details>

      <div id="linkSummary" class="intake-summary" hidden></div>
    </div>

    <!-- Hero -->
    <div class="hero-section">
      <h1 class="hero-title">One upload. Unlimited reach.</h1>
      <p class="hero-subtitle">Upload your recommendation letter once and send it to multiple US universities instantly.</p>
    </div>

    <div class="compose-grid">
      <!-- (A) Upload PDF (left) -->
      <div class="upload-section" id="uploadSection">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon"><span class="material-icons">cloud_upload</span></div>
          <h2 class="upload-title">Upload Recommendation Letter (PDF)</h2>
          <p class="upload-subtitle">Drag & drop your PDF here, or click to browse</p>
          <div id="uploadHint" style="margin:.5rem 0 0; font-size:.9rem; color:#556;">PDF only. Recommended size ≤ 10 MB.</div>

          <input type="file" id="fileInput" class="file-input" accept=".pdf,application/pdf" />
          <button class="upload-btn" id="chooseFileBtn">
            <span class="material-icons">upload_file</span> Choose PDF
          </button>
        </div>

        <div class="uploaded-file" id="uploadedFile">
          <div class="file-info">
            <div class="file-icon"><span class="material-icons">description</span></div>
            <div class="file-details">
              <h3 id="fileName">recommendation-letter.pdf</h3>
              <p id="fileSize">—</p>
            </div>
            <button class="remove-file" id="removeFileBtn" title="Remove PDF">
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>
      </div>

      <!-- (B) Upload Video (right) -->
      <div class="upload-section" id="videoUploadSection">
        <div class="upload-area" id="videoUploadArea">
          <div class="upload-icon"><span class="material-icons">videocam</span></div>
          <h2 class="upload-title">Upload Intro/Context Video (optional)</h2>
          <p class="upload-subtitle">Drag & drop your video here, or click to browse</p>
          <div style="margin:.5rem 0 0; font-size:.9rem; color:#556;">
            Supported: MP4 / MOV / WEBM. Tip: keep it short (≤ 2–3 min).
          </div>

          <input type="file" id="videoInput" class="file-input" accept="video/mp4,video/quicktime,video/webm" />
          <button class="upload-btn" id="chooseVideoBtn">
            <span class="material-icons">video_file</span> Choose Video
          </button>
        </div>

        <div class="uploaded-file" id="uploadedVideo">
          <div class="file-info" style="align-items:flex-start;">
            <div class="file-icon"><span class="material-icons">smart_display</span></div>
            <div class="file-details" style="flex:1;">
              <h3 id="videoName">intro.mp4</h3>
              <p id="videoSize">—</p>
              <!-- Optional inline preview -->
              <video id="videoPreview" class="video-preview" controls playsinline style="display:none; margin-top:.6rem; max-height:240px; width:100%; border-radius:10px; background:#000;"></video>
            </div>
            <button class="remove-video" id="removeVideoBtn" title="Remove video" style="background:none;border:none;color:#666;cursor:pointer;padding:.5rem;border-radius:50%;transition:.2s;">
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>
      </div>

      <!-- (C) Writer (full width on a new row) -->
      <div class="writer-section" id="writerSection" style="grid-column:1 / -1;">
        <h2 class="section-title"><span class="material-icons">edit</span> Write Letter</h2>
        <input id="writerTitle" class="writer-title" placeholder="Letter title (optional, e.g., 'Recommendation for Jane Doe')" />
        <div class="writer-toolbar">
          <button class="btn btn-muted" data-wcmd="bold" title="Bold (Ctrl/Cmd+B)"><b>B</b></button>
          <button class="btn btn-muted" data-wcmd="italic" title="Italic (Ctrl/Cmd+I)"><i>I</i></button>
          <button class="btn btn-muted" data-wcmd="underline" title="Underline (Ctrl/Cmd+U)"><u>U</u></button>
          <div class="meta">
            <span id="writerCount">0 words • 0 chars</span>
            <span id="writerSaved">Not saved</span>
          </div>
        </div>
        <div id="writerBox" class="writer-box" contenteditable="true" aria-label="Letter editor"
             placeholder="Write your recommendation letter here..."></div>
        <div class="writer-actions">
          <button class="btn btn-primary" id="saveDraftBtn">Save draft</button>
          <button class="btn btn-muted" id="restoreDraftBtn">Restore</button>
          <button class="btn btn-danger" id="clearDraftBtn">Clear</button>
          <button class="btn btn-muted" id="copyDraftBtn">Copy</button>
          <button class="btn btn-muted" id="downloadDraftBtn">Download .txt</button>
          <button class="btn btn-success" id="attachDraftBtn">Attach draft</button>
          <label style="display:flex; align-items:center; gap:.4rem; margin-left:auto;">
            <input type="checkbox" id="writerAutosaveToggle" checked />
            Autosave
          </label>
        </div>
      </div>
    </div>

    <!-- Selected Universities (KEEP in Recommender) -->
    <div class="selected-section">
      <h2 class="section-title" style="display:flex;align-items:center;gap:.5rem;">
        <span class="material-icons">check_circle</span> Selected Universities
        <button id="copyLinkBtn" class="page-btn" title="Copy shareable link" style="margin-left:auto;">Copy link</button>
      </h2>
      <div class="selected-count" id="selectedCount">0 universities selected</div>
      <div class="selected-list" id="selectedList" role="list" aria-live="polite"></div>
      <div class="send-section">
        <button class="send-btn" id="sendBtn" disabled>
          <span class="material-icons">send</span>
          Send to Selected Universities
        </button>
      </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progressSection">
      <h2 class="progress-title">Sending Letters...</h2>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText" aria-live="polite">Preparing to send...</div>
      <div class="delivery-list" id="deliveryList"></div>
    </div>

    <!-- Success Section -->
    <div class="success-section" id="successSection">
      <div class="success-icon"><span class="material-icons">check_circle</span></div>
      <h2 class="success-title">Letters Sent Successfully!</h2>
      <p class="success-subtitle">Your recommendation letter has been delivered to all selected universities.</p>
      <button class="new-upload-btn" id="newUploadBtn">
        <span class="material-icons">add</span>
        Send Another Letter
      </button>
    </div>

    <!-- Confirm Send Modal -->
    <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(720px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1.2rem 1.4rem; border-bottom:1px solid:#eee; display:flex; justify-content:space-between; align-items:center;">
          <div id="confirmModalTitle" style="font-weight:700;">Confirm recipients</div>
          <button aria-label="Close" id="modalCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1.2rem 1.4rem; max-height:60vh; overflow:auto; line-height:1.45;">
          <div id="modalSummary" style="margin-bottom:1rem;"></div>
          <div id="modalLists" style="display:grid; gap:1rem;">
            <div>
              <div style="font-weight:600;">Included (<span id="modalIncludedCount">0</span>)</div>
              <div id="modalIncluded"></div>
            </div>
            <div>
              <div style="font-weight:600;">Removed vs student’s list (<span id="modalRemovedCount">0</span>)</div>
              <div id="modalRemoved" style="color:#b00020;"></div>
            </div>
            <div>
              <div style="font-weight:600;">Added by you (<span id="modalAddedCount">0</span>)</div>
              <div id="modalAdded" style="color:#1b5e20;"></div>
            </div>
          </div>
        </div>
        <div style="padding:1rem 1.4rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="modalCancelBtn">Cancel</button>
          <button class="apply-btn" id="modalConfirmBtn">Send now</button>
        </div>
      </div>
    </div>

    <!-- Bulk Import Modal (Hidden in Recommender View) -->
    <div id="bulkImportModal" role="dialog" aria-modal="true"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(680px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1rem 1.2rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0; font-size:1.1rem;">Bulk Import universities</h3>
          <button aria-label="Close" id="importCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1rem 1.2rem; display:grid; gap:.75rem;">
          <div style="font-size:.92rem; color:#556;">
            Paste one <b>name per line</b>. We’ll fuzzy-match against the master list.
          </div>

          <div id="importPreview" style="font-size:.9rem; color:#667;"></div>
        </div>
        <div style="padding:1rem 1.2rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="bulkImportCancelBtn">Cancel</button>
          <button class="apply-btn" id="bulkImportAddBtn">Add matches</button>
        </div>
      </div>
    </div>
    <!-- Contact Admin Overlay -->
    <div id="contactOverlay" role="dialog" aria-modal="true" aria-labelledby="contactTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:10000;">
      <div style="background:#fff; width:min(560px,92vw); border-radius:16px; box-shadow:0 18px 50px rgba(0,0,0,.22); overflow:hidden; transform:translateY(12px); opacity:0; transition:.18s;">
        <div style="padding:1rem 1.25rem; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
          <div id="contactTitle" style="font-weight:700;">Contact admin</div>
          <button aria-label="Close" id="contactCloseBtn2" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <form id="contactForm2" style="padding:1rem 1.25rem; display:grid; gap:.75rem;">
          <div>
            <label for="cFirst2" style="display:block; font-weight:600; margin-bottom:.35rem;">First name</label>
            <input id="cFirst2" name="first" class="filter-select" type="text" placeholder="Your first name" required />
          </div>
          <div>
            <label for="cEmail2" style="display:block; font-weight:600; margin-bottom:.35rem;">Email address</label>
            <input id="cEmail2" name="email" class="filter-select" type="email" placeholder="you@example.com" required />
          </div>
          <div>
            <label for="cQuery2" style="display:block; font-weight:600; margin-bottom:.35rem;">Query</label>
            <textarea id="cQuery2" name="query" rows="5" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;" placeholder="How can we help?" required></textarea>
          </div>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid #f1f5f9; padding-top:.75rem;">
            <button type="button" class="page-btn" id="contactCancelBtn2">Cancel</button>
            <button type="submit" class="apply-btn" id="contactSendBtn2">Send</button>
          </div>
          <input type="hidden" name="form-name" value="contact-admin">
        </form>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>
  </div><!-- /.container (Recommender) -->
  <!-- STUDENT VIEW (default visible) -->
  <div class="container" id="panel-student">
    <div class="student-card" style="margin-bottom:1rem;">
      <h1 class="hero-title" style="margin:0 0 .4rem;">Student Portal</h1>
      <p class="hero-subtitle" style="margin:0 0 .8rem;">Request recommendations and track their status.</p>

      <div class="student-tabs" role="tablist" aria-label="Student actions">
        <!-- REORDERED: Select (left), Send (center), Track (right) -->
        <button id="stuTabSelect" class="student-tab" role="tab" aria-selected="false" type="button">
          Select Universities
        </button>
        <button id="stuTabSend" class="student-tab" role="tab" aria-selected="true" type="button">
          Send Recommendation Request
        </button>
        <button id="stuTabTrack" class="student-tab" role="tab" aria-selected="false" type="button">
          Track Recommendation &amp; Status
        </button>
      </div>
      <div class="student-panels">
        <!-- Send -->
        <section id="stuPanelSend">
          <form id="stuSendForm" class="student-card" style="padding:1rem; box-shadow:none; border:1px solid #e5e7eb;">
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:.75rem;">
              <div>
                <label style="font-weight:600; display:block; margin-bottom:.25rem;">Your Name</label>
                <input id="stuName" class="filter-select" type="text" placeholder="Student full name" required />
              </div>
              <div>
                <label style="font-weight:600; display:block; margin-bottom:.25rem;">Your Email</label>
                <input id="stuEmail" class="filter-select" type="email" placeholder="you@example.com" required />
              </div>
              <div>
                <label style="font-weight:600; display:block; margin-bottom:.25rem;">Program/Degree</label>
                <input id="stuProgram" class="filter-select" type="text" placeholder="Master of Computer Science" required />
              </div>
              <div>
                <label style="font-weight:600; display:block; margin-bottom:.25rem;">Recommender Name</label>
                <input id="recName" class="filter-select" type="text" placeholder="Prof. Jane Smith" required />
              </div>
              <div>
                <label style="font-weight:600; display:block; margin-bottom:.25rem;">Recommender Email</label>
                <input id="recEmail" class="filter-select" type="email" placeholder="jane@university.edu" required />
              </div>
            </div>
            <div style="margin-top:.75rem; display:flex; gap:.5rem; justify-content:flex-end;">
              <button type="reset" class="page-btn">Clear</button>
              <button type="submit" class="apply-btn">Send Request</button>
            </div>
          </form>
        </section>

        <!-- Select -->
        <section id="stuPanelSelect" hidden>
          <div class="university-section">
            <h2 class="section-title"><span class="material-icons">school</span> Select Universities</h2>

            <!-- Search + Apply -->
            <div class="university-search" style="position:relative; display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem;">
              <input
                type="text"
                class="search-input filter-select"
                placeholder="Search universities..."
                id="universitySearch"
                autocomplete="off"
                aria-autocomplete="list"
                aria-expanded="false"
                aria-owns="searchSuggest"
              />
              <button class="apply-btn" id="searchApplyBtn" title="Apply search (Enter)" type="button">Apply</button>
              <div id="searchSuggest" class="suggest-popover" style="display:none;"></div>
            </div>

            <!-- Browse-all dropdown -->
            <select id="universitySelect" class="filter-select" title="Browse all universities" style="margin-bottom:.5rem;">
              <option value="" selected disabled>Browse all universities (6000+)</option>
            </select>

            <!-- Filters -->
            <div class="filter-meta" id="resultMeta" aria-live="polite">Showing 0 of 0</div>
            <div class="filter-bar">
              <select id="stateFilter" class="filter-select" aria-label="Filter by state">
                <option value="">All states</option>
                <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option>
                <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option>
                <option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
                <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option>
                <option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
                <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option>
                <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
                <option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
              </select>

              <select id="typeFilter" class="filter-select" aria-label="Filter by institution type">
                <option value="">All types</option>
                <option value="Public">Public</option>
                <option value="Private nonprofit">Private nonprofit</option>
                <option value="Private for-profit">Private for-profit</option>
              </select>

              <select id="levelFilter" class="filter-select" aria-label="Filter by level">
                <option value="">All levels</option>
                <option value="4-year">4-year</option>
                <option value="2-year">2-year</option>
                <option value="Less-than-2-year">Less-than-2-year</option>
              </select>

              <select id="sortBy" class="filter-select" aria-label="Sort results">
                <option value="name_asc">Sort: Name (A–Z)</option>
                <option value="state_asc">Sort: State (A–Z)</option>
              </select>

              <button class="apply-btn" id="filterApplyBtn" title="Apply filters and sort" type="button">Apply filters</button>
              <button class="apply-btn" id="resetBtn" title="Reset search and filters" type="button">Reset</button>
            </div>

            <!-- Empty state -->
            <div id="emptyState" class="empty-state" aria-live="polite">
              <div style="font-weight:600; margin-bottom:.25rem;">No universities match your filters</div>
              <div style="font-size:.9rem; color:#667;">Try adjusting search or clearing filters.</div>
              <div class="actions">
                <button class="apply-btn" id="clearFiltersBtn" type="button">Clear filters</button>
                <button class="page-btn" id="retryLoadBtn" style="display:none;" type="button">Retry loading</button>
              </div>
            </div>

            <!-- Results grid -->
            <div class="university-grid" id="universityGrid" role="list" aria-label="Universities list"></div>

            <!-- Pagination -->
            <div class="pagination">
              <div class="pager">
                <button class="page-btn" id="prevPage">Prev</button>
                <span id="pageInfo" style="font-weight:600;">Page 1 of 1</span>
                <button class="page-btn" id="nextPage">Next</button>
              </div>
              <div class="page-size">
                <label for="pageSize">Per page:</label>
                <select id="pageSize" class="filter-select" style="width:auto;display:inline-block;">
                  <option value="20">20</option>
                  <option value="40" selected>40</option>
                  <option value="80">80</option>
                  <option value="120">120</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Selected Universities (read-only for Student) -->
          <div class="selected-section">
            <h2 class="section-title" style="display:flex;align-items:center;gap:.5rem;">
              <span class="material-icons">check_circle</span> Selected Universities
            </h2>
            <div class="selected-count" id="selectedCountStu">0 universities selected</div>
            <div class="selected-list" id="selectedListStu" role="list" aria-live="polite"></div>
          </div>
        </section>

        <!-- Track -->
        <section id="stuPanelTrack" hidden>
          <div class="student-card" style="padding:0; overflow:hidden;">
            <table class="table" aria-label="Recommendation requests">
              <thead>
                <tr>
                  <th>Recommender</th>
                  <th>Universities</th>
                  <th>Date Sent</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="stuTrackBody">
                <!-- Populated by code -->
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">
      <p>&copy; 2025 <span style="color: #ffeb3b; font-weight: 600;">StellarRec™</span>. All rights reserved. |
        Making recommendations stellar since 2025 🚀</p>
    </div>
  </footer>
<!-- Vendor scripts (CDN, with cache-busting) -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js?v=2025-09-06" defer></script>
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js?v=2025-09-06" defer></script>

<!-- Optional: your app shell files (kept in case you use them) -->
<script>
/* Minimal Universities Loader (keeps all existing features) */
(function(){
  if (window.__srUniversitiesLoaded) return;
  window.__srUniversitiesLoaded = true;

  const CANDIDATE_URLS = [
    '/assets/us_institutions_by_state_2023.json',           // correct on Netlify when publish dir = public
    './assets/us_institutions_by_state_2023.json',
    'assets/us_institutions_by_state_2023.json'
  ];

  const MOCK = { unitid:'MOCK-0000', name:'Mock University', state:'CA', type:'Private nonprofit', level:'4-year' };

  function fallbackList(){
    // If your old fallback exists, reuse it; otherwise keep at least Mock
    return [MOCK];
  }

  function flattenAndMap(data){
    // Accept either an array of rows or an object keyed by state -> [rows]
    const rows = Array.isArray(data)
      ? data
      : Object.keys(data||{}).flatMap(st => (data[st]||[]).map(r => ({...r, state: r.state || st})));

    const mapped = rows.map((r, i) => ({
      unitid: String(r.unitid ?? r.UNITID ?? r.id ?? `u${i}`),
      name:   r.name   ?? r.INSTNM ?? r.instnm ?? 'Unnamed University',
      state:  r.state  ?? r.STABBR ?? r.state_abbr ?? '',
      type:   r.type   ?? r.SECTOR_DESC ?? r.sector ?? '',
      level:  r.level  ?? r.ICLEVEL_DESC ?? r.level_desc ?? '',
    })).filter(u => u.unitid && u.name);

    // Ensure unique ids
    const seen = new Set();
    const uniq = [];
    for (const u of mapped) { if (!seen.has(u.unitid)) { seen.add(u.unitid); uniq.push(u); } }

    // Ensure Mock University is the very first entry (without duplicates)
    if (!uniq.find(x => x.unitid === MOCK.unitid)) uniq.unshift(MOCK);
    return uniq;
  }

  async function loadOnce(){
    if (Array.isArray(window.universities) && window.universities.length) return;

    let json = null, lastErr = null;
    for (const url of CANDIDATE_URLS) {
      try {
        const res = await fetch(url, { cache: 'force-cache' });
        if (!res.ok) { lastErr = new Error('HTTP ' + res.status); continue; }
        json = await res.json();
        break;
      } catch (e) { lastErr = e; }
    }

    if (!json) {
      console.warn('[SR] Could not fetch universities JSON. Using fallback.', lastErr);
      window.universities = fallbackList();
    } else {
      window.universities = flattenAndMap(json);
    }

    // Make sure Mock University is preselected in both Student and Recommender
    try {
      window.studentUnitIds = new Set([MOCK.unitid, ...(window.studentUnitIds || [])]);
      window.SR = window.SR || {};
      window.SR.selected = new Set([MOCK.unitid, ...(window.SR.selected || [])]);
    } catch {}

    // Optional: build Fuse index if your autosuggest uses it
    if (window.Fuse) {
      window.SR = window.SR || {};
      window.SR.fuse = new Fuse(window.universities, { keys:['name','state'], threshold:0.33, includeScore:true });
    }

    // Nudge any listeners that wait for the data
    window.dispatchEvent(new Event('sr:universities-ready'));
  }

  loadOnce();
})();
</script>

  <script src="/assets/js/university-search.js?v=2025-09-06-1" defer></script>

<!-- Core App Bootstrap (integrated, idempotent) -->
<script>
(function(){
  if (window.__srIntegrated__) return;
  window.__srIntegrated__ = true;

  /* ===== Utilities ===== */
  const $  = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  const tryJSON = (s,d)=>{ try{ return JSON.parse(s); }catch(_){ return d; } };

  /* ===== Toast (idempotent) ===== */
  (function ensureToast(){
    if (typeof window.toast === 'function') return;
    window.toast = function(msg, type='info'){
      const wrap = $('#toastWrap');
      if(!wrap){ alert(msg); return; }
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.innerHTML = `
        <span class="icon material-icons">${type==='success'?'check_circle':type==='error'?'error':'info'}</span>
        <div class="msg">${msg}</div>
        <button class="x" aria-label="Dismiss" type="button">✕</button>
      `;
      el.querySelector('.x').onclick = ()=> el.remove();
      wrap.appendChild(el);
      setTimeout(()=> el.remove(), 3200);
    };
  })();

  /* ===== Persistent state ===== */
  const SR_LS_KEY = 'sr_state_v1';
  const srSafe = {
    get(){ return tryJSON(localStorage.getItem(SR_LS_KEY)||'{}', {}); },
    set(data){ try{ localStorage.setItem(SR_LS_KEY, JSON.stringify(data)); }catch(_){ } }
  };

  /* ===== Global app object ===== */
  window.SR = {
    universities: [],      // master list
    filtered: [],          // filtered results
    page: 1,
    perPage: 40,
    q: '',
    filters: { state:'', type:'', level:'', sort:'name_asc' },
    selected: new Set(),   // Set of unitids
    requests: [],          // for recommender send history
    studentTrack: [],      // student-side mirror
    mockPinned: 'MOCK-0000',
    fuse: null
  };

  /* ===== Normalizer ===== */
  function normalize(arr){
    return arr.map(u=>({
      unitid: String(u.unitid ?? u.UnitID ?? u.id ?? u.code ?? Math.random().toString(36).slice(2,9)),
      name:   String(u.name   ?? u.InstitutionName ?? u.inst_name ?? u.title ?? 'Unnamed Institution'),
      state:  String(u.state  ?? u.State ?? u.province ?? u.region ?? ''),
      type:   String(u.type   ?? u.Sector ?? u.Control ?? 'Public'),
      level:  String(u.level  ?? u.Level ?? u.inst_level ?? '4-year')
    }));
  }

  /* ===== Dataset loaders ===== */
  async function loadFromPublicJSON(){
    // expects array or { "CA": [ ... ], "NY": [ ... ] }
 const url = '/assets/us_institutions_by_state_2023.json';

    const res = await fetch(url, { cache:'force-cache' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.json();

    let flat = [];
    if (Array.isArray(raw)) {
      flat = raw;
    } else if (raw && typeof raw === 'object') {
      for (const [state, list] of Object.entries(raw)) {
        if (Array.isArray(list)){
          list.forEach(d => flat.push({ ...d, state: d.state ?? d.State ?? state }));
        }
      }
    }
    if (flat.length < 1000) throw new Error('Dataset looks too small.');
    return normalize(flat);
  }

  function generateFallback(){
    const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
    const TYPES  = ["Public","Private nonprofit","Private for-profit"];
    const LEVELS = ["4-year","2-year","Less-than-2-year"];
    const list = [];
    let idx = 1;

    const anchors = [
      { name:"Harvard University", state:"MA", type:"Private nonprofit", level:"4-year" },
      { name:"Stanford University", state:"CA", type:"Private nonprofit", level:"4-year" },
      { name:"Massachusetts Institute of Technology", state:"MA", type:"Private nonprofit", level:"4-year" },
      { name:"University of California, Berkeley", state:"CA", type:"Public", level:"4-year" },
      { name:"Georgia Institute of Technology", state:"GA", type:"Public", level:"4-year" }
    ];
    anchors.forEach(a=> list.push({ unitid:String(100000+idx++), ...a }));

    for (; idx<=6500; idx++){
      const st = STATES[idx % STATES.length];
      const tp = TYPES[idx % TYPES.length];
      const lv = LEVELS[idx % LEVELS.length];
      const name = (idx % 7 === 0) ? `${st} State University ${idx}` :
                   (idx % 5 === 0) ? `${st} Institute of Technology ${idx}` :
                                     `University ${idx}`;
      list.push({ unitid:String(100000+idx), name, state:st, type:tp, level:lv });
    }
    return normalize(list);
  }

  /* ===== Dataset bootstrap ===== */
  async function ensureDataset(){
    if (Array.isArray(window.universities) && window.universities.length){
      SR.universities = normalize(window.universities);
    } else {
      try {
        SR.universities = await loadFromPublicJSON();
      } catch (err){
        console.warn('[SR] Falling back to generated dataset:', err);
        SR.universities = generateFallback();
      }
    }

    // Ensure mock pinned record exists
    if (!SR.universities.find(u=>u.unitid===SR.mockPinned)){
      SR.universities.unshift({ unitid:SR.mockPinned, name:"Mock University", state:"CA", type:"Private nonprofit", level:"4-year" });
    }

    // Build Fuse index
    SR.fuse = new Fuse(SR.universities, { keys:['name'], includeScore:false, threshold:0.3, minMatchCharLength:2 });

    // Restore persisted
    const saved = srSafe.get();
    if (Array.isArray(saved.requests)) SR.requests = saved.requests;
    if (Array.isArray(saved.studentTrack)) SR.studentTrack = saved.studentTrack;
    const selected = new Set(Array.isArray(saved.selectedIds) ? saved.selectedIds : []);
    selected.add(SR.mockPinned);
    SR.selected = selected;

    SR.filtered = SR.universities.slice(0);
  }

  /* ===== Persistence helper ===== */
  function persist(){
    srSafe.set({
      selectedIds: Array.from(SR.selected),
      requests: SR.requests,
      studentTrack: SR.studentTrack
    });
  }

  /* ===== UI helpers (stubs will be filled later) ===== */
  window.updateSelectedList = function(){
    const list = $('#selectedList');
    const listStu = $('#selectedListStu');
    const countEl = $('#selectedCount');
    const countStu = $('#selectedCountStu');
    if (!list || !countEl) return;

    const items = SR.universities.filter(u=> SR.selected.has(u.unitid));
    list.innerHTML = items.map(u=>`
      <span class="selected-tag" data-id="${u.unitid}">
        ${u.name} <span class="remove-tag" title="Remove" aria-label="Remove" data-remove="${u.unitid}">✕</span>
      </span>`).join('');
    if (listStu){
      listStu.innerHTML = list.innerHTML; // read-only copy for student
      listStu.querySelectorAll('[data-remove]').forEach(el=> el.remove()); // ensure no removes in student
    }

    const n = items.length;
    countEl.textContent  = `${n} universit${n===1?'y':'ies'} selected`;
    if (countStu) countStu.textContent = countEl.textContent;

    // bind removes (recommender only)
    list.querySelectorAll('[data-remove]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        SR.selected.delete(btn.dataset.remove);
        updateSelectedList(); updateSendButton(); persist();
      });
    });
  };

  window.updateSendButton = function(){
    const btn = $('#sendBtn');
    if (!btn) return;
    const hasSomething = SR.selected.size > 0;
    btn.disabled = !hasSomething;
  };

  /* ===== Filters, paging, grid rendering ===== */
  function applyFilters(){
    // text query
    const q = SR.q.trim();
    let base = SR.universities;

    if (q.length >= 2 && SR.fuse){
      const hits = SR.fuse.search(q).slice(0, 1000).map(h=>h.item);
      base = hits;
    }

    // structured filters
    const { state, type, level } = SR.filters;
    let out = base.filter(u =>
      (!state || u.state === state) &&
      (!type  || u.type  === type)  &&
      (!level || u.level === level)
    );

    // sort
    const s = SR.filters.sort || 'name_asc';
    if (s === 'name_asc') {
      out.sort((a,b)=> a.name.localeCompare(b.name));
    } else if (s === 'state_asc'){
      out.sort((a,b)=> a.state.localeCompare(b.state) || a.name.localeCompare(b.name));
    }

    SR.filtered = out;
    SR.page = 1;
    renderGrid();
    updateResultMeta();
    updateSendButton();
  }

  function updateResultMeta(){
    const meta = $('#resultMeta');
    if (!meta) return;
    meta.textContent = `Showing ${Math.min(SR.filtered.length, SR.perPage)} of ${SR.filtered.length}`;
  }

  function renderGrid(){
    const grid = $('#universityGrid');
    const pageInfo = $('#pageInfo');
    const prev = $('#prevPage');
    const next = $('#nextPage');
    if (!grid) return;

    const total = SR.filtered.length;
    const pages = Math.max(1, Math.ceil(total / SR.perPage));
    SR.page = Math.min(SR.page, pages);

    const start = (SR.page - 1) * SR.perPage;
    const slice = SR.filtered.slice(start, start + SR.perPage);

    grid.innerHTML = slice.map(u=>`
      <div class="university-card ${SR.selected.has(u.unitid)?'selected':''}" data-id="${u.unitid}">
        <div class="university-header">
          <div class="university-logo">${(u.name[0]||'#')}</div>
          <div>
            <div class="university-name">${u.name}</div>
            <div class="university-location">${u.state || '—'} • ${u.type}</div>
            <span class="university-pill">${u.level}</span>
          </div>
          <button class="apply-btn" style="margin-left:auto" data-apply="${u.unitid}">Apply</button>
        </div>
      </div>
    `).join('');

    if (pageInfo) pageInfo.textContent = `Page ${SR.page} of ${pages}`;
    if (prev) prev.disabled = SR.page<=1;
    if (next) next.disabled = SR.page>=pages;

    // delegation: apply buttons & card toggle
    grid.addEventListener('click', onGridClick, { once:true });
  }

  function onGridClick(e){
    const t = e.target;
    // Apply button toggles selection
    if (t && t.matches('[data-apply]')){
      const id = t.getAttribute('data-apply');
      toggleSelect(id);
      return;
    }
    // Card click also toggles (unless clicking button)
    const card = t.closest && t.closest('.university-card');
    if (card && !t.matches('button')){
      const id = card.getAttribute('data-id');
      toggleSelect(id);
    }
  }

  function toggleSelect(id){
    const had = SR.selected.has(id);
    if (had) SR.selected.delete(id);
    else SR.selected.add(id);
    updateSelectedList(); renderGrid(); updateSendButton(); persist();
  }

  /* ===== Populate dropdown ===== */
  function populateBrowseDropdown(){
    const sel = $('#universitySelect');
    if (!sel) return;
    const opts = ['<option value="" selected disabled>Browse all universities (6000+)</option>']
      .concat(SR.universities.slice(0, 2000).map(u=> `<option value="${u.unitid}">${u.name} (${u.state})</option>`)); // cap for perf
    sel.innerHTML = opts.join('');
    sel.addEventListener('change', ()=>{
      const id = sel.value;
      if (id){
        SR.selected.add(id);
        updateSelectedList(); updateSendButton(); persist();
      }
      sel.value = '';
    });
  }

  /* ===== Autosuggest ===== */
  function bindSearchSuggest(){
    const input = $('#universitySearch');
    const pop   = $('#searchSuggest');
    if (!input || !pop) return;

    function hide(){ pop.style.display='none'; input.setAttribute('aria-expanded','false'); }
    function show(){ pop.style.display='block'; input.setAttribute('aria-expanded','true'); }

    input.addEventListener('input', ()=>{
      const q = input.value.trim();
      SR.q = q;
      if (q.length < 2){ hide(); return; }
      const hits = SR.fuse.search(q).slice(0, 8).map(h=>h.item);
      pop.innerHTML = hits.map(u=>`
        <div class="suggest-item" data-id="${u.unitid}">
          <span>${u.name}</span><small>${u.state || '—'}</small>
        </div>`).join('');
      if (hits.length){ show(); } else { hide(); }
    });

    pop.addEventListener('click', (e)=>{
      const el = e.target.closest('.suggest-item');
      if (!el) return;
      const id = el.getAttribute('data-id');
      SR.selected.add(id);
      input.value = '';
      SR.q = '';
      hide(); updateSelectedList(); updateSendButton(); persist();
    });

    document.addEventListener('click', (e)=>{
      if (!pop.contains(e.target) && !input.contains(e.target)) hide();
    });

    $('#searchApplyBtn')?.addEventListener('click', ()=>{ applyFilters(); hide(); });
  }

  /* ===== Filters & paging bindings ===== */
  function bindFilterControls(){
    const state = $('#stateFilter');
    const type  = $('#typeFilter');
    const level = $('#levelFilter');
    const sort  = $('#sortBy');
    const apply = $('#filterApplyBtn');
    const reset = $('#resetBtn');
    const pageSize = $('#pageSize');
    const prev = $('#prevPage');
    const next = $('#nextPage');
    const clearFiltersBtn = $('#clearFiltersBtn');

    state?.addEventListener('change', e=> SR.filters.state = e.target.value);
    type ?.addEventListener('change', e=> SR.filters.type  = e.target.value);
    level?.addEventListener('change', e=> SR.filters.level = e.target.value);
    sort ?.addEventListener('change', e=> SR.filters.sort  = e.target.value);
    pageSize?.addEventListener('change', e=> { SR.perPage = parseInt(e.target.value||'40',10); renderGrid(); updateResultMeta(); });

    apply?.addEventListener('click', applyFilters);
    reset?.addEventListener('click', ()=>{
      SR.q=''; SR.filters={ state:'', type:'', level:'', sort:'name_asc' };
      $('#universitySearch').value=''; state.value=''; type.value=''; level.value=''; sort.value='name_asc';
      applyFilters();
    });
    clearFiltersBtn?.addEventListener('click', ()=>{
      SR.q=''; SR.filters={ state:'', type:'', level:'', sort:'name_asc' };
      $('#universitySearch').value=''; state.value=''; type.value=''; level.value=''; sort.value='name_asc';
      applyFilters();
    });

    prev?.addEventListener('click', ()=>{ if (SR.page>1){ SR.page--; renderGrid(); updateResultMeta(); } });
    next?.addEventListener('click', ()=>{ const pages=Math.max(1,Math.ceil(SR.filtered.length/SR.perPage)); if (SR.page<pages){ SR.page++; renderGrid(); updateResultMeta(); } });
  }

  /* ===== Copy link (share) ===== */
  function bindCopyLink(){
    const btn = $('#copyLinkBtn');
    btn?.addEventListener('click', async ()=>{
      try{
        const ids = Array.from(SR.selected).filter(x=>x!==SR.mockPinned);
        const url = new URL(location.href);
        url.search = '';
        url.hash = '';
        url.pathname = '/reco';
        url.searchParams.set('unis', ids.join(','));
        await navigator.clipboard.writeText(url.toString());
        toast('Shareable link copied!', 'success');
      }catch(_){ toast('Could not copy link.', 'error'); }
    });
  }

  /* ===== Student: send request form ===== */
  function bindStudentSend(){
    // Backend integration is now handled by the dedicated script block
    // This function is kept for compatibility but the actual form handling
    // is done by the backend integration script
    console.log('Student send form binding - handled by backend integration script');
  }

  /* ===== Student tracking table render ===== */
  /* ===== Enhanced Student tracking table render ===== */
  window.renderStudentTrack = function(){
    const body = $('#stuTrackBody');
    if (!body) return;
    if (!SR.studentTrack.length){
      body.innerHTML = `
        <tr>
          <td colspan="4" style="color:#667; text-align:center; padding:2rem;">
            <div style="font-size:1.1rem; margin-bottom:0.5rem;">📋 No recommendation requests yet</div>
            <div style="font-size:0.9rem;">Submit a request in the "Send Recommendation Request" tab to get started!</div>
          </td>
        </tr>`;
      return;
    }
    
    body.innerHTML = SR.studentTrack.map(r=>{
      const statusClass = r.status === 'sent' ? 'sent' : 
                         r.status === 'received' ? 'received' : 
                         r.status === 'failed' ? 'error' : 
                         r.status === 'testing' ? 'testing' : 'pending';
      
      const statusText = r.status === 'sent' ? '✅ Sent' :
                        r.status === 'received' ? '📨 Received' :
                        r.status === 'failed' ? '❌ Failed' : 
                        r.status === 'testing' ? '🧪 Testing Mode' : '⏳ Pending';
      
      const universitiesText = r.universities && r.universities.length > 0 ? 
        r.universities.slice(0, 2).join(', ') + (r.universities.length > 2 ? ` +${r.universities.length - 2} more` : '') :
        'Mock University';
      
      const timeAgo = r.ts ? getTimeAgo(r.ts) : '—';
      
      return `
        <tr style="border-left: 3px solid ${statusClass === 'sent' ? '#4caf50' : statusClass === 'failed' ? '#f44336' : statusClass === 'testing' ? '#2196f3' : '#ff9800'};">
          <td>
            <div style="font-weight:600;">${r.who || '—'}</div>
            <div style="font-size:0.85rem; color:#666; margin-top:0.2rem;">${r.email || '—'}</div>
            ${r.note ? `<div style="font-size:0.8rem;color:#2196f3;margin-top:4px;">ℹ️ ${r.note}</div>` : ''}
          </td>
          <td>
            <div style="font-size:0.9rem;">${universitiesText}</div>
            ${r.studentName ? `<div style="font-size:0.8rem; color:#666; margin-top:0.2rem;">For: ${r.studentName}</div>` : ''}
          </td>
          <td>
            <div>${r.ts ? new Date(r.ts).toLocaleDateString() : '—'}</div>
            <div style="font-size:0.8rem; color:#666;">${timeAgo}</div>
          </td>
          <td>
            <span class="track-pill ${statusClass}" style="display:inline-flex; align-items:center; gap:0.3rem;">
              ${statusText}
            </span>
            ${r.error ? `<div style="font-size:0.75rem; color:#f44336; margin-top:0.3rem;">${r.error}</div>` : ''}
          </td>
        </tr>
      `;
    }).join('');
  };
  
  // Helper function for time ago display
  function getTimeAgo(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
    if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    return 'Just now';
  }

  /* ===== Recommender send flow (modal + progress) ===== */
  function bindRecommenderSend(){
    const btn = $('#sendBtn');
    if (!btn) return;
    const modal = $('#confirmModal');
    const closeX = $('#modalCloseBtn');
    const cancel = $('#modalCancelBtn');
    const confirm= $('#modalConfirmBtn');

    function openModal(){
      // build summary/added/removed based on student vs current (stub: assume student had none)
      const selectedItems = SR.universities.filter(u=> SR.selected.has(u.unitid));
      $('#modalIncluded').innerHTML = selectedItems.map(u=> `<div>• ${u.name} (${u.state})</div>`).join('');
      $('#modalIncludedCount').textContent = String(selectedItems.length);
      $('#modalRemoved').innerHTML = `<em>None</em>`;
      $('#modalRemovedCount').textContent = '0';
      $('#modalAdded').innerHTML = `<em>All current are additions</em>`;
      $('#modalAddedCount').textContent = String(selectedItems.length);
      $('#modalSummary').innerHTML = `You’re about to send your letter to <b>${selectedItems.length}</b> universit${selectedItems.length===1?'y':'ies'}.`;
      modal.style.display = 'flex';
    }
    function closeModal(){ modal.style.display = 'none'; }

    btn.addEventListener('click', ()=>{
      if (btn.disabled) return;
      openModal();
    });
    closeX?.addEventListener('click', closeModal);
    cancel?.addEventListener('click', closeModal);

    confirm?.addEventListener('click', ()=>{
      closeModal();
      startProgressSend();
    });
  }

  function startProgressSend(){
    const section = $('#progressSection');
    const fill = $('#progressFill');
    const text = $('#progressText');
    const list = $('#deliveryList');
    const success = $('#successSection');

    section.style.display = 'block';
    fill.style.width = '0%';
    list.innerHTML = '';
    success.style.display = 'none';

    const items = SR.universities.filter(u=> SR.selected.has(u.unitid));
    let done = 0;

    function step(){
      if (done >= items.length){
        fill.style.width = '100%';
        text.textContent = 'Done.';
        setTimeout(()=>{
          section.style.display = 'none';
          success.style.display = 'block';
          toast('Letters sent (stub).', 'success');
        }, 500);
        return;
      }
      const u = items[done++];
      // simulate sending
      const row = document.createElement('div');
      row.className = 'delivery-item';
      row.innerHTML = `<div class="delivery-status pending">…</div><div>${u.name} (${u.state})</div>`;
      list.appendChild(row);
      fill.style.width = `${Math.floor((done/items.length)*100)}%`;
      text.textContent = `Sending to ${u.name}… (${done}/${items.length})`;
      setTimeout(()=>{
        row.querySelector('.delivery-status').className = 'delivery-status success';
        row.querySelector('.delivery-status').textContent = '✓';
        step();
      }, 180);
    }
    step();
  }

  /* ===== Intake link parsing & apply ===== */
  function bindLinkIntake(){
    const els = {
      input:  $('#linkInput'),
      parse:  $('#linkParseBtn'),
      status: $('#linkStatus'),
      sum:    $('#linkSummary'),
      help:   $('#linkHelpBtn'),
    };
    function setStatus(msg, type='info'){
      const color = type==='error' ? '#b91c1c' : type==='success' ? '#166534' : '#334155';
      if (els.status) els.status.innerHTML = `<span style="color:${color}">${msg}</span>`;
    }
    function summarize(data, matchedCount){
      const lines = [];
      const full = [data.studentFirst, data.studentLast].filter(Boolean).join(' ');
      if (full) lines.push(`<div><b>Student</b>: ${full}</div>`);
      if (data.studentEmail || data.studentPhone){
        lines.push(`<div><b>Contact</b>: ${[data.studentEmail, data.studentPhone].filter(Boolean).join(' • ')}</div>`);
      }
      if (typeof data.waiveAccess !== 'undefined'){
        lines.push(`<div><b>Waive access</b>: ${data.waiveAccess?'<span class="ok">Yes</span>':'No'}</div>`);
      }
      if (data.recommenderName || data.recommenderEmail || data.recommenderPhone){
        lines.push(`<div><b>Recommender</b>: ${[data.recommenderName, data.recommenderEmail, data.recommenderPhone].filter(Boolean).join(' • ')}</div>`);
      }
      if (Array.isArray(data.unitids) && data.unitids.length){
        lines.push(`<div><b>Universities (unitids)</b>: ${data.unitids.length} <span class="${matchedCount>0?'ok':'warn'}">(matched ${matchedCount})</span></div>`);
      } else if (Array.isArray(data.unames) && data.unames.length){
        lines.push(`<div><b>Universities (by name)</b>: ${data.unames.length} (will match)</div>`);
      }
      els.sum.innerHTML = lines.join('') || '<div class="muted">No details found.</div>';
      els.sum.hidden = false;
    }
    function parseLink(raw){
      try{
        const url = new URL(raw);
        const q = url.searchParams;
        const data = {
          studentFirst:   q.get('sf') || q.get('sfn') || '',
          studentLast:    q.get('sl') || q.get('sln') || '',
          studentEmail:   q.get('se') || q.get('semail') || '',
          studentPhone:   q.get('sp') || q.get('sphone') || '',
          waiveAccess:    (q.get('waive') === '1' || q.get('waive') === 'true'),
          recommenderName: q.get('rname') || '',
          recommenderEmail: q.get('remail') || '',
          recommenderPhone: q.get('rphone') || '',
          unitids: [],
          unames: [],
        };
        const unis = q.get('unis');   if (unis)   data.unitids = unis.split(',').map(s=>s.trim()).filter(Boolean);
        const unames= q.get('unames'); if (unames) data.unames = unames.split(',').map(s=>s.trim()).filter(Boolean);
        return data;
      }catch(_){ return null; }
    }
    async function applyReferralData(data){
      let matched = 0;
      // Prefer unitids
      if (Array.isArray(data.unitids) && data.unitids.length){
        const master = new Set(SR.universities.map(u=> String(u.unitid)));
        data.unitids.forEach(id=>{
          const key = String(id);
          if (master.has(key)){ SR.selected.add(key); matched++; }
        });
      }
      // Fallback: fuzzy by names
      if ((!data.unitids || !data.unitids.length) && Array.isArray(data.unames) && data.unames.length){
        const want = data.unames.map(s=> s.toLowerCase());
        SR.universities.forEach(u=>{
          if (want.some(w => u.name.toLowerCase().includes(w))){ SR.selected.add(u.unitid); matched++; }
        });
      }
      // always keep Mock pinned
      SR.selected.add(SR.mockPinned);
      updateSelectedList(); updateSendButton(); persist();
      return matched;
    }
    async function handleImport(){
      const raw = (els.input?.value || '').trim();
      if (!raw){ setStatus('Please paste a link first.','error'); return; }
      const data = parseLink(raw);
      if (!data){ setStatus('That doesn’t look like a valid link.','error'); return; }
      setStatus('Parsing link and applying data…');
      const matched = await applyReferralData(data);
      summarize(data, matched);
      const full = [data.studentFirst, data.studentLast].filter(Boolean).join(' ');
      if (full) { const t = $('#writerTitle'); if (t) t.value = `Recommendation for ${full}`; }
      toast(`Imported ${matched} universit${matched===1?'y':'ies'} from the link.`, matched?'success':'info');
      setStatus('Link imported successfully.','success');

      // Switch to Recommender view
      const recPanel = $('#panel-recommender'); const stuPanel = $('#panel-student');
      if (recPanel && stuPanel){
        stuPanel.hidden = true; recPanel.hidden = false;
        recPanel.style.display = ''; stuPanel.style.display = 'none';
        document.querySelectorAll('.header-nav .nav-link').forEach(b=>{
          const on = b.dataset.view === 'recommender';
          b.setAttribute('aria-selected', on?'true':'false');
          if (on) b.setAttribute('aria-current','page'); else b.removeAttribute('aria-current');
        });
        
        // Hide any bulk import elements that might be spilling over
        document.querySelectorAll('[data-action="bulk-import"], .bulk-import-btn, button[title*="Bulk"], button[title*="Import"]').forEach(el => {
          if (el.closest('#panel-recommender')) {
            el.style.display = 'none';
          }
        });
        
        try{ localStorage.setItem('sr_current_view','recommender'); }catch(_){}
        history.replaceState(null,'','#recommender');
      }
    }
    els.help?.addEventListener('click', ()=>{
      const det = $('#linkFormatDetails');
      if (det){ det.open = true; det.scrollIntoView({ behavior:'smooth', block:'nearest' }); }
    });
    els.parse?.addEventListener('click', handleImport);
    els.input?.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); handleImport(); } });
  }

  /* ===== Header: view toggles + theme ===== */
  function bindHeader(){
    const studentPanel = $('#panel-student');
    const recPanel     = $('#panel-recommender');
    const toggles      = $$('.header-nav .nav-link');
    const themeBtn     = $('#headerThemeBtn');

    function setActive(view){
      const isStudent = (view==='student');
      studentPanel.hidden = !isStudent;
      recPanel.hidden     =  isStudent;
      studentPanel.style.display = isStudent ? '' : 'none';
      recPanel.style.display     = isStudent ? 'none' : '';
      toggles.forEach(btn=>{
        const on = btn.dataset.view === view;
        btn.setAttribute('aria-selected', on?'true':'false');
        if (on) btn.setAttribute('aria-current','page'); else btn.removeAttribute('aria-current');
      });
      try { localStorage.setItem('sr_current_view', view); }catch(_){}
      history.replaceState(null,'','#'+view);
    }

    toggles.forEach(btn=> btn.addEventListener('click', ()=> setActive(btn.dataset.view)));
    const fromHash = (location.hash||'').slice(1);
    const saved    = localStorage.getItem('sr_current_view') || 'student';
    const initial  = (fromHash==='recommender'||fromHash==='student') ? fromHash : saved;
    setActive(initial);
    
    // Handle URL with query params like ?#send
    if (location.search && location.hash) {
      const cleanHash = location.hash.slice(1);
      if (cleanHash === 'send' || cleanHash === 'select' || cleanHash === 'track') {
        setActive('student'); // Ensure we're in student view for student tabs
      }
    }

    // Theme
    if (themeBtn){
      themeBtn.addEventListener('click', ()=>{
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme')==='dark';
        root.setAttribute('data-theme', isDark?'light':'dark');
        themeBtn.setAttribute('aria-pressed', isDark?'false':'true');
        try{ localStorage.setItem('sr_theme', isDark?'light':'dark'); }catch(_){}
      });
      const t = localStorage.getItem('sr_theme');
      if (t==='dark'||t==='light'){
        document.documentElement.setAttribute('data-theme', t);
        themeBtn.setAttribute('aria-pressed', t==='dark' ? 'true' : 'false');
      }
    }
  }

  /* ===== Writer: toolbar + meta + persistence ===== */
  function bindWriter(){
    const box   = $('#writerBox');
    const title = $('#writerTitle');
    const savedEl = $('#writerSaved');
    if (!box) return;
    const LSKEY = 'sr_writer_draft_v2';

    // Guidance card (mount once)
    (function mountGuide(){
      if ($('#writerGuide')) return;
      const guide = document.createElement('div');
      guide.id = 'writerGuide';
      guide.className = 'writer-guide';
      guide.innerHTML = `
        <b>Prompt guidance (please include specific examples & anecdotes):</b>
        <ul>
          <li><b>Your relationship</b> with the applicant (capacity, duration, context).</li>
          <li><b>Strengths & weaknesses</b> with concrete cases that illustrate both.</li>
          <li><b>Performance vs. peers</b> (quantify if possible; top % or comparative outcomes).</li>
          <li><b>Potential for growth</b> and readiness for the program’s rigor.</li>
          <li><b>Qualities as a person</b> (integrity, leadership, resilience, collaboration), with stories.</li>
        </ul>`;
      const writerSection = $('#writerSection') || box.parentElement;
      writerSection?.insertBefore(guide, writerSection.querySelector('.writer-actions') || box.nextSibling);
      const toggle = ()=>{
        const hasText = (box.innerText||'').trim().length > 0 || !!box.querySelector('img,table,ul,ol,blockquote,pre');
        guide.style.display = hasText ? 'none' : 'block';
      };
      ['input','keyup','paste','cut','blur','DOMSubtreeModified'].forEach(ev=> box.addEventListener(ev, toggle));
      toggle();
    })();

    function refreshMeta(){
      const text = box.innerText || '';
      const words = (text.trim().match(/\S+/g)||[]).length;
      const chars = text.length;
      $('#writerCount').textContent = `${words} words • ${chars} chars`;
    }
    function exec(cmd){
      box.focus({ preventScroll:true });
      document.execCommand(cmd, false, null);
      refreshMeta();
    }
    $$('[data-wcmd]').forEach(btn=>{
      if (!btn.__srExec){
        btn.__srExec = true;
        btn.addEventListener('click', ()=> exec(btn.getAttribute('data-wcmd')));
      }
    });
    ['input','keyup','paste','cut'].forEach(ev=> box.addEventListener(ev, refreshMeta));
    refreshMeta();

    function setSaved(s){ if (savedEl) savedEl.textContent = s; }

    $('#saveDraftBtn')?.addEventListener('click', ()=>{
      try{
        const payload = { title: title?.value || '', html: box.innerHTML };
        localStorage.setItem(LSKEY, JSON.stringify(payload));
        setSaved('Saved'); toast('Draft saved.','success');
      }catch(_){ toast('Could not save locally.','error'); }
    });
    $('#restoreDraftBtn')?.addEventListener('click', ()=>{
      try{
        const raw = localStorage.getItem(LSKEY);
        if (!raw){ toast('No saved draft found.','info'); return; }
        const data = JSON.parse(raw);
        if (title) title.value = data.title || '';
        box.innerHTML = data.html || '';
        setSaved('Restored'); refreshMeta();
      }catch(_){ toast('Could not restore draft.','error'); }
    });
    $('#clearDraftBtn')?.addEventListener('click', ()=>{ box.innerHTML=''; refreshMeta(); setSaved('Cleared'); });
    $('#copyDraftBtn')?.addEventListener('click', async ()=>{
      try{ const tmp = document.createElement('div'); tmp.innerHTML = box.innerHTML;
        await navigator.clipboard.writeText(tmp.innerText); setSaved('Copied'); toast('Plain text copied.','success');
      }catch(_){ toast('Copy failed.','error'); }
    });
    $('#downloadDraftBtn')?.addEventListener('click', ()=>{
      const text = (title?.value ? title.value+'\n\n' : '') + (box.innerText||'');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
      a.download = 'recommendation-letter.txt';
      a.click(); setSaved('Downloaded');
    });
    $('#attachDraftBtn')?.addEventListener('click', ()=>{
      try{
        const payload = { title: title?.value || '', html: box.innerHTML, ts: Date.now() };
        localStorage.setItem('sr_attached_draft', JSON.stringify(payload));
        setSaved('Attached'); toast('Draft attached to this send session.','success');
      }catch(_){ toast('Attach failed.','error'); }
    });
  }

  /* ===== Uploads (PDF + Video) ===== */
  function bindUploads(){
    // PDF
    const choose = $('#chooseFileBtn'), file = $('#fileInput'),
          box = $('#uploadedFile'), name = $('#fileName'), size = $('#fileSize'), remove = $('#removeFileBtn');
    choose?.addEventListener('click', ()=> file?.click());
    file?.addEventListener('change', ()=>{
      const f = file.files?.[0]; if (!f) return;
      name.textContent = f.name; size.textContent = `${(f.size/1024/1024).toFixed(2)} MB`;
      box.style.display = 'block'; toast('PDF attached.','success');
    });
    remove?.addEventListener('click', ()=>{ file.value=''; box.style.display='none'; });

    // Video
    const chooseV = $('#chooseVideoBtn'), video = $('#videoInput'),
          boxV = $('#uploadedVideo'), nameV = $('#videoName'), sizeV = $('#videoSize'),
          removeV = $('#removeVideoBtn'), prevV = $('#videoPreview');
    chooseV?.addEventListener('click', ()=> video?.click());
    video?.addEventListener('change', ()=>{
      const f = video.files?.[0]; if (!f) return;
      nameV.textContent = f.name; sizeV.textContent = `${(f.size/1024/1024).toFixed(2)} MB`;
      boxV.style.display = 'block';
      try{ prevV.src = URL.createObjectURL(f); prevV.style.display='block'; }catch(_){}
    });
    removeV?.addEventListener('click', ()=>{
      video.value=''; boxV.style.display='none'; prevV.removeAttribute('src'); prevV.style.display='none';
    });
  }

  /* ===== Contact Admin overlay ===== */
  function bindContactOverlay(){
    const overlay = $('#contactOverlay');
    const openBtn = $('#contactAdminItem');
    const closeBtn1 = $('#contactCloseBtn2');
    const closeBtn2 = $('#contactCancelBtn2');
    openBtn?.addEventListener('click', ()=>{ overlay.style.display='flex'; requestAnimationFrame(()=>{
      const panel = overlay.querySelector('div[style*="transform"]');
      if (panel){ panel.style.opacity = 1; }
    });});
    closeBtn1?.addEventListener('click', ()=> overlay.style.display='none');
    closeBtn2?.addEventListener('click', ()=> overlay.style.display='none');
    overlay?.addEventListener('click', (e)=>{ if (e.target===overlay) overlay.style.display='none'; });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && overlay?.style.display==='flex') overlay.style.display='none'; });

    $('#contactForm2')?.addEventListener('submit', (e)=>{
      e.preventDefault(); overlay.style.display='none'; toast('Message sent to admin.','success');
    });

    // Avatar click: open dropdown & highlight Contact admin
    const avatar = $('#userAvatarBtn'); const dropdown = $('#userDropdown');
    avatar?.addEventListener('click', ()=>{
      dropdown?.classList.add('show'); avatar.setAttribute('aria-expanded','true');
      const item = $('#contactAdminItem');
      if (dropdown && item){
        dropdown.classList.add('sr-highlight');
        setTimeout(()=> dropdown.classList.remove('sr-highlight'), 900);
        item.scrollIntoView({ behavior:'smooth', block:'center' });
      }
    });
  }

  /* ===== Send button pulse ===== */
  function bindSendPulse(){
    function pulseSendBtn(flash=false){
      const btn = $('#sendBtn'); if (!btn) return;
      btn.classList.remove('sr-flash', 'sr-pulse');
      if (!btn.disabled){
        if (flash) btn.classList.add('sr-flash');
        btn.classList.add('sr-pulse');
      }
    }
    const btn = $('#sendBtn');
    if (!btn) return;
    setTimeout(()=> pulseSendBtn(false), 50);
    const grid = $('#universityGrid');
    grid?.addEventListener('click', (e)=>{
      const t = e.target;
      if (t && t.classList && t.classList.contains('apply-btn')){
        setTimeout(()=> pulseSendBtn(true), 120);
      }
    });
    const obs = new MutationObserver(()=> pulseSendBtn(true));
    obs.observe(btn, { attributes:true, attributeFilter:['disabled'] });
  }

  /* ===== Page init ===== */
  document.addEventListener('DOMContentLoaded', async ()=>{
    await ensureDataset();

    populateBrowseDropdown();
    bindSearchSuggest();
    bindFilterControls();
    bindCopyLink();
    bindStudentSend();
    bindRecommenderSend();
    bindUploads();
    bindContactOverlay();
    bindHeader();
    bindWriter();
    bindSendPulse();

    applyFilters();
    updateSelectedList();
    updateSendButton();

    // Ensure Mock is pre-selected and persisted
    SR.selected.add(SR.mockPinned);
    persist();
  });
})();
  </script>
  <script>
document.addEventListener('DOMContentLoaded', function(){
  // --- Recommender: hide intake & tighten hero spacing ---
  (function(){
    if (window.__srCompactBound) return; window.__srCompactBound = true;

    function applyRecommenderCompact(){
      const isRec = (location.hash.replace('#','') === 'recommender');
      const panel = document.getElementById('panel-recommender');
      const intake= document.getElementById('linkIntake');
      if (!panel) return;

      if (isRec) {
        // add compact class (CSS above will hide the intake & pull hero up)
        panel.classList.add('is-compact');
        // remove the card from DOM so it doesn't take up space/accessibility focus
        if (intake) { try { intake.remove(); } catch{} }
      } else {
        panel.classList.remove('is-compact'); // no change to student view
      }
    }

    // Apply on load and when hash changes (if user switches tabs via URL)
    applyRecommenderCompact();
    window.addEventListener('hashchange', applyRecommenderCompact);
  })();
});
</script>
<!-- Extra protective hotfix block (no-op if already bound; keeps features resilient) -->
<script>
(function(){
  if (window.__srHotfix__) return;
  window.__srHotfix__ = true;

  const $  = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));

  // Close search suggest when clicking outside (extra guard)
  (function(){
    const pop = $('#searchSuggest'); const input = $('#universitySearch');
    if (!pop || !input) return;
    if (pop.__srBound) return; pop.__srBound = true;
    document.addEventListener('click', (e)=>{
      if (!pop.contains(e.target) && !input.contains(e.target)){
        pop.style.display = 'none';
        input.setAttribute('aria-expanded','false');
      }
    });
  })();

  // Ensure theme button state reflects localStorage on late load
  (function(){
    const themeBtn = $('#headerThemeBtn');
    const t = localStorage.getItem('sr_theme');
    if (themeBtn) {
      if (t==='dark'||t==='light'){
        document.documentElement.setAttribute('data-theme', t);
        themeBtn.setAttribute('aria-pressed', t==='dark' ? 'true' : 'false');
      }
      // Ensure theme button is visible and functional
      themeBtn.style.display = 'inline-flex';
      
      // Add click handler if not already bound
      if (!themeBtn.hasAttribute('data-theme-bound')) {
        themeBtn.setAttribute('data-theme-bound', 'true');
        themeBtn.addEventListener('click', ()=>{
          const root = document.documentElement;
          const isDark = root.getAttribute('data-theme')==='dark';
          const newTheme = isDark ? 'light' : 'dark';
          root.setAttribute('data-theme', newTheme);
          themeBtn.setAttribute('aria-pressed', newTheme === 'dark' ? 'true' : 'false');
          try{ localStorage.setItem('sr_theme', newTheme); }catch(_){}
        });
      }
    }
  })();

  // Ensure Student/Recommender toggle works properly
  (function(){
    const studentPanel = document.getElementById('panel-student');
    const recPanel = document.getElementById('panel-recommender');
    const toggles = document.querySelectorAll('.header-nav .nav-link');
    
    if (studentPanel && recPanel && toggles.length > 0) {
      toggles.forEach(btn => {
        if (!btn.hasAttribute('data-toggle-bound')) {
          btn.setAttribute('data-toggle-bound', 'true');
          btn.addEventListener('click', () => {
            const view = btn.dataset.view;
            const isStudent = (view === 'student');
            
            // Update panels
            studentPanel.hidden = !isStudent;
            recPanel.hidden = isStudent;
            studentPanel.style.display = isStudent ? '' : 'none';
            recPanel.style.display = isStudent ? 'none' : '';
            
            // Update toggle states
            toggles.forEach(toggle => {
              const on = toggle.dataset.view === view;
              toggle.setAttribute('aria-selected', on ? 'true' : 'false');
              if (on) toggle.setAttribute('aria-current', 'page'); 
              else toggle.removeAttribute('aria-current');
            });
            
            // Save state
            try { 
              localStorage.setItem('sr_current_view', view); 
              history.replaceState(null, '', '#' + view);
            } catch(_) {}
          });
        }
      });
    }
  })();

  // Keyboard: Escape closes overlays & suggest
  (function(){
    document.addEventListener('keydown', (e)=>{
      if (e.key!=='Escape') return;
      const contactOverlay = $('#contactOverlay');
      if (contactOverlay?.style.display==='flex'){ contactOverlay.style.display='none'; }
      const suggest = $('#searchSuggest'); const input = $('#universitySearch');
      if (suggest && input){ suggest.style.display='none'; input.setAttribute('aria-expanded','false'); }
    });
  })();

  // Accessibility tweaks: set ARIA on dyn changes
  (function(){
    const uniGrid = $('#universityGrid');
    if (!uniGrid) return;
    uniGrid.setAttribute('role', 'list');
  })();

  // Prevent accidental text selection on button mash
  (function(){
    $$('button').forEach(b=>{
      b.addEventListener('mousedown', (e)=> e.preventDefault());
    });
  })();
})();
</script>

<!-- Minimal analytics placeholder (optional, safe to remove) -->
<script>
window.__srAnalytics = {
  log: (event, data={})=>{
    try{
      const entry = { event, data, ts: Date.now() };
      const raw = localStorage.getItem('sr_logs') || '[]';
      const arr = JSON.parse(raw); arr.push(entry);
      while (arr.length > 1000) arr.shift();
      localStorage.setItem('sr_logs', JSON.stringify(arr));
    }catch(_){}
  }
};
// Example: when send succeeds (stubbed in startProgressSend), you could call:
// __srAnalytics.log('send_complete', { count: selectedCount });
</script>

<!-- Defensive CSS for late-insert UI jitter (optional) -->
<style>
  /* Prevent layout jump when toasts appear */
  .toast-wrap { will-change: transform; }
  /* Smooth opening of dropdown */
  .user-dropdown { will-change: transform, opacity; }
  /* Stronger focus rings for a11y */
  .page-btn:focus-visible, .apply-btn:focus-visible, .filter-select:focus-visible {
    outline: 3px solid #1976d2; outline-offset: 2px;
  }
  :root[data-theme="dark"] .page-btn:focus-visible,
  :root[data-theme="dark"] .apply-btn:focus-visible,
  :root[data-theme="dark"] .filter-select:focus-visible {
    outline: 3px solid #7aa2ff;
  }
</style>

<!-- Service worker registration (optional, safe to keep) -->
<script>
(function(){
  if ('serviceWorker' in navigator){
    try{
      navigator.serviceWorker.register('/sw.js');
    }catch(_){}
  }
})();
</script>
<script>
/**
 * Robust Student Tabs Controller
 * - Runs after DOM is ready
 * - Prevents double-binding
 * - Syncs hash (#send | #select | #track) <-> UI
 * - Survives DOM re-renders via a tiny retry loop
 */
(function(){
  function bindStudentTabs(attempt=0){
    if (window.__srStudentTabsBound__) return;
    const tSend   = document.getElementById('stuTabSend');
    const tSelect = document.getElementById('stuTabSelect');
    const tTrack  = document.getElementById('stuTabTrack');
    const pSend   = document.getElementById('stuPanelSend');
    const pSelect = document.getElementById('stuPanelSelect');
    const pTrack  = document.getElementById('stuPanelTrack');
    const allTabs   = [tSend, tSelect, tTrack];
    const allPanels = { send:pSend, select:pSelect, track:pTrack };

    // If the nodes aren’t in the DOM yet, retry shortly (handles late mounts)
    if (!tSend || !tSelect || !tTrack || !pSend || !pSelect || !pTrack) {
      if (attempt < 20) return setTimeout(()=>bindStudentTabs(attempt+1), 100);
      return; // give up silently after ~2s
    }

    function activate(which){
      // aria-selected on tabs
      [['send',tSend],['select',tSelect],['track',tTrack]].forEach(([k,btn])=>{
        if (!btn) return;
        btn.setAttribute('aria-selected', k===which ? 'true':'false');
      });
      // hide/show panels
      Object.entries(allPanels).forEach(([k,sec])=>{
        if (!sec) return;
        sec.hidden = (k!==which);
      });
      // reflect in hash for deep-linking
      try { history.replaceState(null,'', '#'+which); } catch(_){}
      // if you have a renderer for Track, call it
      if (which==='track' && typeof window.renderStudentTrack==='function') {
        window.renderStudentTrack();
      }
    }

    // Ensure buttons aren’t accidental submits inside forms
    allTabs.forEach(b=>{ if (b) b.type = 'button'; });

    // Bind once
    if (!tSend.__bound){
      tSend  .addEventListener('click', ()=>activate('send'));
      tSelect.addEventListener('click', ()=>activate('select'));
      tTrack .addEventListener('click', ()=>activate('track'));
      tSend.__bound = tSelect.__bound = tTrack.__bound = true;
    }

    // Choose initial tab:
    // 1) URL hash (#select/#track/#send) wins
    // 2) Otherwise, whichever tab has aria-selected="true"
    // 3) Fallback to "send"
    const hash = (location.hash||'').replace('#','').toLowerCase();
    const fromHash = (hash==='select'||hash==='track'||hash==='send') ? hash : null;
    const fromAria =
      (tSelect.getAttribute('aria-selected')==='true' && 'select') ||
      (tTrack .getAttribute('aria-selected')==='true' && 'track')  ||
      (tSend  .getAttribute('aria-selected')==='true' && 'send')   ||
      null;
    activate(fromHash || fromAria || 'send');

    // Also listen to hash changes (deep-link from elsewhere)
    window.addEventListener('hashchange', ()=>{
      const h = (location.hash||'').replace('#','').toLowerCase();
      if (h==='select'||h==='track'||h==='send') activate(h);
    });

    window.__srStudentTabsBound__ = true;
  }

  // Run ASAP (covers both inline and deferred script orders)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>bindStudentTabs());
  } else {
    bindStudentTabs();
  }
})();
</script>
  <script>
(function(){
  if (window.__sr_uni_loader__) return; window.__sr_uni_loader__ = true;

  // Global app state (reuse if present)
  window.SR = window.SR || {
    universities: [],
    filtered: [],
    q: '',
    page: 1,
    perPage: 40,
    filters: { state:'', type:'', level:'', sort:'name_asc' },
    selected: new Set(['MOCK-0000']),
    fuse: null
  };

  function normalize(arr){
    return arr.map(u=>({
      unitid: String(u.unitid ?? u.UnitID ?? u.id ?? u.code ?? Math.random().toString(36).slice(2,9)),
      name:   String(u.name ?? u.InstitutionName ?? u.inst_name ?? u.title ?? 'Unnamed Institution'),
      state:  String(u.state ?? u.State ?? u.province ?? u.region ?? ''),
      type:   String(u.type  ?? u.Sector ?? u.Control ?? 'Public'),
      level:  String(u.level ?? u.Level ?? u.inst_level ?? '4-year')
    }));
  }

  async function loadFromPublicJSON(){
    // Try the path you mentioned
    const tryUrls = [
      'public/assets/us_institutions_by_state_2023.json',
      '/public/assets/us_institutions_by_state_2023.json',
      '/assets/us_institutions_by_state_2023.json' // fallback if deployed without /public prefix
    ];
    let raw;
    for (const url of tryUrls){
      try{
        const res = await fetch(url, { cache:'force-cache' });
        if (!res.ok) continue;
        raw = await res.json();
        break;
      }catch(_){}
    }
    if (!raw) throw new Error('Could not fetch universities JSON.');

    let flat = [];
    if (Array.isArray(raw)) flat = raw;
    else if (raw && typeof raw==='object'){
      for (const [state, list] of Object.entries(raw)){
        if (Array.isArray(list)) list.forEach(d => flat.push({ ...d, state: d.state ?? d.State ?? state }));
      }
    }
    if (flat.length < 1000) throw new Error('Dataset looks too small; is the correct JSON deployed?');
    return normalize(flat);
  }

  async function ensureDataset(){
    if (window.SR && SR.universities && SR.universities.length) return;

    SR.universities = await loadFromPublicJSON();

    // Ensure Mock University exists and stays selected
    if (!SR.universities.find(u=>u.unitid==='MOCK-0000')){
      SR.universities.unshift({ unitid:'MOCK-0000', name:'Mock University', state:'CA', type:'Private nonprofit', level:'4-year' });
    }
    SR.selected = new Set([...(SR.selected||[]), 'MOCK-0000']);

    // Build Fuse index for fast autosuggest
    SR.fuse = new Fuse(SR.universities, {
      keys: ['name'],
      includeScore: true,
      threshold: 0.3,
      minMatchCharLength: 2
    });
  }

  // Expose (used by later snippets)
  window.srEnsureDataset = ensureDataset;
})();
</script>
<script>
(function(){
  if (window.__sr_browse_bind__) return; window.__sr_browse_bind__ = true;

  async function populateBrowseDropdown(){
    const sel = document.getElementById('universitySelect');
    if (!sel) return;
    sel.length = 0;
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.disabled = true; opt0.selected = true;
    opt0.textContent = 'Browse all universities (6000+)';
    sel.appendChild(opt0);

    // Sort by name A–Z for a nice dropdown
    const list = SR.universities.slice().sort((a,b)=> a.name.localeCompare(b.name));
    for (const u of list){
      const opt = document.createElement('option');
      opt.value = u.unitid;
      opt.textContent = `${u.name} (${u.state})`;
      sel.appendChild(opt);
    }

    sel.addEventListener('change', ()=>{
      const id = sel.value;
      if (!id) return;
      SR.selected.add(id);
      updateSelectedList();
      toast('Added to your selection.','success');
      // reset dropdown so user can pick another
      sel.value = '';
    });
  }

  // Minimal selected list updater (works for both student & recommender panels)
  window.updateSelectedList = window.updateSelectedList || function(){
    const ids = Array.from(SR.selected||[]);
    const map = new Map(SR.universities.map(u=>[u.unitid, u]));
    const items = ids.map(id=> map.get(id)).filter(Boolean);

    const fill = (listEl, countEl)=>{
      if (!listEl || !countEl) return;
      listEl.innerHTML = '';
      items.forEach(u=>{
        const tag = document.createElement('div');
        tag.className = 'selected-tag';
        tag.innerHTML = `<span class="material-icons" aria-hidden="true">school</span>${u.name} <span class="remove-tag" role="button" title="Remove" data-id="${u.unitid}">✕</span>`;
        listEl.appendChild(tag);
      });
      countEl.textContent = `${items.length} universit${items.length===1?'y':'ies'} selected`;
      listEl.querySelectorAll('.remove-tag').forEach(x=>{
        x.addEventListener('click', ()=>{ SR.selected.delete(x.dataset.id); updateSelectedList(); });
      });
      // keep send button state fresh if it exists
      if (typeof updateSendButton === 'function') updateSendButton();
    };

    fill(document.getElementById('selectedList'),    document.getElementById('selectedCount'));
    fill(document.getElementById('selectedListStu'), document.getElementById('selectedCountStu'));
  };

  // Call after dataset is ready
  (async()=>{ await window.srEnsureDataset?.(); await populateBrowseDropdown(); updateSelectedList(); })();
})();
</script>
<script>
(function(){
  if (window.__sr_autosuggest__) return; window.__sr_autosuggest__ = true;

  const input   = document.getElementById('universitySearch');
  const popover = document.getElementById('searchSuggest');

  if (!input || !popover) return;

  function hide(){ popover.style.display='none'; input.setAttribute('aria-expanded','false'); }
  function show(){ popover.style.display='block'; input.setAttribute('aria-expanded','true'); }

  function renderSuggestions(q){
    if (!q || q.trim().length < 2) { hide(); return; }
    const results = SR.fuse ? SR.fuse.search(q).slice(0, 10).map(r=>r.item) : [];
    if (!results.length){ hide(); return; }

    popover.innerHTML = '';
    results.forEach(u=>{
      const row = document.createElement('div');
      row.className = 'suggest-item';
      row.setAttribute('role','option');
      row.innerHTML = `<span>${u.name}</span><small style="opacity:.7;">${u.state}</small>`;
      row.addEventListener('click', ()=>{
        SR.selected.add(u.unitid);
        updateSelectedList();
        toast(`Added: ${u.name}`,'success');
        hide();
        input.value = '';
      });
      popover.appendChild(row);
    });
    show();
  }

  // Debounce input
  let t;
  input.addEventListener('input', ()=>{
    clearTimeout(t);
    const q = input.value;
    t = setTimeout(()=> renderSuggestions(q), 140);
  });

  // Apply button (Search) acts like pressing Enter -> render suggestions
  document.getElementById('searchApplyBtn')?.addEventListener('click', ()=>{
    renderSuggestions(input.value);
  });

  // Keyboard + outside click handling
  document.addEventListener('click', (e)=>{
    if (!popover.contains(e.target) && !input.contains(e.target)) hide();
  });
  input.addEventListener('keydown', (e)=>{
    if (e.key==='Escape'){ hide(); input.blur(); }
    if (e.key==='Enter'){ e.preventDefault(); renderSuggestions(input.value); }
  });
})();
</script>

<script>
/* ======== Student Select: autosuggest + browse-all population ========
   Paste this near </body>. It is idempotent and won't break existing code.
======================================================================== */
(function(){
  if (window.__sr_select_patch__) return;
  window.__sr_select_patch__ = true;

  // ---- DOM ----
  const input    = document.getElementById('universitySearch');
  const popover  = document.getElementById('searchSuggest');
  const selectEl = document.getElementById('universitySelect');
  const listStu  = document.getElementById('selectedListStu');
  const countStu = document.getElementById('selectedCountStu');

  if (!input || !popover || !selectEl) return; // only run on student-select screen

  // ---- SR core (create minimal state if not present) ----
  window.SR = window.SR || {};
  SR.universities = Array.isArray(SR.universities) ? SR.universities : [];
  SR.selected     = SR.selected instanceof Set ? SR.selected : new Set();

  // ---- Util ----
  const norm = (arr)=> arr.map(u=>({
    unitid: String(u.unitid ?? u.UnitID ?? u.id ?? u.code ?? Math.random().toString(36).slice(2,9)),
    name:   String(u.name ?? u.InstitutionName ?? u.inst_name ?? u.title ?? 'Unnamed Institution'),
    state:  String(u.state ?? u.State ?? u.province ?? u.region ?? ''),
    type:   String(u.type  ?? u.Sector ?? u.Control ?? 'Public'),
    level:  String(u.level ?? u.Level ?? u.inst_level ?? '4-year'),
  }));

  async function loadUniversitiesOnce(){
    if (SR.universities && SR.universities.length > 0) return SR.universities;

    // Try the Netlify root path first (public/ is served at /)
    const candidates = [
      '/assets/us_institutions_by_state_2023.json',
      'assets/us_institutions_by_state_2023.json',
      '/public/assets/us_institutions_by_state_2023.json',
      'public/assets/us_institutions_by_state_2023.json',
    ];

    for (const url of candidates){
      try{
        const res = await fetch(url, { cache: 'force-cache' });
        if (!res.ok) continue;
        const raw = await res.json();

        let flat = [];
        if (Array.isArray(raw)) flat = raw;
        else if (raw && typeof raw === 'object'){
          for (const [state, list] of Object.entries(raw)){
            if (Array.isArray(list)){
              list.forEach(d => flat.push({ ...d, state: d.state ?? d.State ?? state }));
            }
          }
        }
        if (flat.length > 1000){
          // Add Mock University to the real data
          flat.unshift({ unitid:'MOCK-0000', name:'Mock University', state:'CA', control:'Private nonprofit', level:'4-year', city:'Mock City' });
          SR.universities = norm(flat);
          console.log(`✅ Loaded ${flat.length} universities from ${url}`);
          break;
        }
      }catch(_){}
    }

    // Fallback (tiny synthetic list) if file wasn’t found
    if (!SR.universities || SR.universities.length === 0){
      SR.universities = norm([
        { unitid:'MOCK-0000', name:'Mock University',               state:'CA', type:'Private nonprofit', level:'4-year' },
        { unitid:'166027', name:'Harvard University',               state:'MA', type:'Private nonprofit', level:'4-year' },
        { unitid:'110635', name:'Stanford University',              state:'CA', type:'Private nonprofit', level:'4-year' },
        { unitid:'1106351',name:'Massachusetts Institute of Technology', state:'MA', type:'Private nonprofit', level:'4-year' },
        { unitid:'1106352',name:'University of California, Berkeley',   state:'CA', type:'Public',           level:'4-year' },
      ]);
      console.warn('[SR] Using small fallback university list (JSON not found). Tried URLs:', candidates);
    }

    // Ensure Mock University is always present and preselected
    if (!SR.universities.find(u => u.unitid === 'MOCK-0000')) {
      SR.universities.unshift({ unitid:'MOCK-0000', name:'Mock University', state:'CA', type:'Private nonprofit', level:'4-year' });
    }
    SR.selected = SR.selected || new Set();
    SR.selected.add('MOCK-0000');

    return SR.universities;
  }

  function ensureFuse(){
    if (!window.Fuse) return null;
    if (SR.fuse) return SR.fuse;
    SR.fuse = new Fuse(SR.universities, {
      keys: [{ name:'name', weight: 0.8 }, { name:'state', weight: 0.2 }],
      threshold: 0.3,
      minMatchCharLength: 2,
      ignoreLocation: true
    });
    return SR.fuse;
  }

  // ---- Browse-all population ----
  function populateBrowseAll(){
    // Keep the first (placeholder) option, remove the rest
    while (selectEl.options.length > 1) selectEl.remove(1);

    const frag = document.createDocumentFragment();
    // Sort A→Z by name for the dropdown, but keep Mock University first
    const sorted = SR.universities.slice().sort((a,b)=> {
      if (a.unitid === 'MOCK-0000') return -1;
      if (b.unitid === 'MOCK-0000') return 1;
      return a.name.localeCompare(b.name);
    });
    sorted.forEach(u=>{
      const opt = document.createElement('option');
      opt.value = u.unitid;
      opt.textContent = `${u.name} ${u.state ? `(${u.state})` : ''}`;
      opt.setAttribute('data-name', u.name);
      opt.setAttribute('data-state', u.state);
      frag.appendChild(opt);
    });
    selectEl.appendChild(frag);
  }

  // When user picks a university in the dropdown, add to selected
  selectEl.addEventListener('change', ()=>{
    const id = selectEl.value;
    if (!id) return;
    SR.selected.add(String(id));
    // reflect in UI
    if (typeof window.updateSelectedList === 'function') {
      updateSelectedList();             // your existing renderer (recommender list)
    }
    updateStudentSelectedMini();
    // reset dropdown back to placeholder
    selectEl.selectedIndex = 0;
  });

  // ---- Student selected list (read-only view) ----
  function updateStudentSelectedMini(){
    if (!listStu || !countStu) return;
    // Silent if your page already syncs these elsewhere:
    if (window.__sr_student_selected_external__) return;

    // Build simple tags from SR.selected
    const byId = new Map(SR.universities.map(u => [String(u.unitid), u]));
    listStu.innerHTML = '';
    let added = 0;
    SR.selected.forEach(id=>{
      const u = byId.get(String(id));
      if (!u) return;
      const tag = document.createElement('div');
      tag.className = 'selected-tag';
      tag.innerHTML = `<span class="material-icons" aria-hidden="true">school</span>${u.name}${u.state?` • ${u.state}`:''}`;
      listStu.appendChild(tag);
      added++;
    });
    countStu.textContent = `${added} universit${added===1?'y':'ies'} selected`;
  }

  // ---- Autosuggest ----
  let activeIndex = -1; // keyboard highlight
  function hideSuggest(){ popover.style.display='none'; popover.innerHTML=''; activeIndex = -1; input.setAttribute('aria-expanded','false'); }
  function showSuggest(){ popover.style.display='block'; input.setAttribute('aria-expanded','true'); }

  function renderSuggest(items){
    popover.innerHTML = items.map((u, i)=>`
      <div class="suggest-item" data-unitid="${u.unitid}" data-idx="${i}" role="option" aria-selected="${i===activeIndex?'true':'false'}">
        <div>${u.name}</div>
        <small style="opacity:.8">${u.state||''}</small>
      </div>
    `).join('');
    showSuggest();
  }

  function pickByIndex(i){
    const rows = Array.from(popover.querySelectorAll('.suggest-item'));
    const el = rows[i];
    if (!el) return;
    const id = el.getAttribute('data-unitid');
    if (!id) return;
    SR.selected.add(String(id));
    if (typeof window.updateSelectedList === 'function') updateSelectedList();
    updateStudentSelectedMini();
    hideSuggest();
    input.value = '';
  }

  function selectByClick(e){
    const row = e.target.closest('.suggest-item'); if (!row) return;
    const idx = Number(row.getAttribute('data-idx')||'-1');
    if (idx >= 0) pickByIndex(idx);
  }

  input.addEventListener('input', ()=>{
    const q = input.value.trim();
    if (q.length < 2){ hideSuggest(); return; }
    const fuse = ensureFuse();
    if (!fuse){ hideSuggest(); return; }

    const results = fuse.search(q, { limit: 8 }).map(r=> r.item);
    if (!results.length){ hideSuggest(); return; }
    activeIndex = 0;
    renderSuggest(results);
  });

  input.addEventListener('keydown', (e)=>{
    if (popover.style.display !== 'block') return;
    const rows = Array.from(popover.querySelectorAll('.suggest-item'));
    if (!rows.length) return;

    if (e.key === 'ArrowDown'){ e.preventDefault(); activeIndex = (activeIndex+1) % rows.length; rows.forEach((r,i)=> r.setAttribute('aria-selected', i===activeIndex?'true':'false')); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); activeIndex = (activeIndex-1+rows.length) % rows.length; rows.forEach((r,i)=> r.setAttribute('aria-selected', i===activeIndex?'true':'false')); }
    else if (e.key === 'Enter'){ e.preventDefault(); pickByIndex(Math.max(0, activeIndex)); }
    else if (e.key === 'Escape'){ e.preventDefault(); hideSuggest(); }
  });

  popover.addEventListener('click', selectByClick);
  document.addEventListener('click', (e)=>{ if (!popover.contains(e.target) && e.target !== input) hideSuggest(); });

  // ---- Bootstrap once DOM is ready ----
  // DISABLED: This init function conflicts with the second one
  // The second init function (ensureRealDataset) handles all data loading
  (async function init(){
    // Only handle non-data-loading initialization
    ensureFuse();
    // Note: populateBrowseAll() is called by the second init function
    // first render will be handled after data loading
    // updateStudentSelectedMini();
    
    // Hide bulk import modal in recommender view
    function hideBulkImportModal() {
      const recommenderPanel = document.getElementById('panel-recommender');
      const bulkImportModal = document.getElementById('bulkImportModal');
      
      if (recommenderPanel && !recommenderPanel.hidden && bulkImportModal) {
        bulkImportModal.style.display = 'none';
        bulkImportModal.setAttribute('hidden', 'true');
      }
    }
    
    // Run immediately and set up observer
    hideBulkImportModal();
    
    // Watch for view changes
    const observer = new MutationObserver(hideBulkImportModal);
    const recommenderPanel = document.getElementById('panel-recommender');
    if (recommenderPanel) {
      observer.observe(recommenderPanel, { attributes: true, attributeFilter: ['hidden'] });
    }
  })();
})();
</script>

<script>
/* ===== Ensure real names from JSON + Mock University present ===== */
(function(){
  if (window.__sr_names_fix__) return; window.__sr_names_fix__ = true;

  const selectEl = document.getElementById('universitySelect');
  const listStu  = document.getElementById('selectedListStu');
  const countStu = document.getElementById('selectedCountStu');

  window.SR = window.SR || {};
  SR.universities = Array.isArray(SR.universities) ? SR.universities : [];
  SR.selected     = SR.selected instanceof Set ? SR.selected : new Set();

  const MOCK = { unitid:'MOCK-0000', name:'Mock University', state:'CA', type:'Private nonprofit', level:'4-year' };

  const norm = (arr)=> arr.map(u=>({
    unitid: String(u.unitid ?? u.UnitID ?? u.id ?? u.code ?? Math.random().toString(36).slice(2,9)),
    name:   String(u.name ?? u.InstitutionName ?? u.inst_name ?? u.title ?? 'Unnamed Institution'),
    state:  String(u.state ?? u.State ?? u.province ?? u.region ?? ''),
    type:   String(u.type  ?? u.Sector ?? u.Control ?? 'Public'),
    level:  String(u.level ?? u.Level ?? u.inst_level ?? '4-year'),
  }));

  async function tryFetch(url){
    try {
      console.log('[SR] Attempting to fetch universities from:', url);
      
      // Try without cache first, then with cache if that fails
      let res;
      try {
        res = await fetch(url, { cache: 'no-cache' });
      } catch (e) {
        console.log('[SR] No-cache fetch failed, trying with cache:', e.message);
        res = await fetch(url, { cache: 'force-cache' });
      }
      
      if (!res.ok) {
        console.log('[SR] Fetch failed for:', url, 'Status:', res.status, 'StatusText:', res.statusText);
        return null;
      }
      
      console.log('[SR] Fetch successful for:', url, 'Status:', res.status);
      const raw = await res.json();
      console.log('[SR] Raw data type:', typeof raw, 'Keys:', Object.keys(raw).slice(0, 5));

      let flat = [];
      if (Array.isArray(raw)) {
        flat = raw;
        console.log('[SR] Data is array, length:', flat.length);
      } else if (raw && typeof raw === 'object'){
        console.log('[SR] Data is object, processing states...');
        for (const [state, list] of Object.entries(raw)){
          if (Array.isArray(list)){
            console.log('[SR] Processing state:', state, 'with', list.length, 'universities');
            list.forEach(d=> flat.push({ ...d, state: d.state ?? d.State ?? state }));
          }
        }
      }
      console.log('[SR] Flattened universities count:', flat.length);
      
      if (flat.length > 1000){
        const normalized = norm(flat);
        console.log('[SR] Universities loaded from:', url, 'count=', flat.length);
        console.log('[SR] First 3 normalized universities:', normalized.slice(0, 3).map(u => `${u.name} (${u.state})`));
        return normalized;
      } else {
        console.warn('[SR] Not enough universities found:', flat.length, 'expected > 1000');
      }
    } catch(e){ 
      console.error('[SR] Error fetching from:', url, e);
    }
    return null;
  }

  async function ensureRealDataset(){
    // If already loaded with many entries, keep it (but still ensure mock)
    if (SR.universities && SR.universities.length > 1000){
      console.log('[SR] Universities already loaded:', SR.universities.length, 'entries');
      ensureMockPresence();
      return;
    }
    
    // If we have the fallback list (5 universities), we need to override it
    if (SR.universities && SR.universities.length <= 10) {
      console.log('[SR] Found fallback list with', SR.universities.length, 'universities. Attempting to load full dataset...');
      // Clear the fallback data so we can load the real data
      SR.universities = [];
    }
    
    console.log('[SR] Loading university data from JSON...');
    
    // SURGICAL FIX: Direct, simplified approach to load JSON data
    try {
      console.log('[SR] Attempting direct fetch of JSON file...');
      const response = await fetch('/assets/us_institutions_by_state_2023.json', {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const jsonData = await response.json();
      console.log('[SR] JSON loaded successfully, processing states...');
      
      // Process the JSON data directly
      const universities = [];
      let totalProcessed = 0;
      
      for (const [stateCode, stateUniversities] of Object.entries(jsonData)) {
        if (Array.isArray(stateUniversities)) {
          console.log(`[SR] Processing ${stateCode}: ${stateUniversities.length} universities`);
          
          stateUniversities.forEach(uni => {
            universities.push({
              unitid: String(uni.unitid || `${stateCode}-${totalProcessed}`),
              name: String(uni.name || 'Unknown University'),
              state: String(uni.state || stateCode),
              control: String(uni.control || 'Public'),
              level: String(uni.level || '4-year')
            });
            totalProcessed++;
          });
        }
      }
      
      console.log(`[SR] Processed ${universities.length} universities from ${Object.keys(jsonData).length} states`);
      
      if (universities.length > 1000) {
        SR.universities = universities;
        console.log('[SR] ✅ SUCCESS: Loaded', universities.length, 'universities from JSON file');
        console.log('[SR] Sample universities:', universities.slice(0, 3).map(u => `${u.name} (${u.state})`));
      } else {
        throw new Error(`Insufficient universities loaded: ${universities.length}`);
      }
      
    } catch (error) {
      console.error('[SR] ❌ FAILED to load JSON data:', error);
      console.log('[SR] Using fallback university list...');
      
      // Use fallback list
      SR.universities = [
        { unitid:'MOCK-0000', name:'Mock University', state:'CA', control:'Private nonprofit', level:'4-year' },
        { unitid:'166027', name:'Harvard University', state:'MA', control:'Private nonprofit', level:'4-year' },
        { unitid:'110635', name:'Stanford University', state:'CA', control:'Private nonprofit', level:'4-year' },
        { unitid:'1106351', name:'Massachusetts Institute of Technology', state:'MA', control:'Private nonprofit', level:'4-year' },
        { unitid:'1106352', name:'University of California, Berkeley', state:'CA', control:'Public', level:'4-year' },
      ];
    }
    
    ensureMockPresence();
  }

  function ensureMockPresence(){
    const hasMock = SR.universities.some(u=> String(u.unitid) === 'MOCK-0000');
    if (!hasMock) SR.universities.unshift(MOCK);
    SR.selected.add('MOCK-0000'); // keep Mock preselected
    try {
      const saved = JSON.parse(localStorage.getItem('sr_state_v1') || '{}');
      const ids = new Set(Array.isArray(saved.selectedIds) ? saved.selectedIds : []);
      ids.add('MOCK-0000');
      saved.selectedIds = Array.from(ids);
      localStorage.setItem('sr_state_v1', JSON.stringify(saved));
    } catch {}
  }

  function populateBrowseAll(){
    if (!selectEl) return;
    while (selectEl.options.length > 1) selectEl.remove(1);
    const frag = document.createDocumentFragment();
    const sorted = SR.universities.slice().sort((a,b)=> {
      if (a.unitid === 'MOCK-0000') return -1;
      if (b.unitid === 'MOCK-0000') return 1;
      return a.name.localeCompare(b.name);
    });
    sorted.forEach(u=>{
      const opt = document.createElement('option');
      opt.value = u.unitid;
      opt.textContent = `${u.name}${u.state?` (${u.state})`:''}`;
      frag.appendChild(opt);
    });
    selectEl.appendChild(frag);
  }

  function updateStudentSelectedMini(){
    if (!listStu || !countStu) return;
    const byId = new Map(SR.universities.map(u=> [String(u.unitid), u]));
    listStu.innerHTML = '';
    let n = 0;
    SR.selected.forEach(id=>{
      const u = byId.get(String(id)); if (!u) return;
      const tag = document.createElement('div');
      tag.className = 'selected-tag';
      tag.innerHTML = `<span class="material-icons" aria-hidden="true">school</span>${u.name}${u.state?` • ${u.state}`:''}`;
      listStu.appendChild(tag);
      n++;
    });
    countStu.textContent = `${n} universit${n===1?'y':'ies'} selected`;
  }
  // expose for other scripts if needed
  window.updateStudentSelectedMini = updateStudentSelectedMini;

  // keep dropdown -> selection behavior
  selectEl?.addEventListener('change', ()=>{
    const id = selectEl.value;
    if (!id) return;
    SR.selected.add(String(id));
    if (typeof window.updateSelectedList === 'function') updateSelectedList();
    updateStudentSelectedMini();
    selectEl.selectedIndex = 0;
  });

  (async function init(){
    console.log('[SR] Starting university data loading...');
    
    // DIRECT APPROACH: Load JSON data immediately without complex logic
    try {
      console.log('[SR] Fetching university JSON directly...');
      const response = await fetch('/assets/us_institutions_by_state_2023.json');
      
      if (!response.ok) {
        throw new Error(`Failed to fetch: ${response.status} ${response.statusText}`);
      }
      
      const jsonData = await response.json();
      console.log('[SR] JSON fetched successfully, processing...');
      
      // Process the data directly
      const universities = [];
      let count = 0;
      
      // Add Mock University first
      universities.push({
        unitid: 'MOCK-0000',
        name: 'Mock University',
        state: 'CA',
        control: 'Private nonprofit',
        level: '4-year'
      });
      
      // Process all states
      for (const [state, stateUniversities] of Object.entries(jsonData)) {
        if (Array.isArray(stateUniversities)) {
          stateUniversities.forEach(uni => {
            universities.push({
              unitid: String(uni.unitid || `${state}-${count++}`),
              name: String(uni.name || 'Unknown University'),
              state: String(uni.state || state),
              control: String(uni.control || 'Public'),
              level: String(uni.level || '4-year')
            });
          });
        }
      }
      
      // Set the data
      SR.universities = universities;
      window.universities = universities;
      
      console.log('[SR] ✅ SUCCESS! Loaded', universities.length, 'universities');
      console.log('[SR] Sample:', universities.slice(0, 3).map(u => `${u.name} (${u.state})`));
      
      // Ensure Mock is selected
      SR.selected = SR.selected || new Set();
      SR.selected.add('MOCK-0000');
      
    } catch (error) {
      console.error('[SR] ❌ FAILED to load JSON:', error);
      
      // Fallback
      SR.universities = [
        { unitid: 'MOCK-0000', name: 'Mock University', state: 'CA', control: 'Private nonprofit', level: '4-year' }
      ];
      window.universities = SR.universities;
    }
    
    // Initialize everything else
    ensureFuse();
    populateBrowseAll();
    updateStudentSelectedMini();
    
    console.log('[SR] Initialization complete with', SR.universities.length, 'universities');
  })();
})();
</script>

<script src="/assets/js/university-search.js" defer></script>

<!-- End of page -->
</body>
</html>
<!-- (Blank chunk intentionally reserved in case you later insert build-time includes) -->
<!-- You can keep this placeholder or remove it; it does not affect functionality. -->
<!--
Notes:
- All critical features are implemented in the integrated bootstrap script:
  * dataset loading (public JSON or generated fallback)
  * Fuse.js autosuggest
  * search/filter/sort + pagination
  * selected list (student readonly + recommender editable)
  * copy share link
  * writer editor (toolbar + guidance + persistence)
  * upload PDF/video stubs with preview
  * contact admin overlay (open from avatar dropdown and dedicated item)
  * recommender send flow (confirm modal + simulated progress + success)
  * theme toggle with localStorage persistence
  * student portal send + tracking table
  * send button pulse and accessibility tweaks
- The earlier duplicate/partial scripts were merged to prevent event double-binding.
-->
<!-- (Optional extension points) -->
<script>
/* Example: hook to programmatically import a deep-link on load */
(function(){
  const params = new URLSearchParams(location.search);
  if (params.get('autoimport')==='1'){
    const demo = 'https://example.com/reco?sf=Jane&sl=Doe&se=jane@email.com&waive=1&unames=Harvard%20University,Stanford%20University';
    const input = document.getElementById('linkInput');
    const btn = document.getElementById('linkParseBtn');
    if (input && btn){
      input.value = demo;
      setTimeout(()=> btn.click(), 300);
    }
  }
})();
</script>

<!-- (Optional) keyboard shortcuts -->
<script>
(function(){
  document.addEventListener('keydown', (e)=>{
    // Bold/Italic/Underline in writer
    const box = document.getElementById('writerBox');
    const active = document.activeElement;
    const inWriter = active===box || (active && box && box.contains(active));
    if (!inWriter) return;

    if ((e.ctrlKey||e.metaKey) && !e.altKey){
      if (e.key.toLowerCase()==='b'){ e.preventDefault(); document.execCommand('bold'); }
      if (e.key.toLowerCase()==='i'){ e.preventDefault(); document.execCommand('italic'); }
      if (e.key.toLowerCase()==='u'){ e.preventDefault(); document.execCommand('underline'); }
    }
  });
})();
</script>

<!-- (Optional) progressive enhancement for drag & drop uploads -->
<script>
(function(){
  const uploadArea = document.getElementById('uploadArea');
  const fileInput  = document.getElementById('fileInput');
  if (!uploadArea || !fileInput) return;
  ['dragenter','dragover'].forEach(ev=> uploadArea.addEventListener(ev, (e)=>{ e.preventDefault(); uploadArea.parentElement.classList.add('dragover'); }));
  ['dragleave','drop'].forEach(ev=> uploadArea.addEventListener(ev, (e)=>{ e.preventDefault(); uploadArea.parentElement.classList.remove('dragover'); }));
  uploadArea.addEventListener('drop', (e)=>{
    const f = e.dataTransfer?.files?.[0]; if (!f) return;
    if (!/pdf$/i.test(f.type) && !/\.pdf$/i.test(f.name)){ toast('Please drop a PDF file.','error'); return; }
    const dt = new DataTransfer(); dt.items.add(f); fileInput.files = dt.files;
    fileInput.dispatchEvent(new Event('change'));
  });
})();
</script>



<!-- (Optional) enhance accessibility for modals -->
<script>
(function(){
  function trapFocus(modal){
    const focusable = modal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
    const first = focusable[0], last = focusable[focusable.length - 1];
    function handler(e){
      if (e.key !== 'Tab') return;
      if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    modal.__trapHandler = handler;
    modal.addEventListener('keydown', handler);
  }
  function untrap(modal){
    if (modal.__trapHandler){ modal.removeEventListener('keydown', modal.__trapHandler); delete modal.__trapHandler; }
  }
  // Hook confirm modal
  const confirmModal = document.getElementById('confirmModal');
  const contactOverlay = document.getElementById('contactOverlay');

  const openObs = new MutationObserver(()=>{
    [confirmModal, contactOverlay].forEach(m=>{
      if (!m) return;
      if (m.style.display === 'flex'){ trapFocus(m); }
      else { untrap(m); }
    });
  });
  openObs.observe(document.body, { attributes:true, childList:true, subtree:true });
})();
</script>

<!-- (Optional) simple debounce utility for later expansions -->
<script>
window.srDebounce = function(fn, wait=150){
  let t; return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this, args), wait); };
};
</script>

<!-- (Optional) improve hash routing resilience -->
<script>
(function(){
  window.addEventListener('hashchange', ()=>{
    const view = (location.hash || '#student').slice(1);
    const toggles = document.querySelectorAll('.header-nav .nav-link');
    const studentPanel = document.getElementById('panel-student');
    const recPanel = document.getElementById('panel-recommender');
    const isStudent = view!=='recommender';
    if (studentPanel && recPanel){
      studentPanel.hidden = !isStudent;
      recPanel.hidden = isStudent;
      studentPanel.style.display = isStudent ? '' : 'none';
      recPanel.style.display = isStudent ? 'none' : '';
    }
    toggles.forEach(btn=>{
      const on = btn.dataset.view === (isStudent?'student':'recommender');
      btn.setAttribute('aria-selected', on?'true':'false');
      if (on) btn.setAttribute('aria-current','page'); else btn.removeAttribute('aria-current');
    });
    try{ localStorage.setItem('sr_current_view', isStudent?'student':'recommender'); }catch(_){}
  });
})();
</script>

<!-- (Optional) expose a tiny API for integration tests -->
<script>
window.SR_API = {
  selectByName(name){
    const hit = SR.universities.find(u=> u.name.toLowerCase().includes(String(name).toLowerCase()));
    if (!hit) return false;
    SR.selected.add(hit.unitid); updateSelectedList(); updateSendButton(); return true;
  },
  clearSelected(){
    SR.selected = new Set([SR.mockPinned]); updateSelectedList(); updateSendButton(); return true;
  },
  getSelected(){ return SR.universities.filter(u=> SR.selected.has(u.unitid)).map(u=> u.name); }
};
</script>

<!-- (Optional) micro CSS fixes -->
<style>
  /* Prevent long university names from breaking layout */
  .selected-tag { max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .university-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .university-header { gap: .75rem; }
</style>
<!-- (Optional) material icon font fallback for offline dev -->
<script>
(function(){
  // If Material Icons fail to load, fallback to text glyphs
  const test = document.createElement('span');
  test.className = 'material-icons';
  test.style.position = 'absolute';
  test.style.opacity = '0';
  test.textContent = 'check_circle';
  document.body.appendChild(test);
  setTimeout(()=>{
    const computed = window.getComputedStyle(test);
    const fontFamily = computed.getPropertyValue('font-family') || '';
    if (!/Material Icons/i.test(fontFamily)){
      // fallback: just ensure icons show readable text
      const style = document.createElement('style');
      style.textContent = `.material-icons{ font-family: inherit !important; font-weight: 600; letter-spacing: .5px; }`;
      document.head.appendChild(style);
    }
    test.remove();
  }, 500);
})();
</script>

<!-- (Optional) page visibility hook to pause fake sending if tab hidden -->
<script>
(function(){
  document.addEventListener('visibilitychange', ()=>{
    // In a real app, we'd pause network-hungry tasks here.
    // For now, no-op to keep demo predictable.
  });
})();
</script>

<!-- (Optional) keyboard navigation in autosuggest -->
<script>
(function(){
  const input = document.getElementById('universitySearch');
  const pop   = document.getElementById('searchSuggest');
  if (!input || !pop) return;
  let index = -1;

  input.addEventListener('keydown', (e)=>{
    const items = Array.from(pop.querySelectorAll('.suggest-item'));
    if (!items.length) return;

    if (e.key==='ArrowDown'){ e.preventDefault(); index = (index+1) % items.length; highlight(); }
    if (e.key==='ArrowUp'){ e.preventDefault(); index = (index-1+items.length) % items.length; highlight(); }
    if (e.key==='Enter'){
      if (index>=0){ e.preventDefault(); items[index].click(); index=-1; }
    }
    if (e.key==='Escape'){ pop.style.display='none'; input.setAttribute('aria-expanded','false'); index=-1; }
  });

  function highlight(){
    const items = Array.from(pop.querySelectorAll('.suggest-item'));
    items.forEach((el,i)=> el.style.background = i===index ? '#f8f9fa' : '');
  }
})();
</script>
<script>
(function(){
  if (window.__sr_filter_page__) return; window.__sr_filter_page__ = true;

  const els = {
    grid:   document.getElementById('universityGrid'),
    meta:   document.getElementById('resultMeta'),
    empty:  document.getElementById('emptyState'),
    pageInfo: document.getElementById('pageInfo'),
    prev:   document.getElementById('prevPage'),
    next:   document.getElementById('nextPage'),
    pageSize: document.getElementById('pageSize'),
    state:  document.getElementById('stateFilter'),
    type:   document.getElementById('typeFilter'),
    level:  document.getElementById('levelFilter'),
    sort:   document.getElementById('sortBy'),
    apply:  document.getElementById('filterApplyBtn'),
    reset:  document.getElementById('resetBtn'),
    clearFilters: document.getElementById('clearFiltersBtn')
  };

  function applyFilters(){
    const {state,type,level,sort} = SR.filters;
    let list = SR.universities.slice();

    if (state) list = list.filter(u=>u.state===state);
    if (type)  list = list.filter(u=>u.type===type);
    if (level) list = list.filter(u=>u.level===level);

    // sorting
    if (sort==='name_asc')  list.sort((a,b)=> a.name.localeCompare(b.name));
    if (sort==='state_asc') list.sort((a,b)=> a.state.localeCompare(b.state) || a.name.localeCompare(b.name));

    SR.filtered = list;
    SR.page = 1;
    renderGrid();
  }

  function renderGrid(){
    const grid = els.grid; if (!grid) return;
    const total = SR.filtered.length;
    const per   = SR.perPage;
    const pages = Math.max(1, Math.ceil(total / per));
    if (SR.page > pages) SR.page = pages;
    const start = (SR.page - 1) * per;
    const part  = SR.filtered.slice(start, start+per);

    grid.innerHTML = '';
    part.forEach(u=>{
      const card = document.createElement('div');
      const isSel = SR.selected.has(u.unitid);
      card.className = 'university-card' + (isSel?' selected':'');
      card.setAttribute('role','listitem');
      card.innerHTML = `
        <div class="university-header">
          <div class="university-logo" aria-hidden="true">${(u.name[0]||'?').toUpperCase()}</div>
          <div>
            <div class="university-name">${u.name}</div>
            <div class="university-location">${u.state} • ${u.type}</div>
            <span class="university-pill">${u.level}</span>
          </div>
        </div>
        <button class="apply-btn" type="button" data-id="${u.unitid}">${isSel?'Remove':'Select'}</button>
      `;
      // Toggle on card click (not the button to avoid double-trigger)
      card.addEventListener('click', (e)=>{
        if (e.target.closest('button')) return; // button handles itself
        toggleSelect(u.unitid);
      });
      // Toggle via button
      card.querySelector('button').addEventListener('click', ()=>{
        toggleSelect(u.unitid);
      });
      grid.appendChild(card);
    });

    // meta + empty state
    if (els.meta) els.meta.textContent = `Showing ${Math.min(per, total - start)} of ${total}`;
    if (els.empty) els.empty.style.display = total ? 'none' : 'block';

    // pager
    els.pageInfo && (els.pageInfo.textContent = `Page ${SR.page} of ${Math.max(1, Math.ceil(total/per))}`);
    els.prev && (els.prev.disabled = SR.page<=1);
    els.next && (els.next.disabled = SR.page>=Math.ceil(total/per));
  }

  function toggleSelect(id){
    if (SR.selected.has(id)) SR.selected.delete(id);
    else SR.selected.add(id);
    updateSelectedList();
    renderGrid(); // refresh select/remove labels + selected class
  }

  // Bind controls
  function bindFilterEvents(){
    if (els.apply && !els.apply.__bound){
      els.apply.__bound = true;
      els.apply.addEventListener('click', ()=>{
        SR.filters.state = els.state?.value || '';
        SR.filters.type  = els.type?.value  || '';
        SR.filters.level = els.level?.value || '';
        SR.filters.sort  = els.sort?.value  || 'name_asc';
        applyFilters();
      });
    }
    if (els.reset && !els.reset.__bound){
      els.reset.__bound = true;
      els.reset.addEventListener('click', ()=>{
        if (els.state) els.state.value = '';
        if (els.type)  els.type.value  = '';
        if (els.level) els.level.value = '';
        if (els.sort)  els.sort.value  = 'name_asc';
        SR.filters = { state:'', type:'', level:'', sort:'name_asc' };
        applyFilters();
      });
    }
    if (els.clearFilters && !els.clearFilters.__bound){
      els.clearFilters.__bound = true;
      els.clearFilters.addEventListener('click', ()=>{
        if (els.state) els.state.value = '';
        if (els.type)  els.type.value  = '';
        if (els.level) els.level.value = '';
        if (els.sort)  els.sort.value  = 'name_asc';
        SR.filters = { state:'', type:'', level:'', sort:'name_asc' };
        applyFilters();
      });
    }
    if (els.prev && !els.prev.__bound){
      els.prev.__bound = true;
      els.prev.addEventListener('click', ()=>{ if (SR.page>1){ SR.page--; renderGrid(); }});
    }
    if (els.next && !els.next.__bound){
      els.next.__bound = true;
      els.next.addEventListener('click', ()=>{ SR.page++; renderGrid(); });
    }
    if (els.pageSize && !els.pageSize.__bound){
      els.pageSize.__bound = true;
      els.pageSize.addEventListener('change', ()=>{
        const n = parseInt(els.pageSize.value,10);
        SR.perPage = Number.isFinite(n) && n>0 ? n : 40;
        SR.page = 1;
        renderGrid();
      });
    }
  }

  (async()=>{
    await window.srEnsureDataset?.();
    bindFilterEvents();
    applyFilters();
  })();
})();
</script>


<!-- (Optional) ensure dropdown hides when clicking outside -->
<script>
(function(){
  const dd = document.getElementById('userDropdown');
  const avatar = document.getElementById('userAvatarBtn');
  document.addEventListener('click', (e)=>{
    if (!dd) return;
    if (avatar && (avatar===e.target || avatar.contains(e.target))) return;
    if (!dd.contains(e.target)){ dd.classList.remove('show'); avatar?.setAttribute('aria-expanded','false'); }
  });
})();
</script>

<!-- (Optional) fix for very small screens -->
<style>
@media (max-width: 380px){
  .header-content { padding: 0; }
  .logo { font-size: 1.4rem; }
  .nav-link { padding: .25rem .5rem; }
  .writer-actions { flex-direction: column; align-items: stretch; }
  .filter-bar { grid-template-columns: 1fr; }
}
</style>
<!-- Final guard to ensure Mock University is selected & send button state right after any external script runs -->
<script>
(function(){
  const ensure = ()=>{
    if (!window.SR || !Array.isArray(SR.universities)) return false;
    
    // Ensure Mock University is in the universities list
    if (!SR.universities.find(u => u.unitid === 'MOCK-0000')) {
      SR.universities.unshift({ 
        unitid: 'MOCK-0000', 
        name: 'Mock University', 
        state: 'CA', 
        type: 'Private nonprofit', 
        level: '4-year' 
      });
    }
    
    // Ensure Mock University is selected
    SR.selected = SR.selected || new Set();
    SR.selected.add('MOCK-0000');
    
    // Update UI
    if (typeof window.updateSelectedList === 'function') updateSelectedList();
    if (typeof window.updateSendButton === 'function') updateSendButton();
    
    // Persist state
    try{
      const saved = JSON.parse(localStorage.getItem('sr_state_v1')||'{}');
      saved.selectedIds = Array.from(SR.selected);
      localStorage.setItem('sr_state_v1', JSON.stringify(saved));
    }catch(_){}
    
    return true;
  };
  
  // Try immediately
  if (!ensure()){
    let tries = 0;
    const t = setInterval(()=>{ 
      tries++; 
      if (ensure() || tries>25) {
        clearInterval(t);
        // Force one more update after everything is loaded
        setTimeout(() => {
          if (typeof window.updateSelectedList === 'function') updateSelectedList();
        }, 500);
      }
    }, 120);
  }
})();
</script>

<!-- Bulk Import Modal Override for Recommender View -->
<script>
(function(){
  // Override any attempts to show the bulk import modal in recommender view
  function preventBulkImportModal() {
    const bulkImportModal = document.getElementById('bulkImportModal');
    const recommenderPanel = document.getElementById('panel-recommender');
    
    if (bulkImportModal && recommenderPanel && !recommenderPanel.hidden) {
      // Force hide the modal
      bulkImportModal.style.display = 'none';
      bulkImportModal.setAttribute('hidden', 'true');
      return true;
    }
    return false;
  }
  
  // Watch for any attempts to show the modal
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
        const target = mutation.target;
        if (target.id === 'bulkImportModal') {
          preventBulkImportModal();
        }
      }
    });
  });
  
  // Start observing when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    const bulkImportModal = document.getElementById('bulkImportModal');
    if (bulkImportModal) {
      observer.observe(bulkImportModal, { attributes: true, attributeFilter: ['style'] });
      preventBulkImportModal(); // Run immediately
    }
  });
  
  // Also run prevention check periodically
  setInterval(preventBulkImportModal, 500);
})();
</script>

<!-- Backend Integration for Send Recommendation Request -->
<script>
// Backend URL - Using Netlify Functions
window.SR_BACKEND_BASE = window.SR_BACKEND_BASE || 'https://stellarrec.netlify.app/.netlify/functions';

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
  if (window.__srSendBound) return; 
  window.__srSendBound = true;

  console.log('🔧 Initializing backend integration...');

  const form = document.getElementById('stuSendForm');
  if (!form) {
    console.error('❌ stuSendForm not found!');
    return;
  }
  console.log('✅ Found stuSendForm:', form);

  const nameEl = document.getElementById('stuName');
  const emailEl = document.getElementById('stuEmail');
  const recName = document.getElementById('recName');
  const recMail = document.getElementById('recEmail');
  
  const validEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').toLowerCase());

  // Helper: selected unit IDs (keep Mock if none)
  function getSelectedUnitIds() {
    const a = window.studentUnitIds ? Array.from(window.studentUnitIds) : [];
    const b = (window.SR && SR.selected) ? Array.from(SR.selected) : [];
    const all = new Set([...(a||[]), ...(b||[])]);
    if (!all.size) all.add('MOCK-0000');
    return Array.from(all);
  }

  // Helper: split "First Last"
  function splitName(full) {
    const parts = String(full||'').trim().split(/\s+/);
    const first = parts.shift() || '';
    const last = parts.join(' ') || '';
    return { first, last };
  }

  // Call backend API
  async function createRecommendationOnBackend({ studentName, studentEmail, recommenderName, recommenderEmail }) {
    const { first: sf, last: sl } = splitName(studentName);
    const unitids = getSelectedUnitIds();
    const waive = 1;
    const title = (document.getElementById('writerTitle')?.value || '').trim();
    
    const payload = {
      student_name: studentName,
      student_email: studentEmail.toLowerCase(),
      student_first: sf,
      student_last: sl,
      recommender_name: recommenderName,
      recommender_email: recommenderEmail.toLowerCase(),
      unitids,
      waive,
      title
    };

    console.log('📤 Sending payload to backend:', payload);
    console.log('🔗 API URL:', `${window.SR_BACKEND_BASE}/recommendations`);

    const res = await fetch(`${window.SR_BACKEND_BASE}/recommendations`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    console.log('📡 Response status:', res.status);
    console.log('📡 Response headers:', Object.fromEntries(res.headers.entries()));
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error('❌ Backend error response:', errorText);
      throw new Error(`Backend ${res.status}: ${errorText}`);
    }
    
    const result = await res.json();
    console.log('📨 Backend result:', result);
    return result;
  }

  // Enhanced tracking integration
  function addToStudentTrack({id, who, email, ts, status, universities = [], studentName = '', studentEmail = ''}) {
    if (window.SR && Array.isArray(SR.studentTrack)) {
      const trackEntry = {
        id: id || 'req_' + Date.now(),
        who: who,
        email: email,
        ts: ts,
        status: status,
        universities: universities,
        studentName: studentName,
        studentEmail: studentEmail,
        lastUpdated: Date.now()
      };
      
      const existingIndex = SR.studentTrack.findIndex(entry => entry.id === trackEntry.id);
      if (existingIndex >= 0) {
        SR.studentTrack[existingIndex] = { ...SR.studentTrack[existingIndex], ...trackEntry };
      } else {
        SR.studentTrack.unshift(trackEntry);
      }
      
      try {
        const saved = JSON.parse(localStorage.getItem('sr_state_v1') || '{}');
        saved.studentTrack = SR.studentTrack;
        localStorage.setItem('sr_state_v1', JSON.stringify(saved));
      } catch(_) {}
      
      if (typeof window.renderStudentTrack === 'function') {
        window.renderStudentTrack();
      }
    }
  }

  // Test backend connectivity
  console.log('🧪 Testing backend connectivity...');
  fetch(`${window.SR_BACKEND_BASE}/health`)
    .then(r => r.json())
    .then(data => console.log('✅ Backend health check:', data))
    .catch(err => console.error('❌ Backend health check failed:', err));

  console.log('✅ Adding form submit listener...');

  form.addEventListener('submit', async (e) => {
    console.log('🚀 Form submitted!', e);
    e.preventDefault();
    
    const studentName = (nameEl?.value||'').trim();
    const studentEmail = (emailEl?.value||'').trim();
    const rName = (recName?.value||'').trim();
    const rMail = (recMail?.value||'').trim();
    
    console.log('📝 Form data:', { studentName, studentEmail, rName, rMail });
    
    if (!studentName || !validEmail(studentEmail) || !rName || !validEmail(rMail)) {
      console.log('❌ Validation failed');
      if (typeof toast === 'function') {
        toast('Please fill valid student & recommender details.','error');
      } else {
        alert('Please fill valid student & recommender details.');
      }
      return;
    }
    
    console.log('✅ Validation passed, proceeding with submission...');

    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Sending...';
    submitBtn.disabled = true;

    try {
      const selectedUniversities = getSelectedUnitIds().map(id => {
        if (window.SR && SR.universities) {
          const uni = SR.universities.find(u => u.unitid === id);
          return uni ? uni.name : id;
        }
        return id === 'MOCK-0000' ? 'Mock University' : id;
      });

      console.log('🎯 Selected universities:', selectedUniversities);
      console.log('🌐 Backend URL:', window.SR_BACKEND_BASE);

      const result = await createRecommendationOnBackend({
        studentName, 
        studentEmail,
        recommenderName: rName, 
        recommenderEmail: rMail
      });

      console.log('✅ Backend response:', result);

      const now = Date.now();
      const requestId = result.id || 'req_' + now;
      
      // Check if we're in testing mode (Resend free tier)
      const isTestingMode = result.message && result.message.includes('testing');
      
      addToStudentTrack({
        id: requestId,
        who: rName,
        email: rMail,
        ts: now,
        status: isTestingMode ? 'testing' : 'sent',
        universities: selectedUniversities,
        studentName: studentName,
        studentEmail: studentEmail,
        note: isTestingMode ? 'Email sent to verified test address (swetha.rajan103@gmail.com) due to Resend testing limitations' : undefined
      });

      if (typeof toast === 'function') {
        if (isTestingMode) {
          toast('🧪 Email sent in testing mode! Check tracking tab for details.','info');
        } else {
          toast('Request sent to recommender by email! 🎉','success');
        }
      } else {
        alert(isTestingMode ? 'Email sent in testing mode!' : 'Request sent successfully!');
      }
      
      setTimeout(() => {
        const trackTab = document.getElementById('stuTabTrack');
        if (trackTab) {
          trackTab.click();
          if (typeof toast === 'function') {
            toast('Check your request status in the tracking tab!', 'info');
          }
        }
      }, 2000);
      
      form.reset();

    } catch (err) {
      console.error('Backend error:', err);
      
      const now = Date.now();
      addToStudentTrack({
        id: 'req_' + now,
        who: rName,
        email: rMail,
        ts: now,
        status: 'failed',
        universities: getSelectedUnitIds().map(id => id === 'MOCK-0000' ? 'Mock University' : id),
        studentName: studentName,
        studentEmail: studentEmail,
        error: err.message
      });
      
      if (typeof toast === 'function') {
        toast('Could not send the recommendation email. Check tracking tab for details.','error');
      } else {
        alert('Error: Could not send the recommendation email.');
      }
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
});</script>

<!-- StellarRec API Integration -->
<script src="../frontend/js/api-client.js"></script>
<script src="../frontend/js/recommendation-handler.js"></script>

<!-- THE END -->
</body>
</html>

  
