<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StellarRec - One upload. Unlimited reach.</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Roboto',sans-serif;
      background:linear-gradient(135deg,var(--bg-grad-1,#f8f9fa) 0%,var(--bg-grad-2,#e9ecef) 100%);
      color:var(--text,#333);
      min-height:100vh;
    }
    /* Header */
    .header {
      background:linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color:#fff; padding:1.1rem 2rem; /* tighter to bring hero closer */
      box-shadow:0 4px 20px rgba(25,118,210,0.3);
    }
    .header-content {
      max-width:1200px; margin:0 auto;
      display:flex; justify-content:space-between; align-items:center; gap:1rem;
    }
    .logo {
      display:flex; align-items:center; gap:.5rem;
      font-size:1.8rem; font-weight:700;
      text-decoration:none; color:#fff; transition:.3s;
    }
    .logo:hover { opacity:.85; transform:translateY(-1px); }
    /* Header nav (Student left, Recommender right) */
    .header-nav { display:flex; justify-content:space-between; align-items:center; gap:1rem; flex:1; margin:0 1rem; }
    .nav-left, .nav-right { display:flex; gap:1.25rem; align-items:center; }
    [hidden] { display: none !important; }

    .nav-link{
      color:#fff; text-decoration:none; font-weight:700; opacity:.95;
      padding:.35rem .75rem; border-radius:10px; transition:opacity .15s, transform .15s;
    }
    .nav-link:hover{ opacity:1; transform:translateY(-1px); }
    .nav-link[aria-current="page"]{ background:#ffffff22; }
    /* Center header tabs (A) */
    .hdr-tabs {
      display:flex; align-items:center; gap:.4rem;
      background:#ffffff22; border:1px solid #ffffff55; border-radius:999px;
      padding:.2rem; min-height:40px;
    }
    .hdr-tab {
      appearance:none; border:0; background:transparent; color:#fff;
      padding:.45rem .9rem; border-radius:999px; font-weight:700; cursor:pointer;
      letter-spacing:.2px; font-size:.95rem; opacity:.9;
    }
    .hdr-tab[aria-selected="true"] {
      background:#fff; color:#1976d2; box-shadow:0 6px 20px rgba(0,0,0,.12);
      opacity:1;
    }
    .hdr-tab:focus-visible { outline:3px solid rgba(255,255,255,.5); outline-offset:2px; }
    /* Right controls (theme + avatar) */
    .right-controls { display:flex; align-items:center; gap:.75rem; }
    /* Avatar + dropdown */
    .user-info { position:relative; display:flex; align-items:center; gap:1rem; }
    .user-avatar {
      width:45px; height:45px;
      background:rgba(255,255,255,.2); border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:1.2rem; cursor:pointer; transition:.2s;
      border:2px solid rgba(255,255,255,0.1);
    }
    .user-avatar:hover { background:rgba(255,255,255,.3); transform:scale(1.05); border-color:rgba(255,255,255,.3); }
    .user-avatar:focus { outline:none; box-shadow:0 0 0 3px rgba(255,255,255,.3); }
    .user-dropdown {
      position:absolute; top:100%; right:0; margin-top:.5rem;
      background:#fff; border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,.15);
      min-width:260px; max-width:min(92vw,360px);
      opacity:0; visibility:hidden;
      transform:translateY(-10px) scale(.95);
      transition:all .2s cubic-bezier(0.4,0,0.2,1); z-index:1000;
      border:1px solid rgba(0,0,0,.08);
    }
    .user-dropdown.show { opacity:1; visibility:visible; transform:translateY(0) scale(1); }
    .user-dropdown::before{
      content:''; position:absolute; top:-8px; right:16px; width:16px; height:16px;
      background:#fff; border:1px solid rgba(0,0,0,.08); border-bottom:none; border-right:none;
      transform:rotate(45deg);
    }
    .dropdown-header { padding:1rem; border-bottom:1px solid #f0f0f0; color:#333; font-weight:600; font-size:.9rem; }
    .dropdown-item {
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem; color:#333; cursor:pointer; transition:.15s;
    }
    .dropdown-item:hover, .dropdown-item:focus { background:#f8f9fa; outline:none; }
    .dropdown-item .material-icons { font-size:1.2rem; color:#666; }
    .dropdown-item.active { background:#e3f2fd; color:#1976d2; }
    .dropdown-item.active .material-icons { color:#1976d2; }
    .view-label { display:flex; flex-direction:column; }
    .view-name { font-weight:600; font-size:.9rem; }
    .view-description { font-size:.8rem; color:#666; margin-top:.1rem; }
    .container { max-width:1200px; margin:0 auto; padding:1.25rem; }
    .hero-section { text-align:center; margin:1rem 0 1.5rem; }
    .hero-title { font-size:2.3rem; font-weight:700; color:#1976d2; margin-bottom:.6rem; }
    .hero-subtitle { font-size:1.1rem; color:#666; margin-bottom:1.25rem; }
    /* Two-column layout */
    .compose-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:2rem; }
    @media (max-width: 980px) { .compose-grid { grid-template-columns:1fr; } }

    .upload-section, .writer-section, .university-section,
    .selected-section, .progress-section {
      background:#fff; border-radius:16px; padding:2rem;
      box-shadow:0 8px 32px rgba(0,0,0,.1); margin-bottom:0;
    }
    .upload-section { border:2px dashed #e0e0e0; transition:.3s; }
    .upload-section.dragover { border-color:#1976d2; background:#f3f8ff; }
    .upload-area { text-align:center; padding:2rem; }
    .upload-icon { font-size:4rem; color:#1976d2; margin-bottom:1rem; }
    .upload-title { font-size:1.5rem; font-weight:600; margin-bottom:.5rem; color:#333; }
    .upload-subtitle { color:#666; margin-bottom:2rem; }
    .file-input { display:none; }
    .upload-btn {
      background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff;
      padding:1rem 2rem; border:none; border-radius:12px;
      font-size:1.1rem; font-weight:600; cursor:pointer;
      transition:.3s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    .uploaded-file {
      display:none; background:#e8f5e8; border:2px solid #4caf50;
      border-radius:12px; padding:1.5rem; margin-top:1rem;
    }
    .file-info { display:flex; align-items:center; gap:1rem; }
    .file-icon { font-size:2rem; color:#4caf50; }
    .file-details h3 { color:#2e7d32; margin-bottom:.25rem; }
    .file-details p { color:#4caf50; font-size:.9rem; }
    .remove-file {
      margin-left:auto; background:none; border:none; color:#666;
      cursor:pointer; padding:.5rem; border-radius:50%; transition:.2s;
    }
    .remove-file:hover { background:rgba(244,67,54,.1); color:#f44336; }
    .section-title {
      font-size:1.5rem; font-weight:600; color:#333;
      margin-bottom:1rem; display:flex; align-items:center; gap:.5rem;
    }
    /* Writer */
    .writer-toolbar { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.75rem; align-items:center; }
    .writer-toolbar .btn {
      background:#fff; border:2px solid #e5e7eb; border-radius:10px;
      padding:.45rem .75rem; cursor:pointer; font-weight:600;
    }
    .writer-toolbar .btn:hover { background:#f8f9fa; }
    .writer-toolbar .meta { margin-left:auto; font-size:.9rem; color:#667; display:flex; gap:.75rem; align-items:center; }
    .writer-title {
      width:100%; padding:.7rem .9rem;
      border:2px solid #e0e0e0; border-radius:12px;
      font-size:1rem; margin-bottom:.6rem;
    }
    .writer-box {
      border:2px solid #e0e0e0; border-radius:12px;
      min-height:280px; padding:1rem; line-height:1.55;
    }
    .writer-box:focus { outline:none; border-color:#1976d2; }
    .writer-actions { display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap; }
    .btn-primary { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; border:none; }
    .btn-success { background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; border:none; }
    .btn-danger  { background:linear-gradient(135deg,#e53935,#ef5350); color:#fff; border:none; }
    .btn-muted   { background:#fff; color:#333; }
    .filter-meta { font-size:.9rem; color:#666; margin:.25rem 0 .5rem; }
    .filter-bar { display:grid; grid-template-columns: repeat(8, minmax(140px, 1fr)); gap:.5rem; margin-bottom:.75rem; align-items:center; }
    .filter-select { width:100%; padding:.7rem .9rem; border:2px solid #e0e0e0; border-radius:12px; background:#fff; font-size:.95rem; }
    .university-grid {
      display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:1rem;
      max-height:480px; overflow-y:auto; padding:1rem; border:1px solid #f0f0f0; border-radius:12px;
    }
    .university-card { background:#f8f9fa; border:2px solid transparent; border-radius:12px; padding:1rem; cursor:pointer; transition:.2s; }
    .university-card:hover { border-color:#1976d2; background:#f3f8ff; }
    .university-card.selected { border-color:#1976d2; background:#e3f2fd; }
    .university-header { display:flex; align-items:center; gap:1rem; margin-bottom:.5rem; }
    .university-logo { width:40px; height:40px; background:#1976d2; color:#fff; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:600; }
    .university-name { font-weight:600; color:#333; }
    .university-location { color:#666; font-size:.9rem; }
    .university-pill { margin-top:.25rem; display:inline-block; font-size:.75rem; color:#555; background:#eef3ff; border:1px solid #dbe7ff; padding:.15rem .5rem; border-radius:999px; }
    .pagination { display:flex; justify-content:space-between; align-items:center; margin-top:.75rem; }
    .pager { display:flex; gap:.5rem; }
    .page-btn { background:#fff; border:2px solid #e0e0e0; border-radius:10px; padding:.5rem .9rem; cursor:pointer; font-weight:600; }
    .page-btn[disabled] { opacity:.5; cursor:not-allowed; }
    .page-size { margin-left:auto; display:flex; align-items:center; gap:.5rem; }
    .selected-count { color:#1976d2; font-weight:600; margin-bottom:1rem; }
    .selected-list { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:2rem; }
    .selected-tag { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:.5rem 1rem; border-radius:20px; font-size:.9rem; display:flex; align-items:center; gap:.5rem; }
    .remove-tag { cursor:pointer; background:rgba(255,255,255,.2); border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .remove-tag:hover { background:rgba(255,255,255,.3); }
    .send-section { text-align:center; }
    .send-btn {
      background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; padding:1.2rem 3rem; border:none; border-radius:12px;
      font-size:1.2rem; font-weight:600; cursor:pointer; transition:.2s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .send-btn:disabled { background:#ccc; cursor:not-allowed; }
    .send-btn:not(:disabled):hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(76,175,80,.3); }
    .progress-section { display:none; }
    .progress-title { font-size:1.3rem; font-weight:600; color:#333; margin-bottom:1rem; text-align:center; }
    .progress-bar { width:100%; height:12px; background:#e0e0e0; border-radius:6px; overflow:hidden; margin-bottom:1rem; }
    .progress-fill { height:100%; background:linear-gradient(135deg,#4caf50,#66bb6a); border-radius:6px; transition:width .5s ease; width:0%; }
    .progress-text { text-align:center; color:#666; font-size:.9rem; }
    .delivery-list { margin-top:1rem; }
    .delivery-item { display:flex; align-items:center; gap:1rem; padding:.75rem; border-radius:8px; margin-bottom:.5rem; background:#f8f9fa; }
    .delivery-status { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .delivery-status.pending { background:#fff3e0; color:#ff9800; }
    .delivery-status.success { background:#e8f5e8; color:#4caf50; }
    .delivery-status.error { background:#ffebee; color:#f44336; }
    .success-section {
      display:none; background:linear-gradient(135deg,#e8f5e8,#f1f8e9);
      border:2px solid #4caf50; border-radius:16px; padding:2rem; text-align:center; box-shadow:0 8px 32px rgba(76,175,80,.2);
    }
    .success-icon { font-size:4rem; color:#4caf50; margin-bottom:1rem; }
    .success-title { font-size:1.8rem; font-weight:600; color:#2e7d32; margin-bottom:1rem; }
    .success-subtitle { color:#4caf50; margin-bottom:2rem; }
    .new-upload-btn { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:1rem 2rem; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition:.2s; }
    .new-upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    @keyframes flash { 0%{box-shadow:0 0 0 rgba(25,118,210,0);} 25%{box-shadow:0 0 0 6px rgba(25,118,210,.25);} 100%{box-shadow:0 0 0 rgba(25,118,210,0);} }
    .flash { animation: flash 1.2s ease; }
    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; font-size:.75rem; border-radius:999px; border:1px solid; }
    .badge-student { background:#f1f8ff; color:#0d47a1; border-color:#bbdefb; }
    .badge-added   { background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9; }
    .badge-removed { background:#ffebee; color:#b71c1c; border-color:#ffcdd2; }
    .toast-wrap { position: fixed; right: 16px; bottom: 16px; z-index: 99999; display: grid; gap: 8px; }
    .toast { min-width: 240px; max-width: 420px; padding: .75rem .9rem; border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.15); color:#0f172a; background:#fff; border:1px solid #e5e7eb;
      display:flex; align-items:flex-start; gap:.6rem; animation: toast-in .18s ease; }
    .toast.success { border-color:#c8e6c9; background:#f1f8f3; }
    .toast.error   { border-color:#ffcdd2; background:#fff2f2; }
    .toast.info    { border-color:#bbdefb; background:#f3f8ff; }
    .toast .icon { font-size: 1.1rem; line-height:1; margin-top:.1rem; }
    .toast .msg  { flex:1; font-size:.95rem; }
    .toast .x    { border:none; background:transparent; cursor:pointer; font-size:1rem; opacity:.6; }
    .toast .x:hover { opacity:.9; }
    @keyframes toast-in { from { transform: translateY(6px); opacity:0; } to { transform: translateY(0); opacity:1; } }
    .empty-state { display:none; background:#fff; border:1px dashed #d0d7de; border-radius:12px; padding:1.25rem; color:#445; text-align:center; }
    .empty-state .actions { margin-top:.75rem; display:flex; gap:.5rem; justify-content:center; }
    /* Student view (B) */
    .student-card {
      background:#fff; border-radius:16px; padding:1.25rem 1.5rem;
      box-shadow:0 8px 32px rgba(0,0,0,.08);
    }
    .student-tabs {
      display:flex; gap:.4rem; background:#f1f5f9; border-radius:999px; padding:.2rem;
      border:1px solid #e5e7eb; margin-bottom:.9rem;
      justify-content: space-between; /* NEW: positions left / center / right */
      width: 100%;                    /* ensure full row width */
    }
    .student-tab {
      appearance:none; background:transparent; border:0; cursor:pointer;
      padding:.5rem 1rem; border-radius:999px; font-weight:700; color:#334155;
    }
    .student-tab[aria-selected="true"] {
      background:#fff; color:#0f172a; box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    .student-panels > section { display:block; }
    .student-panels > section[hidden] { display:none; }
    .table { width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
      border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
    .table th, .table td { padding:.7rem .8rem; text-align:left; border-bottom:1px solid #eef2f7; }
    .table th { background:#f8fafc; color:#334155; font-weight:700; }
    .table tr:last-child td { border-bottom:none; }
    .track-pill { display:inline-block; padding:.2rem .6rem; border-radius:999px; font-weight:700; font-size:.8rem; }
    .track-pill.pending { background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
    .track-pill.sent    { background:#ecfeff; color:#155e75; border:1px solid #a5f3fc; }
    .track-pill.received{ background:#ecfdf5; color:#166534; border:1px solid #bbf7d0; }
    @media (max-width:768px) {
      .container { padding:1rem; }
      .hero-title { font-size:2rem; }
      .university-grid { grid-template-columns:1fr; }
      .header-content { flex-direction:column; gap:1rem; }
      .filter-bar { grid-template-columns:1fr 1fr; }
    }
    /* Dark theme basics (CSS side) */
    :root[data-theme="dark"] {
      --bg:#0b1220; --panel:#111a2a; --text:#e5eefc; --muted:#93a3bc; --primary:#7aa2ff; --border:#24324a;
    }
    :root[data-theme="dark"] body { background: linear-gradient(135deg,#0b1220 0%,#0f1729 100%); color: var(--text); }
    :root[data-theme="dark"] .upload-section,
    :root[data-theme="dark"] .writer-section,
    :root[data-theme="dark"] .university-section,
    :root[data-theme="dark"] .selected-section,
    :root[data-theme="dark"] .progress-section { background: var(--panel); box-shadow:none; }
    :root[data-theme="dark"] .filter-select,
    :root[data-theme="dark"] .writer-title,
    :root[data-theme="dark"] .writer-box,
    :root[data-theme="dark"] .page-btn { background:#0f1729; color:var(--text); border-color: var(--border); }
    :root[data-theme="dark"] .university-card { background:#0f1729; }
    :root[data-theme="dark"] .university-card:hover { background:#12203a; border-color:#274780; }
    :root[data-theme="dark"] .university-card.selected { background:#13254a; }
    :root[data-theme="dark"] .hero-subtitle, :root[data-theme="dark"] .university-location { color: var(--muted); }
    :root[data-theme="dark"] .hdr-tabs { background:#ffffff11; border-color:#ffffff33; }
    :root[data-theme="dark"] .hdr-tab { color:#e5eefc; }
    :root[data-theme="dark"] .hdr-tab[aria-selected="true"] { background:#0f1729; color:#7aa2ff; }
    :root[data-theme="dark"] .student-card,
    :root[data-theme="dark"] .table,
    :root[data-theme="dark"] .student-tabs { background:#111a2a; border-color:#24324a; }
    :root[data-theme="dark"] .table th { background:#0f1729; color:#e5eefc; }
    :root[data-theme="dark"] .student-tab { color:#c9d6ee; }
    :root[data-theme="dark"] .student-tab[aria-selected="true"] { background:#0f1729; color:#7aa2ff; }
    /* Footer (match header) */
    .site-footer {
      background: linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color: #fff;
      padding: 1.5rem 0;
      text-align: center;
    }
    .site-footer p { margin: 0; font-size: 0.95rem; }
    .theme-btn {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.55rem 1rem; border-radius:999px;
      border:1px solid #ffffff55; background:#ffffff22; color:#fff; font-weight:600;
      cursor:pointer; transition: transform .15s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .theme-btn:hover { transform: translateY(-1px); background:#ffffff33; border-color:#ffffff88; }
    .theme-btn:focus-visible { outline:3px solid rgba(255,255,255,.5); outline-offset:2px; }
    .theme-btn .material-icons { font-size:18px; }
    /* unify apply/page buttons in student view */
    .apply-btn {
      background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; border:none;
      padding:.6rem 1rem; border-radius:10px; font-weight:700; cursor:pointer;
    }
    .apply-btn:hover { transform:translateY(-1px); box-shadow:0 8px 20px rgba(25,118,210,.25); }
    /* Intake card (link paste) */
.intake-card {
  background:#fff; border-radius:16px; padding:1.25rem 1.5rem;
  box-shadow:0 8px 32px rgba(0,0,0,.08); margin:1rem auto 1.25rem;
  border:1px solid #e5e7eb; max-width:1200px;
}
.intake-row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
.intake-title { display:flex; align-items:center; gap:.5rem; font-size:1.25rem; font-weight:700; color:#0f172a; }
.intake-actions { display:flex; gap:.5rem; }
.intake-sub { color:#475569; margin:.35rem 0 .75rem; }
.intake-inputs { display:flex; gap:.5rem; align-items:center; }
.intake-inputs .filter-select { flex:1; }
.intake-status { margin-top:.6rem; font-size:.95rem; color:#334155; }
.intake-details { margin-top:.5rem; }
.intake-help { background:#f8fafc; padding:.75rem; border-radius:10px; border:1px solid #e5e7eb; color:#334155; }
.intake-summary {
  margin-top:.75rem; border-top:1px dashed #e5e7eb; padding-top:.6rem;
  font-size:.95rem; color:#0f172a; display:grid; gap:.35rem;
}
.intake-summary .ok { color:#166534; }
.intake-summary .warn { color:#9a3412; }
.intake-summary .muted { color:#64748b; }

:root[data-theme="dark"] .intake-card { background:#111a2a; border-color:#24324a; box-shadow:none; }
:root[data-theme="dark"] .intake-sub, 
:root[data-theme="dark"] .intake-help { color:#c9d6ee; background:#0f1729; border-color:#24324a; }
:root[data-theme="dark"] .intake-summary { color:#e5eefc; border-color:#24324a; }

/* NEW: autosuggest popover styling (kept minimal) */
.suggest-popover{
  position:absolute; top:100%; left:0; right:0; z-index:50; margin-top:.25rem;
  background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 12px 24px rgba(0,0,0,.08);
  max-height:320px; overflow:auto; padding:.25rem;
}
.suggest-item{
  padding:.5rem .6rem; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;
}
.suggest-item:hover{ background:#f8fafc; }
:root[data-theme="dark"] .suggest-popover{ background:#0f1729; border-color:#24324a; }
:root[data-theme="dark"] .suggest-item:hover{ background:#111f38; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <div class="header-content">
      <!-- Left: Logo -->
      <a href="/" class="logo" target="_self" aria-label="Go to homepage">
        <span class="material-icons">star</span>
        stellarrec
      </a>
      <!-- Center: Student / Recommender toggles -->
      <nav class="header-nav" role="tablist" aria-label="Choose portal">
        <div class="nav-left">
          <button class="nav-link" data-view="student" role="tab" aria-selected="true" type="button">Student</button>
        </div>
        <div class="nav-right">
          <button class="nav-link" data-view="recommender" role="tab" aria-selected="false" type="button">Recommender</button>
        </div>
      </nav>
      <!-- Right: Theme + Avatar -->
      <div class="right-controls">
        <button id="headerThemeBtn" class="theme-btn" type="button" aria-pressed="false" title="Toggle theme">
          <span class="material-icons" aria-hidden="true">dark_mode</span>
          Light / Dark
        </button>
        <div class="user-info">
          <button class="user-avatar" id="userAvatarBtn" aria-haspopup="true" aria-expanded="false" type="button">
            <span class="material-icons">person</span>
          </button>
          <div class="user-dropdown" id="userDropdown" role="menu" aria-hidden="true">
            <div class="dropdown-header">Quick actions</div>
            <div class="dropdown-item" role="menuitem" tabindex="0">
              <span class="material-icons">help_outline</span>
              <div class="view-label">
                <a href="https://stellarrec.netlify.app/portal-signin"
                   class="view-name" style="text-decoration:none; color:inherit;" target="_self">
                  How it works
                </a>
                <div class="view-description">Sign-in portal</div>
              </div>
            </div>
            <div class="dropdown-item" id="contactAdminItem" role="menuitem" tabindex="0">
              <span class="material-icons">support_agent</span>
              <div class="view-label">
                <div class="view-name">Contact admin</div>
                <div class="view-description">Send a message</div>
              </div>
            </div>
            <div class="dropdown-item" style="border-top:1px solid #f0f0f0;">
              <label for="mockToggle" style="display:flex; align-items:center; gap:.75rem; width:100%; cursor:pointer;">
                <span class="material-icons">build</span>
                <div class="view-label">
                  <div class="view-name">Use mock API</div>
                  <div class="view-description">Toggle mock vs real backend</div>
                </div>
                <input id="mockToggle" type="checkbox" style="margin-left:auto; width:18px; height:18px;" />
              </label>
            </div>
          </div>
        </div><!-- /.user-info -->
      </div><!-- /.right-controls -->
    </div><!-- /.header-content -->
  </div><!-- /.header -->
    <!-- MAIN — RECOMMENDER VIEW (hidden by default) -->
  <div class="container" id="panel-recommender" hidden>
    <!-- Student Link Intake -->
    <div class="intake-card" id="linkIntake">
      <div class="intake-row">
        <h2 class="intake-title">
          <span class="material-icons" aria-hidden="true">link</span>
          Paste student link
        </h2>
        <div class="intake-actions">
          <button class="page-btn" id="linkHelpBtn" type="button" title="What does this do?">What’s this?</button>
        </div>
      </div>

      <p class="intake-sub">Paste the link you received by email from the student. We’ll import their details and selected universities.</p>

      <div class="intake-inputs">
        <input id="linkInput" class="filter-select" type="url" placeholder="Paste the student link here… e.g. https://example.com/reco?sf=Jane&sl=Doe&se=jane@email.com&waive=1&unis=166027,110635" />
        <button id="linkParseBtn" class="apply-btn" type="button">Import</button>
      </div>

      <div id="linkStatus" class="intake-status" aria-live="polite"></div>

      <details id="linkFormatDetails" class="intake-details">
        <summary>Expected link format (examples)</summary>
        <div class="intake-help">
          <div><b>With unit IDs (best):</b><br>
            <code>?sf=Jane&sl=Doe&se=jane@email.com&sp=2065551212&waive=1&unis=166027,110635&rname=Prof%20Smith&remail=smith@uni.edu&rphone=2125559876</code>
          </div>
          <div><b>With names (we’ll match):</b><br>
            <code>?sf=Jane&sl=Doe&se=jane@email.com&waive=0&unames=Harvard%20University,Stanford%20University</code>
          </div>
          <div style="margin-top:.35rem;">
            <small>
              Params: <code>sf</code>=student first, <code>sl</code>=student last, <code>se</code>=student email, <code>sp</code>=student phone,
              <code>waive</code>=1/0, <code>unis</code>=CSV of unitids, <code>unames</code>=CSV of names,
              <code>rname</code>=recommender name, <code>remail</code>=recommender email, <code>rphone</code>=recommender phone.
            </small>
          </div>
        </div>
      </details>

      <div id="linkSummary" class="intake-summary" hidden></div>
    </div>

    <!-- Hero -->
    <div class="hero-section">
      <h1 class="hero-title">One upload. Unlimited reach.</h1>
      <p class="hero-subtitle">Upload your recommendation letter once and send it to multiple US universities instantly.</p>
    </div>

    <div class="compose-grid">
      <!-- (A) Upload PDF (left) -->
      <div class="upload-section" id="uploadSection">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon"><span class="material-icons">cloud_upload</span></div>
          <h2 class="upload-title">Upload Recommendation Letter (PDF)</h2>
          <p class="upload-subtitle">Drag & drop your PDF here, or click to browse</p>
          <div id="uploadHint" style="margin:.5rem 0 0; font-size:.9rem; color:#556;">PDF only. Recommended size ≤ 10 MB.</div>

          <input type="file" id="fileInput" class="file-input" accept=".pdf,application/pdf" />
          <button class="upload-btn" id="chooseFileBtn">
            <span class="material-icons">upload_file</span> Choose PDF
          </button>
        </div>

        <div class="uploaded-file" id="uploadedFile">
          <div class="file-info">
            <div class="file-icon"><span class="material-icons">description</span></div>
            <div class="file-details">
              <h3 id="fileName">recommendation-letter.pdf</h3>
              <p id="fileSize">—</p>
            </div>
            <button class="remove-file" id="removeFileBtn" title="Remove PDF">
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>
      </div>

      <!-- (B) Upload Video (right) -->
      <div class="upload-section" id="videoUploadSection">
        <div class="upload-area" id="videoUploadArea">
          <div class="upload-icon"><span class="material-icons">videocam</span></div>
          <h2 class="upload-title">Upload Intro/Context Video (optional)</h2>
          <p class="upload-subtitle">Drag & drop your video here, or click to browse</p>
          <div style="margin:.5rem 0 0; font-size:.9rem; color:#556;">
            Supported: MP4 / MOV / WEBM. Tip: keep it short (≤ 2–3 min).
          </div>

          <input type="file" id="videoInput" class="file-input" accept="video/mp4,video/quicktime,video/webm" />
          <button class="upload-btn" id="chooseVideoBtn">
            <span class="material-icons">video_file</span> Choose Video
          </button>
        </div>

        <div class="uploaded-file" id="uploadedVideo">
          <div class="file-info" style="align-items:flex-start;">
            <div class="file-icon"><span class="material-icons">smart_display</span></div>
            <div class="file-details" style="flex:1;">
              <h3 id="videoName">intro.mp4</h3>
              <p id="videoSize">—</p>
              <!-- Optional inline preview -->
              <video id="videoPreview" class="video-preview" controls playsinline style="display:none; margin-top:.6rem; max-height:240px; width:100%; border-radius:10px; background:#000;"></video>
            </div>
            <button class="remove-video" id="removeVideoBtn" title="Remove video" style="background:none;border:none;color:#666;cursor:pointer;padding:.5rem;border-radius:50%;transition:.2s;">
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>
      </div>

      <!-- (C) Writer (full width on a new row) -->
      <div class="writer-section" id="writerSection" style="grid-column:1 / -1;">
        <h2 class="section-title"><span class="material-icons">edit</span> Write Letter</h2>
        <input id="writerTitle" class="writer-title" placeholder="Letter title (optional, e.g., 'Recommendation for Jane Doe')" />
        <div class="writer-toolbar">
          <button class="btn btn-muted" data-wcmd="bold" title="Bold (Ctrl/Cmd+B)"><b>B</b></button>
          <button class="btn btn-muted" data-wcmd="italic" title="Italic (Ctrl/Cmd+I)"><i>I</i></button>
          <button class="btn btn-muted" data-wcmd="underline" title="Underline (Ctrl/Cmd+U)"><u>U</u></button>
          <div class="meta">
            <span id="writerCount">0 words • 0 chars</span>
            <span id="writerSaved">Not saved</span>
          </div>
        </div>
        <div id="writerBox" class="writer-box" contenteditable="true" aria-label="Letter editor"
             placeholder="Write your recommendation letter here..."></div>
        <div class="writer-actions">
          <button class="btn btn-primary" id="saveDraftBtn">Save draft</button>
          <button class="btn btn-muted" id="restoreDraftBtn">Restore</button>
          <button class="btn btn-danger" id="clearDraftBtn">Clear</button>
          <button class="btn btn-muted" id="copyDraftBtn">Copy</button>
          <button class="btn btn-muted" id="downloadDraftBtn">Download .txt</button>
          <button class="btn btn-success" id="attachDraftBtn">Attach draft</button>
          <label style="display:flex; align-items:center; gap:.4rem; margin-left:auto;">
            <input type="checkbox" id="writerAutosaveToggle" checked />
            Autosave
          </label>
        </div>
      </div>
    </div>

    <!-- Selected Universities (KEEP in Recommender) -->
    <div class="selected-section">
      <h2 class="section-title" style="display:flex;align-items:center;gap:.5rem;">
        <span class="material-icons">check_circle</span> Selected Universities
        <button id="copyLinkBtn" class="page-btn" title="Copy shareable link" style="margin-left:auto;">Copy link</button>
      </h2>
      <div class="selected-count" id="selectedCount">0 universities selected</div>
      <div class="selected-list" id="selectedList" role="list" aria-live="polite"></div>
      <div class="send-section">
        <button class="send-btn" id="sendBtn" disabled>
          <span class="material-icons">send</span>
          Send to Selected Universities
        </button>
      </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progressSection">
      <h2 class="progress-title">Sending Letters...</h2>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText" aria-live="polite">Preparing to send...</div>
      <div class="delivery-list" id="deliveryList"></div>
    </div>

    <!-- Success Section -->
    <div class="success-section" id="successSection">
      <div class="success-icon"><span class="material-icons">check_circle</span></div>
      <h2 class="success-title">Letters Sent Successfully!</h2>
      <p class="success-subtitle">Your recommendation letter has been delivered to all selected universities.</p>
      <button class="new-upload-btn" id="newUploadBtn">
        <span class="material-icons">add</span>
        Send Another Letter
      </button>
    </div>

    <!-- Confirm Send Modal -->
    <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(720px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1.2rem 1.4rem; border-bottom:1px solid:#eee; display:flex; justify-content:space-between; align-items:center;">
          <div id="confirmModalTitle" style="font-weight:700;">Confirm recipients</div>
          <button aria-label="Close" id="modalCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1.2rem 1.4rem; max-height:60vh; overflow:auto; line-height:1.45;">
          <div id="modalSummary" style="margin-bottom:1rem;"></div>
          <div id="modalLists" style="display:grid; gap:1rem;">
            <div>
              <div style="font-weight:600;">Included (<span id="modalIncludedCount">0</span>)</div>
              <div id="modalIncluded"></div>
            </div>
            <div>
              <div style="font-weight:600;">Removed vs student’s list (<span id="modalRemovedCount">0</span>)</div>
              <div id="modalRemoved" style="color:#b00020;"></div>
            </div>
            <div>
              <div style="font-weight:600;">Added by you (<span id="modalAddedCount">0</span>)</div>
              <div id="modalAdded" style="color:#1b5e20;"></div>
            </div>
          </div>
        </div>
        <div style="padding:1rem 1.4rem; border-top:1px solid:#eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="modalCancelBtn">Cancel</button>
          <button class="apply-btn" id="modalConfirmBtn">Send now</button>
        </div>
      </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="importModal" role="dialog" aria-modal="true" aria-labelledby="importTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(680px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1rem 1.2rem; border-bottom:1px solid:#eee; display:flex; justify-content:space-between; align-items:center;">
          <div id="importTitle" style="font-weight:700;">Bulk import universities</div>
          <button aria-label="Close" id="importCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1rem 1.2rem; display:grid; gap:.75rem;">
          <div style="font-size:.92rem; color:#556;">
            Paste one <b>name per line</b>. We’ll fuzzy-match against the master list.
          </div>
          <textarea id="importTextarea" rows="10" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;"></textarea>
          <div id="importPreview" style="font-size:.9rem; color:#667;"></div>
        </div>
        <div style="padding:1rem 1.2rem; border-top:1px solid:#eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="importCancelBtn">Cancel</button>
          <button class="apply-btn" id="importConfirmBtn">Add matches</button>
        </div>
      </div>
    </div>
    <!-- Contact Admin Overlay -->
    <div id="contactOverlay" role="dialog" aria-modal="true" aria-labelledby="contactTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:10000;">
      <div style="background:#fff; width:min(560px,92vw); border-radius:16px; box-shadow:0 18px 50px rgba(0,0,0,.22); overflow:hidden; transform:translateY(12px); opacity:0; transition:.18s;">
        <div style="padding:1rem 1.25rem; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
          <div id="contactTitle" style="font-weight:700;">Contact admin</div>
          <button aria-label="Close" id="contactCloseBtn2" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <form id="contactForm2" style="padding:1rem 1.25rem; display:grid; gap:.75rem;">
          <div>
            <label for="cFirst2" style="display:block; font-weight:600; margin-bottom:.35rem;">First name</label>
            <input id="cFirst2" name="first" class="filter-select" type="text" placeholder="Your first name" required />
          </div>
          <div>
            <label for="cEmail2" style="display:block; font-weight:600; margin-bottom:.35rem;">Email address</label>
            <input id="cEmail2" name="email" class="filter-select" type="email" placeholder="you@example.com" required />
          </div>
          <div>
            <label for="cQuery2" style="display:block; font-weight:600; margin-bottom:.35rem;">Query</label>
            <textarea id="cQuery2" name="query" rows="5" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;" placeholder="How can we help?" required></textarea>
          </div>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid #f1f5f9; padding-top:.75rem;">
            <button type="button" class="page-btn" id="contactCancelBtn2">Cancel</button>
            <button type="submit" class="apply-btn" id="contactSendBtn2">Send</button>
          </div>
          <input type="hidden" name="form-name" value="contact-admin">
        </form>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>
  </div><!-- /.container (Recommender) -->
  <!-- STUDENT VIEW (default visible) -->
  <div class="container" id="panel-student">
    <div class="student-card" style="margin-bottom:1rem;">
      <h1 class="hero-title" style="margin:0 0 .4rem;">Student Portal</h1>
      <p class="hero-subtitle" style="margin:0 0 .8rem;">Request recommendations and track their status.</p>

      <div class="student-tabs" role="tablist" aria-label="Student actions">
        <!-- REORDERED: Select (left), Send (center), Track (right) -->
        <button id="stuTabSelect" class="student-tab" role="tab" aria-selected="false" type="button">
          Select Universities
        </button>
        <button id="stuTabSend" class="student-tab" role="tab" aria-selected="true" type="button">
          Send Recommendation Request
        </button>
        <button id="stuTabTrack" class="student-tab" role="tab" aria-selected="false" type="button">
          Track Recommendation &amp; Status
        </button>
      </div>

      <div class="student-panels">
        <!-- Send -->
        <section id="stuPanelSend">
          <form id="stuSendForm" class="student-card" style="padding:1rem; box-shadow:none; border:1px solid #e5e7eb;">
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:.75rem;">
              <div>
                <label style="font-weight:600; display:block; margin-bottom:.25rem;">Your Name</label>
                <input id="stuName" class="filter-select" type="text" placeholder="Student full name" required />
              </div>
              <div>
                <label style="font-weight:600; display:block; margin-bottom:.25rem;">Your Email</label>
                <input id="stuEmail" class="filter-select" type="email" placeholder="you@example.com" required />
              </div>
              <div>
                <label style="font-weight:600; display:block; margin-bottom:.25rem;">Recommender Name</label>
                <input id="recName" class="filter-select" type="text" placeholder="Prof. Jane Smith" required />
              </div>
              <div>
                <label style="font-weight:600; display:block; margin-bottom:.25rem;">Recommender Email</label>
                <input id="recEmail" class="filter-select" type="email" placeholder="jane@university.edu" required />
              </div>
            </div>
            <div style="margin-top:.75rem; display:flex; gap:.5rem; justify-content:flex-end;">
              <button type="reset" class="page-btn">Clear</button>
              <button type="submit" class="apply-btn">Send Request</button>
            </div>
          </form>
        </section>

        <!-- Select (moved to left tab, content unchanged) -->
        <section id="stuPanelSelect" hidden>
          <div class="university-section">
            <h2 class="section-title"><span class="material-icons">school</span> Select Universities</h2>

            <!-- Search + Apply + Bulk import -->
            <div class="university-search" style="position:relative; display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem;">
              <input
                type="text"
                class="search-input filter-select"
                placeholder="Search universities..."
                id="universitySearch"
                autocomplete="off"
                aria-autocomplete="list"
                aria-expanded="false"
                aria-owns="searchSuggest"
              />
              <button class="apply-btn" id="searchApplyBtn" title="Apply search (Enter)" type="button">Apply</button>
              <button class="page-btn" id="bulkImportBtn" title="Bulk import by names" type="button">Bulk import</button>
              <div id="searchSuggest" class="suggest-popover" style="display:none;"></div>
            </div>

            <!-- Browse-all dropdown -->
            <select id="universitySelect" class="filter-select" title="Browse all universities" style="margin-bottom:.5rem;">
              <option value="" selected disabled>Browse all universities (6000+)</option>
            </select>

            <!-- Filters -->
            <div class="filter-meta" id="resultMeta" aria-live="polite">Showing 0 of 0</div>
            <div class="filter-bar">
              <select id="stateFilter" class="filter-select" aria-label="Filter by state">
                <option value="">All states</option>
                <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option>
                <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option>
                <option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
                <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option>
                <option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
                <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option>
                <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
                <option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
              </select>

              <select id="typeFilter" class="filter-select" aria-label="Filter by institution type">
                <option value="">All types</option>
                <option value="Public">Public</option>
                <option value="Private nonprofit">Private nonprofit</option>
                <option value="Private for-profit">Private for-profit</option>
              </select>

              <select id="levelFilter" class="filter-select" aria-label="Filter by level">
                <option value="">All levels</option>
                <option value="4-year">4-year</option>
                <option value="2-year">2-year</option>
                <option value="Less-than-2-year">Less-than-2-year</option>
              </select>

              <select id="sortBy" class="filter-select" aria-label="Sort results">
                <option value="name_asc">Sort: Name (A–Z)</option>
                <option value="state_asc">Sort: State (A–Z)</option>
              </select>

              <button class="apply-btn" id="filterApplyBtn" title="Apply filters and sort" type="button">Apply filters</button>
              <button class="apply-btn" id="resetBtn" title="Reset search and filters" type="button">Reset</button>
            </div>

            <!-- Empty state -->
            <div id="emptyState" class="empty-state" aria-live="polite">
              <div style="font-weight:600; margin-bottom:.25rem;">No universities match your filters</div>
              <div style="font-size:.9rem; color:#667;">Try adjusting search or clearing filters.</div>
              <div class="actions">
                <button class="apply-btn" id="clearFiltersBtn" type="button">Clear filters</button>
                <button class="page-btn" id="retryLoadBtn" style="display:none;" type="button">Retry loading</button>
              </div>
            </div>

            <!-- Results grid -->
            <div class="university-grid" id="universityGrid" role="list" aria-label="Universities list"></div>

            <!-- Pagination -->
            <div class="pagination">
              <div class="pager">
                <button class="page-btn" id="prevPage">Prev</button>
                <span id="pageInfo" style="font-weight:600;">Page 1 of 1</span>
                <button class="page-btn" id="nextPage">Next</button>
              </div>
              <div class="page-size">
                <label for="pageSize">Per page:</label>
                <select id="pageSize" class="filter-select" style="width:auto;display:inline-block;">
                  <option value="20">20</option>
                  <option value="40" selected>40</option>
                  <option value="80">80</option>
                  <option value="120">120</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Selected Universities (read-only for Student) -->
          <div class="selected-section">
            <h2 class="section-title" style="display:flex;align-items:center;gap:.5rem;">
              <span class="material-icons">check_circle</span> Selected Universities
            </h2>
            <div class="selected-count" id="selectedCountStu">0 universities selected</div>
            <div class="selected-list" id="selectedListStu" role="list" aria-live="polite"></div>
          </div>
        </section>

        <!-- Track -->
        <section id="stuPanelTrack" hidden>
          <div class="student-card" style="padding:0; overflow:hidden;">
            <table class="table" aria-label="Recommendation requests">
              <thead>
                <tr>
                  <th>Recommender</th>
                  <th>Email</th>
                  <th>Requested</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="stuTrackBody">
                <!-- Populated by dashboard.js -->
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">
      <p>&copy; 2025 <span style="color: #ffeb3b; font-weight: 600;">StellarRec™</span>. All rights reserved. |
        Making recommendations stellar since 2025 🚀</p>
    </div>
  </footer>

<!-- Vendor scripts (CDN, with cache-busting) -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js?v=2025-09-06" defer></script>
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js?v=2025-09-06" defer></script>

<!-- Your app code (keep after vendors; add cache-busting too) -->
<script src="/assets/js/dashboard.js?v=2025-09-06-1" defer></script>
<script src="/assets/js/university-search.js?v=2025-09-06-1" defer></script>
<script>
/* ==== Core state (kept tiny; persists) ==== */
const SR_LS_KEY = 'sr_state_v1';
const srSafe = {
  get(){ try { return JSON.parse(localStorage.getItem(SR_LS_KEY)||'{}'); } catch(e){ return {}; } },
  set(data){ try { localStorage.setItem(SR_LS_KEY, JSON.stringify(data)); } catch(e){} }
};
const SR = {
  universities: [],         // full master (6000+)
  filtered: [],             // after search/filters
  page: 1,
  perPage: 40,
  q: '',
  filters: { state:'', type:'', level:'', sort:'name_asc' },
  selected: new Set(),      // unitid strings
  requests: [],             // {id, unitid, uniName, who, email, ts, status}
  studentTrack: [],         // mirrors requests for Student view
  mockPinned: 'MOCK-0000',  // Mock University id
  fuse: null
};

/* ==== Data bootstrap (fallback generator if external script not present) ==== */
(function bootstrapData(){
  // if window.universities already defined by /assets/js/university-search.js, use it.
  if (Array.isArray(window.universities) && window.universities.length > 0) {
    SR.universities = normalize(window.universities);
  } else {
    // generate synthetic US-like list 6,500+
    const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
    const TYPES = ["Public","Private nonprofit","Private for-profit"];
    const LEVELS = ["4-year","2-year","Less-than-2-year"];
    const list = [];
    let idx = 1;
    // Add some named anchors
    const anchors = [
      { name:"Harvard University",           state:"MA", type:"Private nonprofit", level:"4-year" },
      { name:"Stanford University",          state:"CA", type:"Private nonprofit", level:"4-year" },
      { name:"Massachusetts Institute of Technology", state:"MA", type:"Private nonprofit", level:"4-year" },
      { name:"University of California, Berkeley", state:"CA", type:"Public", level:"4-year" },
      { name:"Georgia Institute of Technology", state:"GA", type:"Public", level:"4-year" },
    ];
    anchors.forEach(a=>{
      list.push({ unitid:String(100000+idx++), name:a.name, state:a.state, type:a.type, level:a.level });
    });
    for (; idx<=6500; idx++){
      const st = STATES[idx % STATES.length];
      const tp = TYPES[idx % TYPES.length];
      const lv = LEVELS[idx % LEVELS.length];
      const name = (idx % 7 === 0) ? `${st} State University ${idx}` :
                   (idx % 5 === 0) ? `${st} Institute of Technology ${idx}` :
                                     `University ${idx}`;
      list.push({ unitid:String(100000+idx), name, state:st, type:tp, level:lv });
    }
    SR.universities = normalize(list);
  }

  // ensure Mock pre-selected presence in master
  if (!SR.universities.find(u=>u.unitid===SR.mockPinned)) {
    SR.universities.unshift({ unitid:SR.mockPinned, name:"Mock University", state:"CA", type:"Private nonprofit", level:"4-year" });
  }

  // Fuse for autosuggest
  SR.fuse = new Fuse(SR.universities, {
    keys: ["name"], includeScore:false, threshold:0.3, minMatchCharLength:2
  });

  // restore persisted selection/requests
  const saved = srSafe.get();
  if (Array.isArray(saved.requests)) SR.requests = saved.requests;
  if (Array.isArray(saved.studentTrack)) SR.studentTrack = saved.studentTrack;
  const initialSelected = new Set(Array.isArray(saved.selectedIds)? saved.selectedIds : []);
  // always keep Mock preselected
  initialSelected.add(SR.mockPinned);
  SR.selected = initialSelected;

  // initial filtered == all
  SR.filtered = SR.universities.slice(0);
})();

function normalize(arr){
  return arr.map(u=>({
    unitid: String(u.unitid ?? u.id ?? u.code ?? Math.random().toString(36).slice(2,9)),
    name:   String(u.name),
    state:  String(u.state ?? u.province ?? u.region ?? ''),
    type:   String(u.type  ?? u.inst_type ?? 'Public'),
    level:  String(u.level ?? u.inst_level ?? '4-year')
  }));
}

/* ==== Utilities ==== */
const $ = (sel, root=document)=> root.querySelector(sel);
const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
const toast = (msg, type='info')=>{
  const wrap = $('#toastWrap'); if(!wrap) return;
  const div = document.createElement('div');
  div.className = `toast ${type}`;
  div.innerHTML = `<span class="icon material-icons">${type==='error'?'error':'check_circle'}</span><div class="msg">${msg}</div><button class="x" aria-label="Dismiss">✕</button>`;
  wrap.appendChild(div);
  const close = ()=>{ div.remove(); };
  div.querySelector('.x').addEventListener('click', close);
  setTimeout(close, 3200);
};
const persist = ()=>{
  srSafe.set({
    selectedIds: Array.from(SR.selected),
    requests: SR.requests,
    studentTrack: SR.studentTrack
  });
};

/* ==== Selected Lists (Student & Recommender) ==== */
function updateSelectedList(){
  // Recommender list (selectedList)
  const wrap = $('#selectedList'); if (wrap) {
    wrap.innerHTML = '';
    Array.from(SR.selected).forEach(id=>{
      const u = SR.universities.find(x=>x.unitid===id);
      if(!u) return;
      const chip = document.createElement('div');
      chip.className = 'selected-tag';
      chip.innerHTML = `
        <span class="material-icons" aria-hidden="true">school</span>
        ${u.name}
        <span class="remove-tag" role="button" title="Remove" ${id===SR.mockPinned?'style="opacity:.4;pointer-events:none;"':''}>✕</span>
      `;
      chip.querySelector('.remove-tag')?.addEventListener('click', ()=>{ removeSelected(id); });
      wrap.appendChild(chip);
    });
    $('#selectedCount').textContent = `${SR.selected.size} universities selected`;
  }
  // Student read-only list
  const wrapS = $('#selectedListStu'); if (wrapS) {
    wrapS.innerHTML = '';
    Array.from(SR.selected).forEach(id=>{
      const u = SR.universities.find(x=>x.unitid===id);
      if(!u) return;
      const chip = document.createElement('div');
      chip.className = 'selected-tag';
      chip.innerHTML = `<span class="material-icons" aria-hidden="true">task_alt</span>${u.name}`;
      wrapS.appendChild(chip);
    });
    $('#selectedCountStu').textContent = `${SR.selected.size} universities selected`;
  }
  updateSendButton();
}
function addSelected(id){
  if (!id) return;
  SR.selected.add(String(id));
  // keep Mock pinned (cannot be removed via Clear)
  if (!SR.selected.has(SR.mockPinned)) SR.selected.add(SR.mockPinned);
  updateSelectedList();
  persist();
}
function removeSelected(id){
  if (id===SR.mockPinned) return; // keep
  SR.selected.delete(String(id));
  updateSelectedList();
  persist();
}
function updateSendButton(){
  const btn = $('#sendBtn');
  if (btn) btn.disabled = SR.selected.size === 0;
}

/* ==== Search / Filters / Pagination / Autosuggest ==== */
function applyFilters(){
  const q = SR.q.trim().toLowerCase();
  let arr = SR.universities;
  if (q){
    // use Fuse for quality
    const top = SR.fuse.search(q).slice(0, 300).map(r=>r.item);
    // also include plain contains for coverage
    const plain = SR.universities.filter(u=>u.name.toLowerCase().includes(q)).slice(0, 300);
    const map = new Map();
    [...top, ...plain].forEach(u=>map.set(u.unitid, u));
    arr = Array.from(map.values());
  }
  if (SR.filters.state) arr = arr.filter(u=>u.state===SR.filters.state);
  if (SR.filters.type)  arr = arr.filter(u=>u.type===SR.filters.type);
  if (SR.filters.level) arr = arr.filter(u=>u.level===SR.filters.level);

  // sort
  if (SR.filters.sort==='name_asc') arr.sort((a,b)=>a.name.localeCompare(b.name));
  if (SR.filters.sort==='state_asc') arr.sort((a,b)=>(a.state||'').localeCompare(b.state||'') || a.name.localeCompare(b.name));

  SR.filtered = arr;
  SR.page = 1;
  renderGrid();
}

function renderGrid(){
  const grid = $('#universityGrid'); if(!grid) return;
  grid.innerHTML = '';
  const per = SR.perPage;
  const total = SR.filtered.length || 0;
  const totalPages = Math.max(1, Math.ceil(total / per));
  SR.page = Math.min(Math.max(1, SR.page), totalPages);
  const start = (SR.page-1)*per, end = start + per;
  const rows = SR.filtered.slice(start, end);
  rows.forEach(u=>{
    const card = document.createElement('div');
    card.className = 'university-card';
    if (SR.selected.has(u.unitid)) card.classList.add('selected');
    card.innerHTML = `
      <div class="university-header">
        <div class="university-logo">${(u.name||'U').slice(0,2).toUpperCase()}</div>
        <div>
          <div class="university-name">${u.name}</div>
          <div class="university-location">${u.state || '—'} • ${u.type} • ${u.level}</div>
          <span class="university-pill">UnitID: ${u.unitid}</span>
        </div>
      </div>
      <button class="apply-btn" data-id="${u.unitid}">${SR.selected.has(u.unitid)?'Selected':'Apply'}</button>
    `;
    card.querySelector('.apply-btn').addEventListener('click', (e)=>{
      const id = e.currentTarget.getAttribute('data-id');
      addSelected(id);
      e.currentTarget.textContent = 'Selected';
      card.classList.add('selected');
      toast(`Added “${u.name}” to Selected Universities`,'success');
    });
    grid.appendChild(card);
  });
  // meta + pagination bits
  $('#resultMeta').textContent = `Showing ${Math.min(end,total)} of ${total}`;
  $('#pageInfo').textContent = `Page ${SR.page} of ${totalPages}`;
  $('#emptyState').style.display = total ? 'none' : 'block';
}

function populateBrowseDropdown(){
  const sel = $('#universitySelect'); if(!sel) return;
  // clear old
  sel.innerHTML = `<option value="" selected disabled>Browse all universities (${SR.universities.length.toLocaleString()})</option>`;
  const frag = document.createDocumentFragment();
  SR.universities.slice(0, 8000).forEach(u=>{
    const opt = document.createElement('option');
    opt.value = u.unitid; opt.textContent = `${u.name} (${u.state})`;
    frag.appendChild(opt);
  });
  sel.appendChild(frag);
}

function bindStudentSelectUI(){
  const qInput = $('#universitySearch');
  const sugg   = $('#searchSuggest');
  const searchApply = $('#searchApplyBtn');
  const bulkBtn= $('#bulkImportBtn');

  const doSuggest = ()=>{
    const q = (qInput.value||'').trim();
    if (!q){ sugg.style.display='none'; return; }
    const res = SR.fuse.search(q).slice(0, 20).map(r=>r.item);
    if (!res.length){ sugg.style.display='none'; return; }
    sugg.innerHTML = res.map(u=>`<div class="suggest-item" data-id="${u.unitid}">
      <span>${u.name}</span><small>${u.state}</small></div>`).join('');
    sugg.style.display='block';
    $$('[data-id]', sugg).forEach(el=>{
      el.addEventListener('click', ()=>{
        addSelected(el.getAttribute('data-id'));
        qInput.value=''; sugg.style.display='none';
      });
    });
  };

  qInput.addEventListener('input', ()=>{ SR.q = qInput.value; doSuggest(); });
  qInput.addEventListener('keydown', (e)=>{
    if (e.key==='Enter'){ e.preventDefault(); SR.q = qInput.value; applyFilters(); sugg.style.display='none'; }
    if (e.key==='Escape'){ sugg.style.display='none'; }
  });
  searchApply.addEventListener('click', ()=>{ SR.q = qInput.value; applyFilters(); sugg.style.display='none'; });

  // Browse dropdown
  $('#universitySelect').addEventListener('change', (e)=>{
    const id = e.target.value;
    addSelected(id);
    e.target.selectedIndex = 0; // reset back to placeholder
  });

  // Filters + per page + paging
  $('#filterApplyBtn').addEventListener('click', ()=>{
    SR.filters.state = $('#stateFilter').value;
    SR.filters.type  = $('#typeFilter').value;
    SR.filters.level = $('#levelFilter').value;
    SR.filters.sort  = $('#sortBy').value;
    SR.perPage = parseInt($('#pageSize').value,10)||40;
    applyFilters();
  });
  $('#resetBtn').addEventListener('click', ()=>{
    SR.q=''; if($('#universitySearch')) $('#universitySearch').value='';
    ['stateFilter','typeFilter','levelFilter','sortBy'].forEach(id=>{ if($( '#'+id)) $('#'+id).value=''; });
    SR.filters={state:'',type:'',level:'',sort:'name_asc'};
    applyFilters();
  });
  $('#clearFiltersBtn').addEventListener('click', ()=>{ $('#resetBtn').click(); });

  $('#prevPage').addEventListener('click', ()=>{ SR.page=Math.max(1, SR.page-1); renderGrid(); });
  $('#nextPage').addEventListener('click', ()=>{
    const totalPages = Math.max(1, Math.ceil(SR.filtered.length / SR.perPage));
    SR.page=Math.min(totalPages, SR.page+1); renderGrid();
  });
  $('#pageSize').addEventListener('change', ()=>{ SR.perPage=parseInt($('#pageSize').value,10)||40; renderGrid(); });

  // Bulk import modal
  const im = {
    modal: $('#importModal'), openBtn: $('#bulkImportBtn'), closeBtn: $('#importCloseBtn'),
    cancelBtn: $('#importCancelBtn'), confirmBtn: $('#importConfirmBtn'),
    ta: $('#importTextarea'), prev: $('#importPreview')
  };
  const openM = ()=>{ im.modal.style.display='flex'; im.ta.value=''; im.prev.textContent=''; };
  const closeM= ()=>{ im.modal.style.display='none'; };
  bulkBtn.addEventListener('click', openM);
  im.closeBtn.addEventListener('click', closeM);
  im.cancelBtn.addEventListener('click', closeM);
  im.ta.addEventListener('input', ()=>{
    const lines = im.ta.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    im.prev.textContent = `${lines.length} line(s)`;
  });
  im.confirmBtn.addEventListener('click', ()=>{
    const names = im.ta.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(s=>s.toLowerCase());
    if (!names.length){ toast('Nothing to import.','info'); return; }
    let added=0;
    const byName = new Map(SR.universities.map(u=>[u.name.toLowerCase(), u.unitid]));
    names.forEach(n=>{
      // exact name or contains
      let id = byName.get(n);
      if (!id){
        const hit = SR.universities.find(u=>u.name.toLowerCase().includes(n));
        if (hit) id = hit.unitid;
      }
      if (id && !SR.selected.has(id)){ SR.selected.add(id); added++; }
    });
    updateSelectedList(); persist(); closeM();
    toast(`Imported ${added} universit${added===1?'y':'ies'}.`,'success');
  });
}

/* ==== Recommender send flow -> Track ==== */
function bindRecommenderSend(){
  const btn = $('#sendBtn');
  const modal = $('#confirmModal');
  const open = ()=>{ 
    // Fill modal lists
    const all = Array.from(SR.selected).map(id=>SR.universities.find(u=>u.unitid===id)).filter(Boolean);
    $('#modalIncluded').innerHTML = all.map(u=>`<div>• ${u.name}</div>`).join('');
    $('#modalIncludedCount').textContent = all.length;
    // simple summary (student deltas omitted in this implementation)
    $('#modalRemoved').innerHTML = '<em>—</em>'; $('#modalRemovedCount').textContent='0';
    $('#modalAdded').innerHTML = '<em>—</em>';   $('#modalAddedCount').textContent='0';
    $('#modalSummary').textContent = `You are about to send your letter to ${all.length} universit${all.length===1?'y':'ies'}.`;
    modal.style.display='flex';
  };
  const close = ()=>{ modal.style.display='none'; };

  btn.addEventListener('click', open);
  $('#modalCancelBtn').addEventListener('click', close);
  $('#modalCloseBtn').addEventListener('click', close);
  $('#modalConfirmBtn').addEventListener('click', ()=>{
    close();
    // show progress quickly then create requests
    const progress = $('#progressSection'); const success = $('#successSection');
    const fill = $('#progressFill'); const text = $('#progressText'); const list = $('#deliveryList');
    success.style.display='none'; progress.style.display='block'; list.innerHTML='';
    const ids = Array.from(SR.selected);
    let done=0;
    ids.forEach((id, i)=>{
      const u = SR.universities.find(x=>x.unitid===id);
      const row = document.createElement('div');
      row.className='delivery-item';
      row.innerHTML = `<span class="delivery-status pending">•</span><div>${u?.name || id}</div>`;
      list.appendChild(row);
      setTimeout(()=>{
        row.querySelector('.delivery-status').className='delivery-status success';
        row.querySelector('.delivery-status').textContent='✓';
        done++;
        fill.style.width = `${Math.round(done/ids.length*100)}%`;
        text.textContent = `Sent ${done}/${ids.length}`;
        // create request record
        SR.requests.push({ id: 'R'+Date.now()+i, unitid:id, uniName:u?.name||id, who:'—', email:'—', ts: Date.now(), status:'Sent' });
        SR.studentTrack = SR.requests.slice(0);
        persist();
        if (done===ids.length){
          setTimeout(()=>{
            progress.style.display='none';
            success.style.display='block';
          }, 400);
        }
      }, 250 + i*120);
    });
  });

  $('#newUploadBtn').addEventListener('click', ()=>{
    $('#successSection').style.display='none';
    $('#progressSection').style.display='none';
    toast('Ready for a new batch.','info');
  });

  // Copy link (simple stub)
  $('#copyLinkBtn').addEventListener('click', async ()=>{
    try {
      const url = location.origin + location.pathname + '#recommender';
      await navigator.clipboard.writeText(url);
      toast('Shareable link copied.','success');
    } catch(e){ toast('Unable to copy link.','error'); }
  });
}

/* ==== Student: Send Recommendation Request (connects to Track) ==== */
function bindStudentSend(){
  const form = $('#stuSendForm'); if(!form) return;
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const who = $('#recName').value.trim();
    const email = $('#recEmail').value.trim();
    if(!who || !email){ toast('Please fill recommender name and email.','error'); return; }
    // create one request that ties to Track view (Student)
    SR.studentTrack.push({ id:'S'+Date.now(), uniName:'— (from student portal)', who, email, ts: Date.now(), status:'Sent' });
    persist();
    renderStudentTrack();
    toast('Request sent to your recommender.','success');
    form.reset();
  });
  form.addEventListener('reset', ()=>{ toast('Form cleared.','info'); });
}

function renderStudentTrack(){
  const tbody = $('#stuTrackBody'); if(!tbody) return;
  tbody.innerHTML = '';
  SR.studentTrack.slice().sort((a,b)=>b.ts-a.ts).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.who || '—'}</td>
      <td>${r.email || '—'}</td>
      <td>${new Date(r.ts).toLocaleString()}</td>
      <td><span class="track-pill sent">${r.status}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

/* ==== Misc: headers/theme/tabs already handled by your existing scripts ==== */

/* ==== INIT ==== */
document.addEventListener('DOMContentLoaded', ()=>{
  // populate dropdown, render grid, selected lists
  populateBrowseDropdown();
  applyFilters();
  updateSelectedList();
  bindStudentSelectUI();
  bindRecommenderSend();
  bindStudentSend();
});
</script>
<!-- Link intake + autoset (from your original snippet, left intact but now connected) -->
<script>
(function(){
  // Helper: safe localStorage to avoid quota crashes
  const safeLS = {
    get(k, d){ try { return localStorage.getItem(k) ?? d; } catch(e){ return d; } },
    set(k, v){ try { localStorage.setItem(k, v); } catch(e){} }
  };
  const norm = s => (s||'').toString().trim().toLowerCase();

  const els = {
    input:  document.getElementById('linkInput'),
    parse:  document.getElementById('linkParseBtn'),
    status: document.getElementById('linkStatus'),
    sum:    document.getElementById('linkSummary'),
    help:   document.getElementById('linkHelpBtn'),
  };

  els.help?.addEventListener('click', () => {
    const det = document.getElementById('linkFormatDetails');
    if (!det) return;
    det.open = true;
    det.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });

  function setStatus(msg, type='info'){
    const color = type==='error' ? '#b91c1c' : type==='success' ? '#166534' : '#334155';
    if (els.status) els.status.innerHTML = `<span style="color:${color}">${msg}</span>`;
  }
  function summarize(data, matchedCount){
    const lines = [];
    if (data.studentFirst || data.studentLast) {
      lines.push(`<div><b>Student</b>: ${[data.studentFirst, data.studentLast].filter(Boolean).join(' ') || '<span class="muted">—</span>'}</div>`);
    }
    if (data.studentEmail || data.studentPhone) {
      lines.push(`<div><b>Contact</b>: ${[data.studentEmail, data.studentPhone].filter(Boolean).join(' • ') || '<span class="muted">—</span>'}</div>`);
    }
    if (typeof data.waiveAccess !== 'undefined') {
      lines.push(`<div><b>Waive access</b>: ${data.waiveAccess ? '<span class="ok">Yes</span>' : 'No'}</div>`);
    }
    if (data.recommenderName || data.recommenderEmail || data.recommenderPhone) {
      lines.push(`<div><b>Recommender</b>: ${data.recommenderName || ''} ${data.recommenderEmail ? '• ' + data.recommenderEmail : ''} ${data.recommenderPhone ? '• ' + data.recommenderPhone : ''}</div>`);
    }
    if (Array.isArray(data.unitids) && data.unitids.length) {
      lines.push(`<div><b>Universities (unitids)</b>: ${data.unitids.length} ${matchedCount!=null?`<span class="${matchedCount>0?'ok':'warn'}">(matched ${matchedCount})</span>`:''}</div>`);
    } else if (Array.isArray(data.unames) && data.unames.length) {
      lines.push(`<div><b>Universities (by name)</b>: ${data.unames.length} (will match)</div>`);
    }
    els.sum.innerHTML = lines.join('') || '<div class="muted">No details found.</div>';
    els.sum.hidden = false;
  }

  function parseLink(raw){
    try {
      const url = new URL(raw);
      const q   = url.searchParams;
      const data = {
        studentFirst:   q.get('sf') || q.get('sfn') || '',
        studentLast:    q.get('sl') || q.get('sln') || '',
        studentEmail:   q.get('se') || q.get('semail') || '',
        studentPhone:   q.get('sp') || q.get('sphone') || '',
        waiveAccess:    q.get('waive') === '1' || q.get('waive') === 'true',
        recommenderName: q.get('rname') || '',
        recommenderEmail: q.get('remail') || '',
        recommenderPhone: q.get('rphone') || '',
        unitids: [],
        unames: [],
      };
      const unis = q.get('unis');  if (unis)   data.unitids = unis.split(',').map(s=>s.trim()).filter(Boolean);
      const unames = q.get('unames'); if (unames) data.unames = unames.split(',').map(s=>s.trim()).filter(Boolean);
      return data;
    } catch(e){ return null; }
  }

  async function applyReferralData(data){
    // Prefer unitids
    let matched = 0;
    if (Array.isArray(data.unitids) && data.unitids.length){
      const master = new Set(SR.universities.map(u=>String(u.unitid)));
      data.unitids.forEach(id=>{
        const key = String(id);
        if (master.has(key)){ SR.selected.add(key); matched++; }
      });
    }
    // fallback: names
    if ((!data.unitids || !data.unitids.length) && Array.isArray(data.unames) && data.unames.length){
      const want = data.unames.map(s=>s.toLowerCase());
      SR.universities.forEach(u=>{
        if (want.some(w => u.name.toLowerCase().includes(w))){ SR.selected.add(u.unitid); matched++; }
      });
    }
    // keep Mock
    SR.selected.add(SR.mockPinned);
    updateSelectedList(); persist();
    return matched;
  }

  async function handleImport(){
    const raw = (els.input?.value || '').trim();
    if (!raw){ setStatus('Please paste a link first.','error'); return; }
    const data = parseLink(raw);
    if (!data){ setStatus('That doesn’t look like a valid link.','error'); return; }
    setStatus('Parsing link and applying data…');
    const matched = await applyReferralData(data);
    summarize(data, matched);
    // Title convenience
    const full = [data.studentFirst, data.studentLast].filter(Boolean).join(' ');
    if (full) { const t = $('#writerTitle'); if (t) t.value = `Recommendation for ${full}`; }
    toast(`Imported ${matched} universit${matched===1?'y':'ies'} from the link.` , matched? 'success':'info');
    setStatus('Link imported successfully.','success');
    // switch to Recommender
    const recPanel = document.getElementById('panel-recommender');
    const stuPanel = document.getElementById('panel-student');
    if (recPanel && stuPanel) {
      stuPanel.hidden = true; recPanel.hidden = false;
      recPanel.style.display = ''; stuPanel.style.display = 'none';
      const toggles = document.querySelectorAll('.header-nav .nav-link');
      toggles.forEach(b=>{
        const on = b.dataset.view === 'recommender';
        b.setAttribute('aria-selected', on?'true':'false');
        if (on) b.setAttribute('aria-current','page'); else b.removeAttribute('aria-current');
      });
      history.replaceState(null,'','#recommender');
      safeLS.set('sr_current_view','recommender');
    }
  }

  els.parse?.addEventListener('click', handleImport);
  els.input?.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); handleImport(); } });
})();
</script>

<!-- View toggler & simple header behaviors (original kept) -->
<script>
  (function(){
    function safeSet(key, val){ try { localStorage.setItem(key, val); } catch (e) {} }
    function safeGet(key, def){ try { return localStorage.getItem(key) ?? def; } catch (e) { return def; } }
    const studentPanel = document.getElementById('panel-student');
    const recPanel     = document.getElementById('panel-recommender');
    const toggles      = document.querySelectorAll('.header-nav .nav-link');
    if (studentPanel) studentPanel.hidden = false;
    if (recPanel)     recPanel.hidden     = true;
    function setActive(view){
      const isStudent = (view==='student');
      if (studentPanel) studentPanel.hidden = !isStudent;
      if (recPanel)     recPanel.hidden     =  isStudent;
      toggles.forEach(btn=>{
        const on = btn.dataset.view===view;
        btn.setAttribute('aria-selected', on?'true':'false');
        if (on) btn.setAttribute('aria-current','page'); else btn.removeAttribute('aria-current');
      });
      history.replaceState(null,'','#'+view);
      safeSet('sr_current_view', view);
    }
    toggles.forEach(btn=>btn.addEventListener('click',()=>setActive(btn.dataset.view)));
    const fromHash=(location.hash||'').slice(1);
    const saved=safeGet('sr_current_view','student');
    const initial=(fromHash==='recommender'||fromHash==='student')?fromHash:saved;
    setActive(initial==='recommender'?'recommender':'student');
    window.addEventListener('hashchange',()=>{
      const v=(location.hash||'#student').slice(1);
      setActive(v==='recommender'?'recommender':'student');
    });

    // Theme toggle
    const themeBtn = document.getElementById('headerThemeBtn');
    if (themeBtn){
      themeBtn.addEventListener('click', ()=>{
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme')==='dark';
        root.setAttribute('data-theme', isDark ? 'light' : 'dark');
        themeBtn.setAttribute('aria-pressed', isDark ? 'false':'true');
        try { localStorage.setItem('sr_theme', isDark ? 'light' : 'dark'); } catch(e){}
      });
      try {
        const t = localStorage.getItem('sr_theme');
        if (t==='dark'||t==='light'){
          document.documentElement.setAttribute('data-theme', t);
          themeBtn.setAttribute('aria-pressed', t==='dark' ? 'true':'false');
        }
      } catch(e){}
    }
  })();
</script>

<!-- Student tabs controller (original kept) -->
<script>
(function(){
  const tabs = { send:$('#stuTabSend'), select:$('#stuTabSelect'), track:$('#stuTabTrack') };
  const panels = { send:$('#stuPanelSend'), select:$('#stuPanelSelect'), track:$('#stuPanelTrack') };
  function activate(which){
    Object.entries(tabs).forEach(([k,btn])=> btn?.setAttribute('aria-selected', k===which?'true':'false'));
    Object.entries(panels).forEach(([k,sec])=> sec && (sec.hidden = (k!==which)));
    if (which==='track') renderStudentTrack();
  }
  tabs.send  ?.addEventListener('click', ()=>activate('send'));
  tabs.select?.addEventListener('click', ()=>activate('select'));
  tabs.track ?.addEventListener('click', ()=>activate('track'));
  activate('send');
})();
</script>
<!-- Robust toggler duplicate (original kept; harmless no-op with our bindings) -->
<script>
(function(){
  const studentPanel = document.getElementById('panel-student');
  const recPanel     = document.getElementById('panel-recommender');
  const toggles      = document.querySelectorAll('.header-nav .nav-link');
  if (!studentPanel || !recPanel || !toggles.length) return;
  const safeLS = { get(k,d){ try { return localStorage.getItem(k) ?? d; } catch(e){ return d; } },
                   set(k,v){ try { localStorage.setItem(k, v); } catch(e){} } };
  function setActive(view){
    const isStudent = (view==='student');
    studentPanel.hidden = !isStudent; recPanel.hidden =  isStudent;
    studentPanel.style.display = isStudent ? '' : 'none';
    recPanel.style.display     = isStudent ? 'none' : '';
    toggles.forEach(btn=>{
      const on = btn.dataset.view===view;
      btn.setAttribute('aria-selected', on?'true':'false');
      if (on) btn.setAttribute('aria-current','page'); else btn.removeAttribute('aria-current');
    });
    history.replaceState(null,'','#'+view); safeLS.set('sr_current_view',view);
  }
  toggles.forEach(btn=>btn.addEventListener('click',()=>setActive(btn.dataset.view)));
  const fromHash=(location.hash||'').replace('#',''); const saved=safeLS.get('sr_current_view','');
  const initial=(fromHash==='recommender'||fromHash==='student')?fromHash:(saved==='recommender'||saved==='student'?saved:'student');
  setActive(initial);
  window.addEventListener('hashchange',()=>{ const v=(location.hash||'#student').slice(1); setActive(v==='recommender'?'recommender':'student'); });
})();
</script>

<!-- Tiny upload & contact stubs so buttons feel live -->
<script>
(function(){
  const choose = $('#chooseFileBtn'), file = $('#fileInput'), box = $('#uploadedFile'), name = $('#fileName'), size = $('#fileSize'), remove = $('#removeFileBtn');
  choose?.addEventListener('click', ()=>file?.click());
  file?.addEventListener('change', ()=>{
    const f = file.files?.[0]; if(!f) return;
    name.textContent = f.name; size.textContent = `${(f.size/1024/1024).toFixed(2)} MB`;
    box.style.display='block'; toast('PDF attached.','success');
  });
  remove?.addEventListener('click', ()=>{ file.value=''; box.style.display='none'; });

  const chooseV=$('#chooseVideoBtn'), video=$('#videoInput'), boxV=$('#uploadedVideo'), nameV=$('#videoName'), sizeV=$('#videoSize'), removeV=$('#removeVideoBtn'), prevV=$('#videoPreview');
  chooseV?.addEventListener('click', ()=>video?.click());
  video?.addEventListener('change', ()=>{
    const f=video.files?.[0]; if(!f) return;
    nameV.textContent=f.name; sizeV.textContent=`${(f.size/1024/1024).toFixed(2)} MB`;
    boxV.style.display='block';
    try { prevV.src = URL.createObjectURL(f); prevV.style.display='block'; } catch(e){}
  });
  removeV?.addEventListener('click', ()=>{ video.value=''; boxV.style.display='none'; prevV.removeAttribute('src'); prevV.style.display='none'; });

  // Contact overlay
  const overlay = $('#contactOverlay');
  const openBtn = $('#contactAdminItem');
  const closeBtn1 = $('#contactCloseBtn2');
  const closeBtn2 = $('#contactCancelBtn2');
  openBtn?.addEventListener('click', ()=>{ overlay.style.display='flex'; requestAnimationFrame(()=>overlay.querySelector('div[style*="transform"]').style.opacity=1); });
  closeBtn1?.addEventListener('click', ()=> overlay.style.display='none');
  closeBtn2?.addEventListener('click', ()=> overlay.style.display='none');
  $('#contactForm2')?.addEventListener('submit', (e)=>{ e.preventDefault(); overlay.style.display='none'; toast('Message sent to admin.','success'); });
})();
</script>

</body>
</html>

  
