<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StellarRec - One upload. Unlimited reach.</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Roboto',sans-serif;
      background:linear-gradient(135deg,var(--bg-grad-1,#f8f9fa) 0%,var(--bg-grad-2,#e9ecef) 100%);
      color:var(--text,#333);
      min-height:100vh;
    }

    /* Header */
    .header {
      background:linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color:#fff; padding:1.5rem 2rem;
      box-shadow:0 4px 20px rgba(25,118,210,0.3);
    }
    .header-content {
      max-width:1200px; margin:0 auto;
      display:flex; justify-content:space-between; align-items:center; gap:1rem;
    }
    .logo {
      display:flex; align-items:center; gap:.5rem;
      font-size:1.8rem; font-weight:700;
      text-decoration:none; color:#fff; transition:.3s;
    }
    .logo:hover { opacity:.85; transform:translateY(-1px); }

    /* Avatar + dropdown */
    .user-info { position:relative; display:flex; align-items:center; gap:1rem; }
    .user-avatar {
      width:45px; height:45px;
      background:rgba(255,255,255,.2); border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:1.2rem; cursor:pointer; transition:.2s;
      border:2px solid rgba(255,255,255,0.1);
    }
    .user-avatar:hover { background:rgba(255,255,255,.3); transform:scale(1.05); border-color:rgba(255,255,255,.3); }
    .user-avatar:focus { outline:none; box-shadow:0 0 0 3px rgba(255,255,255,.3); }

    .user-dropdown {
      position:absolute; top:100%; right:0; margin-top:.5rem;
      background:#fff; border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,.15);
      min-width:260px; max-width:min(92vw,360px);
      opacity:0; visibility:hidden;
      transform:translateY(-10px) scale(.95);
      transition:all .2s cubic-bezier(0.4,0,0.2,1); z-index:1000;
      border:1px solid rgba(0,0,0,.08);
    }
    .user-dropdown.show { opacity:1; visibility:visible; transform:translateY(0) scale(1); }
    .user-dropdown::before{
      content:''; position:absolute; top:-8px; right:16px; width:16px; height:16px;
      background:#fff; border:1px solid rgba(0,0,0,.08); border-bottom:none; border-right:none;
      transform:rotate(45deg);
    }
    .dropdown-header { padding:1rem; border-bottom:1px solid #f0f0f0; color:#333; font-weight:600; font-size:.9rem; }
    .dropdown-item {
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem; color:#333; cursor:pointer; transition:.15s;
    }
    .dropdown-item:hover, .dropdown-item:focus { background:#f8f9fa; outline:none; }
    .dropdown-item .material-icons { font-size:1.2rem; color:#666; }
    .dropdown-item.active { background:#e3f2fd; color:#1976d2; }
    .dropdown-item.active .material-icons { color:#1976d2; }
    .view-label { display:flex; flex-direction:column; }
    .view-name { font-weight:600; font-size:.9rem; }
    .view-description { font-size:.8rem; color:#666; margin-top:.1rem; }

    .container { max-width:1200px; margin:0 auto; padding:2rem; }
    .hero-section { text-align:center; margin-bottom:3rem; }
    .hero-title { font-size:2.5rem; font-weight:700; color:#1976d2; margin-bottom:1rem; }
    .hero-subtitle { font-size:1.2rem; color:#666; margin-bottom:2rem; }

    /* Two-column layout */
    .compose-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:2rem; }
    @media (max-width: 980px) { .compose-grid { grid-template-columns:1fr; } }

    .upload-section, .writer-section, .university-section,
    .selected-section, .progress-section {
      background:#fff; border-radius:16px; padding:2rem;
      box-shadow:0 8px 32px rgba(0,0,0,.1); margin-bottom:0;
    }
    .upload-section { border:2px dashed #e0e0e0; transition:.3s; }
    .upload-section.dragover { border-color:#1976d2; background:#f3f8ff; }

    .upload-area { text-align:center; padding:2rem; }
    .upload-icon { font-size:4rem; color:#1976d2; margin-bottom:1rem; }
    .upload-title { font-size:1.5rem; font-weight:600; margin-bottom:.5rem; color:#333; }
    .upload-subtitle { color:#666; margin-bottom:2rem; }
    .file-input { display:none; }
    .upload-btn {
      background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff;
      padding:1rem 2rem; border:none; border-radius:12px;
      font-size:1.1rem; font-weight:600; cursor:pointer;
      transition:.3s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    .uploaded-file {
      display:none; background:#e8f5e8; border:2px solid #4caf50;
      border-radius:12px; padding:1.5rem; margin-top:1rem;
    }
    .file-info { display:flex; align-items:center; gap:1rem; }
    .file-icon { font-size:2rem; color:#4caf50; }
    .file-details h3 { color:#2e7d32; margin-bottom:.25rem; }
    .file-details p { color:#4caf50; font-size:.9rem; }
    .remove-file {
      margin-left:auto; background:none; border:none; color:#666;
      cursor:pointer; padding:.5rem; border-radius:50%; transition:.2s;
    }
    .remove-file:hover { background:rgba(244,67,54,.1); color:#f44336; }

    .section-title {
      font-size:1.5rem; font-weight:600; color:#333;
      margin-bottom:1rem; display:flex; align-items:center; gap:.5rem;
    }

    /* Writer */
    .writer-toolbar { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.75rem; align-items:center; }
    .writer-toolbar .btn {
      background:#fff; border:2px solid #e5e7eb; border-radius:10px;
      padding:.45rem .75rem; cursor:pointer; font-weight:600;
    }
    .writer-toolbar .btn:hover { background:#f8f9fa; }
    .writer-toolbar .meta { margin-left:auto; font-size:.9rem; color:#667; display:flex; gap:.75rem; align-items:center; }
    .writer-title {
      width:100%; padding:.7rem .9rem;
      border:2px solid #e0e0e0; border-radius:12px;
      font-size:1rem; margin-bottom:.6rem;
    }
    .writer-box {
      border:2px solid #e0e0e0; border-radius:12px;
      min-height:280px; padding:1rem; line-height:1.55;
    }
    .writer-box:focus { outline:none; border-color:#1976d2; }
    .writer-actions { display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap; }
    .btn-primary { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; border:none; }
    .btn-success { background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; border:none; }
    .btn-danger  { background:linear-gradient(135deg,#e53935,#ef5350); color:#fff; border:none; }
    .btn-muted   { background:#fff; color:#333; }
    .filter-meta { font-size:.9rem; color:#666; margin:.25rem 0 .5rem; }
    .filter-bar { display:grid; grid-template-columns: repeat(8, minmax(140px, 1fr)); gap:.5rem; margin-bottom:.75rem; align-items:center; }
    .filter-select { width:100%; padding:.7rem .9rem; border:2px solid #e0e0e0; border-radius:12px; background:#fff; font-size:.95rem; }

    .university-grid {
      display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:1rem;
      max-height:480px; overflow-y:auto; padding:1rem; border:1px solid #f0f0f0; border-radius:12px;
    }
    .university-card { background:#f8f9fa; border:2px solid transparent; border-radius:12px; padding:1rem; cursor:pointer; transition:.2s; }
    .university-card:hover { border-color:#1976d2; background:#f3f8ff; }
    .university-card.selected { border-color:#1976d2; background:#e3f2fd; }
    .university-header { display:flex; align-items:center; gap:1rem; margin-bottom:.5rem; }
    .university-logo { width:40px; height:40px; background:#1976d2; color:#fff; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:600; }
    .university-name { font-weight:600; color:#333; }
    .university-location { color:#666; font-size:.9rem; }
    .university-pill { margin-top:.25rem; display:inline-block; font-size:.75rem; color:#555; background:#eef3ff; border:1px solid #dbe7ff; padding:.15rem .5rem; border-radius:999px; }

    .pagination { display:flex; justify-content:space-between; align-items:center; margin-top:.75rem; }
    .pager { display:flex; gap:.5rem; }
    .page-btn { background:#fff; border:2px solid #e0e0e0; border-radius:10px; padding:.5rem .9rem; cursor:pointer; font-weight:600; }
    .page-btn[disabled] { opacity:.5; cursor:not-allowed; }
    .page-size { margin-left:auto; display:flex; align-items:center; gap:.5rem; }

    .selected-count { color:#1976d2; font-weight:600; margin-bottom:1rem; }
    .selected-list { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:2rem; }
    .selected-tag { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:.5rem 1rem; border-radius:20px; font-size:.9rem; display:flex; align-items:center; gap:.5rem; }
    .remove-tag { cursor:pointer; background:rgba(255,255,255,.2); border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .remove-tag:hover { background:rgba(255,255,255,.3); }

    .send-section { text-align:center; }
    .send-btn {
      background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; padding:1.2rem 3rem; border:none; border-radius:12px;
      font-size:1.2rem; font-weight:600; cursor:pointer; transition:.2s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .send-btn:disabled { background:#ccc; cursor:not-allowed; }
    .send-btn:not(:disabled):hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(76,175,80,.3); }

    .progress-section { display:none; }
    .progress-title { font-size:1.3rem; font-weight:600; color:#333; margin-bottom:1rem; text-align:center; }
    .progress-bar { width:100%; height:12px; background:#e0e0e0; border-radius:6px; overflow:hidden; margin-bottom:1rem; }
    .progress-fill { height:100%; background:linear-gradient(135deg,#4caf50,#66bb6a); border-radius:6px; transition:width .5s ease; width:0%; }
    .progress-text { text-align:center; color:#666; font-size:.9rem; }
    .delivery-list { margin-top:1rem; }
    .delivery-item { display:flex; align-items:center; gap:1rem; padding:.75rem; border-radius:8px; margin-bottom:.5rem; background:#f8f9fa; }
    .delivery-status { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .delivery-status.pending { background:#fff3e0; color:#ff9800; }
    .delivery-status.success { background:#e8f5e8; color:#4caf50; }
    .delivery-status.error { background:#ffebee; color:#f44336; }

    .success-section {
      display:none; background:linear-gradient(135deg,#e8f5e8,#f1f8e9);
      border:2px solid #4caf50; border-radius:16px; padding:2rem; text-align:center; box-shadow:0 8px 32px rgba(76,175,80,.2);
    }
    .success-icon { font-size:4rem; color:#4caf50; margin-bottom:1rem; }
    .success-title { font-size:1.8rem; font-weight:600; color:#2e7d32; margin-bottom:1rem; }
    .success-subtitle { color:#4caf50; margin-bottom:2rem; }
    .new-upload-btn { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:1rem 2rem; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition:.2s; }
    .new-upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }

    @keyframes flash { 0%{box-shadow:0 0 0 rgba(25,118,210,0);} 25%{box-shadow:0 0 0 6px rgba(25,118,210,.25);} 100%{box-shadow:0 0 0 rgba(25,118,210,0);} }
    .flash { animation: flash 1.2s ease; }

    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; font-size:.75rem; border-radius:999px; border:1px solid; }
    .badge-student { background:#f1f8ff; color:#0d47a1; border-color:#bbdefb; }
    .badge-added   { background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9; }
    .badge-removed { background:#ffebee; color:#b71c1c; border-color:#ffcdd2; }

    .toast-wrap { position: fixed; right: 16px; bottom: 16px; z-index: 99999; display: grid; gap: 8px; }
    .toast {
      min-width: 240px; max-width: 420px; padding: .75rem .9rem; border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.15); color:#0f172a; background:#fff; border:1px solid #e5e7eb;
      display:flex; align-items:flex-start; gap:.6rem; animation: toast-in .18s ease;
    }
    .toast.success { border-color:#c8e6c9; background:#f1f8f3; }
    .toast.error   { border-color:#ffcdd2; background:#fff2f2; }
    .toast.info    { border-color:#bbdefb; background:#f3f8ff; }
    .toast .icon { font-size: 1.1rem; line-height:1; margin-top:.1rem; }
    .toast .msg  { flex:1; font-size:.95rem; }
    .toast .x    { border:none; background:transparent; cursor:pointer; font-size:1rem; opacity:.6; }
    .toast .x:hover { opacity:.9; }
    @keyframes toast-in { from { transform: translateY(6px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    .empty-state { display:none; background:#fff; border:1px dashed #d0d7de; border-radius:12px; padding:1.25rem; color:#445; text-align:center; }
    .empty-state .actions { margin-top:.75rem; display:flex; gap:.5rem; justify-content:center; }

    @media (max-width:768px) {
      .container { padding:1rem; }
      .hero-title { font-size:2rem; }
      .university-grid { grid-template-columns:1fr; }
      .header-content { flex-direction:column; gap:1rem; }
      .filter-bar { grid-template-columns:1fr 1fr; }
    }

    /* Dark theme basics (CSS side) */
    :root[data-theme="dark"] {
      --bg:#0b1220; --panel:#111a2a; --text:#e5eefc; --muted:#93a3bc; --primary:#7aa2ff; --border:#24324a;
    }
    :root[data-theme="dark"] body { background: linear-gradient(135deg,#0b1220 0%,#0f1729 100%); color: var(--text); }
    :root[data-theme="dark"] .upload-section,
    :root[data-theme="dark"] .writer-section,
    :root[data-theme="dark"] .university-section,
    :root[data-theme="dark"] .selected-section,
    :root[data-theme="dark"] .progress-section { background: var(--panel); box-shadow:none; }
    :root[data-theme="dark"] .filter-select,
    :root[data-theme="dark"] .writer-title,
    :root[data-theme="dark"] .writer-box,
    :root[data-theme="dark"] .page-btn { background:#0f1729; color:var(--text); border-color: var(--border); }
    :root[data-theme="dark"] .university-card { background:#0f1729; }
    :root[data-theme="dark"] .university-card:hover { background:#12203a; border-color:#274780; }
    :root[data-theme="dark"] .university-card.selected { background:#13254a; }
    :root[data-theme="dark"] .hero-subtitle, :root[data-theme="dark"] .university-location { color: var(--muted); }

    /* Footer (match header) */
    .site-footer {
      background: linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color: #fff;
      padding: 1.5rem 0;
      text-align: center;
    }
    .site-footer p { margin: 0; font-size: 0.95rem; }

    /* theme button centered in header */
    .center-controls { display:flex; justify-content:center; align-items:center; flex:1 1 auto; }
    .header-content > .logo { flex:0 0 auto; }
    .header-content > .center-controls { flex:1 1 auto; }
    .header-content > .user-info { flex:0 0 auto; }

    .theme-btn {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.55rem 1rem; border-radius:999px;
      border:1px solid #ffffff55; background:#ffffff22; color:#fff; font-weight:600;
      cursor:pointer; transition: transform .15s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .theme-btn:hover { transform: translateY(-1px); background:#ffffff33; border-color:#ffffff88; }
    .theme-btn:focus-visible { outline:3px solid rgba(255,255,255,.5); outline-offset:2px; }
    .theme-btn .material-icons { font-size:18px; }

    /* Autosuggest styling + fly animation */
    .suggest-popover { max-height: 280px; overflow-y: auto; }
    .suggest-item { padding:.55rem .8rem; cursor:pointer; display:flex; align-items:center; gap:.5rem; font-size:.95rem; }
    .suggest-item[aria-selected="true"], .suggest-item:hover { background:#f3f8ff; }
    @keyframes fly-to-selected {
      0% { transform: translate(0,0) scale(1); opacity: 1; }
      100% { transform: translate(var(--dx,0), var(--dy,0)) scale(0.85); opacity: 0; }
    }
    .fly-chip {
      position: fixed; z-index: 99999; pointer-events: none;
      background: linear-gradient(135deg,#1976d2,#7c4dff); color: #fff;
      padding: .4rem .8rem; border-radius: 999px; font-size: .85rem; box-shadow: 0 8px 24px rgba(0,0,0,.18);
      animation: fly-to-selected .45s ease forwards;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <div class="header-content">
      <!-- Left: Logo -->
      <a href="/" class="logo" target="_self" aria-label="Go to homepage">
        <span class="material-icons">star</span>
        stellarrec
      </a>

      <!-- Center: Theme button -->
      <div class="center-controls">
        <button id="headerThemeBtn" class="theme-btn" type="button" aria-pressed="false">
          <span class="material-icons" aria-hidden="true">dark_mode</span>
          Light / Dark
        </button>
      </div>

      <!-- Right: Avatar dropdown -->
      <div class="user-info">
        <button class="user-avatar" id="userAvatarBtn" aria-haspopup="true" aria-expanded="false" type="button">
          <span class="material-icons">person</span>
        </button>

        <!-- Dropdown menu -->
        <div class="user-dropdown" id="userDropdown" role="menu" aria-hidden="true">
          <div class="dropdown-header">Quick actions</div>

          <!-- How it works -->
          <div class="dropdown-item" role="menuitem" tabindex="0">
            <span class="material-icons">help_outline</span>
            <div class="view-label">
              <a href="https://stellarrec.netlify.app/portal-signin"
                 class="view-name"
                 style="text-decoration:none; color:inherit;"
                 target="_self">
                How it works
              </a>
              <div class="view-description">Sign-in portal</div>
            </div>
          </div>

          <!-- Contact Admin -->
          <div class="dropdown-item" id="contactAdminItem" role="menuitem" tabindex="0">
            <span class="material-icons">support_agent</span>
            <div class="view-label">
              <div class="view-name">Contact admin</div>
              <div class="view-description">Send a message</div>
            </div>
          </div>

          <!-- Mock API toggle -->
          <div class="dropdown-item" style="border-top:1px solid #f0f0f0;">
            <label for="mockToggle" style="display:flex; align-items:center; gap:.75rem; width:100%; cursor:pointer;">
              <span class="material-icons">build</span>
              <div class="view-label">
                <div class="view-name">Use mock API</div>
                <div class="view-description">Toggle mock vs real backend</div>
              </div>
              <input id="mockToggle" type="checkbox" style="margin-left:auto; width:18px; height:18px;" />
            </label>
          </div>
        </div>
      </div><!-- /.user-info -->
    </div><!-- /.header-content -->
  </div><!-- /.header -->

  <!-- Contact Admin Modal (legacy modal) -->
  <div id="contactModal" role="dialog" aria-modal="true" aria-labelledby="contactTitle"
       style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; width:min(560px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
      <div style="padding:1.2rem 1.4rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div id="contactTitle" style="font-weight:700;">Contact Admin</div>
        <button aria-label="Close" id="contactCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
      </div>
      <form id="contactForm" style="padding:1rem 1.4rem; display:grid; gap:.75rem;">
        <label>First name
          <input type="text" id="contactFirst" required class="filter-select" style="margin-top:.35rem;">
        </label>
        <label>Email address
          <input type="email" id="contactEmail" required class="filter-select" style="margin-top:.35rem;">
        </label>
        <label>Query
          <textarea id="contactQuery" rows="5" required class="filter-select" style="margin-top:.35rem;"></textarea>
        </label>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; padding-top:.5rem;">
          <button type="button" class="page-btn" id="contactCancelBtn">Cancel</button>
          <button type="submit" class="apply-btn" id="contactSendBtn">Send</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MAIN -->
  <div class="container" id="panel-recommender">
    <!-- Student Context Bar -->
    <div class="student-bar" id="studentBar" style="display:flex; align-items:center; gap:.75rem; background:#fff; border:1px solid #eaeaea; border-radius:12px; padding:1rem; margin-bottom:1rem;">
      <span class="material-icons" aria-hidden="true">account_circle</span>
      <div style="flex:1">
        <div id="studentTitle" style="font-weight:700;">No student loaded</div>
        <div id="studentMeta" style="color:#666; font-size:.9rem;">Load a student to see their preselected universities.</div>
      </div>
      <input id="studentIdInput" class="filter-select" placeholder="Student ID or email" style="max-width:220px;" aria-label="Student identifier"/>
      <button class="apply-btn" id="loadStudentBtn">Load student</button>
      <label style="display:flex; align-items:center; gap:.4rem; margin-left:.5rem; font-size:.9rem;">
        <input type="checkbox" id="allowEditsToggle"/>
        Allow recommender edits
      </label>
    </div>

    <!-- Hero -->
    <div class="hero-section">
      <h1 class="hero-title">One upload. Unlimited reach.</h1>
      <p class="hero-subtitle">Upload your recommendation letter once and send it to multiple US universities instantly.</p>
    </div>

    <!-- Upload + Writer -->
    <div class="compose-grid">
      <!-- Upload Section -->
      <div class="upload-section" id="uploadSection">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon"><span class="material-icons">cloud_upload</span></div>
          <h2 class="upload-title">Upload Recommendation Letter</h2>
          <p class="upload-subtitle">Drag and drop your PDF file here, or click to browse</p>
          <div id="uploadHint" style="margin:.5rem 0 0; font-size:.9rem; color:#556;">PDF only. Recommended size ≤ 10 MB.</div>

          <input type="file" id="fileInput" class="file-input" accept=".pdf,.txt" />
          <button class="upload-btn" id="chooseFileBtn">
            <span class="material-icons">upload_file</span>
            Choose File
          </button>
        </div>
        <div class="uploaded-file" id="uploadedFile">
          <div class="file-info">
            <div class="file-icon"><span class="material-icons">description</span></div>
            <div class="file-details">
              <h3 id="fileName">recommendation-letter.pdf</h3>
              <p id="fileSize">2.4 MB • Uploaded successfully</p>
            </div>
            <button class="remove-file" id="removeFileBtn"><span class="material-icons">close</span></button>
          </div>
        </div>
      </div>

      <!-- Writer -->
      <div class="writer-section" id="writerSection">
        <h2 class="section-title"><span class="material-icons">edit</span> Write Letter</h2>
        <input id="writerTitle" class="writer-title" placeholder="Letter title (optional, e.g., 'Recommendation for Jane Doe')" />
        <div class="writer-toolbar">
          <button class="btn btn-muted" data-wcmd="bold" title="Bold (Ctrl/Cmd+B)"><b>B</b></button>
          <button class="btn btn-muted" data-wcmd="italic" title="Italic (Ctrl/Cmd+I)"><i>I</i></button>
          <button class="btn btn-muted" data-wcmd="underline" title="Underline (Ctrl/Cmd+U)"><u>U</u></button>
          <div class="meta">
            <span id="writerCount">0 words • 0 chars</span>
            <span id="writerSaved">Not saved</span>
          </div>
        </div>
        <div id="writerBox" class="writer-box" contenteditable="true" aria-label="Letter editor"
             placeholder="Write your recommendation letter here..."></div>
        <div class="writer-actions">
          <button class="btn btn-primary" id="saveDraftBtn">Save draft</button>
          <button class="btn btn-muted" id="restoreDraftBtn">Restore</button>
          <button class="btn btn-danger" id="clearDraftBtn">Clear</button>
          <button class="btn btn-muted" id="copyDraftBtn">Copy</button>
          <button class="btn btn-muted" id="downloadDraftBtn">Download .txt</button>
          <button class="btn btn-success" id="attachDraftBtn">Attach draft</button>
          <label style="display:flex; align-items:center; gap:.4rem; margin-left:auto;">
            <input type="checkbox" id="writerAutosaveToggle" checked />
            Autosave
          </label>
        </div>
      </div>
    </div>
    <!-- University Selection -->
    <div class="university-section">
      <h2 class="section-title"><span class="material-icons">school</span> Select Universities</h2>

      <!-- Search + Apply (inline) + Bulk import INSIDE the white box -->
      <div class="university-search" style="position:relative; display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem;">
        <input
          type="text"
          class="search-input filter-select"
          placeholder="Search universities..."
          id="universitySearch"
          autocomplete="off"
          aria-autocomplete="list"
          aria-expanded="false"
          aria-owns="searchSuggest"
        />
        <button class="apply-btn" id="searchApplyBtn" title="Apply search (Enter)" type="button">Apply</button>

        <!-- Bulk import moved here (inside the same white panel) -->
        <button class="page-btn" id="bulkImportBtn" title="Bulk import by names" type="button">Bulk import</button>

        <!-- Suggestions popover -->
        <div id="searchSuggest" class="suggest-popover" style="display:none;"></div>
      </div>

      <!-- Browse-all dropdown -->
      <select id="universitySelect" class="filter-select" title="Browse all universities" style="margin-bottom:.5rem;">
        <option value="" selected disabled>Browse all universities (6000+)</option>
      </select>

      <!-- Filters -->
      <div class="filter-meta" id="resultMeta" aria-live="polite">Showing 0 of 0</div>

      <div class="filter-bar">
        <select id="stateFilter" class="filter-select" aria-label="Filter by state">
          <option value="">All states</option>
          <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option>
          <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option>
          <option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
          <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option>
          <option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option>
          <option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
          <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option>
          <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option>
          <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
          <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option>
          <option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
          <option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
          <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
        </select>

        <select id="typeFilter" class="filter-select" aria-label="Filter by institution type">
          <option value="">All types</option>
          <option value="Public">Public</option>
          <option value="Private nonprofit">Private nonprofit</option>
          <option value="Private for-profit">Private for-profit</option>
        </select>

        <select id="levelFilter" class="filter-select" aria-label="Filter by level">
          <option value="">All levels</option>
          <option value="4-year">4-year</option>
          <option value="2-year">2-year</option>
          <option value="Less-than-2-year">Less-than-2-year</option>
        </select>

        <select id="sortBy" class="filter-select" aria-label="Sort results">
          <option value="name_asc">Sort: Name (A–Z)</option>
          <option value="state_asc">Sort: State (A–Z)</option>
        </select>

        <button class="apply-btn" id="filterApplyBtn" title="Apply filters and sort" type="button">Apply filters</button>
        <button class="apply-btn" id="resetBtn" title="Reset search and filters" type="button">Reset</button>
        <!-- REMOVED: Select page button entirely -->
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="empty-state" aria-live="polite">
        <div style="font-weight:600; margin-bottom:.25rem;">No universities match your filters</div>
        <div style="font-size:.9rem; color:#667;">Try adjusting search or clearing filters.</div>
        <div class="actions">
          <button class="apply-btn" id="clearFiltersBtn" type="button">Clear filters</button>
          <button class="page-btn" id="retryLoadBtn" style="display:none;" type="button">Retry loading</button>
        </div>
      </div>

      <!-- Results grid -->
      <div class="university-grid" id="universityGrid" role="list" aria-label="Universities list"></div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pager">
          <button class="page-btn" id="prevPage">Prev</button>
          <span id="pageInfo" style="font-weight:600;">Page 1 of 1</span>
          <button class="page-btn" id="nextPage">Next</button>
        </div>
        <div class="page-size">
          <label for="pageSize">Per page:</label>
          <select id="pageSize" class="filter-select" style="width:auto;display:inline-block;">
            <option value="20">20</option>
            <option value="40" selected>40</option>
            <option value="80">80</option>
            <option value="120">120</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Selected Universities -->
    <div class="selected-section">
      <h2 class="section-title" style="display:flex;align-items:center;gap:.5rem;">
        <span class="material-icons">check_circle</span> Selected Universities
        <button id="copyLinkBtn" class="page-btn" title="Copy shareable link" style="margin-left:auto;">Copy link</button>
      </h2>
      <div class="selected-count" id="selectedCount">0 universities selected</div>
      <div class="selected-list" id="selectedList" role="list" aria-live="polite"></div>
      <div class="send-section">
        <button class="send-btn" id="sendBtn" disabled>
          <span class="material-icons">send</span>
          Send to Selected Universities
        </button>
      </div>
    </div>
    <!-- Progress Section -->
    <div class="progress-section" id="progressSection">
      <h2 class="progress-title">Sending Letters...</h2>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText" aria-live="polite">Preparing to send...</div>
      <div class="delivery-list" id="deliveryList"></div>
    </div>

    <!-- Success Section -->
    <div class="success-section" id="successSection">
      <div class="success-icon"><span class="material-icons">check_circle</span></div>
      <h2 class="success-title">Letters Sent Successfully!</h2>
      <p class="success-subtitle">Your recommendation letter has been delivered to all selected universities.</p>
      <button class="new-upload-btn" id="newUploadBtn">
        <span class="material-icons">add</span>
        Send Another Letter
      </button>
    </div>

    <!-- Confirm Send Modal -->
    <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(720px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1.2rem 1.4rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
          <div id="confirmModalTitle" style="font-weight:700;">Confirm recipients</div>
          <button aria-label="Close" id="modalCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1.2rem 1.4rem; max-height:60vh; overflow:auto; line-height:1.45;">
          <div id="modalSummary" style="margin-bottom:1rem;"></div>
          <div id="modalLists" style="display:grid; gap:1rem;">
            <div>
              <div style="font-weight:600;">Included (<span id="modalIncludedCount">0</span>)</div>
              <div id="modalIncluded"></div>
            </div>
            <div>
              <div style="font-weight:600;">Removed vs student’s list (<span id="modalRemovedCount">0</span>)</div>
              <div id="modalRemoved" style="color:#b00020;"></div>
            </div>
            <div>
              <div style="font-weight:600;">Added by you (<span id="modalAddedCount">0</span>)</div>
              <div id="modalAdded" style="color:#1b5e20;"></div>
            </div>
          </div>
        </div>
        <div style="padding:1rem 1.4rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="modalCancelBtn">Cancel</button>
          <button class="apply-btn" id="modalConfirmBtn">Send now</button>
        </div>
      </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="importModal" role="dialog" aria-modal="true" aria-labelledby="importTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(680px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1rem 1.2rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
          <div id="importTitle" style="font-weight:700;">Bulk import universities</div>
          <button aria-label="Close" id="importCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1rem 1.2rem; display:grid; gap:.75rem;">
          <div style="font-size:.92rem; color:#556;">
            Paste one <b>name per line</b>. We’ll fuzzy-match against the master list.
          </div>
          <textarea id="importTextarea" rows="10" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;"></textarea>
          <div id="importPreview" style="font-size:.9rem; color:#667;"></div>
        </div>
        <div style="padding:1rem 1.2rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="importCancelBtn">Cancel</button>
          <button class="apply-btn" id="importConfirmBtn">Add matches</button>
        </div>
      </div>
    </div>

    <!-- Contact Admin Overlay -->
    <div id="contactOverlay" role="dialog" aria-modal="true" aria-labelledby="contactTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:10000;">
      <div style="background:#fff; width:min(560px,92vw); border-radius:16px; box-shadow:0 18px 50px rgba(0,0,0,.22); overflow:hidden; transform:translateY(12px); opacity:0; transition:.18s;">
        <div style="padding:1rem 1.25rem; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
          <div id="contactTitle" style="font-weight:700;">Contact admin</div>
          <button aria-label="Close" id="contactCloseBtn2" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <form id="contactForm2" style="padding:1rem 1.25rem; display:grid; gap:.75rem;">
          <div>
            <label for="cFirst2" style="display:block; font-weight:600; margin-bottom:.35rem;">First name</label>
            <input id="cFirst2" name="first" class="filter-select" type="text" placeholder="Your first name" required />
          </div>
          <div>
            <label for="cEmail2" style="display:block; font-weight:600; margin-bottom:.35rem;">Email address</label>
            <input id="cEmail2" name="email" class="filter-select" type="email" placeholder="you@example.com" required />
          </div>
          <div>
            <label for="cQuery2" style="display:block; font-weight:600; margin-bottom:.35rem;">Query</label>
            <textarea id="cQuery2" name="query" rows="5" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;" placeholder="How can we help?" required></textarea>
          </div>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid #f1f5f9; padding-top:.75rem;">
            <button type="button" class="page-btn" id="contactCancelBtn2">Cancel</button>
            <button type="submit" class="apply-btn" id="contactSendBtn2">Send</button>
          </div>
          <input type="hidden" name="form-name" value="contact-admin">
        </form>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>
  </div><!-- /.container -->

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">
      <p>&copy; 2025 <span style="color: #ffeb3b; font-weight: 600;">StellarRec™</span>. All rights reserved. |
        Making recommendations stellar since 2025 🚀</p>
    </div>
  </footer>
  <!-- Sanity checks + header interactions -->
  <script>
    (function(){
      if (typeof Fuse !== 'function') console.warn('[SR] Fuse.js not loaded');
      if (typeof localforage === 'undefined') console.warn('[SR] localForage not loaded');
      else localforage.config({ name: 'StellarRec' });

      // Avatar dropdown toggling (works with corrected structure)
      const btn = document.getElementById('userAvatarBtn');
      const dd  = document.getElementById('userDropdown');
      function closeDD(e){
        if (!dd) return;
        if (e && (dd.contains(e.target) || btn.contains(e.target))) return;
        dd.classList.remove('show');
        btn?.setAttribute('aria-expanded','false');
        document.removeEventListener('click', closeDD);
      }
      btn?.addEventListener('click', (e)=>{
        e.stopPropagation();
        dd?.classList.toggle('show');
        btn.setAttribute('aria-expanded', dd?.classList.contains('show') ? 'true' : 'false');
        if (dd?.classList.contains('show')) setTimeout(()=>document.addEventListener('click', closeDD), 0);
      });

      // Theme button fallback (dashboard.js will also manage this)
      document.getElementById('headerThemeBtn')?.addEventListener('click', ()=>{
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme') === 'dark';
        root.setAttribute('data-theme', isDark ? 'light' : 'dark');
      });
    })();
  </script>

  <!-- Vendor scripts (self-hosted) -->
  <script src="/assets/js/vendor/fuse.min.js" defer></script>
  <script src="/assets/js/vendor/localforage.min.js" defer></script>

  <!-- Your app code -->
  <script src="/assets/js/dashboard.js" defer></script>

  <!-- Search/Filters/Autosuggest/Pagination + “fly” animation -->
  <script>
  (function(){
    // Utilities + state used here (we avoid clobbering global code)
    const norm = s => (s||'').toString().trim().toLowerCase();

    const el = {
      input: document.getElementById('universitySearch'),
      apply: document.getElementById('searchApplyBtn'),
      suggest: document.getElementById('searchSuggest'),
      state: document.getElementById('stateFilter'),
      type: document.getElementById('typeFilter'),
      level: document.getElementById('levelFilter'),
      sort: document.getElementById('sortBy'),
      reset: document.getElementById('resetBtn'),
      applyFilters: document.getElementById('filterApplyBtn'),
      select: document.getElementById('universitySelect'),
      grid: document.getElementById('universityGrid'),
      empty: document.getElementById('emptyState'),
      prev: document.getElementById('prevPage'),
      next: document.getElementById('nextPage'),
      pageInfo: document.getElementById('pageInfo'),
      pageSize: document.getElementById('pageSize'),
      selectedList: document.getElementById('selectedList'),
      resultMeta: document.getElementById('resultMeta'),
    };

    if (!el.grid) return;

    const state = {
      q: '',
      byState: '',
      byType: '',
      byLevel: '',
      sort: 'name_asc',
      page: 1,
      pageSize: 40,
      filteredIds: [],
    };

    function renderResultMeta(filtered, total){
      if (el.resultMeta) el.resultMeta.textContent = `Showing ${filtered} of ${total}`;
    }

    function applyFiltersAndSort(){
      if (!Array.isArray(window.universities)) return;
      const q = norm(state.q);
      let rows = window.universities.slice();

      if (q) rows = rows.filter(u => norm(u.name).includes(q));
      if (state.byState) rows = rows.filter(u => (u.state || '') === state.byState);
      if (state.byType)  rows = rows.filter(u => (u.type  || '') === state.byType);
      if (state.byLevel) rows = rows.filter(u => (u.level || '') === state.byLevel);

      if (state.sort === 'name_asc') {
        rows.sort((a,b)=> a.name.localeCompare(b.name));
      } else if (state.sort === 'state_asc') {
        rows.sort((a,b)=> (a.state||'').localeCompare(b.state||'') || a.name.localeCompare(b.name));
      }

      state.filteredIds = rows.map(u => u.unitid);
      state.page = 1;
      renderResultMeta(state.filteredIds.length, window.universities.length);
      renderPage();
    }

    function renderPage(){
      const { page, pageSize, filteredIds } = state;
      const start = (page - 1) * pageSize;
      const end   = start + pageSize;
      const ids = filteredIds.slice(start, end);

      el.grid.innerHTML = '';

      if (!ids.length) {
        if (el.empty) el.empty.style.display = 'block';
        el.grid.style.display = 'none';
      } else {
        if (el.empty) el.empty.style.display = 'none';
        el.grid.style.display = 'grid';

        ids.forEach(id => {
          const u = window.universities.find(x => x.unitid === id);
          if (!u) return;

          const card = document.createElement('div');
          card.className = 'university-card';
          card.role = 'listitem';
          card.innerHTML = `
            <div class="university-header">
              <div class="university-logo">${(u.name||'U').slice(0,1)}</div>
              <div>
                <div class="university-name">${u.name}</div>
                <div class="university-location">${u.state || ''}</div>
                ${u.level ? `<span class="university-pill">${u.level}</span>` : ''}
              </div>
            </div>
            <div style="display:flex; gap:.5rem; align-items:center; margin-top:.5rem;">
              <button type="button" class="apply-btn add-btn">Add</button>
            </div>
          `;
          card.querySelector('.add-btn').addEventListener('click', () => {
            selectUniversity(u);
            animateToSelected(card, u.name);
          });
          el.grid.appendChild(card);
        });
      }

      const totalPages = Math.max(1, Math.ceil(filteredIds.length / state.pageSize));
      if (el.pageInfo) el.pageInfo.textContent = `Page ${Math.min(page,totalPages)} of ${totalPages}`;
      if (el.prev) el.prev.disabled = (page <= 1);
      if (el.next) el.next.disabled = (page >= totalPages);
    }

    function selectUniversity(u){
      window.studentUnitIds = window.studentUnitIds || new Set();
      window.addedByRecommender = window.addedByRecommender || new Set();
      window.removedByRecommender = window.removedByRecommender || new Set();

      if (window.studentUnitIds.has(u.unitid)) {
        window.removedByRecommender.delete(u.unitid);
      } else {
        window.addedByRecommender.add(u.unitid);
      }

      window.updateSelectedList?.();
      window.updateSendButton?.();
    }

    function animateToSelected(fromEl, label){
      try {
        const list = el.selectedList;
        if (!fromEl || !list) return;

        const r1 = fromEl.getBoundingClientRect();
        const r2 = list.getBoundingClientRect();
        const dx = (r2.left + r2.width * 0.15) - (r1.left + r1.width/2);
        const dy = (r2.top  + 8) - (r1.top  + r1.height/2);

        const chip = document.createElement('div');
        chip.className = 'fly-chip';
        chip.textContent = label || 'Added';
        chip.style.left = `${r1.left + r1.width/2}px`;
        chip.style.top  = `${r1.top  + r1.height/2}px`;
        chip.style.setProperty('--dx', `${dx}px`);
        chip.style.setProperty('--dy', `${dy}px`);
        document.body.appendChild(chip);
        setTimeout(()=> chip.remove(), 480);
      } catch {}
    }

    function buildSuggestions(query){
      if (!Array.isArray(window.universities)) return [];
      const q = norm(query);
      if (!q) return [];
      const max = 10, out = [];
      for (const u of window.universities) {
        if (norm(u.name).includes(q)) {
          out.push(u);
          if (out.length >= max) break;
        }
      }
      return out;
    }

    function showSuggest(list){
      if (!el.suggest) return;
      if (!list.length) { el.suggest.style.display='none'; el.input?.setAttribute('aria-expanded','false'); return; }
      el.suggest.innerHTML = list.map((u,i)=>`
        <div class="suggest-item" role="option" data-id="${u.unitid}" aria-selected="${i===0?'true':'false'}">
          <span class="material-icons" aria-hidden="true">school</span>
          <span>${u.name}</span>
          <span class="suggest-muted">· ${u.state||''}</span>
        </div>
      `).join('');
      el.suggest.style.display = 'block';
      el.input?.setAttribute('aria-expanded','true');
    }

    function hideSuggest(){
      if (!el.suggest) return;
      el.suggest.style.display='none';
      el.input?.setAttribute('aria-expanded','false');
    }

    function setupAutosuggest(){
      if (!el.input) return;
      let hoverIdx = -1;
      let items = [];

      function refresh(){
        items = buildSuggestions(el.input.value);
        showSuggest(items);
        hoverIdx = items.length ? 0 : -1;
        highlight();
      }
      function highlight(){
        if (!el.suggest) return;
        [...el.suggest.querySelectorAll('.suggest-item')].forEach((n,i)=>{
          n.setAttribute('aria-selected', i===hoverIdx ? 'true' : 'false');
        });
      }

      el.input.addEventListener('input', refresh);
      el.input.addEventListener('keydown', (e)=>{
        if (!items.length) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); hoverIdx = Math.min(hoverIdx+1, items.length-1); highlight(); }
        if (e.key === 'ArrowUp')   { e.preventDefault(); hoverIdx = Math.max(0, hoverIdx-1); highlight(); }
        if (e.key === 'Enter')     { e.preventDefault(); choose(items[hoverIdx]); }
        if (e.key === 'Escape')    { hideSuggest(); }
      });

      el.suggest?.addEventListener('click', (e)=>{
        const it = e.target.closest('.suggest-item');
        if (!it) return;
        const id = it.getAttribute('data-id');
        const u = window.universities?.find(x=> String(x.unitid) === String(id));
        choose(u);
      });

      document.addEventListener('click', (e)=>{
        if (!e.target.closest('.university-search')) hideSuggest();
      });

      function choose(u){
        if (!u) return;
        el.input.value = u.name;
        state.q = u.name;
        hideSuggest();
        applyFiltersAndSort();

        const card = [...el.grid.querySelectorAll('.university-card')]
          .find(c => c.querySelector('.university-name')?.textContent === u.name);
        if (card) {
          selectUniversity(u);
          animateToSelected(card, u.name);
        } else {
          animateToSelected(el.input, u.name);
          selectUniversity(u);
        }
      }
    }

    function setupFilterHandlers(){
      el.apply?.addEventListener('click', ()=>{
        state.q = el.input?.value || '';
        applyFiltersAndSort();
      });
      el.input?.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') { e.preventDefault(); el.apply?.click(); }
      });

      el.applyFilters?.addEventListener('click', ()=>{
        state.byState = el.state?.value || '';
        state.byType  = el.type?.value  || '';
        state.byLevel = el.level?.value || '';
        state.sort    = el.sort?.value  || 'name_asc';
        applyFiltersAndSort();
      });

      el.reset?.addEventListener('click', ()=>{
        state.q = '';
        state.byState = '';
        state.byType  = '';
        state.byLevel = '';
        state.sort    = 'name_asc';
        if (el.input) el.input.value = '';
        if (el.state) el.state.value = '';
        if (el.type)  el.type.value  = '';
        if (el.level) el.level.value = '';
        if (el.sort)  el.sort.value  = 'name_asc';
        applyFiltersAndSort();
      });

      el.select?.addEventListener('change', ()=>{
        const id = el.select.value;
        const u = window.universities?.find(x => String(x.unitid) === String(id) || x.name === id);
        if (u) {
          selectUniversity(u);
          animateToSelected(el.select, u.name);
        }
        el.select.value = '';
      });

      // Clear filters button in empty-state
      document.getElementById('clearFiltersBtn')?.addEventListener('click', ()=> el.reset?.click());
    }

    function setupPagination(){
      el.prev?.addEventListener('click', ()=>{
        if (state.page > 1) { state.page--; renderPage(); }
      });
      el.next?.addEventListener('click', ()=>{
        const totalPages = Math.max(1, Math.ceil(state.filteredIds.length / state.pageSize));
        if (state.page < totalPages) { state.page++; renderPage(); }
      });
      el.pageSize?.addEventListener('change', ()=>{
        const v = parseInt(el.pageSize.value, 10);
        state.pageSize = isNaN(v) ? 40 : v;
        state.page = 1;
        renderPage();
      });
    }

    function bootOnceDataReady(){
      if (!Array.isArray(window.universities) || !window.universities.length) {
        setTimeout(bootOnceDataReady, 200);
        return;
      }
      setupAutosuggest();
      setupFilterHandlers();
      setupPagination();

      // Populate Browse-all if not already done elsewhere
      if (el.select && el.select.options.length <= 1) {
        const frag = document.createDocumentFragment();
        window.universities.slice(0, 1000).forEach(u=>{
          const opt = document.createElement('option');
          opt.value = String(u.unitid);
          opt.textContent = u.name;
          frag.appendChild(opt);
        });
        el.select.appendChild(frag);
      }

      applyFiltersAndSort();
    }

    bootOnceDataReady();
  })();
  </script>
</body>
</html>


