[Block 1/15]

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StellarRec - One upload. Unlimited reach.</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Roboto',sans-serif;
      background:linear-gradient(135deg,var(--bg-grad-1,#f8f9fa) 0%,var(--bg-grad-2,#e9ecef) 100%);
      color:var(--text,#333);
      min-height:100vh;
    }

    /* Header */
    .header {
      background:linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color:#fff; padding:1.5rem 2rem;
      box-shadow:0 4px 20px rgba(25,118,210,0.3);
    }
    .header-content {
      max-width:1200px; margin:0 auto;
      display:flex; justify-content:space-between; align-items:center; gap:1rem;
    }
    .logo {
      display:flex; align-items:center; gap:.5rem;
      font-size:1.8rem; font-weight:700;
      text-decoration:none; color:#fff; transition:.3s;
    }
    .logo:hover { opacity:.85; transform:translateY(-1px); }

    .user-info { position:relative; display:flex; align-items:center; gap:1rem; }
    .user-avatar {
      width:45px; height:45px;
      background:rgba(255,255,255,.2); border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:1.2rem; cursor:pointer; transition:.3s;
    }
    .user-avatar:hover { background:rgba(255,255,255,.3); transform:scale(1.05); }

    .user-dropdown {
      position:absolute; top:100%; right:0; margin-top:.5rem;
      background:#fff; border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,.15);
      min-width:260px; opacity:0; visibility:hidden;
      transform:translateY(-10px);
      transition:.3s; z-index:1000;
    }
    .user-dropdown.show { opacity:1; visibility:visible; transform:translateY(0); }

    .dropdown-header { padding:1rem; border-bottom:1px solid #f0f0f0; color:#333; font-weight:600; font-size:.9rem; }
    .dropdown-item {
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem; color:#333; cursor:pointer; transition:.2s;
    }
    .dropdown-item:hover { background:#f8f9fa; }
    .dropdown-item.active { background:#e3f2fd; color:#1976d2; }
    .dropdown-item .material-icons { font-size:1.2rem; color:#666; }
    .dropdown-item.active .material-icons { color:#1976d2; }

    .view-label { display:flex; flex-direction:column; }
    .view-name { font-weight:600; font-size:.9rem; }
    .view-description { font-size:.8rem; color:#666; margin-top:.1rem; }

    /* SR tabs */
    .sr-tabs { display:flex; gap:.5rem; }
    .sr-tab {
      background:#ffffff22; color:#fff;
      border:1px solid #ffffff44; border-radius:999px;
      padding:.4rem .9rem; font-weight:600; cursor:pointer; transition:.15s; outline: none;
    }
    .sr-tab[aria-selected="true"] { background:#fff; color:#1976d2; }
    .sr-tab:focus-visible { box-shadow:0 0 0 3px rgba(255,255,255,.5); }
    @media (max-width:768px){ .sr-tabs{ align-self:flex-start; } }
[Block 2/15]

    .container { max-width:1200px; margin:0 auto; padding:2rem; }
    .hero-section { text-align:center; margin-bottom:3rem; }
    .hero-title { font-size:2.5rem; font-weight:700; color:#1976d2; margin-bottom:1rem; }
    .hero-subtitle { font-size:1.2rem; color:#666; margin-bottom:2rem; }

    /* Two-column layout */
    .compose-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:2rem; }
    @media (max-width: 980px) { .compose-grid { grid-template-columns:1fr; } }

    .upload-section, .writer-section, .university-section,
    .selected-section, .progress-section {
      background:#fff; border-radius:16px; padding:2rem;
      box-shadow:0 8px 32px rgba(0,0,0,.1); margin-bottom:0;
    }
    .upload-section { border:2px dashed #e0e0e0; transition:.3s; }
    .upload-section.dragover { border-color:#1976d2; background:#f3f8ff; }

    .upload-area { text-align:center; padding:2rem; }
    .upload-icon { font-size:4rem; color:#1976d2; margin-bottom:1rem; }
    .upload-title { font-size:1.5rem; font-weight:600; margin-bottom:.5rem; color:#333; }
    .upload-subtitle { color:#666; margin-bottom:2rem; }
    .file-input { display:none; }
    .upload-btn {
      background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff;
      padding:1rem 2rem; border:none; border-radius:12px;
      font-size:1.1rem; font-weight:600; cursor:pointer;
      transition:.3s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    .uploaded-file {
      display:none; background:#e8f5e8; border:2px solid #4caf50;
      border-radius:12px; padding:1.5rem; margin-top:1rem;
    }
    .file-info { display:flex; align-items:center; gap:1rem; }
    .file-icon { font-size:2rem; color:#4caf50; }
    .file-details h3 { color:#2e7d32; margin-bottom:.25rem; }
    .file-details p { color:#4caf50; font-size:.9rem; }
    .remove-file {
      margin-left:auto; background:none; border:none; color:#666;
      cursor:pointer; padding:.5rem; border-radius:50%; transition:.2s;
    }
    .remove-file:hover { background:rgba(244,67,54,.1); color:#f44336; }

    .section-title {
      font-size:1.5rem; font-weight:600; color:#333;
      margin-bottom:1rem; display:flex; align-items:center; gap:.5rem;
    }

    /* Writer */
    .writer-toolbar { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.75rem; align-items:center; }
    .writer-toolbar .btn {
      background:#fff; border:2px solid #e5e7eb; border-radius:10px;
      padding:.45rem .75rem; cursor:pointer; font-weight:600;
    }
    .writer-toolbar .btn:hover { background:#f8f9fa; }
    .writer-toolbar .meta { margin-left:auto; font-size:.9rem; color:#667; display:flex; gap:.75rem; align-items:center; }
    .writer-title {
      width:100%; padding:.7rem .9rem;
      border:2px solid #e0e0e0; border-radius:12px;
      font-size:1rem; margin-bottom:.6rem;
    }
    .writer-box {
      border:2px solid #e0e0e0; border-radius:12px;
      min-height:280px; padding:1rem; line-height:1.55;
    }
    .writer-box:focus { outline:none; border-color:#1976d2; }
    .writer-actions { display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap; }
    .btn-primary { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; border:none; }
    .btn-success { background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; border:none; }
    .btn-danger  { background:linear-gradient(135deg,#e53935,#ef5350); color:#fff; border:none; }
    .btn-muted   { background:#fff; color:#333; }
[Block 3/15]

    .filter-meta { font-size:.9rem; color:#666; margin:.25rem 0 .5rem; }

    .filter-bar { display:grid; grid-template-columns: repeat(8, minmax(140px, 1fr)); gap:.5rem; margin-bottom:.75rem; align-items:center; }
    .filter-select { width:100%; padding:.7rem .9rem; border:2px solid #e0e0e0; border-radius:12px; background:#fff; font-size:.95rem; }

    .university-grid {
      display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:1rem;
      max-height:480px; overflow-y:auto; padding:1rem; border:1px solid #f0f0f0; border-radius:12px;
    }
    .university-card { background:#f8f9fa; border:2px solid transparent; border-radius:12px; padding:1rem; cursor:pointer; transition:.2s; }
    .university-card:hover { border-color:#1976d2; background:#f3f8ff; }
    .university-card.selected { border-color:#1976d2; background:#e3f2fd; }
    .university-header { display:flex; align-items:center; gap:1rem; margin-bottom:.5rem; }
    .university-logo { width:40px; height:40px; background:#1976d2; color:#fff; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:600; }
    .university-name { font-weight:600; color:#333; }
    .university-location { color:#666; font-size:.9rem; }
    .university-pill { margin-top:.25rem; display:inline-block; font-size:.75rem; color:#555; background:#eef3ff; border:1px solid #dbe7ff; padding:.15rem .5rem; border-radius:999px; }

    .pagination { display:flex; justify-content:space-between; align-items:center; margin-top:.75rem; }
    .pager { display:flex; gap:.5rem; }
    .page-btn { background:#fff; border:2px solid #e0e0e0; border-radius:10px; padding:.5rem .9rem; cursor:pointer; font-weight:600; }
    .page-btn[disabled] { opacity:.5; cursor:not-allowed; }
    .page-size { margin-left:auto; display:flex; align-items:center; gap:.5rem; }

    .selected-count { color:#1976d2; font-weight:600; margin-bottom:1rem; }
    .selected-list { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:2rem; }
    .selected-tag { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:.5rem 1rem; border-radius:20px; font-size:.9rem; display:flex; align-items:center; gap:.5rem; }
    .remove-tag { cursor:pointer; background:rgba(255,255,255,.2); border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .remove-tag:hover { background:rgba(255,255,255,.3); }

    .send-section { text-align:center; }
    .send-btn {
      background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; padding:1.2rem 3rem; border:none; border-radius:12px;
      font-size:1.2rem; font-weight:600; cursor:pointer; transition:.2s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .send-btn:disabled { background:#ccc; cursor:not-allowed; }
    .send-btn:not(:disabled):hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(76,175,80,.3); }

    .progress-section { display:none; }
    .progress-title { font-size:1.3rem; font-weight:600; color:#333; margin-bottom:1rem; text-align:center; }
    .progress-bar { width:100%; height:12px; background:#e0e0e0; border-radius:6px; overflow:hidden; margin-bottom:1rem; }
    .progress-fill { height:100%; background:linear-gradient(135deg,#4caf50,#66bb6a); border-radius:6px; transition:width .5s ease; width:0%; }
    .progress-text { text-align:center; color:#666; font-size:.9rem; }
    .delivery-list { margin-top:1rem; }
    .delivery-item { display:flex; align-items:center; gap:1rem; padding:.75rem; border-radius:8px; margin-bottom:.5rem; background:#f8f9fa; }
    .delivery-status { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .delivery-status.pending { background:#fff3e0; color:#ff9800; }
    .delivery-status.success { background:#e8f5e8; color:#4caf50; }
    .delivery-status.error { background:#ffebee; color:#f44336; }

    .success-section {
      display:none; background:linear-gradient(135deg,#e8f5e8,#f1f8e9);
      border:2px solid #4caf50; border-radius:16px; padding:2rem; text-align:center; box-shadow:0 8px 32px rgba(76,175,80,.2);
    }
    .success-icon { font-size:4rem; color:#4caf50; margin-bottom:1rem; }
    .success-title { font-size:1.8rem; font-weight:600; color:#2e7d32; margin-bottom:1rem; }
    .success-subtitle { color:#4caf50; margin-bottom:2rem; }
    .new-upload-btn { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:1rem 2rem; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition:.2s; }
    .new-upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }

    @keyframes flash { 0%{box-shadow:0 0 0 rgba(25,118,210,0);} 25%{box-shadow:0 0 0 6px rgba(25,118,210,.25);} 100%{box-shadow:0 0 0 rgba(25,118,210,0);} }
    .flash { animation: flash 1.2s ease; }

    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; font-size:.75rem; border-radius:999px; border:1px solid; }
    .badge-student { background:#f1f8ff; color:#0d47a1; border-color:#bbdefb; }
    .badge-added   { background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9; }
    .badge-removed { background:#ffebee; color:#b71c1c; border-color:#ffcdd2; }

    .toast-wrap { position: fixed; right: 16px; bottom: 16px; z-index: 99999; display: grid; gap: 8px; }
    .toast {
      min-width: 240px; max-width: 420px; padding: .75rem .9rem; border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.15); color:#0f172a; background:#fff; border:1px solid #e5e7eb;
      display:flex; align-items:flex-start; gap:.6rem; animation: toast-in .18s ease;
    }
    .toast.success { border-color:#c8e6c9; background:#f1f8f3; }
    .toast.error   { border-color:#ffcdd2; background:#fff2f2; }
    .toast.info    { border-color:#bbdefb; background:#f3f8ff; }
    .toast .icon { font-size: 1.1rem; line-height:1; margin-top:.1rem; }
    .toast .msg  { flex:1; font-size:.95rem; }
    .toast .x    { border:none; background:transparent; cursor:pointer; font-size:1rem; opacity:.6; }
    .toast .x:hover { opacity:.9; }
    @keyframes toast-in { from { transform: translateY(6px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    .empty-state { display:none; background:#fff; border:1px dashed #d0d7de; border-radius:12px; padding:1.25rem; color:#445; text-align:center; }
    .empty-state .actions { margin-top:.75rem; display:flex; gap:.5rem; justify-content:center; }

    @media (max-width:768px) {
      .container { padding:1rem; }
      .hero-title { font-size:2rem; }
      .university-grid { grid-template-columns:1fr; }
      .header-content { flex-direction:column; gap:1rem; }
      .filter-bar { grid-template-columns:1fr 1fr; }
    }

    /* Autosuggest */
    .suggest-popover {
      position: absolute; z-index: 2000; width: 100%;
      max-height: 280px; overflow-y: auto; margin-top: .25rem;
      background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 12px 32px rgba(0,0,0,.08);
    }
    .suggest-item { padding:.6rem .8rem; cursor:pointer; display:flex; align-items:center; gap:.5rem; font-size:.95rem; }
    .suggest-item[aria-selected="true"], .suggest-item:hover { background:#f3f8ff; }
    .suggest-muted { color:#6b7280; font-size:.85rem; }
    .suggest-highlight { font-weight:700; }

    /* Header tabs */
    .sr-tabs { display:flex; gap:.5rem; }
    .sr-tab {
      background:#ffffff22; color:#fff; border:1px solid #ffffff44; border-radius:999px;
      padding:.4rem .9rem; font-weight:600; cursor:pointer; transition:.15s; outline: none;
    }
    .sr-tab[aria-selected="true"] { background:#fff; color:#1976d2; }
    .sr-tab:focus-visible { box-shadow:0 0 0 3px rgba(255,255,255,.5); }
    @media (max-width:768px){ .sr-tabs{ align-self:flex-start; } }

    /* Dark theme toggle basics */
    :root[data-theme="dark"] {
      --bg:#0b1220; --panel:#111a2a; --text:#e5eefc; --muted:#93a3bc; --primary:#7aa2ff; --border:#24324a;
    }
    :root[data-theme="dark"] body { background: linear-gradient(135deg,#0b1220 0%,#0f1729 100%); color: var(--text); }
    :root[data-theme="dark"] .upload-section,
    :root[data-theme="dark"] .writer-section,
    :root[data-theme="dark"] .university-section,
    :root[data-theme="dark"] .selected-section,
    :root[data-theme="dark"] .progress-section { background: var(--panel); box-shadow:none; }
    :root[data-theme="dark"] .filter-select,
    :root[data-theme="dark"] .writer-title,
    :root[data-theme="dark"] .writer-box,
    :root[data-theme="dark"] .page-btn { background:#0f1729; color:var(--text); border-color: var(--border); }
    :root[data-theme="dark"] .university-card { background:#0f1729; }
    :root[data-theme="dark"] .university-card:hover { background:#12203a; border-color:#274780; }
    :root[data-theme="dark"] .university-card.selected { background:#13254a; }
    :root[data-theme="dark"] .hero-subtitle, :root[data-theme="dark"] .university-location { color: var(--muted); }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <a href="index.html" class="logo">
        <span class="material-icons">star</span>
        stellarrec
      </a>

      <!-- View Tabs -->
      <div id="sr-tabs" role="tablist" aria-label="Switch View" class="sr-tabs">
        <button id="tab-recommender" role="tab" aria-selected="true" aria-controls="panel-recommender" class="sr-tab">Recommender</button>
        <button id="tab-student" role="tab" aria-selected="false" aria-controls="panel-student" class="sr-tab">Student</button>
      </div>

      <!-- User / settings -->
      <div class="user-info">
        <div class="user-avatar" id="userAvatarBtn" aria-haspopup="true" aria-expanded="false">
          <span class="material-icons">person</span>
        </div>
        <div class="user-dropdown" id="userDropdown" role="menu" aria-hidden="true">
          <div class="dropdown-header">Quick actions</div>

          <div class="dropdown-item" id="contactAdminItem">
            <span class="material-icons">support_agent</span>
            <div class="view-label">
              <div class="view-name">Contact admin</div>
              <div class="view-description">Send a message</div>
            </div>
          </div>

          <div class="dropdown-item" id="themeToggleItem">
            <span class="material-icons">dark_mode</span>
            <div class="view-label">
              <div class="view-name">Theme</div>
              <div class="view-description">Light / Dark</div>
            </div>
            <label style="margin-left:auto;display:flex;align-items:center;gap:.4rem;">
              <input id="themeToggle" type="checkbox" />
              <span style="font-size:.85rem;">Dark</span>
            </label>
          </div>

          <div class="dropdown-item active" onclick="switchView('recommender', event)">
            <span class="material-icons">edit</span>
            <div class="view-label">
              <div class="view-name">Recommender</div>
              <div class="view-description">Write & send letters</div>
            </div>
          </div>
          <div class="dropdown-item" onclick="switchView('student', event)">
            <span class="material-icons">school</span>
            <div class="view-label">
              <div class="view-name">Student</div>
              <div class="view-description">Track applications</div>
            </div>
          </div>

          <!-- Mock API toggle -->
          <div class="dropdown-item" style="border-top:1px solid #f0f0f0;">
            <label for="mockToggle" style="display:flex; align-items:center; gap:.75rem; width:100%; cursor:pointer;">
              <span class="material-icons">build</span>
              <div class="view-label">
                <div class="view-name">Use mock API</div>
                <div class="view-description">Toggle mock vs real backend</div>
              </div>
              <input id="mockToggle" type="checkbox" style="margin-left:auto; width:18px; height:18px;" />
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Admin Modal -->
  <div id="contactModal" role="dialog" aria-modal="true" aria-labelledby="contactTitle"
       style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; width:min(560px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
      <div style="padding:1.2rem 1.4rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div id="contactTitle" style="font-weight:700;">Contact Admin</div>
        <button aria-label="Close" id="contactCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
      </div>
      <form id="contactForm" style="padding:1rem 1.4rem; display:grid; gap:.75rem;">
        <label>First name
          <input type="text" id="contactFirst" required class="filter-select" style="margin-top:.35rem;">
        </label>
        <label>Email address
          <input type="email" id="contactEmail" required class="filter-select" style="margin-top:.35rem;">
        </label>
        <label>Query
          <textarea id="contactQuery" rows="5" required class="filter-select" style="margin-top:.35rem;"></textarea>
        </label>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; padding-top:.5rem;">
          <button type="button" class="page-btn" id="contactCancelBtn">Cancel</button>
          <button type="submit" class="apply-btn" id="contactSendBtn">Send</button>
        </div>
      </form>
    </div>
  </div>

  <div class="container" id="panel-recommender">
    <!-- Student Context Bar -->
    <div class="student-bar" id="studentBar" style="display:flex; align-items:center; gap:.75rem; background:#fff; border:1px solid #eaeaea; border-radius:12px; padding:1rem; margin-bottom:1rem;">
      <span class="material-icons" aria-hidden="true">account_circle</span>
      <div style="flex:1">
        <div id="studentTitle" style="font-weight:700;">No student loaded</div>
        <div id="studentMeta" style="color:#666; font-size:.9rem;">Load a student to see their preselected universities.</div>
      </div>
      <input id="studentIdInput" class="filter-select" placeholder="Student ID or email" style="max-width:220px;" aria-label="Student identifier"/>
      <button class="apply-btn" id="loadStudentBtn">Load student</button>
      <label style="display:flex; align-items:center; gap:.4rem; margin-left:.5rem; font-size:.9rem;">
        <input type="checkbox" id="allowEditsToggle"/>
        Allow recommender edits
      </label>
    </div>

    <!-- Hero -->
    <div class="hero-section">
      <h1 class="hero-title">One upload. Unlimited reach.</h1>
      <p class="hero-subtitle">Upload your recommendation letter once and send it to multiple US universities instantly.</p>
    </div>

    <!-- Upload + Writer -->
    <div class="compose-grid">
      <!-- Upload Section -->
      <div class="upload-section" id="uploadSection">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon"><span class="material-icons">cloud_upload</span></div>
          <h2 class="upload-title">Upload Recommendation Letter</h2>
          <p class="upload-subtitle">Drag and drop your PDF file here, or click to browse</p>
          <input type="file" id="fileInput" class="file-input" accept=".pdf,.txt" />
          <button class="upload-btn" id="chooseFileBtn">
            <span class="material-icons">upload_file</span>
            Choose File
          </button>
        </div>
        <div class="uploaded-file" id="uploadedFile">
          <div class="file-info">
            <div class="file-icon"><span class="material-icons">description</span></div>
            <div class="file-details">
              <h3 id="fileName">recommendation-letter.pdf</h3>
              <p id="fileSize">2.4 MB • Uploaded successfully</p>
            </div>
            <button class="remove-file" id="removeFileBtn"><span class="material-icons">close</span></button>
          </div>
        </div>
      </div>

      <!-- Writer -->
      <div class="writer-section" id="writerSection">
        <h2 class="section-title"><span class="material-icons">edit</span> Write Letter</h2>
        <input id="writerTitle" class="writer-title" placeholder="Letter title (optional, e.g., 'Recommendation for Jane Doe')" />
        <div class="writer-toolbar">
          <button class="btn btn-muted" data-wcmd="bold" title="Bold (Ctrl/Cmd+B)"><b>B</b></button>
          <button class="btn btn-muted" data-wcmd="italic" title="Italic (Ctrl/Cmd+I)"><i>I</i></button>
          <button class="btn btn-muted" data-wcmd="underline" title="Underline (Ctrl/Cmd+U)"><u>U</u></button>
          <div class="meta">
            <span id="writerCount">0 words • 0 chars</span>
            <span id="writerSaved">Not saved</span>
          </div>
        </div>
        <div id="writerBox" class="writer-box" contenteditable="true" aria-label="Letter editor"
             placeholder="Write your recommendation letter here..."></div>
        <div class="writer-actions">
          <button class="btn btn-primary" id="saveDraftBtn">Save draft</button>
          <button class="btn btn-muted" id="restoreDraftBtn">Restore</button>
          <button class="btn btn-danger" id="clearDraftBtn">Clear</button>
          <button class="btn btn-muted" id="copyDraftBtn">Copy</button>
          <button class="btn btn-muted" id="downloadDraftBtn">Download .txt</button>
          <button class="btn btn-success" id="attachDraftBtn">Attach draft</button>
          <label style="display:flex; align-items:center; gap:.4rem; margin-left:auto;">
            <input type="checkbox" id="writerAutosaveToggle" checked />
            Autosave
          </label>
        </div>
      </div>
    </div>
[Block 4/15]

    <!-- University Selection -->
    <div class="university-section">
      <h2 class="section-title"><span class="material-icons">school</span> Select Universities</h2>

      <!-- Search + Apply -->
      <div class="university-search" style="position:relative;">
        <input type="text" class="search-input filter-select" placeholder="Search universities..." id="universitySearch" autocomplete="off"/>
        <div id="searchSuggest" class="suggest-popover" style="display:none;"></div>
        <button class="apply-btn" id="searchApplyBtn" title="Apply search (Enter)">Apply</button>
      </div>

      <!-- Browse-all dropdown -->
      <select id="universitySelect" class="filter-select" title="Browse all universities" style="margin-bottom:.5rem;">
        <option value="" selected disabled>Browse all universities (6000+)</option>
      </select>

      <!-- Filters -->
      <div class="filter-meta" id="resultMeta" aria-live="polite">Showing 0 of 0</div>
      <div class="filter-bar">
        <select id="stateFilter" class="filter-select" aria-label="Filter by state">
          <option value="">All states</option>
          <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option>
          <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option>
          <option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
          <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option>
          <option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option>
          <option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
          <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option>
          <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option>
          <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
          <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option>
          <option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
          <option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
          <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
        </select>

        <select id="typeFilter" class="filter-select" aria-label="Filter by institution type">
          <option value="">All types</option>
          <option value="Public">Public</option>
          <option value="Private nonprofit">Private nonprofit</option>
          <option value="Private for-profit">Private for-profit</option>
        </select>

        <select id="levelFilter" class="filter-select" aria-label="Filter by level">
          <option value="">All levels</option>
          <option value="4-year">4-year</option>
          <option value="2-year">2-year</option>
          <option value="Less-than-2-year">Less-than-2-year</option>
        </select>

        <select id="sortBy" class="filter-select" aria-label="Sort results">
          <option value="name_asc">Sort: Name (A–Z)</option>
          <option value="state_asc">Sort: State (A–Z)</option>
        </select>

        <button class="apply-btn" id="filterApplyBtn" title="Apply filters and sort">Apply filters</button>
        <button class="apply-btn" id="resetBtn" title="Reset search and filters">Reset</button>
        <button class="apply-btn" id="selectPageBtn" title="Select all universities on this page">Select page</button>
        <button class="page-btn" id="bulkImportBtn" title="Bulk import by names">Bulk import</button>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="empty-state" aria-live="polite">
        <div style="font-weight:600; margin-bottom:.25rem;">No universities match your filters</div>
        <div style="font-size:.9rem; color:#667;">Try adjusting search or clearing filters.</div>
        <div class="actions">
          <button class="apply-btn" id="clearFiltersBtn" type="button">Clear filters</button>
          <button class="page-btn" id="retryLoadBtn" style="display:none;" type="button">Retry loading</button>
        </div>
      </div>

      <!-- Results grid -->
      <div class="university-grid" id="universityGrid" role="list" aria-label="Universities list"></div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pager">
          <button class="page-btn" id="prevPage">Prev</button>
          <span id="pageInfo" style="font-weight:600;">Page 1 of 1</span>
          <button class="page-btn" id="nextPage">Next</button>
        </div>
        <div class="page-size">
          <label for="pageSize">Per page:</label>
          <select id="pageSize" class="filter-select" style="width:auto;display:inline-block;">
            <option value="20">20</option>
            <option value="40" selected>40</option>
            <option value="80">80</option>
            <option value="120">120</option>
          </select>
        </div>
      </div>
    </div>
[Block 5/15]

    <!-- Selected Universities -->
    <div class="selected-section">
      <h2 class="section-title" style="display:flex;align-items:center;gap:.5rem;">
        <span class="material-icons">check_circle</span> Selected Universities
        <button id="copyLinkBtn" class="page-btn" title="Copy shareable link" style="margin-left:auto;">Copy link</button>
      </h2>
      <div class="selected-count" id="selectedCount">0 universities selected</div>
      <div class="selected-list" id="selectedList" role="list" aria-live="polite"></div>
      <div class="send-section">
        <button class="send-btn" id="sendBtn" disabled onclick="sendLetters()">
          <span class="material-icons">send</span>
          Send to Selected Universities
        </button>
      </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progressSection">
      <h2 class="progress-title">Sending Letters...</h2>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText" aria-live="polite">Preparing to send...</div>
      <div class="delivery-list" id="deliveryList"></div>
      <!-- Pause/Resume + Cancel buttons are injected dynamically -->
    </div>

    <!-- Success Section -->
    <div class="success-section" id="successSection">
      <div class="success-icon"><span class="material-icons">check_circle</span></div>
      <h2 class="success-title">Letters Sent Successfully!</h2>
      <p class="success-subtitle">Your recommendation letter has been delivered to all selected universities.</p>
      <button class="new-upload-btn" onclick="startNewUpload()">
        <span class="material-icons">add</span>
        Send Another Letter
      </button>
    </div>

    <!-- Footer (same structure as index.html; styles already present globally) -->
    <footer class="site-footer" id="siteFooter" style="margin-top:3rem;">
      <div class="container" style="padding: 1.5rem 0;">
        <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:center; justify-content:space-between;">
          <div style="display:flex; align-items:center; gap:.5rem; color:#475569;">
            <span class="material-icons" aria-hidden="true">star</span>
            <strong>stellarrec</strong>
            <span aria-hidden="true" style="opacity:.6;">•</span>
            <span>One upload. Unlimited reach.</span>
          </div>
          <nav aria-label="Footer">
            <a href="/" class="page-btn" style="text-decoration:none;">Home</a>
            <a href="/#features" class="page-btn" style="text-decoration:none;">Features</a>
            <a href="/#how-it-works" class="page-btn" style="text-decoration:none;">How it works</a>
            <a href="/#contact" class="page-btn" style="text-decoration:none;">Contact</a>
          </nav>
        </div>
      </div>
    </footer>
[Block 6/15]

    <!-- Confirm Send Modal -->
    <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(720px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1.2rem 1.4rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
          <div id="confirmModalTitle" style="font-weight:700;">Confirm recipients</div>
          <button aria-label="Close" id="modalCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1rem 1.4rem; max-height:60vh; overflow:auto; line-height:1.45;">
          <div id="modalSummary" style="margin-bottom:1rem;"></div>
          <div id="modalLists" style="display:grid; gap:1rem;">
            <div>
              <div style="font-weight:600;">Included (<span id="modalIncludedCount">0</span>)</div>
              <div id="modalIncluded"></div>
            </div>
            <div>
              <div style="font-weight:600;">Removed vs student’s list (<span id="modalRemovedCount">0</span>)</div>
              <div id="modalRemoved" style="color:#b00020;"></div>
            </div>
            <div>
              <div style="font-weight:600;">Added by you (<span id="modalAddedCount">0</span>)</div>
              <div id="modalAdded" style="color:#1b5e20;"></div>
            </div>
          </div>
        </div>
        <div style="padding:1rem 1.4rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="modalCancelBtn">Cancel</button>
          <button class="apply-btn" id="modalConfirmBtn">Send now</button>
        </div>
      </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="importModal" role="dialog" aria-modal="true" aria-labelledby="importTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(680px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1rem 1.2rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
          <div id="importTitle" style="font-weight:700;">Bulk import universities</div>
          <button aria-label="Close" id="importCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1rem 1.2rem; display:grid; gap:.75rem;">
          <div style="font-size:.92rem; color:#556;">
            Paste one <b>name per line</b>. We’ll fuzzy-match against the master list.
          </div>
          <textarea id="importTextarea" rows="10" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;"></textarea>
          <div id="importPreview" style="font-size:.9rem; color:#667;"></div>
        </div>
        <div style="padding:1rem 1.2rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="importCancelBtn">Cancel</button>
          <button class="apply-btn" id="importConfirmBtn">Add matches</button>
        </div>
      </div>
    </div>

    <!-- Contact Admin Overlay (animated from avatar dropdown) -->
    <div id="contactOverlay" role="dialog" aria-modal="true" aria-labelledby="contactTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:10000;">
      <div style="background:#fff; width:min(560px,92vw); border-radius:16px; box-shadow:0 18px 50px rgba(0,0,0,.22); overflow:hidden; transform:translateY(12px); opacity:0; transition:.18s;">
        <div style="padding:1rem 1.25rem; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
          <div id="contactTitle" style="font-weight:700;">Contact admin</div>
          <button aria-label="Close" id="contactCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <form id="contactForm" style="padding:1rem 1.25rem; display:grid; gap:.75rem;">
          <div>
            <label for="cFirst" style="display:block; font-weight:600; margin-bottom:.35rem;">First name</label>
            <input id="cFirst" name="firstName" class="filter-select" type="text" placeholder="Your first name" required />
          </div>
          <div>
            <label for="cEmail" style="display:block; font-weight:600; margin-bottom:.35rem;">Email address</label>
            <input id="cEmail" name="email" class="filter-select" type="email" placeholder="you@example.com" required />
          </div>
          <div>
            <label for="cQuery" style="display:block; font-weight:600; margin-bottom:.35rem;">Query</label>
            <textarea id="cQuery" name="query" rows="5" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;" placeholder="How can we help?" required></textarea>
          </div>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid #f1f5f9; padding-top:.75rem;">
            <button type="button" class="page-btn" id="contactCancelBtn">Cancel</button>
            <button type="submit" class="apply-btn" id="contactSendBtn">Send</button>
          </div>
          <!-- Hidden action field so we don’t expose email; handled by serverless/.toml route -->
          <input type="hidden" name="action" value="contact-admin">
        </form>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>
[Block 7/15]

   <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

<script>
/* ===================== tiny toast ===================== */
(function(){
  window.toast = function(msg, type='info', opts={}){
    const wrap = document.getElementById('toastWrap') || (()=>{ const d=document.createElement('div'); d.id='toastWrap'; d.className='toast-wrap'; document.body.appendChild(d); return d; })();
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `
      <div class="icon">${type==='success'?'✓':type==='error'?'!':'ℹ︎'}</div>
      <div class="msg">${msg}</div>
      <button class="x" aria-label="Close">×</button>`;
    wrap.appendChild(el);
    const ttl = opts.ttl || 2500;
    const close = ()=>{ if(el.parentNode){ el.parentNode.removeChild(el); } };
    el.querySelector('.x').onclick = close;
    setTimeout(close, ttl);
  };
})();
</script>

<script>
/* ===================== utilities & state ===================== */
const norm = s => (s||'').toString().trim().toLowerCase();
const escapeHtml = s => (s??'').toString()
  .replace(/&/g,'&amp;').replace(/</g,'&lt;')
  .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
const debounce = (fn,wait=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; };

let universities = [];       // full dataset
let filtered = [];           // filtered working set
let page = 1, pageSize = 40; // paging
let flashNextRender = false;

let studentProfile = null;
let studentUnitIds = new Set();     // preselected by student
let addedByRecommender = new Set(); // extra you added
let removedByRecommender = new Set();// you removed from student's list
const getEffectiveSelection = ()=>{
  const s = new Set(studentUnitIds);
  removedByRecommender.forEach(id=>s.delete(id));
  addedByRecommender.forEach(id=>s.add(id));
  return s;
};

/* ===================== THEME ===================== */
(function themeInit(){
  const KEY='sr_theme';
  function apply(t){ document.body.classList.toggle('sr-dark', t==='dark'); }
  apply(localStorage.getItem(KEY)||'light');
  const tgl = document.getElementById('themeToggle');
  if (tgl) {
    tgl.checked = (localStorage.getItem(KEY)==='dark');
    tgl.onchange = e=>{ const mode=e.target.checked?'dark':'light'; localStorage.setItem(KEY,mode); apply(mode); toast(`Theme: ${mode}`,'info',{ttl:1200}); };
  }
})();
</script>

<script>
/* ===================== CONTACT ADMIN (Netlify Forms) ===================== */
(function contactAdmin(){
  const dropdown = document.getElementById('userDropdown');
  const avatar   = document.getElementById('userAvatarBtn');
  const overlay  = document.getElementById('contactOverlay');
  const form     = document.getElementById('contactForm');

  // open/close dropdown
  function toggleUserDropdown(){
    const dd = document.getElementById('userDropdown');
    const show = !dd.classList.contains('show');
    dd.classList.toggle('show', show);
    avatar.setAttribute('aria-expanded', show?'true':'false');
  }
  window.toggleUserDropdown = toggleUserDropdown;
  avatar?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleUserDropdown(); });
  document.addEventListener('click', (e)=>{
    if (!dropdown.contains(e.target) && e.target!==avatar) dropdown.classList.remove('show');
  });

  // open overlay from dropdown item
  const contactItem = document.querySelector('.dropdown-item#contactAdminItem,[data-sr="contact-admin"]') || document.getElementById('contactAdminItem');
  contactItem?.addEventListener('click', ()=>{
    dropdown.classList.remove('show');
    overlay.classList.add('show');
    document.getElementById('contactFirst')?.focus();
  });

  // close buttons
  document.getElementById('contactCancelBtn')?.addEventListener('click', ()=> overlay.classList.remove('show'));
  document.getElementById('contactCloseBtn')?.addEventListener('click', ()=> overlay.classList.remove('show'));
  document.getElementById('contactCancel')?.addEventListener('click', ()=> overlay.classList.remove('show'));
  document.getElementById('contactClose')?.addEventListener('click', ()=> overlay.classList.remove('show'));
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') overlay.classList.remove('show'); });

  // submit → Netlify Forms + fallback
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data = new FormData(form);
    try {
      const resp = await fetch('/', {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams([...data, ['form-name','contact-admin']]).toString()
      });
      if (resp.ok) {
        toast('Message sent.','success');
        form.reset(); overlay.classList.remove('show');
        return;
      }
      throw new Error('Bad response');
    } catch {
      // fallback: open mail client (address not shown on page)
      const to='swetha.rajan103@gmail.com';
      const subject=encodeURIComponent('StellarRec — Admin Contact');
      const body=encodeURIComponent(`First name: ${data.get('first')||''}\nEmail: ${data.get('email')||''}\n\nQuery:\n${data.get('query')||data.get('message')||''}`);
      window.location.href=`mailto:${to}?subject=${subject}&body=${body}`;
      overlay.classList.remove('show');
      toast('Opening your email client…','info');
    }
  });
})();
</script>

<script>
/* ===================== WRITER ===================== */
let writerAutosaveTimer=null;
function writerCmd(cmd){ document.execCommand(cmd,false,null); }
function stripHtml(html){ const t=document.createElement('div'); t.innerHTML=html||''; return t.textContent||t.innerText||''; }
function draftKey(){ const sid=(window.studentProfile && (studentProfile.id||studentProfile.email))||'default'; return 'sr_draft_'+sid; }
function saveDraft(quiet=false){
  const bodyHtml=document.getElementById('writerBox').innerHTML||'';
  const title=document.getElementById('writerTitle').value||'';
  const payload={title, bodyHtml, savedAt:Date.now()};
  try{ localStorage.setItem(draftKey(), JSON.stringify(payload)); updateSavedIndicator(payload.savedAt); if(!quiet) toast('Draft saved.','success',{ttl:1800}); }catch(e){ if(!quiet) toast('Could not save draft.','error'); }
}
function restoreDraft(silent=false){
  try{
    const raw=localStorage.getItem(draftKey());
    if(!raw){ if(!silent) toast('No saved draft found.','info'); updateSavedIndicator(null); return; }
    const p=JSON.parse(raw);
    document.getElementById('writerTitle').value=p.title||'';
    document.getElementById('writerBox').innerHTML=p.bodyHtml||'';
    updateWriterCounts(); updateSavedIndicator(p.savedAt||null);
    if(!silent) toast('Draft restored.','success',{ttl:1500});
  }catch(e){ if(!silent) toast('Could not restore draft.','error'); }
}
function clearDraft(){ document.getElementById('writerTitle').value=''; document.getElementById('writerBox').innerHTML=''; updateWriterCounts(); updateSavedIndicator(null); toast('Editor cleared.','info'); }
function copyDraft(){
  const t=document.getElementById('writerTitle').value||'';
  const text=t? (t+'\n\n'+stripHtml(document.getElementById('writerBox').innerHTML)) : stripHtml(document.getElementById('writerBox').innerHTML);
  navigator.clipboard.writeText(text).then(()=>toast('Copied.','success',{ttl:1200})).catch(()=>toast('Copy failed.','error'));
}
function downloadDraft(){
  const title=(document.getElementById('writerTitle').value||'recommendation-letter').replace(/[^\w\d-_ ]+/g,'').trim()||'letter';
  const text=stripHtml(document.getElementById('writerBox').innerHTML);
  const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.download=`${title}.txt`; a.href=URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href);
}
function attachDraft(){
  const title=(document.getElementById('writerTitle').value||'recommendation-letter').replace(/[^\w\d-_ ]+/g,'').trim()||'letter';
  const text=stripHtml(document.getElementById('writerBox').innerHTML).trim(); if(!text){ toast('Draft is empty.','error'); return; }
  const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const file=new File([blob], `${title}.txt`, {type:'text/plain'}); handleFile(file,true);
}
function updateWriterCounts(){ const text=stripHtml(document.getElementById('writerBox').innerHTML); const words=text.trim()?text.trim().split(/\s+/).length:0; document.getElementById('writerCount').textContent=`${words} words • ${text.length} chars`; }
function updateSavedIndicator(ts){ const el=document.getElementById('writerSaved'); if(!ts){ el.textContent='Not saved'; return; } el.textContent='Saved '+new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function scheduleAutosave(immediate=false){ const t=document.getElementById('writerAutosaveToggle'); if(!t?.checked) return; if(writerAutosaveTimer) clearTimeout(writerAutosaveTimer); writerAutosaveTimer=setTimeout(()=>saveDraft(true), immediate?50:600); }
function setupWriter(){
  const box=document.getElementById('writerBox'); const title=document.getElementById('writerTitle'); const autosave=document.getElementById('writerAutosaveToggle');
  restoreDraft(true); updateWriterCounts();
  box.addEventListener('input', ()=>{ updateWriterCounts(); scheduleAutosave(); });
  title.addEventListener('input', ()=> scheduleAutosave() );
  autosave?.addEventListener('change', ()=>{ if(autosave.checked) scheduleAutosave(true); else if(writerAutosaveTimer){ clearTimeout(writerAutosaveTimer); writerAutosaveTimer=null; } });
  box.addEventListener('blur', ()=>{ if(document.getElementById('writerAutosaveToggle').checked) saveDraft(true); });
  title.addEventListener('blur', ()=>{ if(document.getElementById('writerAutosaveToggle').checked) saveDraft(true); });

  // Toolbar buttons using data-wcmd
  document.querySelectorAll('.writer-toolbar [data-wcmd]').forEach(btn=>{
    btn.addEventListener('click', ()=> writerCmd(btn.getAttribute('data-wcmd')));
  });

  document.getElementById('saveDraftBtn')?.addEventListener('click', ()=>saveDraft(false));
  document.getElementById('restoreDraftBtn')?.addEventListener('click', ()=>restoreDraft(false));
  document.getElementById('clearDraftBtn')?.addEventListener('click', clearDraft);
  document.getElementById('copyDraftBtn')?.addEventListener('click', copyDraft);
  document.getElementById('downloadDraftBtn')?.addEventListener('click', downloadDraft);
  document.getElementById('attachDraftBtn')?.addEventListener('click', attachDraft);
}
</script>

<script>
/* ===================== UPLOAD ===================== */
function setupUpload(){
  const fileInput = document.getElementById('fileInput');
  const chooseBtn = document.getElementById('chooseFileBtn');
  const uploadArea= document.getElementById('uploadArea');
  const removeBtn = document.getElementById('removeFileBtn');

  chooseBtn?.addEventListener('click', ()=> fileInput?.click());
  fileInput?.addEventListener('change', e=>{ if(e.target.files?.[0]) handleFile(e.target.files[0]); });

  uploadArea?.addEventListener('dragover', e=>{ e.preventDefault(); document.getElementById('uploadSection').classList.add('dragover'); });
  uploadArea?.addEventListener('dragleave', ()=> document.getElementById('uploadSection').classList.remove('dragover'));
  uploadArea?.addEventListener('drop', e=>{
    e.preventDefault(); document.getElementById('uploadSection').classList.remove('dragover');
    const f = e.dataTransfer.files?.[0]; if(f) handleFile(f);
  });

  removeBtn?.addEventListener('click', removeFile);
}

function handleFile(file, allowAny=false){
  if(!allowAny && file.type !== 'application/pdf'){ toast('Please upload a PDF file.','error'); return; }
  window.uploadedFile = file;
  document.getElementById('uploadedFile').style.display='block';
  document.getElementById('fileName').textContent = file.name;
  const sizeMB=(file.size/1024/1024).toFixed(1);
  document.getElementById('fileSize').textContent = `${sizeMB} MB • ${allowAny?'Draft attached':'Uploaded successfully'}`;
  toast(allowAny ? 'Draft attached to send queue.' : 'PDF attached. Ready to send.','success');
  updateSendButton();
}
function removeFile(){
  window.uploadedFile=null;
  document.getElementById('uploadedFile').style.display='none';
  const fi=document.getElementById('fileInput'); if(fi) fi.value='';
  updateSendButton();
}
</script>

<script>
/* ===================== SEARCH, FILTERS, PAGING ===================== */
const filters = { q:'', state:'', type:'', level:'', sort:'name_asc' };
let suggestWrap=null, activeIndex=-1, currentSuggestions=[];

function setupUniversitySearch(){
  const input = document.getElementById('universitySearch');
  const apply = document.getElementById('searchApplyBtn');
  if (!input || !apply) return;

  // suggest container sits just under input
  suggestWrap = document.getElementById('searchSuggest');

  const run = (fromApply=false)=>{
    filters.q = norm(input.value);
    page=1; flashNextRender=true;
    refreshList();
    if(fromApply) closeSuggest();
  };
  const runDebounced = debounce(()=>{ run(false); renderSuggestions(input.value); },150);

  apply.addEventListener('click', ()=> run(true));
  input.addEventListener('input', runDebounced);

  input.addEventListener('keydown', (e)=>{
    const open = suggestWrap && suggestWrap.style.display!=='none';
    if(e.key==='Enter'){
      if(open && activeIndex>=0 && currentSuggestions[activeIndex]){
        pickSuggestion(currentSuggestions[activeIndex]); e.preventDefault(); return;
      }
      e.preventDefault(); run(true); return;
    }
    if(e.key==='Escape'){ e.preventDefault(); if(open){ closeSuggest(); return; } input.value=''; run(true); }
    if(open && (e.key==='ArrowDown'||e.key==='ArrowUp')){
      e.preventDefault();
      const max=currentSuggestions.length-1;
      activeIndex = e.key==='ArrowDown' ? (activeIndex+1>max?0:activeIndex+1) : (activeIndex-1<0?max:activeIndex-1);
      updateActiveSuggestion();
    }
  });

  document.addEventListener('click',(ev)=>{
    if(!suggestWrap) return;
    if(ev.target===suggestWrap || suggestWrap.contains(ev.target)) return;
    if(ev.target===input) return;
    closeSuggest();
  });
}

function renderSuggestions(query){
  if(!suggestWrap) return;
  const q=norm(query); if(!q){ closeSuggest(); return; }
  const scored=[];
  for(const u of universities){
    const nm=norm(u.name||''), ct=norm(u.city||''), st=norm(u.state||'');
    let score=0; if(nm.startsWith(q)) score=2; else if(nm.includes(q)) score=1.5; else if(ct.includes(q)||st.includes(q)) score=1;
    if(score>0) scored.push([score,u]); if(scored.length>600) break;
  }
  scored.sort((a,b)=> b[0]-a[0] || (a[1].name||'').localeCompare(b[1].name||'')); 
  const list=scored.slice(0,10).map(x=>x[1]);
  currentSuggestions=list; activeIndex=list.length?0:-1;
  if(!list.length){ closeSuggest(); return; }

  suggestWrap.innerHTML='';
  list.forEach((u,idx)=>{
    const item=document.createElement('div'); item.className='suggest-item'; item.setAttribute('role','option'); item.setAttribute('aria-selected', idx===activeIndex?'true':'false');
    const loc=[u.city,u.state].filter(Boolean).join(', ');
    item.innerHTML = `
      <span class="material-icons" aria-hidden="true" style="font-size:1rem;">school</span>
      <div>
        <div>${highlight(u.name, query)}</div>
        ${loc?`<div class="suggest-muted">${escapeHtml(loc)}</div>`:''}
      </div>`;
    item.addEventListener('mouseenter', ()=>{ activeIndex=idx; updateActiveSuggestion(); });
    item.addEventListener('click', ()=> pickSuggestion(u) );
    suggestWrap.appendChild(item);
  });
  suggestWrap.style.display='block';
}
function highlight(text, query){
  const q=norm(query); if(!q) return escapeHtml(text);
  const i=norm(text).indexOf(q);
  if(i<0) return escapeHtml(text);
  return escapeHtml(text.slice(0,i)) + `<span class="suggest-highlight">${escapeHtml(text.slice(i,i+q.length))}</span>` + escapeHtml(text.slice(i+q.length));
}
function updateActiveSuggestion(){
  if(!suggestWrap) return;
  [...suggestWrap.children].forEach((el,i)=> el.setAttribute('aria-selected', i===activeIndex?'true':'false'));
}
function closeSuggest(){ if(!suggestWrap) return; suggestWrap.style.display='none'; activeIndex=-1; currentSuggestions=[]; }
function pickSuggestion(u){
  const input=document.getElementById('universitySearch'); input.value=u.name||'';
  filters.q = norm(u.name); page=1; flashNextRender=true; refreshList(); closeSuggest();
  const idx=filtered.findIndex(x=>String(x.unitid)===String(u.unitid));
  if(idx>=0){
    page=Math.floor(idx/pageSize)+1; refreshList();
    requestAnimationFrame(()=>{
      const cards=[...document.querySelectorAll('.university-card')];
      const startIdx=(page-1)*pageSize;
      const card=cards[idx-startIdx];
      if(card){ card.classList.add('flash'); setTimeout(()=>card.classList.remove('flash'),1000); card.scrollIntoView({behavior:'smooth',block:'nearest'}); }
    });
  }
}

function setupFilterHandlers(){
  const stateFilter=document.getElementById('stateFilter');
  const typeFilter =document.getElementById('typeFilter');
  const levelFilter=document.getElementById('levelFilter');
  const sortBy     =document.getElementById('sortBy');
  const applyBtn   =document.getElementById('filterApplyBtn');
  const resetBtn   =document.getElementById('resetBtn');
  const selectPageBtn=document.getElementById('selectPageBtn');

  applyBtn?.addEventListener('click', ()=>{
    filters.state=stateFilter.value; filters.type=typeFilter.value; filters.level=levelFilter.value; filters.sort=sortBy.value;
    page=1; flashNextRender=true; refreshList();
  });

  resetBtn?.addEventListener('click', ()=>{
    document.getElementById('universitySearch').value=''; stateFilter.value=''; typeFilter.value=''; levelFilter.value=''; sortBy.value='name_asc';
    filters.q=filters.state=filters.type=filters.level=''; filters.sort='name_asc'; page=1; flashNextRender=true; refreshList();
    toast('Filters reset.','info',{ttl:1500});
  });

  selectPageBtn?.addEventListener('click', ()=>{
    const start=(page-1)*pageSize, end=Math.min(filtered.length, start+pageSize);
    const eff=getEffectiveSelection();
    filtered.slice(start,end).forEach(u=> eff.add(u.unitid));
    filtered.slice(start,end).forEach(u=>{
      if(studentUnitIds.has(u.unitid)) removedByRecommender.delete(u.unitid);
      else addedByRecommender.add(u.unitid);
    });
    renderPage(); updateSelectedList(); updateSendButton();
    toast('Selected all on current page.','success',{ttl:1200});
  });
}

function setupPagination(){
  const prev=document.getElementById('prevPage');
  const next=document.getElementById('nextPage');
  const ps  =document.getElementById('pageSize');
  prev?.addEventListener('click', ()=>{ if(page>1) page--; refreshList(); });
  next?.addEventListener('click', ()=>{ const totalPages=Math.max(1,Math.ceil(filtered.length/pageSize)); if(page<totalPages) page++; refreshList(); });
  ps?.addEventListener('change', e=>{ pageSize=parseInt(e.target.value,10)||40; page=1; refreshList(); });
}

function computeFiltered(){
  filtered = universities.filter(u=>{
    const q=filters.q;
    const qOk=!q || (u.name && norm(u.name).includes(q)) || (u.city && norm(u.city).includes(q)) || (u.state && norm(u.state).includes(q));
    const stOk=!filters.state || u.state===filters.state;
    const tyOk=!filters.type  || u.control===filters.type;
    const lvOk=!filters.level || u.level===filters.level;
    return qOk && stOk && tyOk && lvOk;
  });
  if(filters.sort==='name_asc') filtered.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  if(filters.sort==='state_asc') filtered.sort((a,b)=>(a.state||'').localeCompare(b.state||'') || (a.name||'').localeCompare(b.name||''));
  populateUniversitySelectOptions(filtered.length?filtered:universities);
}

function updateMeta(){
  const start=filtered.length? ((page-1)*pageSize+1):0;
  const end=Math.min(filtered.length, page*pageSize);
  const meta=document.getElementById('resultMeta');
  if(meta) meta.textContent = `Showing ${start}-${end} of ${filtered.length} (from ${universities.length} total)`;
}
function updatePager(){
  const totalPages=Math.max(1,Math.ceil(filtered.length/pageSize));
  document.getElementById('pageInfo').textContent = `Page ${Math.min(page,totalPages)} of ${totalPages}`;
  document.getElementById('prevPage').disabled = (page<=1);
  document.getElementById('nextPage').disabled = (page>=totalPages);
  updateMeta();
}

function renderUniversities(list){
  const grid=document.getElementById('universityGrid'); grid.innerHTML='';
  const eff=getEffectiveSelection();
  const frag=document.createDocumentFragment();
  list.forEach(uni=>{
    const card=document.createElement('div');
    card.className='university-card'+(eff.has(uni.unitid)?' selected':'');
    card.setAttribute('role','listitem');
    card.title=uni.sector||uni.control||'';
    card.addEventListener('click', ()=> toggleUniversity(uni.unitid) );
    card.innerHTML=`
      <div class="university-header">
        <div class="university-logo">${escapeHtml((uni.name||'?').charAt(0))}</div>
        <div>
          <div class="university-name">${escapeHtml(uni.name||'Unknown Institution')}</div>
          <div class="university-location">${escapeHtml([uni.city, uni.state].filter(Boolean).join(', '))}</div>
          ${(uni.level||uni.control)?`<span class="university-pill">${[uni.control,uni.level].filter(Boolean).map(escapeHtml).join(' • ')}</span>`:''}
        </div>
      </div>`;
    if(flashNextRender){ card.classList.add('flash'); setTimeout(()=>card.classList.remove('flash'), 750); }
    frag.appendChild(card);
  });
  grid.appendChild(frag);
}

function renderPage(){
  const start=(page-1)*pageSize, end=start+pageSize;
  const slice=filtered.slice(start,end);
  renderUniversities(slice);
  updatePager();
  const grid=document.getElementById('universityGrid');
  const empty=document.getElementById('emptyState');
  if(filtered.length===0){ grid.style.display='none'; empty.style.display='block'; }
  else{ empty.style.display='none'; grid.style.display='grid'; }
  if(flashNextRender) flashNextRender=false;
}

function toggleUniversity(unitid){
  const allowEdits=document.getElementById('allowEditsToggle')?.checked;
  if(!studentProfile || allowEdits){
    if(studentUnitIds.has(unitid)){ // base had it
      if(removedByRecommender.has(unitid)) removedByRecommender.delete(unitid);
      else removedByRecommender.add(unitid);
      addedByRecommender.delete(unitid);
    } else {
      if(addedByRecommender.has(unitid)) addedByRecommender.delete(unitid);
      else addedByRecommender.add(unitid);
    }
  } else {
    if(studentUnitIds.has(unitid)){
      if(removedByRecommender.has(unitid)) removedByRecommender.delete(unitid);
      else removedByRecommender.add(unitid);
    } else {
      toast('Student has locked the list. You cannot add new universities.','error');
    }
  }
  renderPage(); updateSelectedList(); updateSendButton();
}

function removeFromEffective(unitid){
  if(studentUnitIds.has(unitid)){ removedByRecommender.add(unitid); addedByRecommender.delete(unitid); }
  else { addedByRecommender.delete(unitid); }
  renderPage(); updateSelectedList(); updateSendButton();
}
window.removeFromEffective = removeFromEffective;

function updateSelectedList(){
  const container=document.getElementById('selectedList');
  const counter=document.getElementById('selectedCount');
  const eff=getEffectiveSelection();
  counter.textContent = `${eff.size} universities selected`;
  const chips=[];
  eff.forEach(unitid=>{
    const uni = filtered.find(u=>u.unitid===unitid) || universities.find(u=>u.unitid===unitid);
    const name = uni? uni.name : 'Unknown';
    const badges=[];
    if(studentUnitIds.has(unitid)) badges.push('<span class="badge badge-student">Student</span>');
    if(addedByRecommender.has(unitid)) badges.push('<span class="badge badge-added">You added</span>');
    if(removedByRecommender.has(unitid)) badges.push('<span class="badge badge-removed">Removed</span>');
    chips.push(`
      <div class="selected-tag">
        ${escapeHtml(name)}
        ${badges.length?`<span style="margin-left:.35rem; display:inline-flex; gap:.25rem;">${badges.join('')}</span>`:''}
        <div class="remove-tag" title="Remove" onclick="removeFromEffective(${JSON.stringify(unitid)})">×</div>
      </div>`);
  });
  container.innerHTML=chips.join('');
}

function updateSendButton(){
  const btn=document.getElementById('sendBtn');
  btn.disabled = !(window.uploadedFile && getEffectiveSelection().size>0);
}
</script>

<script>
/* ===================== BROWSE-ALL DROPDOWN ===================== */
function setupUniversitySelect(){
  populateUniversitySelectOptions(universities);
  const sel=document.getElementById('universitySelect');
  if(!sel) return;
  sel.addEventListener('change', e=>{
    const val=e.target.value; if(!val) return;
    // clear filters for visibility
    document.getElementById('universitySearch').value='';
    document.getElementById('stateFilter').value='';
    document.getElementById('typeFilter').value='';
    document.getElementById('levelFilter').value='';
    filters.q=filters.state=filters.type=filters.level=''; filters.sort='name_asc';
    refreshList();

    const idx=filtered.findIndex(u=>String(u.unitid)===String(val));
    if(idx>=0){
      page=Math.floor(idx/pageSize)+1; refreshList();
      requestAnimationFrame(()=>{
        const cards=[...document.querySelectorAll('.university-card')];
        const startIdx=(page-1)*pageSize;
        const card=cards[idx-startIdx];
        if(card){ card.classList.add('flash'); setTimeout(()=>card.classList.remove('flash'),1000); card.scrollIntoView({behavior:'smooth', block:'nearest'}); }
      });
    }

    const uid=Number.isNaN(Number(val))? val : Number(val);
    if(studentUnitIds.has(uid)) removedByRecommender.delete(uid); else addedByRecommender.add(uid);
    updateSelectedList(); updateSendButton(); persistAndSync?.();
    sel.selectedIndex=0;
  });
}
function populateUniversitySelectOptions(list){
  const sel=document.getElementById('universitySelect'); if(!sel) return;
  const placeholder=sel.options[0]; sel.innerHTML=''; sel.appendChild(placeholder);
  const frag=document.createDocumentFragment();
  [...list].sort((a,b)=>(a.name||'').localeCompare(b.name||'')).forEach(u=>{
    const opt=document.createElement('option'); opt.value=u.unitid;
    const loc=[u.city,u.state].filter(Boolean).join(', ');
    opt.textContent = `${u.name||'Unknown Institution'}${loc?' — '+loc:''}`; frag.appendChild(opt);
  });
  sel.appendChild(frag);
}
</script>

<script>
/* ===================== BULK IMPORT (optional simple match) ===================== */
function setupBulkImport(){
  const btn=document.getElementById('bulkImportBtn'); const modal=document.getElementById('importModal');
  const close=document.getElementById('importCloseBtn'); const cancel=document.getElementById('importCancelBtn');
  const confirm=document.getElementById('importConfirmBtn'); const ta=document.getElementById('importTextarea');
  const prev=document.getElementById('importPreview');

  btn?.addEventListener('click', ()=>{ modal.style.display='flex'; ta.value=''; prev.textContent=''; });
  close?.addEventListener('click', ()=> modal.style.display='none');
  cancel?.addEventListener('click', ()=> modal.style.display='none');

  confirm?.addEventListener('click', ()=>{
    const lines=(ta.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!lines.length){ toast('Nothing to import.','error'); return; }
    const qset=new Set(lines.map(norm));
    const matches=universities.filter(u=> qset.has(norm(u.name)) );
    if(!matches.length){ toast('No exact matches. Try pasting official names.','error'); return; }

    const eff=getEffectiveSelection();
    matches.forEach(u=>{
      if(studentUnitIds.has(u.unitid)) removedByRecommender.delete(u.unitid); else addedByRecommender.add(u.unitid);
      eff.add(u.unitid);
    });
    updateSelectedList(); updateSendButton(); toast(`Added ${matches.length} matches.`,'success'); modal.style.display='none';
  });
}
</script>

<script>
/* ===================== STUDENT LOADER (mock) ===================== */
function setupStudentLoader(){
  const btn=document.getElementById('loadStudentBtn'); const input=document.getElementById('studentIdInput');
  btn?.addEventListener('click', async ()=>{
    const id=(input.value||'').trim(); if(!id){ toast('Enter a student id/email.','error'); return; }
    await loadStudentProfile(id);
  });
}
async function fetchStudentProfile(studentIdOrEmail){
  const picks=[]; const pool=[...universities].slice(0,600);
  while(picks.length<10 && pool.length){ const i=Math.floor(Math.random()*pool.length); picks.push(pool[i].unitid); pool.splice(i,1); }
  return { id:studentIdOrEmail, email:/@/.test(studentIdOrEmail)?studentIdOrEmail:(studentIdOrEmail+'@example.edu'), name:`Student ${studentIdOrEmail}`, allowRecommenderEdits:true, selectedUnitIds:picks };
}
async function loadStudentProfile(id){
  try{
    const prof=await fetchStudentProfile(id);
    studentProfile=prof; studentUnitIds=new Set(prof.selectedUnitIds||[]); addedByRecommender.clear(); removedByRecommender.clear();
    document.getElementById('studentTitle').textContent=prof.name;
    document.getElementById('studentMeta').textContent=`Preselected: ${studentUnitIds.size} universities • Edits ${prof.allowRecommenderEdits?'allowed':'locked'}`;
    document.getElementById('allowEditsToggle').checked=!!prof.allowRecommenderEdits;
    page=1; refreshList(); updateSelectedList(); updateSendButton(); toast(`Loaded ${prof.name}.`,'success');
    persistAndSync?.();
  }catch(e){ console.error(e); toast('Could not load student profile.','error'); }
}
</script>

<script>
/* ===================== SEND FLOW (simulated) ===================== */
function setupSendHandler(){
  document.getElementById('sendBtn')?.addEventListener('click', ()=>{
    const eff=getEffectiveSelection();
    if(!window.uploadedFile){ toast('Please upload a file first.','error'); return; }
    if(eff.size===0){ toast('Select at least one university.','error'); return; }
    beginSend(eff);
  });
}
function beginSend(effective){
  const container=document.getElementById('progressList'); container.innerHTML='';
  document.querySelector('.send-section').style.display='block';
  const unis=[...effective].map(uid=> filtered.find(u=>u.unitid===uid)||universities.find(u=>u.unitid===uid)).filter(Boolean);
  let completed=0;
  unis.forEach((uni,i)=>{
    const div=document.createElement('div'); div.className='delivery-item';
    div.innerHTML=`
      <div class="delivery-status pending">…</div>
      <div>
        <div style="font-weight:600">${escapeHtml(uni.name||'Unknown')}</div>
        <div style="font-size:.85rem; color:#666">Sending…</div>
      </div>`;
    container.appendChild(div);
    setTimeout(()=>{
      completed++;
      const ok=Math.random()>0.08;
      const s=div.querySelector('.delivery-status'); const m=div.querySelector('div div:last-child');
      if(ok){ s.className='delivery-status success'; s.textContent='✓'; m.textContent='Delivered successfully'; }
      else  { s.className='delivery-status error';   s.textContent='!'; m.textContent='Failed to deliver'; }
      updateProgress(completed, unis.length);
      if(completed===unis.length){ toast('Send complete.','success'); showSuccess(); }
    }, 1000 + i*450);
  });
}
function updateProgress(done,total){
  const fill=document.getElementById('progressFill'); const txt=document.getElementById('progressText');
  const pct=Math.round((done/total)*100); fill.style.width=pct+'%'; txt.textContent=`Sent ${done} of ${total} (${pct}%)`;
}
function showSuccess(){ document.getElementById('successSection').style.display='block'; }
</script>

<script>
/* ===================== DATASET LOADER (single source of truth) ===================== */
async function loadDataset(){
  try{
    const candidates=[
      'assets/us_institutions_by_state_2023.json',
      '/assets/us_institutions_by_state_2023.json',
      'https://raw.githubusercontent.com/swetharajan7/StellarRec/main/assets/us_institutions_by_state_2023.json',
      'https://cdn.jsdelivr.net/gh/swetharajan7/StellarRec@main/assets/us_institutions_by_state_2023.json'
    ];
    let data=null;
    for(const url of candidates){
      try{
        const resp=await fetch(url+(url.startsWith('http')?'':`?v=${Date.now()}`), {credentials:'omit', cache:'no-store'});
        if(!resp.ok) throw new Error(resp.status);
        let txt=await resp.text();
        txt=txt.replace(/\b-?Infinity\b/g,'null').replace(/\bNaN\b/g,'null').replace(/,\s*([}\]])/g,'$1');
        data=JSON.parse(txt); break;
      }catch(e){ console.warn('[dataset] fallback ->', url, e); }
    }
    if(!data) throw new Error('No dataset loaded');
    universities = Array.isArray(data) ? data : (data && typeof data==='object' ? Object.values(data).flat() : []);
    universities = universities.map(u=>({
      unitid:u.unitid??u.UNITID??u.id,
      name:u.name??u.INSTNM??'Unknown',
      city:u.city??u.CITY??'',
      state:u.state??u.STABBR??'',
      control:u.control??u.CONTROL??'',
      level:u.level??u.ICLEVEL??'',
      sector:u.sector??u.SECTOR??''
    })).filter(u=>u.unitid && u.name);

    // hydrate browse-all placeholder
    const sel=document.getElementById('universitySelect');
    if(sel && sel.options[0]) sel.options[0].textContent=`Browse all universities (${universities.length.toLocaleString()})`;

    refreshList(); updateSelectedList(); updateSendButton();
  }catch(err){
    console.error(err); toast('Failed to load universities list.','error');
    document.getElementById('resultMeta').textContent='Failed to load universities.';
    document.getElementById('emptyState').style.display='block';
    document.getElementById('universityGrid').style.display='none';
    const rb=document.getElementById('retryLoadBtn'); if(rb){ rb.style.display='inline-block'; rb.onclick=()=>location.reload(); }
  }
}
function refreshList(){ computeFiltered(); renderPage(); }
</script>

<script>
/* ===================== INIT ===================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Writer
  setupWriter();
  // Upload
  setupUpload();
  // Search/filter/paging
  setupUniversitySearch();
  setupFilterHandlers();
  setupPagination();
  // Browse-all dropdown
  setupUniversitySelect();
  // Bulk import
  setupBulkImport();
  // Student loader (mock)
  setupStudentLoader();
  // Send
  setupSendHandler();
  // Dataset
  loadDataset();

  // Tagline hotfix
  const h1=document.querySelector('.hero-title'); if(h1) h1.textContent='One upload. Unlimited reach.';
});
</script>

</body>
</html>
