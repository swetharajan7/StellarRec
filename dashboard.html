<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StellarRec - One Upload, Multiple Universities</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1976d2 0%, #7c4dff 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.3);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.8rem;
            font-weight: 700;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .logo:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .user-info {
            position: relative;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: #333;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        
        .dropdown-item.active {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .dropdown-item .material-icons {
            font-size: 1.2rem;
            color: #666;
        }
        
        .dropdown-item.active .material-icons {
            color: #1976d2;
        }
        
        .view-label {
            display: flex;
            flex-direction: column;
        }
        
        .view-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .view-description {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.1rem;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Hero Section */
        .hero-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 1rem;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 2rem;
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            border: 2px dashed #e0e0e0;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #1976d2;
            background: #f3f8ff;
        }

        .upload-area {
            text-align: center;
            padding: 2rem;
        }

        .upload-icon {
            font-size: 4rem;
            color: #1976d2;
            margin-bottom: 1rem;
        }

        .upload-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .upload-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #1976d2, #7c4dff);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.3);
        }

        /* Uploaded File Display */
        .uploaded-file {
            display: none;
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-icon {
            font-size: 2rem;
            color: #4caf50;
        }

        .file-details h3 {
            color: #2e7d32;
            margin-bottom: 0.25rem;
        }

        .file-details p {
            color: #4caf50;
            font-size: 0.9rem;
        }

        .remove-file {
            margin-left: auto;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .remove-file:hover {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        /* University Selection */
        .university-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .university-search {
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        /* Autosuggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover,
        .suggestion-item.highlighted {
            background: #f3f8ff;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .university-search {
            position: relative;
        }

        .university-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #f0f0f0;
            border-radius: 12px;
        }

        .university-card {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .university-card:hover {
            border-color: #1976d2;
            background: #f3f8ff;
        }

        .university-card.selected {
            border-color: #1976d2;
            background: #e3f2fd;
        }

        .university-card:focus {
            outline: 2px solid #1976d2;
            outline-offset: 2px;
        }

        .university-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .university-logo {
            width: 40px;
            height: 40px;
            background: #1976d2;
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .university-name {
            font-weight: 600;
            color: #333;
        }

        .university-location {
            color: #666;
            font-size: 0.9rem;
        }

        /* Selected Universities */
        .selected-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .selected-count {
            color: #1976d2;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .selected-tag {
            background: linear-gradient(135deg, #1976d2, #7c4dff);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .remove-tag {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .remove-tag:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Send Button */
        .send-section {
            text-align: center;
        }

        .send-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 1.2rem 3rem;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            disabled: true;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .send-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        /* Progress Section */
        .progress-section {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .progress-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            border-radius: 6px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        .delivery-list {
            margin-top: 1rem;
        }

        .delivery-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
        }

        .delivery-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .delivery-status.pending {
            background: #fff3e0;
            color: #ff9800;
        }

        .delivery-status.success {
            background: #e8f5e8;
            color: #4caf50;
        }

        .delivery-status.error {
            background: #ffebee;
            color: #f44336;
        }

        /* Success Section */
        .success-section {
            display: none;
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
            border: 2px solid #4caf50;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(76, 175, 80, 0.2);
        }

        .success-icon {
            font-size: 4rem;
            color: #4caf50;
            margin-bottom: 1rem;
        }

        .success-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 1rem;
        }

        .success-subtitle {
            color: #4caf50;
            margin-bottom: 2rem;
        }

        .new-upload-btn {
            background: linear-gradient(135deg, #1976d2, #7c4dff);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .new-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.3);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .hero-title {
                font-size: 2rem;
            }

            .university-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .modal {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <span class="material-icons">star</span>
                stellarrec
            </a>
            <div class="user-info">
                <div class="user-avatar" onclick="toggleUserDropdown()">
                    <span class="material-icons">person</span>
                </div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-header">Switch View</div>
                    <div class="dropdown-item active" onclick="switchView('recommender')">
                        <span class="material-icons">edit</span>
                        <div class="view-label">
                            <div class="view-name">Recommender</div>
                            <div class="view-description">Write & send letters</div>
                        </div>
                    </div>
                    <div class="dropdown-item" onclick="switchView('student')">
                        <span class="material-icons">school</span>
                        <div class="view-label">
                            <div class="view-name">Student</div>
                            <div class="view-description">Track applications</div>
                        </div>
                    </div>
                    <div style="border-top: 1px solid #f0f0f0; margin: 0.5rem 0;"></div>
                    <div class="dropdown-item" onclick="toggleMockAPI()">
                        <span class="material-icons">api</span>
                        <div class="view-label">
                            <div class="view-name">API Mode</div>
                            <div class="view-description" id="apiModeDesc">Using mock data</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Hero Section -->
        <div class="hero-section">
            <h1 class="hero-title">One Upload. Multiple Universities.</h1>
            <p class="hero-subtitle">Upload your recommendation letter once and send it to multiple US universities
                instantly.</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-area">
                <div class="upload-icon">
                    <span class="material-icons">cloud_upload</span>
                </div>
                <h2 class="upload-title">Upload Recommendation Letter</h2>
                <p class="upload-subtitle">Drag and drop your PDF file here, or click to browse</p>
                <input type="file" id="fileInput" class="file-input" accept=".pdf" />
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <span class="material-icons">upload_file</span>
                    Choose File
                </button>
            </div>

            <div class="uploaded-file" id="uploadedFile">
                <div class="file-info">
                    <div class="file-icon">
                        <span class="material-icons">description</span>
                    </div>
                    <div class="file-details">
                        <h3 id="fileName">recommendation-letter.pdf</h3>
                        <p id="fileSize">2.4 MB • Uploaded successfully</p>
                    </div>
                    <button class="remove-file" onclick="removeFile()">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- University Selection -->
        <div class="university-section">
            <h2 class="section-title">
                <span class="material-icons">school</span>
                Select Universities
            </h2>

            <div class="university-search">
                <input type="text" class="search-input" placeholder="Search universities..." id="universitySearch" />
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>

            <div class="university-grid" id="universityGrid">
                <!-- Universities will be populated here -->
            </div>
        </div>

        <!-- Selected Universities -->
        <div class="selected-section">
            <h2 class="section-title">
                <span class="material-icons">check_circle</span>
                Selected Universities
            </h2>
            <div class="selected-count" id="selectedCount">0 universities selected</div>
            <div class="selected-list" id="selectedList">
                <!-- Selected universities will appear here -->
            </div>

            <div class="send-section">
                <button class="send-btn" id="sendBtn" disabled onclick="sendLetters()">
                    <span class="material-icons">send</span>
                    Send to Selected Universities
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <h2 class="progress-title">Sending Letters...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Preparing to send...</div>

            <div class="delivery-list" id="deliveryList">
                <!-- Delivery status will appear here -->
            </div>
        </div>

        <!-- Success Section -->
        <div class="success-section" id="successSection">
            <div class="success-icon">
                <span class="material-icons">check_circle</span>
            </div>
            <h2 class="success-title">Letters Sent Successfully!</h2>
            <p class="success-subtitle">Your recommendation letter has been delivered to all selected universities.</p>
            <button class="new-upload-btn" onclick="startNewUpload()">
                <span class="material-icons">add</span>
                Send Another Letter
            </button>
        </div>
    </div>

    <!-- Modal for confirmations -->
    <div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Confirm Action</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close modal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-content" id="modalContent">
                <!-- Dynamic content -->
            </div>
            <div class="modal-actions" id="modalActions">
                <!-- Dynamic actions -->
            </div>
        </div>
    </div>

    <script>
        // Environment and feature flags
        const USE_MOCK = localStorage.getItem('sr_use_mock') !== '0';
        const API_URL = window.ENV?.API_URL || 'https://api.stellarrec.com';
        
        // Toast notification system
        function toast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#2196f3'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Add toast animations to head
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Sample university data (fallback)
        const mockUniversities = [
            { id: 1, name: "Harvard University", location: "Cambridge, MA", logo: "H" },
            { id: 2, name: "Stanford University", location: "Stanford, CA", logo: "S" },
            { id: 3, name: "MIT", location: "Cambridge, MA", logo: "MIT" },
            { id: 4, name: "Yale University", location: "New Haven, CT", logo: "Y" },
            { id: 5, name: "Princeton University", location: "Princeton, NJ", logo: "P" },
            { id: 6, name: "Columbia University", location: "New York, NY", logo: "C" },
            { id: 7, name: "University of Chicago", location: "Chicago, IL", logo: "UC" },
            { id: 8, name: "University of Pennsylvania", location: "Philadelphia, PA", logo: "UP" },
            { id: 9, name: "California Institute of Technology", location: "Pasadena, CA", logo: "CIT" },
            { id: 10, name: "Johns Hopkins University", location: "Baltimore, MD", logo: "JH" },
            { id: 11, name: "Northwestern University", location: "Evanston, IL", logo: "NU" },
            { id: 12, name: "Duke University", location: "Durham, NC", logo: "D" },
            { id: 13, name: "Dartmouth College", location: "Hanover, NH", logo: "DC" },
            { id: 14, name: "Brown University", location: "Providence, RI", logo: "B" },
            { id: 15, name: "Vanderbilt University", location: "Nashville, TN", logo: "V" },
            { id: 16, name: "Rice University", location: "Houston, TX", logo: "R" },
            { id: 17, name: "Washington University in St. Louis", location: "St. Louis, MO", logo: "WU" },
            { id: 18, name: "Cornell University", location: "Ithaca, NY", logo: "CU" },
            { id: 19, name: "University of Notre Dame", location: "Notre Dame, IN", logo: "ND" },
            { id: 20, name: "UCLA", location: "Los Angeles, CA", logo: "UCLA" }
        ];

        let universities = [];
        let filteredUniversities = [];
        let selectedUniversities = [];
        let uploadedFile = null;
        let currentView = 'recommender';
        let searchDebounceTimer = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            loadUniversities();
            setupFileUpload();
            setupSearch();
            setupClickOutside();
            updateAPIToggle();
        });

        // Load universities from API or mock
        async function loadUniversities() {
            try {
                if (USE_MOCK) {
                    universities = mockUniversities;
                    filteredUniversities = universities;
                    renderUniversities(filteredUniversities);
                    return;
                }

                const response = await fetch(`${API_URL}/universities`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                universities = await response.json();
                filteredUniversities = universities;
                renderUniversities(filteredUniversities);
                toast('Universities loaded successfully', 'success');
            } catch (error) {
                console.error('Failed to load universities:', error);
                universities = mockUniversities;
                filteredUniversities = universities;
                renderUniversities(filteredUniversities);
                showDatasetError(error.message);
            }
        }

        function showDatasetError(errorMsg) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'dataset-error';
            errorDiv.innerHTML = `
                <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; text-align: center;">
                    <span class="material-icons" style="color: #f44336; font-size: 2rem;">error</span>
                    <h3 style="color: #f44336; margin: 0.5rem 0;">Failed to load universities</h3>
                    <p style="color: #666; margin-bottom: 1rem;">Error: ${errorMsg}</p>
                    <button onclick="retryDatasetLoad()" style="background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                        <span class="material-icons" style="font-size: 1rem; vertical-align: middle;">refresh</span>
                        Retry
                    </button>
                </div>
            `;
            document.querySelector('.university-section').prepend(errorDiv);
        }

        function retryDatasetLoad() {
            document.querySelector('.dataset-error')?.remove();
            loadUniversities();
        }

        // User dropdown functionality
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        function toggleMockAPI() {
            const newUseMock = !USE_MOCK;
            localStorage.setItem('sr_use_mock', newUseMock ? '1' : '0');
            toast(`Switched to ${newUseMock ? 'mock' : 'real'} API. Reloading...`, 'info');
            setTimeout(() => location.reload(), 1000);
        }

        function updateAPIToggle() {
            const desc = document.getElementById('apiModeDesc');
            if (desc) {
                desc.textContent = USE_MOCK ? 'Using mock data' : 'Using real API';
            }
        }

        function switchView(view) {
            currentView = view;
            
            // Update active state in dropdown
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.dropdown-item').classList.add('active');
            
            // Update dashboard content based on view
            updateDashboardForView(view);
            
            // Close dropdown
            document.getElementById('userDropdown').classList.remove('show');
        }

        function updateDashboardForView(view) {
            const heroTitle = document.querySelector('.hero-title');
            const heroSubtitle = document.querySelector('.hero-subtitle');
            const uploadTitle = document.querySelector('.upload-title');
            
            if (view === 'student') {
                heroTitle.textContent = 'Track Your Applications';
                heroSubtitle.textContent = 'Monitor the status of your recommendation letters and university applications.';
                uploadTitle.textContent = 'Request Recommendation Letter';
                
                // Could add student-specific functionality here
                // For now, we'll keep the same interface but with different messaging
            } else {
                heroTitle.textContent = 'One Upload. Multiple Universities.';
                heroSubtitle.textContent = 'Upload your recommendation letter once and send it to multiple US universities instantly.';
                uploadTitle.textContent = 'Upload Recommendation Letter';
            }
        }

        function setupClickOutside() {
            document.addEventListener('click', function(event) {
                const userInfo = document.querySelector('.user-info');
                const dropdown = document.getElementById('userDropdown');
                
                if (!userInfo.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // File upload functionality
        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const uploadSection = document.getElementById('uploadSection');

            fileInput.addEventListener('change', handleFileUpload);

            // Drag and drop
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validate file type
            if (file.type !== 'application/pdf') {
                toast('Please upload a PDF file only', 'error');
                return;
            }

            // Validate file size (20MB limit)
            const maxSize = 20 * 1024 * 1024;
            if (file.size > maxSize) {
                toast('File too large. Maximum size is 20MB', 'error');
                return;
            }

            uploadedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = `${(file.size / 1024 / 1024).toFixed(1)} MB • Uploaded successfully`;
            document.getElementById('uploadedFile').style.display = 'block';

            updateSendButton();
        }

        function removeFile() {
            uploadedFile = null;
            document.getElementById('uploadedFile').style.display = 'none';
            document.getElementById('fileInput').value = '';
            updateSendButton();
        }

        // University search and selection with debounce
        // University search and selection with debounce and autosuggestions
        let selectedSuggestionIndex = -1;
        
        function setupSearch() {
            const searchInput = document.getElementById('universitySearch');
            const suggestions = document.getElementById('searchSuggestions');
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                selectedSuggestionIndex = -1;
                
                // Clear previous timer
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                
                // Debounce search by 300ms
                searchDebounceTimer = setTimeout(() => {
                    performSearch(query);
                    showSuggestions(query);
                }, 300);
            });

            // Handle keyboard navigation for suggestions
            searchInput.addEventListener('keydown', (e) => {
                const suggestionItems = suggestions.querySelectorAll('.suggestion-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                    updateSuggestionHighlight(suggestionItems);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    updateSuggestionHighlight(suggestionItems);
                } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
                    e.preventDefault();
                    suggestionItems[selectedSuggestionIndex].click();
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.university-search')) {
                    hideSuggestions();
                }
            });
        }

        function performSearch(query) {
            if (!query.trim()) {
                filteredUniversities = universities;
            } else {
                filteredUniversities = universities.filter(uni =>
                    uni.name.toLowerCase().includes(query) ||
                    uni.location.toLowerCase().includes(query)
                );
            }
            
            renderUniversities(filteredUniversities);
        }

        function showSuggestions(query) {
            const suggestions = document.getElementById('searchSuggestions');
            
            if (!query.trim()) {
                hideSuggestions();
                return;
            }

            const matches = universities.filter(uni =>
                uni.name.toLowerCase().includes(query) ||
                uni.location.toLowerCase().includes(query)
            ).slice(0, 5); // Show max 5 suggestions

            if (matches.length === 0) {
                hideSuggestions();
                return;
            }

            suggestions.innerHTML = matches.map(uni => `
                <div class="suggestion-item" onclick="selectSuggestion('${uni.name}')">
                    <strong>${highlightMatch(uni.name, query)}</strong>
                    <div style="font-size: 0.9rem; color: #666;">${uni.location}</div>
                </div>
            `).join('');

            suggestions.style.display = 'block';
        }

        function hideSuggestions() {
            document.getElementById('searchSuggestions').style.display = 'none';
            selectedSuggestionIndex = -1;
        }

        function selectSuggestion(universityName) {
            document.getElementById('universitySearch').value = universityName;
            hideSuggestions();
            performSearch(universityName.toLowerCase());
        }

        function updateSuggestionHighlight(suggestionItems) {
            suggestionItems.forEach((item, index) => {
                item.classList.toggle('highlighted', index === selectedSuggestionIndex);
            });
        }

        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background: #ffeb3b; padding: 0;">$1</mark>');
        }

        function renderUniversities(universitiesToRender) {
            const grid = document.getElementById('universityGrid');
            
            if (universitiesToRender.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                        <span class="material-icons" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;">search_off</span>
                        <h3 style="color: #666; margin-bottom: 0.5rem;">No universities found</h3>
                        <p style="color: #999; margin-bottom: 1rem;">Try adjusting your search terms</p>
                        <button onclick="clearSearch()" style="background: #1976d2; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            <span class="material-icons" style="font-size: 1rem; vertical-align: middle;">clear</span>
                            Clear filters
                        </button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = universitiesToRender.map(uni => `
                <div class="university-card ${selectedUniversities.includes(uni.id) ? 'selected' : ''}" 
                     onclick="toggleUniversity(${uni.id})"
                     onkeydown="handleUniversityKeydown(event, ${uni.id})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${selectedUniversities.includes(uni.id)}"
                     aria-label="Select ${uni.name}">
                    <div class="university-header">
                        <div class="university-logo">${uni.logo}</div>
                        <div>
                            <div class="university-name">${uni.name}</div>
                            <div class="university-location">${uni.location}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function clearSearch() {
            document.getElementById('universitySearch').value = '';
            filteredUniversities = universities;
            renderUniversities(filteredUniversities);
        }

        function handleUniversityKeydown(event, id) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleUniversity(id);
            }
        }

        function toggleUniversity(id) {
            if (selectedUniversities.includes(id)) {
                selectedUniversities = selectedUniversities.filter(uId => uId !== id);
            } else {
                selectedUniversities.push(id);
            }

            renderUniversities(filteredUniversities);
            updateSelectedList();
            updateSendButton();
        }

        function updateSelectedList() {
            const selectedList = document.getElementById('selectedList');
            const selectedCount = document.getElementById('selectedCount');

            selectedCount.textContent = `${selectedUniversities.length} universities selected`;

            selectedList.innerHTML = selectedUniversities.map(id => {
                const uni = universities.find(u => u.id === id);
                return `
                    <div class="selected-tag">
                        ${uni.name}
                        <div class="remove-tag" onclick="toggleUniversity(${id})">×</div>
                    </div>
                `;
            }).join('');
        }

        function updateSendButton() {
            const sendBtn = document.getElementById('sendBtn');
            const canSend = uploadedFile && selectedUniversities.length > 0;
            sendBtn.disabled = !canSend;
        }



        function simulateDelivery() {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const deliveryList = document.getElementById('deliveryList');

            let progress = 0;
            let currentUniversity = 0;

            const interval = setInterval(() => {
                progress += 100 / selectedUniversities.length;
                progressFill.style.width = `${Math.min(progress, 100)}%`;

                if (currentUniversity < selectedUniversities.length) {
                    const uni = universities.find(u => u.id === selectedUniversities[currentUniversity]);

                    // Add delivery item
                    const deliveryItem = document.createElement('div');
                    deliveryItem.className = 'delivery-item';
                    deliveryItem.innerHTML = `
                        <div class="delivery-status pending">⏳</div>
                        <div>${uni.name}</div>
                        <div style="margin-left: auto; color: #ff9800;">Sending...</div>
                    `;
                    deliveryList.appendChild(deliveryItem);

                    // Update to success after a moment
                    setTimeout(() => {
                        deliveryItem.innerHTML = `
                            <div class="delivery-status success">✓</div>
                            <div>${uni.name}</div>
                            <div style="margin-left: auto; color: #4caf50;">Delivered</div>
                        `;
                    }, 500);

                    currentUniversity++;
                    progressText.textContent = `Sending to ${uni.name}...`;
                }

                if (progress >= 100) {
                    clearInterval(interval);
                    progressText.textContent = 'All letters sent successfully!';

                    setTimeout(() => {
                        document.getElementById('progressSection').style.display = 'none';
                        document.getElementById('successSection').style.display = 'block';
                    }, 1000);
                }
            }, 1000);
        }

        function startNewUpload() {
            // Reset everything
            uploadedFile = null;
            selectedUniversities = [];

            document.getElementById('successSection').style.display = 'none';
            document.querySelector('.upload-section').style.display = 'block';
            document.querySelector('.university-section').style.display = 'block';
            document.querySelector('.selected-section').style.display = 'block';

            removeFile();
            updateSelectedList();
            updateSendButton();

            // Clear progress section
            document.getElementById('deliveryList').innerHTML = '';
            document.getElementById('progressFill').style.width = '0%';
        }

        // Modal functionality with focus trap
        let modalPreviousFocus = null;
        let modalFocusableElements = [];

        function showModal(title, content, actions) {
            modalPreviousFocus = document.activeElement;
            
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalActions').innerHTML = actions;
            
            const modal = document.getElementById('modalOverlay');
            modal.classList.add('show');
            
            // Set up focus trap
            setupFocusTrap();
            
            // Focus first actionable element
            const firstButton = modal.querySelector('button:not(.modal-close)');
            if (firstButton) {
                firstButton.focus();
            } else {
                modal.querySelector('.modal-close').focus();
            }
        }

        function closeModal() {
            const modal = document.getElementById('modalOverlay');
            modal.classList.remove('show');
            
            // Restore focus
            if (modalPreviousFocus) {
                modalPreviousFocus.focus();
                modalPreviousFocus = null;
            }
            
            // Clean up event listeners
            document.removeEventListener('keydown', handleModalKeydown);
        }

        function setupFocusTrap() {
            const modal = document.getElementById('modalOverlay');
            modalFocusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            
            document.addEventListener('keydown', handleModalKeydown);
        }

        function handleModalKeydown(e) {
            if (e.key === 'Escape') {
                closeModal();
                return;
            }
            
            if (e.key === 'Tab') {
                const firstElement = modalFocusableElements[0];
                const lastElement = modalFocusableElements[modalFocusableElements.length - 1];
                
                if (e.shiftKey) {
                    if (document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            }
        }

        // Enhanced send letters with confirmation modal
        function sendLetters() {
            if (!uploadedFile || selectedUniversities.length === 0) return;

            const selectedNames = selectedUniversities.map(id => 
                universities.find(u => u.id === id)?.name
            ).join(', ');

            showModal(
                'Confirm Submission',
                `<p>Send recommendation letter to <strong>${selectedUniversities.length}</strong> universities?</p>
                 <div style="max-height: 150px; overflow-y: auto; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                     <small>${selectedNames}</small>
                 </div>`,
                `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                 <button class="btn btn-primary" onclick="confirmSendLetters()">Send Letters</button>`
            );
        }

        function confirmSendLetters() {
            closeModal();
            
            // Hide other sections and show progress
            document.getElementById('progressSection').style.display = 'block';
            document.querySelector('.upload-section').style.display = 'none';
            document.querySelector('.university-section').style.display = 'none';
            document.querySelector('.selected-section').style.display = 'none';

            simulateDelivery();
        }
    </script>
</body>

</html>