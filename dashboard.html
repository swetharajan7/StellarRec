<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StellarRec - One upload. Unlimited reach.</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Roboto',sans-serif; background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); color:#333; min-height:100vh; }

    .header { background:linear-gradient(135deg,#1976d2 0%,#7c4dff 100%); color:#fff; padding:1.5rem 2rem; box-shadow:0 4px 20px rgba(25,118,210,0.3); }
    .header-content { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; gap: 1rem; }
    .logo { display:flex; align-items:center; gap:.5rem; font-size:1.8rem; font-weight:700; text-decoration:none; color:#fff; transition:.3s; }
    .logo:hover { opacity:.85; transform:translateY(-1px); }
    .user-info { position:relative; display:flex; align-items:center; gap:1rem; }
    .user-avatar { width:45px; height:45px; background:rgba(255,255,255,.2); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; cursor:pointer; transition:.3s; }
    .user-avatar:hover { background:rgba(255,255,255,.3); transform:scale(1.05); }
    .user-dropdown { position:absolute; top:100%; right:0; margin-top:.5rem; background:#fff; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,.15); min-width:240px; opacity:0; visibility:hidden; transform:translateY(-10px); transition:.3s; z-index:1000; }
    .user-dropdown.show { opacity:1; visibility:visible; transform:translateY(0); }
    .dropdown-header { padding:1rem; border-bottom:1px solid #f0f0f0; color:#333; font-weight:600; font-size:.9rem; }
    .dropdown-item { display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem; color:#333; cursor:pointer; transition:.2s; }
    .dropdown-item:hover { background:#f8f9fa; }
    .dropdown-item.active { background:#e3f2fd; color:#1976d2; }
    .dropdown-item .material-icons { font-size:1.2rem; color:#666; }
    .dropdown-item.active .material-icons { color:#1976d2; }
    .view-label { display:flex; flex-direction:column; }
    .view-name { font-weight:600; font-size:.9rem; }
    .view-description { font-size:.8rem; color:#666; margin-top:.1rem; }

    .container { max-width:1200px; margin:0 auto; padding:2rem; }
    .hero-section { text-align:center; margin-bottom:3rem; }
    .hero-title { font-size:2.5rem; font-weight:700; color:#1976d2; margin-bottom:1rem; }
    .hero-subtitle { font-size:1.2rem; color:#666; margin-bottom:2rem; }

    /* New: two-column layout for upload + writer */
    .compose-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:2rem; }
    @media (max-width: 980px) { .compose-grid { grid-template-columns:1fr; } }

    .upload-section, .writer-section, .university-section, .selected-section, .progress-section {
      background:#fff; border-radius:16px; padding:2rem; box-shadow:0 8px 32px rgba(0,0,0,.1); margin-bottom:0;
    }
    .upload-section { border:2px dashed #e0e0e0; transition:.3s; }
    .upload-section.dragover { border-color:#1976d2; background:#f3f8ff; }

    .upload-area { text-align:center; padding:2rem; }
    .upload-icon { font-size:4rem; color:#1976d2; margin-bottom:1rem; }
    .upload-title { font-size:1.5rem; font-weight:600; margin-bottom:.5rem; color:#333; }
    .upload-subtitle { color:#666; margin-bottom:2rem; }
    .file-input { display:none; }
    .upload-btn { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:1rem 2rem; border:none; border-radius:12px; font-size:1.1rem; font-weight:600; cursor:pointer; transition:.3s; display:inline-flex; align-items:center; gap:.5rem; }
    .upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    .uploaded-file { display:none; background:#e8f5e8; border:2px solid #4caf50; border-radius:12px; padding:1.5rem; margin-top:1rem; }
    .file-info { display:flex; align-items:center; gap:1rem; }
    .file-icon { font-size:2rem; color:#4caf50; }
    .file-details h3 { color:#2e7d32; margin-bottom:.25rem; }
    .file-details p { color:#4caf50; font-size:.9rem; }
    .remove-file { margin-left:auto; background:none; border:none; color:#666; cursor:pointer; padding:.5rem; border-radius:50%; transition:.2s; }
    .remove-file:hover { background:rgba(244,67,54,.1); color:#f44336; }

    .section-title { font-size:1.5rem; font-weight:600; color:#333; margin-bottom:1rem; display:flex; align-items:center; gap:.5rem; }

    /* Writer box styles */
    .writer-toolbar { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.75rem; align-items:center; }
    .writer-toolbar .btn { background:#fff; border:2px solid #e5e7eb; border-radius:10px; padding:.45rem .75rem; cursor:pointer; font-weight:600; }
    .writer-toolbar .btn:hover { background:#f8f9fa; }
    .writer-toolbar .meta { margin-left:auto; font-size:.9rem; color:#667; display:flex; gap:.75rem; align-items:center; }
    .writer-title { width:100%; padding:.7rem .9rem; border:2px solid #e0e0e0; border-radius:12px; font-size:1rem; margin-bottom:.6rem; }
    .writer-box { border:2px solid #e0e0e0; border-radius:12px; min-height:280px; padding:1rem; line-height:1.55; }
    .writer-box:focus { outline:none; border-color:#1976d2; }
    .writer-actions { display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap; }
    .btn-primary { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; border:none; }
    .btn-success { background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; border:none; }
    .btn-danger  { background:linear-gradient(135deg,#e53935,#ef5350); color:#fff; border:none; }
    .btn-muted   { background:#fff; color:#333; }

    .filter-meta { font-size:.9rem; color:#666; margin:.25rem 0 .5rem; }

    .filter-bar { display:grid; grid-template-columns: repeat(8, minmax(140px, 1fr)); gap:.5rem; margin-bottom:.75rem; align-items:center; }
    .filter-select { width:100%; padding:.7rem .9rem; border:2px solid #e0e0e0; border-radius:12px; background:#fff; font-size:.95rem; }

    .university-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:1rem; max-height:480px; overflow-y:auto; padding:1rem; border:1px solid #f0f0f0; border-radius:12px; }
    .university-card { background:#f8f9fa; border:2px solid transparent; border-radius:12px; padding:1rem; cursor:pointer; transition:.2s; }
    .university-card:hover { border-color:#1976d2; background:#f3f8ff; }
    .university-card.selected { border-color:#1976d2; background:#e3f2fd; }
    .university-header { display:flex; align-items:center; gap:1rem; margin-bottom:.5rem; }
    .university-logo { width:40px; height:40px; background:#1976d2; color:#fff; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:600; }
    .university-name { font-weight:600; color:#333; }
    .university-location { color:#666; font-size:.9rem; }
    .university-pill { margin-top:.25rem; display:inline-block; font-size:.75rem; color:#555; background:#eef3ff; border:1px solid #dbe7ff; padding:.15rem .5rem; border-radius:999px; }

    .pagination { display:flex; justify-content:space-between; align-items:center; margin-top:.75rem; }
    .pager { display:flex; gap:.5rem; }
    .page-btn { background:#fff; border:2px solid #e0e0e0; border-radius:10px; padding:.5rem .9rem; cursor:pointer; font-weight:600; }
    .page-btn[disabled] { opacity:.5; cursor:not-allowed; }
    .page-size { margin-left:auto; display:flex; align-items:center; gap:.5rem; }

    .selected-count { color:#1976d2; font-weight:600; margin-bottom:1rem; }
    .selected-list { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:2rem; }
    .selected-tag { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:.5rem 1rem; border-radius:20px; font-size:.9rem; display:flex; align-items:center; gap:.5rem; }
    .remove-tag { cursor:pointer; background:rgba(255,255,255,.2); border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .remove-tag:hover { background:rgba(255,255,255,.3); }

    .send-section { text-align:center; }
    .send-btn { background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; padding:1.2rem 3rem; border:none; border-radius:12px; font-size:1.2rem; font-weight:600; cursor:pointer; transition:.2s; display:inline-flex; align-items:center; gap:.5rem; }
    .send-btn:disabled { background:#ccc; cursor:not-allowed; }
    .send-btn:not(:disabled):hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(76,175,80,.3); }

    .progress-section { display:none; }
    .progress-title { font-size:1.3rem; font-weight:600; color:#333; margin-bottom:1rem; text-align:center; }
    .progress-bar { width:100%; height:12px; background:#e0e0e0; border-radius:6px; overflow:hidden; margin-bottom:1rem; }
    .progress-fill { height:100%; background:linear-gradient(135deg,#4caf50,#66bb6a); border-radius:6px; transition:width .5s ease; width:0%; }
    .progress-text { text-align:center; color:#666; font-size:.9rem; }
    .delivery-list { margin-top:1rem; }
    .delivery-item { display:flex; align-items:center; gap:1rem; padding:.75rem; border-radius:8px; margin-bottom:.5rem; background:#f8f9fa; }
    .delivery-status { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .delivery-status.pending { background:#fff3e0; color:#ff9800; }
    .delivery-status.success { background:#e8f5e8; color:#4caf50; }
    .delivery-status.error { background:#ffebee; color:#f44336; }

    .success-section { display:none; background:linear-gradient(135deg,#e8f5e8,#f1f8e9); border:2px solid #4caf50; border-radius:16px; padding:2rem; text-align:center; box-shadow:0 8px 32px rgba(76,175,80,.2); }
    .success-icon { font-size:4rem; color:#4caf50; margin-bottom:1rem; }
    .success-title { font-size:1.8rem; font-weight:600; color:#2e7d32; margin-bottom:1rem; }
    .success-subtitle { color:#4caf50; margin-bottom:2rem; }
    .new-upload-btn { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:1rem 2rem; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition:.2s; }
    .new-upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }

    @keyframes flash { 0%{box-shadow:0 0 0 rgba(25,118,210,0);} 25%{box-shadow:0 0 0 6px rgba(25,118,210,.25);} 100%{box-shadow:0 0 0 rgba(25,118,210,0);} }
    .flash { animation: flash 1.2s ease; }

    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; font-size:.75rem; border-radius:999px; border:1px solid; }
    .badge-student { background:#f1f8ff; color:#0d47a1; border-color:#bbdefb; }
    .badge-added   { background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9; }
    .badge-removed { background:#ffebee; color:#b71c1c; border-color:#ffcdd2; }

    .toast-wrap { position: fixed; right: 16px; bottom: 16px; z-index: 99999; display: grid; gap: 8px; }
    .toast {
      min-width: 240px; max-width: 420px; padding: .75rem .9rem; border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.15); color:#0f172a; background:#fff; border:1px solid #e5e7eb;
      display:flex; align-items:flex-start; gap:.6rem; animation: toast-in .18s ease;
    }
    .toast.success { border-color:#c8e6c9; background:#f1f8f3; }
    .toast.error   { border-color:#ffcdd2; background:#fff2f2; }
    .toast.info    { border-color:#bbdefb; background:#f3f8ff; }
    .toast .icon { font-size: 1.1rem; line-height:1; margin-top:.1rem; }
    .toast .msg  { flex:1; font-size:.95rem; }
    .toast .x    { border:none; background:transparent; cursor:pointer; font-size:1rem; opacity:.6; }
    .toast .x:hover { opacity:.9; }
    @keyframes toast-in { from { transform: translateY(6px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    .empty-state { display:none; background:#fff; border:1px dashed #d0d7de; border-radius:12px; padding:1.25rem; color:#445; text-align:center; }
    .empty-state .actions { margin-top:.75rem; display:flex; gap:.5rem; justify-content:center; }

    @media (max-width:768px) {
      .container { padding:1rem; }
      .hero-title { font-size:2rem; }
      .university-grid { grid-template-columns:1fr; }
      .header-content { flex-direction:column; gap:1rem; }
      .filter-bar { grid-template-columns:1fr 1fr; }
    }

    .suggest-popover {
      position: absolute; z-index: 2000; width: 100%;
      max-height: 280px; overflow-y: auto; margin-top: .25rem;
      background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 12px 32px rgba(0,0,0,.08);
    }
    .suggest-item { padding:.6rem .8rem; cursor:pointer; display:flex; align-items:center; gap:.5rem; font-size:.95rem; }
    .suggest-item[aria-selected="true"], .suggest-item:hover { background:#f3f8ff; }
    .suggest-muted { color:#6b7280; font-size:.85rem; }
    .suggest-highlight { font-weight:700; }

    /* --- SR tabs (added) --- */
    .sr-tabs { display:flex; gap:.5rem; }
    .sr-tab {
      background:#ffffff22; color:#fff; border:1px solid #ffffff44; border-radius:999px;
      padding:.4rem .9rem; font-weight:600; cursor:pointer; transition:.15s; outline: none;
    }
    .sr-tab[aria-selected="true"] { background:#fff; color:#1976d2; }
    .sr-tab:focus-visible { box-shadow:0 0 0 3px rgba(255,255,255,.5); }
    @media (max-width:768px){ .sr-tabs{ align-self:flex-start; } }
    /* Avatar gentle bob animation */
@keyframes sr-bob {
  0%   { transform: translateY(0) }
  50%  { transform: translateY(-2px) }
  100% { transform: translateY(0) }
}
.user-avatar .material-icons {
  animation: sr-bob 3.2s ease-in-out infinite;
  will-change: transform;
}
.user-avatar:hover .material-icons {
  animation-duration: 1.2s;
}

/* Contact Admin modal */
#sr-contact-overlay {
  position: fixed; inset: 0; display:none;
  background: rgba(3, 7, 18, 0.55); z-index: 10000;
  align-items: center; justify-content: center;
}
#sr-contact-sheet {
  width: min(560px, 92vw); background:#fff; border-radius:16px;
  box-shadow: 0 16px 60px rgba(0,0,0,.25); overflow:hidden;
  transform: translateY(12px); opacity: 0; transition: .18s ease;
}
#sr-contact-overlay.show #sr-contact-sheet {
  transform: translateY(0); opacity: 1;
}
.sr-contact-head {
  display:flex; align-items:center; justify-content:space-between;
  padding: 1rem 1.25rem; border-bottom:1px solid #eee; font-weight:700;
}
.sr-contact-body { padding: 1rem 1.25rem; display:grid; gap:.75rem; }
.sr-field { display:grid; gap:.35rem; }
.sr-field label { font-size:.9rem; color:#374151; font-weight:600; }
.sr-input, .sr-textarea {
  width:100%; padding:.7rem .9rem; border:2px solid #e5e7eb; border-radius:10px; font: 400 15px/1.3 'Roboto', sans-serif;
}
.sr-input:focus, .sr-textarea:focus { outline:none; border-color:#1976d2; box-shadow: 0 0 0 3px rgba(25,118,210,.12); }
.sr-textarea { min-height:140px; resize:vertical; }
.sr-contact-foot {
  display:flex; gap:.5rem; justify-content:flex-end; padding: 1rem 1.25rem;
  border-top:1px solid #eee;
}

  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <a href="index.html" class="logo">
        <span class="material-icons">star</span>
        stellarrec
      </a>

      <!-- View Tabs (added) -->
      <div id="sr-tabs" role="tablist" aria-label="Switch View" class="sr-tabs">
        <button id="tab-recommender" role="tab" aria-selected="true" aria-controls="panel-recommender" class="sr-tab">Recommender</button>
        <button id="tab-student" role="tab" aria-selected="false" aria-controls="panel-student" class="sr-tab">Student</button>
      </div>
      <div class="user-info">
        <div class="user-avatar" onclick="toggleUserDropdown()">
          <span class="material-icons">person</span>
        </div>
        <div class="user-dropdown" id="userDropdown">
          <div class="dropdown-header">Switch View</div>
          <div class="dropdown-item active" onclick="switchView('recommender', event)">
            <span class="material-icons">edit</span>
            <div class="view-label">
              <div class="view-name">Recommender</div>
              <div class="view-description">Write & send letters</div>
            </div>
          </div>
          <div class="dropdown-item" onclick="switchView('student', event)">
            <span class="material-icons">school</span>
            <div class="view-label">
              <div class="view-name">Student</div>
              <div class="view-description">Track applications</div>
            </div>
          </div>

          <!-- Mock API toggle -->
          <div class="dropdown-item" style="border-top:1px solid #f0f0f0;">
            <label for="mockToggle" style="display:flex; align-items:center; gap:.75rem; width:100%; cursor:pointer;">
              <span class="material-icons">build</span>
              <div class="view-label">
                <div class="view-name">Use mock API</div>
                <div class="view-description">Toggle mock vs real backend</div>
              </div>
              <input id="mockToggle" type="checkbox" style="margin-left:auto; width:18px; height:18px;" />
            </label>
          </div>
          <!-- /Mock API toggle -->
        </div>
      </div>
    </div>
  </div>

    <!-- Contact admin -->
<div class="dropdown-item" id="srContactOpen">
  <span class="material-icons">mail</span>
  <div class="view-label">
    <div class="view-name">Contact admin</div>
    <div class="view-description">Get help or report an issue</div>
  </div>
</div>
<!-- /Contact admin -->
<div class="container">

    <!-- Student Context Bar -->
    <div class="student-bar" id="studentBar" style="display:flex; align-items:center; gap:.75rem; background:#fff; border:1px solid #eaeaea; border-radius:12px; padding:1rem; margin-bottom:1rem;">
      <span class="material-icons" aria-hidden="true">account_circle</span>
      <div style="flex:1">
        <div id="studentTitle" style="font-weight:700;">No student loaded</div>
        <div id="studentMeta" style="color:#666; font-size:.9rem;">Load a student to see their preselected universities.</div>
      </div>
      <input id="studentIdInput" class="filter-select" placeholder="Student ID or email" style="max-width:220px;" aria-label="Student identifier"/>
      <button class="apply-btn" id="loadStudentBtn">Load student</button>
      <label style="display:flex; align-items:center; gap:.4rem; margin-left:.5rem; font-size:.9rem;">
        <input type="checkbox" id="allowEditsToggle"/>
        Allow recommender edits
      </label>
    </div>

    <!-- Hero Section -->
    <div class="hero-section">
      <h1 class="hero-title">One upload. Unlimited reach.</h1>
      <p class="hero-subtitle">Upload your recommendation letter once and send it broadly and securely.</p>
    </div>
    <!-- Upload + Writer side-by-side -->
    <div class="compose-grid">

      <!-- Upload Section -->
      <div class="upload-section" id="uploadSection">
        <div class="upload-area">
          <div class="upload-icon"><span class="material-icons">cloud_upload</span></div>
          <h2 class="upload-title">Upload Recommendation Letter</h2>
          <p class="upload-subtitle">Drag and drop your PDF file here, or click to browse</p>
          <input type="file" id="fileInput" class="file-input" accept=".pdf" />
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            <span class="material-icons">upload_file</span>
            Choose File
          </button>
        </div>
        <div class="uploaded-file" id="uploadedFile">
          <div class="file-info">
            <div class="file-icon"><span class="material-icons">description</span></div>
            <div class="file-details">
              <h3 id="fileName">recommendation-letter.pdf</h3>
              <p id="fileSize">2.4 MB • Uploaded successfully</p>
            </div>
            <button class="remove-file" onclick="removeFile()"><span class="material-icons">close</span></button>
          </div>
        </div>
      </div>

      <!-- Writer Section -->
      <div class="writer-section" id="writerSection">
        <h2 class="section-title"><span class="material-icons">edit</span> Write Letter</h2>

        <input id="writerTitle" class="writer-title" placeholder="Letter title (optional, e.g., 'Recommendation for Jane Doe')" />

        <div class="writer-toolbar">
          <button class="btn btn-muted" onclick="writerCmd('bold')" title="Bold (Ctrl/Cmd+B)"><b>B</b></button>
          <button class="btn btn-muted" onclick="writerCmd('italic')" title="Italic (Ctrl/Cmd+I)"><i>I</i></button>
          <button class="btn btn-muted" onclick="writerCmd('underline')" title="Underline (Ctrl/Cmd+U)"><u>U</u></button>
          <button class="btn btn-muted" onclick="insertDate()" title="Insert today’s date">📅 Date</button>
          <button class="btn btn-muted" onclick="insertSignature()" title="Insert signature block">✍️ Signature</button>
          <div class="meta">
            <span id="writerCount">0 words • 0 chars</span>
            <span id="writerSaved">Not saved</span>
          </div>
        </div>

        <div id="writerBox" class="writer-box" contenteditable="true" aria-label="Letter editor"
             placeholder="Write your recommendation letter here..."></div>

        <div class="writer-actions">
          <button class="btn btn-primary" onclick="saveDraft()">Save draft</button>
          <button class="btn btn-muted" onclick="restoreDraft()">Restore</button>
          <button class="btn btn-danger" onclick="clearDraft()">Clear</button>
          <button class="btn btn-muted" onclick="copyDraft()">Copy</button>
          <button class="btn btn-muted" onclick="downloadDraft()">Download .txt</button>
          <button class="btn btn-success" onclick="attachDraft()">Attach draft</button>
          <label style="display:flex; align-items:center; gap:.4rem; margin-left:auto;">
            <input type="checkbox" id="writerAutosaveToggle" checked />
            Autosave
          </label>
        </div>
      </div>
    </div>
    <!-- University Selection -->
    <div class="university-section">
      <h2 class="section-title"><span class="material-icons">school</span> Select Universities</h2>

      <!-- Search + Apply -->
      <div class="university-search" style="position:relative;">
        <input type="text" class="search-input" placeholder="Search universities..." id="universitySearch" />
        <button class="apply-btn" id="searchApplyBtn" title="Apply search (Enter)">Apply</button>
      </div>

      <!-- Browse-all dropdown -->
      <select id="universitySelect" class="filter-select" title="Browse all universities" style="margin-bottom:.5rem;">
        <option value="" selected disabled>Browse all universities (6000+)</option>
      </select>

      <!-- Filters -->
      <div class="filter-meta" id="resultMeta" aria-live="polite">Showing 0 of 0</div>
      <div class="filter-bar">
        <select id="stateFilter" class="filter-select" aria-label="Filter by state">
          <option value="">All states</option>
          <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option>
          <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option>
          <option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
          <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option>
          <option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option>
          <option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
          <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option>
          <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option>
          <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
          <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option>
          <option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
          <option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
          <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
        </select>

        <select id="typeFilter" class="filter-select" aria-label="Filter by institution type">
          <option value="">All types</option>
          <option value="Public">Public</option>
          <option value="Private nonprofit">Private nonprofit</option>
          <option value="Private for-profit">Private for-profit</option>
        </select>

        <select id="levelFilter" class="filter-select" aria-label="Filter by level">
          <option value="">All levels</option>
          <option value="4-year">4-year</option>
          <option value="2-year">2-year</option>
          <option value="Less-than-2-year">Less-than-2-year</option>
        </select>

        <select id="sortBy" class="filter-select" aria-label="Sort results">
          <option value="name_asc">Sort: Name (A–Z)</option>
          <option value="state_asc">Sort: State (A–Z)</option>
        </select>

        <button class="apply-btn" id="filterApplyBtn" title="Apply filters and sort">Apply filters</button>
        <button class="apply-btn" id="resetBtn" title="Reset search and filters">Reset</button>
        <button class="apply-btn" id="selectPageBtn" title="Select all universities on this page">Select page</button>
        <button class="page-btn" id="bulkImportBtn" title="Bulk import by names">Bulk import</button>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="empty-state" aria-live="polite">
        <div style="font-weight:600; margin-bottom:.25rem;">No universities match your filters</div>
        <div style="font-size:.9rem; color:#667;">Try adjusting search or clearing filters.</div>
        <div class="actions">
          <button class="apply-btn" id="clearFiltersBtn" type="button">Clear filters</button>
          <button class="page-btn" id="retryLoadBtn" style="display:none;" type="button">Retry loading</button>
        </div>
      </div>

      <!-- Results grid -->
      <div class="university-grid" id="universityGrid" role="list" aria-label="Universities list"></div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pager">
          <button class="page-btn" id="prevPage">Prev</button>
          <span id="pageInfo" style="font-weight:600;">Page 1 of 1</span>
          <button class="page-btn" id="nextPage">Next</button>
        </div>
        <div class="page-size">
          <label for="pageSize">Per page:</label>
          <select id="pageSize" class="filter-select" style="width:auto;display:inline-block;">
            <option value="20">20</option>
            <option value="40" selected>40</option>
            <option value="80">80</option>
            <option value="120">120</option>
          </select>
        </div>
      </div>
    </div>
    <!-- Selected Universities -->
    <div class="selected-section">
      <h2 class="section-title" style="display:flex;align-items:center;gap:.5rem;">
        <span class="material-icons">check_circle</span> Selected Universities
        <button id="copyLinkBtn" class="page-btn" title="Copy shareable link" style="margin-left:auto;">Copy link</button>
      </h2>
      <div class="selected-count" id="selectedCount">0 universities selected</div>
      <div class="selected-list" id="selectedList"></div>
      <div class="send-section">
        <button class="send-btn" id="sendBtn" disabled onclick="sendLetters()">
          <span class="material-icons">send</span>
          Send to Selected Universities
        </button>
      </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progressSection">
      <h2 class="progress-title">Sending Letters...</h2>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText" aria-live="polite">Preparing to send...</div>
      <div class="delivery-list" id="deliveryList"></div>
      <!-- Buttons (Pause/Resume, Cancel) are injected dynamically -->
    </div>

    <!-- Success Section -->
    <div class="success-section" id="successSection">
      <div class="success-icon"><span class="material-icons">check_circle</span></div>
      <h2 class="success-title">Letters Sent Successfully!</h2>
      <p class="success-subtitle">Your recommendation letter has been delivered to all selected universities.</p>
      <button class="new-upload-btn" onclick="startNewUpload()">
        <span class="material-icons">add</span>
        Send Another Letter
      </button>
    </div>
  </div> <!-- /.container -->
  <!-- Confirm Send Modal -->
  <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle"
       style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; width:min(720px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
      <div style="padding:1.2rem 1.4rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div id="confirmModalTitle" style="font-weight:700;">Confirm recipients</div>
        <button aria-label="Close" id="modalCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
      </div>
      <div style="padding:1rem 1.4rem; max-height:60vh; overflow:auto; line-height:1.45;">
        <div id="modalSummary" style="margin-bottom:1rem;"></div>
        <div id="modalLists" style="display:grid; gap:1rem;">
          <div>
            <div style="font-weight:600;">Included (<span id="modalIncludedCount">0</span>)</div>
            <div id="modalIncluded"></div>
          </div>
          <div>
            <div style="font-weight:600;">Removed vs student’s list (<span id="modalRemovedCount">0</span>)</div>
            <div id="modalRemoved" style="color:#b00020;"></div>
          </div>
          <div>
            <div style="font-weight:600;">Added by you (<span id="modalAddedCount">0</span>)</div>
            <div id="modalAdded" style="color:#1b5e20;"></div>
          </div>
        </div>
      </div>
      <div style="padding:1rem 1.4rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
        <button class="page-btn" id="modalCancelBtn">Cancel</button>
        <button class="apply-btn" id="modalConfirmBtn">Send now</button>
      </div>
    </div>
  </div>

  <!-- Bulk Import Modal (native; hotfix also creates one if missing) -->
  <div id="importModal" role="dialog" aria-modal="true" aria-labelledby="importTitle"
       style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; width:min(680px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
      <div style="padding:1rem 1.2rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div id="importTitle" style="font-weight:700;">Bulk import universities</div>
        <button aria-label="Close" id="importCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
      </div>
      <div style="padding:1rem 1.2rem; display:grid; gap:.75rem;">
        <div style="font-size:.92rem; color:#556;">
          Paste one <b>name per line</b>. We’ll fuzzy-match against the master list.
        </div>
        <textarea id="importTextarea" rows="10" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;"></textarea>
        <div id="importPreview" style="font-size:.9rem; color:#667;"></div>
      </div>
      <div style="padding:1rem 1.2rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
        <button class="page-btn" id="importCancelBtn">Cancel</button>
        <button class="apply-btn" id="importConfirmBtn">Add matches</button>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>
  <!-- Footer (Replace with exact footer markup from index.html for pixel parity) -->
  <footer style="margin-top:40px; background:#0b1b33; color:#cbd5e1;">
    <div style="max-width:1200px;margin:0 auto;padding:24px 16px;display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:8px;font-weight:700;">
        <span class="material-icons" aria-hidden="true">star</span> stellarrec
      </div>
      <div style="font-size:.9rem;">© <span id="yearSpan"></span> StellarRec. All rights reserved.</div>
    </div>
  </footer>
  <script>document.getElementById('yearSpan').textContent = new Date().getFullYear();</script>
  <!-- External libs you were using -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <!-- Your main script (keep it) -->
  <script src="dashboard.js"></script>

  <!-- Tab wiring + dataset redirect shim -->
  <script>
    // Wire header tabs to your existing switchView()
    (function(){
      const tabRec = document.getElementById('tab-recommender');
      const tabStu = document.getElementById('tab-student');
      function setTab(view){
        if (!tabRec || !tabStu) return;
        const isRec = view === 'recommender';
        tabRec.setAttribute('aria-selected', isRec ? 'true' : 'false');
        tabStu.setAttribute('aria-selected', isRec ? 'false' : 'true');
      }
      if (tabRec) tabRec.addEventListener('click', function(){
        try { window.switchView && window.switchView('recommender'); } catch(e){}
        setTab('recommender');
      });
      if (tabStu) tabStu.addEventListener('click', function(){
        try { window.switchView && window.switchView('student'); } catch(e){}
        setTab('student');
      });
    })();

    // Ensure hero title uses your new tagline even if main script re-renders
    (function(){
      const t = document.querySelector('.hero-title');
      if (t) t.textContent = 'One upload. Unlimited reach.';
    })();

    // Redirect dataset fetches from /assets/videos/... to /assets/
    (function(){
      const origFetch = window.fetch;
      if (!origFetch) return;
      window.fetch = function(input, init){
        try {
          let url = (typeof input === 'string') ? input : (input && input.url) || '';
          if (typeof url === 'string'){
            url = url.replace('/assets/videos/us_institutions_by_state_2023.min.json','/assets/us_institutions_by_state_2023.json')
                     .replace('/assets/videos/us_institutions_by_state_2023.json','/assets/us_institutions_by_state_2023.json');
            if (typeof input === 'string') input = url; else input = new Request(url, input);
          }
        } catch(e){}
        return origFetch(input, init);
      };
    })();
  </script>
  <!-- ======= STELLARREC SELECT-UNIVERSITIES HOTFIX PACK ======= -->
  <script>
  (function(){
    if (window.__SR_SELECT_UNI_PATCH__) return;
    window.__SR_SELECT_UNI_PATCH__ = true;

    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s||'').toString().trim().toLowerCase();
    const escapeHtml = (s) => (s??'').toString()
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

    let universities      = window.universities      || [];
    let filtered          = window.filtered          || [];
    let page              = typeof window.page === 'number' ? window.page : 1;
    let pageSize          = typeof window.pageSize === 'number' ? window.pageSize : 40;
    let filters           = window.filters || { q:'', state:'', type:'', level:'', sort:'name_asc' };
    let studentUnitIds    = window.studentUnitIds || new Set();
    let addedByRecommender= window.addedByRecommender || new Set();
    let removedByRecommender = window.removedByRecommender || new Set();

    function toast(message){ try {
      const wrap = $('toastWrap') || (function(){ const t=document.createElement('div'); t.id='toastWrap'; t.style.position='fixed'; t.style.right='16px'; t.style.bottom='16px'; t.style.zIndex='99999'; document.body.appendChild(t); return t;})();
      const el = document.createElement('div');
      el.style.cssText = 'background:#111;color:#fff;padding:.6rem .75rem;border-radius:.6rem;margin-top:.4rem;box-shadow:0 8px 24px rgba(0,0,0,.25);font:500 14px/1.2 Roboto,system-ui';
      el.textContent = message;
      wrap.appendChild(el);
      setTimeout(()=>{el.remove();}, 2200);
    } catch(e){} }

    const getEffectiveSelection = window.getEffectiveSelection || function(){
      const base = new Set(studentUnitIds);
      removedByRecommender.forEach(id => base.delete(id));
      addedByRecommender.forEach(id => base.add(id));
      return base;
    };

    function computeFiltered(){
      filtered = universities.filter(u => {
        const q = norm(filters.q);
        const qOk = !q || norm(u.name||'').includes(q) || norm(u.city||'').includes(q) || norm(u.state||'').includes(q);
        const stOk = !filters.state || u.state === filters.state;
        const tyOk = !filters.type  || u.control === filters.type;
        const lvOk = !filters.level || u.level === filters.level;
        return qOk && stOk && tyOk && lvOk;
      });
      if (filters.sort === 'name_asc') filtered.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      else if (filters.sort === 'state_asc') filtered.sort((a,b)=> (a.state||'').localeCompare(b.state||'') || (a.name||'').localeCompare(b.name||''));
    }

    function renderUniversities(list){
      const grid = $('universityGrid'); if (!grid) return;
      grid.innerHTML = '';
      const eff = getEffectiveSelection();
      const frag = document.createDocumentFragment();
      (list||[]).forEach(uni=>{
        const card = document.createElement('div');
        card.className = 'university-card' + (eff.has(uni.unitid) ? ' selected' : '');
        card.setAttribute('role','listitem');
        card.innerHTML = `
          <div class="university-header">
            <div class="university-logo">${escapeHtml((uni.name||'?').charAt(0))}</div>
            <div>
              <div class="university-name">${escapeHtml(uni.name||'Unknown')}</div>
              <div class="university-location">${escapeHtml([uni.city,uni.state].filter(Boolean).join(', '))}</div>
              ${(uni.level || uni.control) ? `<span class="university-pill">${[uni.control, uni.level].filter(Boolean).map(escapeHtml).join(' • ')}</span>` : ''}
            </div>
          </div>`;
        card.addEventListener('click', ()=> toggleUniversity(uni.unitid));
        frag.appendChild(card);
      });
      grid.appendChild(frag);
    }

    function updatePager(){
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      const pi = $('pageInfo'); if (pi) pi.textContent = `Page ${Math.min(page,totalPages)} of ${totalPages}`;
      const prev = $('prevPage'); if (prev) prev.disabled = page <= 1;
      const next = $('nextPage'); if (next) next.disabled = page >= totalPages;

      const meta = $('resultMeta');
      if (meta){
        const start = filtered.length ? ((page-1)*pageSize + 1) : 0;
        const end   = Math.min(filtered.length, page*pageSize);
        meta.textContent = `Showing ${start}-${end} of ${filtered.length} (from ${universities.length} total)`;
      }

      const grid = $('universityGrid'), empty = $('emptyState');
      if (grid && empty){
        if (filtered.length === 0){ grid.style.display='none'; empty.style.display='block'; }
        else { grid.style.display='grid'; empty.style.display='none'; }
      }
    }

    function renderPage(){
      if (!filtered.length) { computeFiltered(); }
      const start = (page-1) * pageSize;
      const end   = start + pageSize;
      renderUniversities(filtered.slice(start,end));
      updatePager();
    }

    function toggleUniversity(unitid){
      if (typeof window.toggleUniversity === 'function' && window.toggleUniversity !== toggleUniversity){
        return window.toggleUniversity(unitid);
      }
      if (studentUnitIds.has(unitid)){
        if (removedByRecommender.has(unitid)) removedByRecommender.delete(unitid);
        else removedByRecommender.add(unitid);
        addedByRecommender.delete(unitid);
      } else {
        if (addedByRecommender.has(unitid)) addedByRecommender.delete(unitid);
        else addedByRecommender.add(unitid);
      }
      renderPage(); updateSelectedList(); updateSendButton();
    }

    function updateSelectedList(){
      const list = $('selectedList'); if (!list) return;
      const count = $('selectedCount');
      const eff = getEffectiveSelection();
      if (count) count.textContent = `${eff.size} universities selected`;
      list.innerHTML = '';
      const frag = document.createDocumentFragment();
      eff.forEach(uid=>{
        const uni = filtered.find(u=>u.unitid===uid) || universities.find(u=>u.unitid===uid);
        const chip = document.createElement('div');
        chip.className = 'selected-tag';
        chip.innerHTML = `${escapeHtml(uni? uni.name : String(uid))} <div class="remove-tag" title="Remove" role="button" aria-label="Remove">×</div>`;
        chip.querySelector('.remove-tag').addEventListener('click', (e)=>{ e.stopPropagation(); removeFromEffective(uid); });
        frag.appendChild(chip);
      });
      list.appendChild(frag);
    }

    function removeFromEffective(uid){
      if (studentUnitIds.has(uid)){ removedByRecommender.add(uid); addedByRecommender.delete(uid); }
      else { addedByRecommender.delete(uid); }
      renderPage(); updateSelectedList(); updateSendButton();
    }

    function updateSendButton(){
      const btn = $('sendBtn'); if (!btn) return;
      const effCount = getEffectiveSelection().size;
      const hasFile = !!(window.uploadedFile);
      btn.disabled = !(hasFile && effCount > 0);
    }

    // AUTOSUGGEST
    function initAutosuggest(){
      const input = $('universitySearch'); if (!input) return;
      let pop = $('suggestPopover');
      if (!pop){
        pop = document.createElement('div');
        pop.id = 'suggestPopover';
        pop.className = 'suggest-popover';
        pop.setAttribute('role','listbox');
        pop.style.display = 'none';
        input.parentNode.appendChild(pop);
      }

      let items = [];
      let activeIndex = -1;
      const close = ()=>{ pop.style.display='none'; items=[]; activeIndex=-1; pop.innerHTML=''; };
      const setActive = (i)=>{
        activeIndex = i;
        Array.from(pop.children).forEach((el,idx)=> el.setAttribute('aria-selected', String(idx===activeIndex)));
      };

      function scoreAndList(qRaw){
        const q = norm(qRaw);
        if (!q) { close(); return; }
        const scored = [];
        for (let i=0;i<universities.length;i++){
          const u = universities[i];
          const nm = norm(u.name||''); const ct = norm(u.city||''); const st = norm(u.state||'');
          let s=0;
          if (nm.startsWith(q)) s=2;
          else if (nm.includes(q)) s=1.5;
          else if (ct.includes(q)||st.includes(q)) s=1;
          if (s>0) scored.push([s,u]);
          if (scored.length>600) break;
        }
        scored.sort((a,b)=> b[0]-a[0] || (a[1].name||'').localeCompare(b[1].name||''));
        items = scored.slice(0,10).map(x=>x[1]);
        if (!items.length){ close(); return; }

        pop.innerHTML='';
        items.forEach((u,idx)=>{
          const row = document.createElement('div');
          row.className = 'suggest-item';
          row.setAttribute('role','option');
          row.setAttribute('aria-selected', idx===0 ? 'true' : 'false');
          row.innerHTML = `
            <span class="material-icons" aria-hidden="true" style="font-size:1rem;">school</span>
            <div>
              <div>${highlight(u.name, qRaw)}</div>
              <div class="suggest-muted">${escapeHtml([u.city,u.state].filter(Boolean).join(', '))}</div>
            </div>`;
          row.addEventListener('mouseenter', ()=> setActive(idx));
          row.addEventListener('click', ()=> pick(u));
          pop.appendChild(row);
        });
        activeIndex = 0;
        pop.style.display='block';
      }

      function highlight(text, query){
        const t = text||''; const q = norm(query); if (!q) return escapeHtml(t);
        const i = norm(t).indexOf(q); if (i<0) return escapeHtml(t);
        return escapeHtml(t.slice(0,i)) + '<span class="suggest-highlight">' + escapeHtml(t.slice(i,i+q.length)) + '</span>' + escapeHtml(t.slice(i+q.length));
      }

      function pick(u){
        input.value = u.name || '';
        filters.q = norm(u.name);
        page = 1;
        computeFiltered(); renderPage();
        close();
        const idx = filtered.findIndex(x => String(x.unitid) === String(u.unitid));
        if (idx >= 0){
          page = Math.floor(idx / pageSize) + 1; renderPage();
          requestAnimationFrame(()=> {
            const cards = Array.from(document.querySelectorAll('.university-card'));
            const startIdx = (page-1)*pageSize;
            const card = cards[idx - startIdx];
            if (card) card.scrollIntoView({behavior:'smooth', block:'nearest'});
          });
        }
      }

      input.addEventListener('input', (e)=> {
        filters.q = input.value.trim().toLowerCase();
        page = 1; computeFiltered(); renderPage(); scoreAndList(input.value);
      });

      input.addEventListener('keydown', (e)=>{
        const open = pop.style.display !== 'none';
        if (e.key === 'Enter'){
          if (open && activeIndex>=0 && items[activeIndex]){ e.preventDefault(); pick(items[activeIndex]); return; }
          e.preventDefault(); filters.q = input.value.trim().toLowerCase(); page=1; computeFiltered(); renderPage(); close(); return;
        }
        if (!open) return;
        if (e.key === 'Escape'){ e.preventDefault(); close(); return; }
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp'){
          e.preventDefault();
          const max = items.length-1;
          if (max < 0) return;
          if (e.key === 'ArrowDown') setActive(activeIndex + 1 > max ? 0 : activeIndex+1);
          else setActive(activeIndex - 1 < 0 ? max : activeIndex-1);
        }
      });

      document.addEventListener('click', (ev)=>{
        if (ev.target === input || ev.target === pop || pop.contains(ev.target)) return;
        close();
      });
    }

    function wireButtons(){
      const apply = $('searchApplyBtn');
      if (apply && !apply.__sr_wired){
        apply.__sr_wired = true;
        apply.addEventListener('click', ()=>{
          const q = $('universitySearch')?.value || '';
          filters.q = q.trim().toLowerCase();
          page = 1; computeFiltered(); renderPage();
        });
      }

      const filt = $('filterApplyBtn');
      if (filt && !filt.__sr_wired){
        filt.__sr_wired = true;
        filt.addEventListener('click', ()=>{
          const state = $('stateFilter')?.value || '';
          const type  = $('typeFilter')?.value || '';
          const level = $('levelFilter')?.value || '';
          const sort  = $('sortBy')?.value || 'name_asc';
          filters.state = state; filters.type = type; filters.level = level; filters.sort = sort;
          page = 1; computeFiltered(); renderPage(); toast('Filters applied');
        });
      }

      const reset = $('resetBtn');
      if (reset && !reset.__sr_wired){
        reset.__sr_wired = true;
        reset.addEventListener('click', ()=>{
          const q = $('universitySearch'); if (q) q.value = '';
          ['stateFilter','typeFilter','levelFilter','sortBy'].forEach(id=>{ const el=$(id); if (el) el.value = id==='sortBy' ? 'name_asc' : ''; });
          filters = { q:'', state:'', type:'', level:'', sort:'name_asc' };
          page=1; computeFiltered(); renderPage(); toast('Filters reset');
        });
      }

      const selectPage = $('selectPageBtn');
      if (selectPage && !selectPage.__sr_wired){
        selectPage.__sr_wired = true;
        selectPage.addEventListener('click', ()=>{
          const start = (page-1)*pageSize, end = Math.min(filtered.length, start+pageSize);
          const eff = getEffectiveSelection();
          filtered.slice(start,end).forEach(u=>{
            eff.add(u.unitid);
            if (studentUnitIds.has(u.unitid)) removedByRecommender.delete(u.unitid);
            else addedByRecommender.add(u.unitid);
          });
          renderPage(); updateSelectedList(); updateSendButton(); toast('Selected all on current page');
        });
      }

      const bulkBtn = $('bulkImportBtn');
      if (bulkBtn && !bulkBtn.__sr_wired){
        bulkBtn.__sr_wired = true;
        bulkBtn.addEventListener('click', ()=> openImportModal());
      }

      const prev = $('prevPage');
      if (prev && !prev.__sr_wired){
        prev.__sr_wired = true;
        prev.addEventListener('click', ()=>{
          const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
          if (page > 1) page--;
          if (page < 1) page=1;
          renderPage();
        });
      }
      const next = $('nextPage');
      if (next && !next.__sr_wired){
        next.__sr_wired = true;
        next.addEventListener('click', ()=>{
          const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
          if (page < totalPages) page++;
          renderPage();
        });
      }
      const per = $('pageSize');
      if (per && !per.__sr_wired){
        per.__sr_wired = true;
        per.addEventListener('change', (e)=>{
          pageSize = parseInt(e.target.value,10) || 40;
          page = 1; renderPage();
        });
      }

      const all = $('universitySelect');
      if (all && !all.__sr_wired){
        all.__sr_wired = true;
        all.addEventListener('change', (e)=>{
          const val = e.target.value; if (!val) return;
          filters = { q:'', state:'', type:'', level:'', sort:'name_asc' };
          const q = $('universitySearch'); if (q) q.value='';
          ['stateFilter','typeFilter','levelFilter','sortBy'].forEach(id=>{ const el=$(id); if (el) el.value = id==='sortBy' ? 'name_asc' : ''; });
          computeFiltered();
          const idx = filtered.findIndex(u => String(u.unitid) === String(val));
          if (idx >= 0){ page = Math.floor(idx / pageSize) + 1; renderPage(); }
          const uidNum = Number(val);
          const uid = Number.isNaN(uidNum) ? val : uidNum;
          if (studentUnitIds.has(uid)) removedByRecommender.delete(uid); else addedByRecommender.add(uid);
          updateSelectedList(); updateSendButton();
          all.selectedIndex = 0;
        });
      }
    }

    function ensureImportModal(){
      if ($('importModal')) return;
      const shell = document.createElement('div');
      shell.id = 'importModal';
      shell.setAttribute('role','dialog');
      shell.setAttribute('aria-modal','true');
      shell.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999;';
      shell.innerHTML = `
        <div style="background:#fff; width:min(680px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
          <div style="padding:1rem 1.2rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">Bulk import universities</div>
            <button id="importCloseBtn" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">✕</button>
          </div>
          <div style="padding:1rem 1.2rem; display:grid; gap:.75rem;">
            <div style="font-size:.92rem; color:#556;">Paste one <b>name per line</b>. We’ll fuzzy-match against the master list.</div>
            <textarea id="importTextarea" rows="10" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;"></textarea>
            <div id="importPreview" style="font-size:.9rem; color:#667;"></div>
          </div>
          <div style="padding:1rem 1.2rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
            <button class="page-btn" id="importCancelBtn">Cancel</button>
            <button class="apply-btn" id="importConfirmBtn">Add matches</button>
          </div>
        </div>`;
      document.body.appendChild(shell);
      $('importCloseBtn').onclick = closeImportModal;
      $('importCancelBtn').onclick = closeImportModal;
      $('importConfirmBtn').onclick = confirmImport;
    }
    function openImportModal(){ ensureImportModal(); $('importModal').style.display='flex'; }
    function closeImportModal(){ const m=$('importModal'); if (m) m.style.display='none'; }
    function confirmImport(){
      const txt = $('importTextarea')?.value || '';
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if (!lines.length){ toast('Nothing to import'); return; }
      const names = new Set(lines.map(norm));
      const matches = universities.filter(u => names.has(norm(u.name||'')) || names.has(norm((u.name||'').replace(/[,]/g,''))));
      if (!matches.length){ toast('No matches found'); return; }
      const eff = getEffectiveSelection();
      matches.forEach(u=>{
        eff.add(u.unitid);
        if (studentUnitIds.has(u.unitid)) removedByRecommender.delete(u.unitid);
        else addedByRecommender.add(u.unitid);
      });
      renderPage(); updateSelectedList(); updateSendButton(); closeImportModal();
      toast(`Added ${matches.length} matches`);
    }

    function populateBrowseAll(){
      const sel = $('universitySelect'); if (!sel) return;
      const keep = sel.options.length ? sel.options[0] : null;
      sel.innerHTML = ''; if (keep) sel.appendChild(keep);
      const sorted = [...universities].sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      const frag = document.createDocumentFragment();
      sorted.forEach(u=>{
        const opt = document.createElement('option');
        opt.value = u.unitid;
        const loc = [u.city,u.state].filter(Boolean).join(', ');
        opt.textContent = `${u.name || 'Unknown Institution'}${loc ? ' — ' + loc : ''}`;
        frag.appendChild(opt);
      });
      sel.appendChild(frag);
      if (keep) keep.textContent = `Browse all universities (${universities.length.toLocaleString()})`;
    }

    document.addEventListener('DOMContentLoaded', function(){
      universities = window.universities || universities || [];
      setTimeout(()=> {
        if ((window.universities||[]).length && universities.length !== window.universities.length){
          universities = window.universities;
          computeFiltered(); renderPage(); populateBrowseAll();
        }
      }, 800);

      if (!filtered.length && universities.length){ computeFiltered(); }

      populateBrowseAll();
      renderPage();
      initAutosuggest();
      wireButtons();

      // Wire native bulk import modal buttons if present
      const im = document.getElementById('importModal');
      if (im){
        const c1 = $('importCloseBtn'), c2 = $('importCancelBtn'), ok = $('importConfirmBtn');
        if (c1) c1.onclick = closeImportModal;
        if (c2) c2.onclick = closeImportModal;
        if (ok) ok.onclick = confirmImport;
      }
    });
  })();
  </script>
  <!-- ======= /STELLARREC HOTFIX PACK ======= -->
  <!-- Contact Admin Overlay -->
<div id="sr-contact-overlay" role="dialog" aria-modal="true" aria-labelledby="sr-contact-title">
  <div id="sr-contact-sheet">
    <div class="sr-contact-head">
      <div id="sr-contact-title">Contact admin</div>
      <button id="sr-contact-close" aria-label="Close" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">✕</button>
    </div>
    <form id="sr-contact-form" class="sr-contact-body" novalidate>
      <div class="sr-field">
        <label for="sr-first-name">First name</label>
        <input id="sr-first-name" class="sr-input" name="firstName" autocomplete="given-name" required />
      </div>
      <div class="sr-field">
        <label for="sr-email">Email address</label>
        <input id="sr-email" class="sr-input" type="email" name="email" autocomplete="email" required />
      </div>
      <div class="sr-field">
        <label for="sr-query">Your query</label>
        <textarea id="sr-query" class="sr-textarea" name="query" required placeholder="How can we help?"></textarea>
      </div>
      <div class="sr-contact-foot">
        <button type="button" class="page-btn" id="sr-contact-cancel">Cancel</button>
        <button type="submit" class="apply-btn" id="sr-contact-send">
          <span class="material-icons" aria-hidden="true" style="font-size:1rem;">send</span> Send
        </button>
      </div>
    </form>
  </div>
</div>
<!-- /Contact Admin Overlay -->
  <script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const overlay = $('sr-contact-overlay');
  const sheet   = $('sr-contact-sheet');
  const openBtn = $('srContactOpen');
  const closeBtn= $('sr-contact-close');
  const cancelBtn = $('sr-contact-cancel');
  const form    = $('sr-contact-form');
  const first   = $('sr-first-name');
  const email   = $('sr-email');
  const query   = $('sr-query');

  // Build admin email in JS (obfuscated; not displayed)
  function adminEmail(){
    const p1 = 'swetha';
    const p2 = 'rajan103';
    const dom = 'gmail';
    const tld = 'com';
    return `${p1}.${p2}@${dom}.${tld}`;
  }

  function openOverlay(){
    overlay.style.display = 'flex';
    // small delay to allow CSS transition
    requestAnimationFrame(()=> overlay.classList.add('show'));
    setTimeout(()=> first && first.focus(), 100);
  }
  function closeOverlay(){
    overlay.classList.remove('show');
    setTimeout(()=> { overlay.style.display='none'; }, 160);
  }

  // Wire open/close
  if (openBtn && !openBtn.__sr_wired){
    openBtn.__sr_wired = true;
    openBtn.addEventListener('click', (e)=> { e.preventDefault(); openOverlay(); });
  }
  if (closeBtn)  closeBtn.addEventListener('click', closeOverlay);
  if (cancelBtn) cancelBtn.addEventListener('click', closeOverlay);
  overlay.addEventListener('click', (e)=> { if (e.target === overlay) closeOverlay(); });
  document.addEventListener('keydown', (e)=> {
    if (overlay.style.display === 'flex' && e.key === 'Escape') closeOverlay();
  });

  // Validation helper
  function showToast(msg, type='info'){
    let wrap = document.getElementById('toastWrap');
    if (!wrap) { wrap = document.createElement('div'); wrap.id='toastWrap'; wrap.className='toast-wrap'; document.body.appendChild(wrap); }
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    t.innerHTML = `<div class="icon">🔔</div><div class="msg">${msg}</div><button class="x" aria-label="Close">✕</button>`;
    t.querySelector('.x').onclick = ()=> t.remove();
    wrap.appendChild(t);
    setTimeout(()=> t.remove(), 3500);
  }

  function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

  // Submit handler (mailto composed; no email shown on page)
  if (form && !form.__sr_wired){
    form.__sr_wired = true;
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const fn = (first.value||'').trim();
      const em = (email.value||'').trim();
      const q  = (query.value||'').trim();

      if (!fn){ first.focus(); showToast('Please enter your first name.','error'); return; }
      if (!validEmail(em)){ email.focus(); showToast('Please enter a valid email.','error'); return; }
      if (!q){ query.focus(); showToast('Please enter your query.','error'); return; }

      // Compose email without revealing the address in the UI
      const to = adminEmail();
      const subject = encodeURIComponent(`Support request from ${fn}`);
      const body = encodeURIComponent(
`First name: ${fn}
Email: ${em}

Query:
${q}

— Sent from StellarRec Dashboard`
      );

      // Prefer opening a new mail draft; fallback: location href
      const mailto = `mailto:${to}?subject=${subject}&body=${body}`;
      const a = document.createElement('a');
      a.href = mailto;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=> a.remove(), 0);

      showToast('Opening your email app…','success');
      closeOverlay();

      // Optional: lightweight analytics event (no-op if not present)
      try { window.gtag && gtag('event','contact_admin_submitted'); } catch(e){}
    });
  }
})();
</script>


</body>
</html>






  
