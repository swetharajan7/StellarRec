[Block 1/15]

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StellarRec - One upload. Unlimited reach.</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Roboto',sans-serif;
      background:linear-gradient(135deg,var(--bg-grad-1,#f8f9fa) 0%,var(--bg-grad-2,#e9ecef) 100%);
      color:var(--text,#333);
      min-height:100vh;
    }

    /* Header */
    .header {
      background:linear-gradient(135deg,#1976d2 0%,#7c4dff 100%);
      color:#fff; padding:1.5rem 2rem;
      box-shadow:0 4px 20px rgba(25,118,210,0.3);
    }
    .header-content {
      max-width:1200px; margin:0 auto;
      display:flex; justify-content:space-between; align-items:center; gap:1rem;
    }
    .logo {
      display:flex; align-items:center; gap:.5rem;
      font-size:1.8rem; font-weight:700;
      text-decoration:none; color:#fff; transition:.3s;
    }
    .logo:hover { opacity:.85; transform:translateY(-1px); }

    .user-info { position:relative; display:flex; align-items:center; gap:1rem; }
    .user-avatar {
      width:45px; height:45px;
      background:rgba(255,255,255,.2); border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:1.2rem; cursor:pointer; transition:.3s;
    }
    .user-avatar:hover { background:rgba(255,255,255,.3); transform:scale(1.05); }

    .user-dropdown {
      position:absolute; top:100%; right:0; margin-top:.5rem;
      background:#fff; border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,.15);
      min-width:260px; opacity:0; visibility:hidden;
      transform:translateY(-10px);
      transition:.3s; z-index:1000;
    }
    .user-dropdown.show { opacity:1; visibility:visible; transform:translateY(0); }

    .dropdown-header { padding:1rem; border-bottom:1px solid #f0f0f0; color:#333; font-weight:600; font-size:.9rem; }
    .dropdown-item {
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem; color:#333; cursor:pointer; transition:.2s;
    }
    .dropdown-item:hover { background:#f8f9fa; }
    .dropdown-item.active { background:#e3f2fd; color:#1976d2; }
    .dropdown-item .material-icons { font-size:1.2rem; color:#666; }
    .dropdown-item.active .material-icons { color:#1976d2; }

    .view-label { display:flex; flex-direction:column; }
    .view-name { font-weight:600; font-size:.9rem; }
    .view-description { font-size:.8rem; color:#666; margin-top:.1rem; }

    /* SR tabs */
    .sr-tabs { display:flex; gap:.5rem; }
    .sr-tab {
      background:#ffffff22; color:#fff;
      border:1px solid #ffffff44; border-radius:999px;
      padding:.4rem .9rem; font-weight:600; cursor:pointer; transition:.15s; outline: none;
    }
    .sr-tab[aria-selected="true"] { background:#fff; color:#1976d2; }
    .sr-tab:focus-visible { box-shadow:0 0 0 3px rgba(255,255,255,.5); }
    @media (max-width:768px){ .sr-tabs{ align-self:flex-start; } }
[Block 2/15]

    .container { max-width:1200px; margin:0 auto; padding:2rem; }
    .hero-section { text-align:center; margin-bottom:3rem; }
    .hero-title { font-size:2.5rem; font-weight:700; color:#1976d2; margin-bottom:1rem; }
    .hero-subtitle { font-size:1.2rem; color:#666; margin-bottom:2rem; }

    /* Two-column layout */
    .compose-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:2rem; }
    @media (max-width: 980px) { .compose-grid { grid-template-columns:1fr; } }

    .upload-section, .writer-section, .university-section,
    .selected-section, .progress-section {
      background:#fff; border-radius:16px; padding:2rem;
      box-shadow:0 8px 32px rgba(0,0,0,.1); margin-bottom:0;
    }
    .upload-section { border:2px dashed #e0e0e0; transition:.3s; }
    .upload-section.dragover { border-color:#1976d2; background:#f3f8ff; }

    .upload-area { text-align:center; padding:2rem; }
    .upload-icon { font-size:4rem; color:#1976d2; margin-bottom:1rem; }
    .upload-title { font-size:1.5rem; font-weight:600; margin-bottom:.5rem; color:#333; }
    .upload-subtitle { color:#666; margin-bottom:2rem; }
    .file-input { display:none; }
    .upload-btn {
      background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff;
      padding:1rem 2rem; border:none; border-radius:12px;
      font-size:1.1rem; font-weight:600; cursor:pointer;
      transition:.3s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }
    .uploaded-file {
      display:none; background:#e8f5e8; border:2px solid #4caf50;
      border-radius:12px; padding:1.5rem; margin-top:1rem;
    }
    .file-info { display:flex; align-items:center; gap:1rem; }
    .file-icon { font-size:2rem; color:#4caf50; }
    .file-details h3 { color:#2e7d32; margin-bottom:.25rem; }
    .file-details p { color:#4caf50; font-size:.9rem; }
    .remove-file {
      margin-left:auto; background:none; border:none; color:#666;
      cursor:pointer; padding:.5rem; border-radius:50%; transition:.2s;
    }
    .remove-file:hover { background:rgba(244,67,54,.1); color:#f44336; }

    .section-title {
      font-size:1.5rem; font-weight:600; color:#333;
      margin-bottom:1rem; display:flex; align-items:center; gap:.5rem;
    }

    /* Writer */
    .writer-toolbar { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.75rem; align-items:center; }
    .writer-toolbar .btn {
      background:#fff; border:2px solid #e5e7eb; border-radius:10px;
      padding:.45rem .75rem; cursor:pointer; font-weight:600;
    }
    .writer-toolbar .btn:hover { background:#f8f9fa; }
    .writer-toolbar .meta { margin-left:auto; font-size:.9rem; color:#667; display:flex; gap:.75rem; align-items:center; }
    .writer-title {
      width:100%; padding:.7rem .9rem;
      border:2px solid #e0e0e0; border-radius:12px;
      font-size:1rem; margin-bottom:.6rem;
    }
    .writer-box {
      border:2px solid #e0e0e0; border-radius:12px;
      min-height:280px; padding:1rem; line-height:1.55;
    }
    .writer-box:focus { outline:none; border-color:#1976d2; }
    .writer-actions { display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap; }
    .btn-primary { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; border:none; }
    .btn-success { background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; border:none; }
    .btn-danger  { background:linear-gradient(135deg,#e53935,#ef5350); color:#fff; border:none; }
    .btn-muted   { background:#fff; color:#333; }
[Block 3/15]

    .filter-meta { font-size:.9rem; color:#666; margin:.25rem 0 .5rem; }

    .filter-bar { display:grid; grid-template-columns: repeat(8, minmax(140px, 1fr)); gap:.5rem; margin-bottom:.75rem; align-items:center; }
    .filter-select { width:100%; padding:.7rem .9rem; border:2px solid #e0e0e0; border-radius:12px; background:#fff; font-size:.95rem; }

    .university-grid {
      display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:1rem;
      max-height:480px; overflow-y:auto; padding:1rem; border:1px solid #f0f0f0; border-radius:12px;
    }
    .university-card { background:#f8f9fa; border:2px solid transparent; border-radius:12px; padding:1rem; cursor:pointer; transition:.2s; }
    .university-card:hover { border-color:#1976d2; background:#f3f8ff; }
    .university-card.selected { border-color:#1976d2; background:#e3f2fd; }
    .university-header { display:flex; align-items:center; gap:1rem; margin-bottom:.5rem; }
    .university-logo { width:40px; height:40px; background:#1976d2; color:#fff; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:600; }
    .university-name { font-weight:600; color:#333; }
    .university-location { color:#666; font-size:.9rem; }
    .university-pill { margin-top:.25rem; display:inline-block; font-size:.75rem; color:#555; background:#eef3ff; border:1px solid #dbe7ff; padding:.15rem .5rem; border-radius:999px; }

    .pagination { display:flex; justify-content:space-between; align-items:center; margin-top:.75rem; }
    .pager { display:flex; gap:.5rem; }
    .page-btn { background:#fff; border:2px solid #e0e0e0; border-radius:10px; padding:.5rem .9rem; cursor:pointer; font-weight:600; }
    .page-btn[disabled] { opacity:.5; cursor:not-allowed; }
    .page-size { margin-left:auto; display:flex; align-items:center; gap:.5rem; }

    .selected-count { color:#1976d2; font-weight:600; margin-bottom:1rem; }
    .selected-list { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:2rem; }
    .selected-tag { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:.5rem 1rem; border-radius:20px; font-size:.9rem; display:flex; align-items:center; gap:.5rem; }
    .remove-tag { cursor:pointer; background:rgba(255,255,255,.2); border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .remove-tag:hover { background:rgba(255,255,255,.3); }

    .send-section { text-align:center; }
    .send-btn {
      background:linear-gradient(135deg,#4caf50,#66bb6a); color:#fff; padding:1.2rem 3rem; border:none; border-radius:12px;
      font-size:1.2rem; font-weight:600; cursor:pointer; transition:.2s; display:inline-flex; align-items:center; gap:.5rem;
    }
    .send-btn:disabled { background:#ccc; cursor:not-allowed; }
    .send-btn:not(:disabled):hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(76,175,80,.3); }

    .progress-section { display:none; }
    .progress-title { font-size:1.3rem; font-weight:600; color:#333; margin-bottom:1rem; text-align:center; }
    .progress-bar { width:100%; height:12px; background:#e0e0e0; border-radius:6px; overflow:hidden; margin-bottom:1rem; }
    .progress-fill { height:100%; background:linear-gradient(135deg,#4caf50,#66bb6a); border-radius:6px; transition:width .5s ease; width:0%; }
    .progress-text { text-align:center; color:#666; font-size:.9rem; }
    .delivery-list { margin-top:1rem; }
    .delivery-item { display:flex; align-items:center; gap:1rem; padding:.75rem; border-radius:8px; margin-bottom:.5rem; background:#f8f9fa; }
    .delivery-status { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .delivery-status.pending { background:#fff3e0; color:#ff9800; }
    .delivery-status.success { background:#e8f5e8; color:#4caf50; }
    .delivery-status.error { background:#ffebee; color:#f44336; }

    .success-section {
      display:none; background:linear-gradient(135deg,#e8f5e8,#f1f8e9);
      border:2px solid #4caf50; border-radius:16px; padding:2rem; text-align:center; box-shadow:0 8px 32px rgba(76,175,80,.2);
    }
    .success-icon { font-size:4rem; color:#4caf50; margin-bottom:1rem; }
    .success-title { font-size:1.8rem; font-weight:600; color:#2e7d32; margin-bottom:1rem; }
    .success-subtitle { color:#4caf50; margin-bottom:2rem; }
    .new-upload-btn { background:linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; padding:1rem 2rem; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition:.2s; }
    .new-upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(25,118,210,.3); }

    @keyframes flash { 0%{box-shadow:0 0 0 rgba(25,118,210,0);} 25%{box-shadow:0 0 0 6px rgba(25,118,210,.25);} 100%{box-shadow:0 0 0 rgba(25,118,210,0);} }
    .flash { animation: flash 1.2s ease; }

    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; font-size:.75rem; border-radius:999px; border:1px solid; }
    .badge-student { background:#f1f8ff; color:#0d47a1; border-color:#bbdefb; }
    .badge-added   { background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9; }
    .badge-removed { background:#ffebee; color:#b71c1c; border-color:#ffcdd2; }

    .toast-wrap { position: fixed; right: 16px; bottom: 16px; z-index: 99999; display: grid; gap: 8px; }
    .toast {
      min-width: 240px; max-width: 420px; padding: .75rem .9rem; border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.15); color:#0f172a; background:#fff; border:1px solid #e5e7eb;
      display:flex; align-items:flex-start; gap:.6rem; animation: toast-in .18s ease;
    }
    .toast.success { border-color:#c8e6c9; background:#f1f8f3; }
    .toast.error   { border-color:#ffcdd2; background:#fff2f2; }
    .toast.info    { border-color:#bbdefb; background:#f3f8ff; }
    .toast .icon { font-size: 1.1rem; line-height:1; margin-top:.1rem; }
    .toast .msg  { flex:1; font-size:.95rem; }
    .toast .x    { border:none; background:transparent; cursor:pointer; font-size:1rem; opacity:.6; }
    .toast .x:hover { opacity:.9; }
    @keyframes toast-in { from { transform: translateY(6px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    .empty-state { display:none; background:#fff; border:1px dashed #d0d7de; border-radius:12px; padding:1.25rem; color:#445; text-align:center; }
    .empty-state .actions { margin-top:.75rem; display:flex; gap:.5rem; justify-content:center; }

    @media (max-width:768px) {
      .container { padding:1rem; }
      .hero-title { font-size:2rem; }
      .university-grid { grid-template-columns:1fr; }
      .header-content { flex-direction:column; gap:1rem; }
      .filter-bar { grid-template-columns:1fr 1fr; }
    }

    /* Autosuggest */
    .suggest-popover {
      position: absolute; z-index: 2000; width: 100%;
      max-height: 280px; overflow-y: auto; margin-top: .25rem;
      background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 12px 32px rgba(0,0,0,.08);
    }
    .suggest-item { padding:.6rem .8rem; cursor:pointer; display:flex; align-items:center; gap:.5rem; font-size:.95rem; }
    .suggest-item[aria-selected="true"], .suggest-item:hover { background:#f3f8ff; }
    .suggest-muted { color:#6b7280; font-size:.85rem; }
    .suggest-highlight { font-weight:700; }

    /* Header tabs */
    .sr-tabs { display:flex; gap:.5rem; }
    .sr-tab {
      background:#ffffff22; color:#fff; border:1px solid #ffffff44; border-radius:999px;
      padding:.4rem .9rem; font-weight:600; cursor:pointer; transition:.15s; outline: none;
    }
    .sr-tab[aria-selected="true"] { background:#fff; color:#1976d2; }
    .sr-tab:focus-visible { box-shadow:0 0 0 3px rgba(255,255,255,.5); }
    @media (max-width:768px){ .sr-tabs{ align-self:flex-start; } }

    /* Dark theme toggle basics */
    :root[data-theme="dark"] {
      --bg:#0b1220; --panel:#111a2a; --text:#e5eefc; --muted:#93a3bc; --primary:#7aa2ff; --border:#24324a;
    }
    :root[data-theme="dark"] body { background: linear-gradient(135deg,#0b1220 0%,#0f1729 100%); color: var(--text); }
    :root[data-theme="dark"] .upload-section,
    :root[data-theme="dark"] .writer-section,
    :root[data-theme="dark"] .university-section,
    :root[data-theme="dark"] .selected-section,
    :root[data-theme="dark"] .progress-section { background: var(--panel); box-shadow:none; }
    :root[data-theme="dark"] .filter-select,
    :root[data-theme="dark"] .writer-title,
    :root[data-theme="dark"] .writer-box,
    :root[data-theme="dark"] .page-btn { background:#0f1729; color:var(--text); border-color: var(--border); }
    :root[data-theme="dark"] .university-card { background:#0f1729; }
    :root[data-theme="dark"] .university-card:hover { background:#12203a; border-color:#274780; }
    :root[data-theme="dark"] .university-card.selected { background:#13254a; }
    :root[data-theme="dark"] .hero-subtitle, :root[data-theme="dark"] .university-location { color: var(--muted); }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <a href="index.html" class="logo">
        <span class="material-icons">star</span>
        stellarrec
      </a>

      <!-- View Tabs -->
      <div id="sr-tabs" role="tablist" aria-label="Switch View" class="sr-tabs">
        <button id="tab-recommender" role="tab" aria-selected="true" aria-controls="panel-recommender" class="sr-tab">Recommender</button>
        <button id="tab-student" role="tab" aria-selected="false" aria-controls="panel-student" class="sr-tab">Student</button>
      </div>

      <!-- User / settings -->
      <div class="user-info">
        <div class="user-avatar" id="userAvatarBtn" aria-haspopup="true" aria-expanded="false">
          <span class="material-icons">person</span>
        </div>
        <div class="user-dropdown" id="userDropdown" role="menu" aria-hidden="true">
          <div class="dropdown-header">Quick actions</div>

          <div class="dropdown-item" id="contactAdminItem">
            <span class="material-icons">support_agent</span>
            <div class="view-label">
              <div class="view-name">Contact admin</div>
              <div class="view-description">Send a message</div>
            </div>
          </div>

          <div class="dropdown-item" id="themeToggleItem">
            <span class="material-icons">dark_mode</span>
            <div class="view-label">
              <div class="view-name">Theme</div>
              <div class="view-description">Light / Dark</div>
            </div>
            <label style="margin-left:auto;display:flex;align-items:center;gap:.4rem;">
              <input id="themeToggle" type="checkbox" />
              <span style="font-size:.85rem;">Dark</span>
            </label>
          </div>

          <div class="dropdown-item active" onclick="switchView('recommender', event)">
            <span class="material-icons">edit</span>
            <div class="view-label">
              <div class="view-name">Recommender</div>
              <div class="view-description">Write & send letters</div>
            </div>
          </div>
          <div class="dropdown-item" onclick="switchView('student', event)">
            <span class="material-icons">school</span>
            <div class="view-label">
              <div class="view-name">Student</div>
              <div class="view-description">Track applications</div>
            </div>
          </div>

          <!-- Mock API toggle -->
          <div class="dropdown-item" style="border-top:1px solid #f0f0f0;">
            <label for="mockToggle" style="display:flex; align-items:center; gap:.75rem; width:100%; cursor:pointer;">
              <span class="material-icons">build</span>
              <div class="view-label">
                <div class="view-name">Use mock API</div>
                <div class="view-description">Toggle mock vs real backend</div>
              </div>
              <input id="mockToggle" type="checkbox" style="margin-left:auto; width:18px; height:18px;" />
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Admin Modal -->
  <div id="contactModal" role="dialog" aria-modal="true" aria-labelledby="contactTitle"
       style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; width:min(560px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
      <div style="padding:1.2rem 1.4rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div id="contactTitle" style="font-weight:700;">Contact Admin</div>
        <button aria-label="Close" id="contactCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
      </div>
      <form id="contactForm" style="padding:1rem 1.4rem; display:grid; gap:.75rem;">
        <label>First name
          <input type="text" id="contactFirst" required class="filter-select" style="margin-top:.35rem;">
        </label>
        <label>Email address
          <input type="email" id="contactEmail" required class="filter-select" style="margin-top:.35rem;">
        </label>
        <label>Query
          <textarea id="contactQuery" rows="5" required class="filter-select" style="margin-top:.35rem;"></textarea>
        </label>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; padding-top:.5rem;">
          <button type="button" class="page-btn" id="contactCancelBtn">Cancel</button>
          <button type="submit" class="apply-btn" id="contactSendBtn">Send</button>
        </div>
      </form>
    </div>
  </div>

  <div class="container" id="panel-recommender">
    <!-- Student Context Bar -->
    <div class="student-bar" id="studentBar" style="display:flex; align-items:center; gap:.75rem; background:#fff; border:1px solid #eaeaea; border-radius:12px; padding:1rem; margin-bottom:1rem;">
      <span class="material-icons" aria-hidden="true">account_circle</span>
      <div style="flex:1">
        <div id="studentTitle" style="font-weight:700;">No student loaded</div>
        <div id="studentMeta" style="color:#666; font-size:.9rem;">Load a student to see their preselected universities.</div>
      </div>
      <input id="studentIdInput" class="filter-select" placeholder="Student ID or email" style="max-width:220px;" aria-label="Student identifier"/>
      <button class="apply-btn" id="loadStudentBtn">Load student</button>
      <label style="display:flex; align-items:center; gap:.4rem; margin-left:.5rem; font-size:.9rem;">
        <input type="checkbox" id="allowEditsToggle"/>
        Allow recommender edits
      </label>
    </div>

    <!-- Hero -->
    <div class="hero-section">
      <h1 class="hero-title">One upload. Unlimited reach.</h1>
      <p class="hero-subtitle">Upload your recommendation letter once and send it to multiple US universities instantly.</p>
    </div>

    <!-- Upload + Writer -->
    <div class="compose-grid">
      <!-- Upload Section -->
      <div class="upload-section" id="uploadSection">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon"><span class="material-icons">cloud_upload</span></div>
          <h2 class="upload-title">Upload Recommendation Letter</h2>
          <p class="upload-subtitle">Drag and drop your PDF file here, or click to browse</p>
          <input type="file" id="fileInput" class="file-input" accept=".pdf,.txt" />
          <button class="upload-btn" id="chooseFileBtn">
            <span class="material-icons">upload_file</span>
            Choose File
          </button>
        </div>
        <div class="uploaded-file" id="uploadedFile">
          <div class="file-info">
            <div class="file-icon"><span class="material-icons">description</span></div>
            <div class="file-details">
              <h3 id="fileName">recommendation-letter.pdf</h3>
              <p id="fileSize">2.4 MB • Uploaded successfully</p>
            </div>
            <button class="remove-file" id="removeFileBtn"><span class="material-icons">close</span></button>
          </div>
        </div>
      </div>

      <!-- Writer -->
      <div class="writer-section" id="writerSection">
        <h2 class="section-title"><span class="material-icons">edit</span> Write Letter</h2>
        <input id="writerTitle" class="writer-title" placeholder="Letter title (optional, e.g., 'Recommendation for Jane Doe')" />
        <div class="writer-toolbar">
          <button class="btn btn-muted" data-wcmd="bold" title="Bold (Ctrl/Cmd+B)"><b>B</b></button>
          <button class="btn btn-muted" data-wcmd="italic" title="Italic (Ctrl/Cmd+I)"><i>I</i></button>
          <button class="btn btn-muted" data-wcmd="underline" title="Underline (Ctrl/Cmd+U)"><u>U</u></button>
          <div class="meta">
            <span id="writerCount">0 words • 0 chars</span>
            <span id="writerSaved">Not saved</span>
          </div>
        </div>
        <div id="writerBox" class="writer-box" contenteditable="true" aria-label="Letter editor"
             placeholder="Write your recommendation letter here..."></div>
        <div class="writer-actions">
          <button class="btn btn-primary" id="saveDraftBtn">Save draft</button>
          <button class="btn btn-muted" id="restoreDraftBtn">Restore</button>
          <button class="btn btn-danger" id="clearDraftBtn">Clear</button>
          <button class="btn btn-muted" id="copyDraftBtn">Copy</button>
          <button class="btn btn-muted" id="downloadDraftBtn">Download .txt</button>
          <button class="btn btn-success" id="attachDraftBtn">Attach draft</button>
          <label style="display:flex; align-items:center; gap:.4rem; margin-left:auto;">
            <input type="checkbox" id="writerAutosaveToggle" checked />
            Autosave
          </label>
        </div>
      </div>
    </div>
[Block 4/15]

    <!-- University Selection -->
    <div class="university-section">
      <h2 class="section-title"><span class="material-icons">school</span> Select Universities</h2>

      <!-- Search + Apply -->
      <div class="university-search" style="position:relative;">
        <input type="text" class="search-input filter-select" placeholder="Search universities..." id="universitySearch" autocomplete="off"/>
        <div id="searchSuggest" class="suggest-popover" style="display:none;"></div>
        <button class="apply-btn" id="searchApplyBtn" title="Apply search (Enter)">Apply</button>
      </div>

      <!-- Browse-all dropdown -->
      <select id="universitySelect" class="filter-select" title="Browse all universities" style="margin-bottom:.5rem;">
        <option value="" selected disabled>Browse all universities (6000+)</option>
      </select>

      <!-- Filters -->
      <div class="filter-meta" id="resultMeta" aria-live="polite">Showing 0 of 0</div>
      <div class="filter-bar">
        <select id="stateFilter" class="filter-select" aria-label="Filter by state">
          <option value="">All states</option>
          <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option>
          <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option>
          <option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
          <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option>
          <option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option>
          <option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
          <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option>
          <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option>
          <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
          <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option>
          <option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
          <option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
          <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
        </select>

        <select id="typeFilter" class="filter-select" aria-label="Filter by institution type">
          <option value="">All types</option>
          <option value="Public">Public</option>
          <option value="Private nonprofit">Private nonprofit</option>
          <option value="Private for-profit">Private for-profit</option>
        </select>

        <select id="levelFilter" class="filter-select" aria-label="Filter by level">
          <option value="">All levels</option>
          <option value="4-year">4-year</option>
          <option value="2-year">2-year</option>
          <option value="Less-than-2-year">Less-than-2-year</option>
        </select>

        <select id="sortBy" class="filter-select" aria-label="Sort results">
          <option value="name_asc">Sort: Name (A–Z)</option>
          <option value="state_asc">Sort: State (A–Z)</option>
        </select>

        <button class="apply-btn" id="filterApplyBtn" title="Apply filters and sort">Apply filters</button>
        <button class="apply-btn" id="resetBtn" title="Reset search and filters">Reset</button>
        <button class="apply-btn" id="selectPageBtn" title="Select all universities on this page">Select page</button>
        <button class="page-btn" id="bulkImportBtn" title="Bulk import by names">Bulk import</button>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="empty-state" aria-live="polite">
        <div style="font-weight:600; margin-bottom:.25rem;">No universities match your filters</div>
        <div style="font-size:.9rem; color:#667;">Try adjusting search or clearing filters.</div>
        <div class="actions">
          <button class="apply-btn" id="clearFiltersBtn" type="button">Clear filters</button>
          <button class="page-btn" id="retryLoadBtn" style="display:none;" type="button">Retry loading</button>
        </div>
      </div>

      <!-- Results grid -->
      <div class="university-grid" id="universityGrid" role="list" aria-label="Universities list"></div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pager">
          <button class="page-btn" id="prevPage">Prev</button>
          <span id="pageInfo" style="font-weight:600;">Page 1 of 1</span>
          <button class="page-btn" id="nextPage">Next</button>
        </div>
        <div class="page-size">
          <label for="pageSize">Per page:</label>
          <select id="pageSize" class="filter-select" style="width:auto;display:inline-block;">
            <option value="20">20</option>
            <option value="40" selected>40</option>
            <option value="80">80</option>
            <option value="120">120</option>
          </select>
        </div>
      </div>
    </div>
[Block 5/15]

    <!-- Selected Universities -->
    <div class="selected-section">
      <h2 class="section-title" style="display:flex;align-items:center;gap:.5rem;">
        <span class="material-icons">check_circle</span> Selected Universities
        <button id="copyLinkBtn" class="page-btn" title="Copy shareable link" style="margin-left:auto;">Copy link</button>
      </h2>
      <div class="selected-count" id="selectedCount">0 universities selected</div>
      <div class="selected-list" id="selectedList" role="list" aria-live="polite"></div>
      <div class="send-section">
        <button class="send-btn" id="sendBtn" disabled onclick="sendLetters()">
          <span class="material-icons">send</span>
          Send to Selected Universities
        </button>
      </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progressSection">
      <h2 class="progress-title">Sending Letters...</h2>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText" aria-live="polite">Preparing to send...</div>
      <div class="delivery-list" id="deliveryList"></div>
      <!-- Pause/Resume + Cancel buttons are injected dynamically -->
    </div>

    <!-- Success Section -->
    <div class="success-section" id="successSection">
      <div class="success-icon"><span class="material-icons">check_circle</span></div>
      <h2 class="success-title">Letters Sent Successfully!</h2>
      <p class="success-subtitle">Your recommendation letter has been delivered to all selected universities.</p>
      <button class="new-upload-btn" onclick="startNewUpload()">
        <span class="material-icons">add</span>
        Send Another Letter
      </button>
    </div>

    <!-- Footer (same structure as index.html; styles already present globally) -->
    <footer class="site-footer" id="siteFooter" style="margin-top:3rem;">
      <div class="container" style="padding: 1.5rem 0;">
        <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:center; justify-content:space-between;">
          <div style="display:flex; align-items:center; gap:.5rem; color:#475569;">
            <span class="material-icons" aria-hidden="true">star</span>
            <strong>stellarrec</strong>
            <span aria-hidden="true" style="opacity:.6;">•</span>
            <span>One upload. Unlimited reach.</span>
          </div>
          <nav aria-label="Footer">
            <a href="/" class="page-btn" style="text-decoration:none;">Home</a>
            <a href="/#features" class="page-btn" style="text-decoration:none;">Features</a>
            <a href="/#how-it-works" class="page-btn" style="text-decoration:none;">How it works</a>
            <a href="/#contact" class="page-btn" style="text-decoration:none;">Contact</a>
          </nav>
        </div>
      </div>
    </footer>
[Block 6/15]

    <!-- Confirm Send Modal -->
    <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(720px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1.2rem 1.4rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
          <div id="confirmModalTitle" style="font-weight:700;">Confirm recipients</div>
          <button aria-label="Close" id="modalCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1rem 1.4rem; max-height:60vh; overflow:auto; line-height:1.45;">
          <div id="modalSummary" style="margin-bottom:1rem;"></div>
          <div id="modalLists" style="display:grid; gap:1rem;">
            <div>
              <div style="font-weight:600;">Included (<span id="modalIncludedCount">0</span>)</div>
              <div id="modalIncluded"></div>
            </div>
            <div>
              <div style="font-weight:600;">Removed vs student’s list (<span id="modalRemovedCount">0</span>)</div>
              <div id="modalRemoved" style="color:#b00020;"></div>
            </div>
            <div>
              <div style="font-weight:600;">Added by you (<span id="modalAddedCount">0</span>)</div>
              <div id="modalAdded" style="color:#1b5e20;"></div>
            </div>
          </div>
        </div>
        <div style="padding:1rem 1.4rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="modalCancelBtn">Cancel</button>
          <button class="apply-btn" id="modalConfirmBtn">Send now</button>
        </div>
      </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="importModal" role="dialog" aria-modal="true" aria-labelledby="importTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; width:min(680px,92vw); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.22); overflow:hidden;">
        <div style="padding:1rem 1.2rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
          <div id="importTitle" style="font-weight:700;">Bulk import universities</div>
          <button aria-label="Close" id="importCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="padding:1rem 1.2rem; display:grid; gap:.75rem;">
          <div style="font-size:.92rem; color:#556;">
            Paste one <b>name per line</b>. We’ll fuzzy-match against the master list.
          </div>
          <textarea id="importTextarea" rows="10" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;"></textarea>
          <div id="importPreview" style="font-size:.9rem; color:#667;"></div>
        </div>
        <div style="padding:1rem 1.2rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="page-btn" id="importCancelBtn">Cancel</button>
          <button class="apply-btn" id="importConfirmBtn">Add matches</button>
        </div>
      </div>
    </div>

    <!-- Contact Admin Overlay (animated from avatar dropdown) -->
    <div id="contactOverlay" role="dialog" aria-modal="true" aria-labelledby="contactTitle"
         style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:10000;">
      <div style="background:#fff; width:min(560px,92vw); border-radius:16px; box-shadow:0 18px 50px rgba(0,0,0,.22); overflow:hidden; transform:translateY(12px); opacity:0; transition:.18s;">
        <div style="padding:1rem 1.25rem; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
          <div id="contactTitle" style="font-weight:700;">Contact admin</div>
          <button aria-label="Close" id="contactCloseBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <form id="contactForm" style="padding:1rem 1.25rem; display:grid; gap:.75rem;">
          <div>
            <label for="cFirst" style="display:block; font-weight:600; margin-bottom:.35rem;">First name</label>
            <input id="cFirst" name="firstName" class="filter-select" type="text" placeholder="Your first name" required />
          </div>
          <div>
            <label for="cEmail" style="display:block; font-weight:600; margin-bottom:.35rem;">Email address</label>
            <input id="cEmail" name="email" class="filter-select" type="email" placeholder="you@example.com" required />
          </div>
          <div>
            <label for="cQuery" style="display:block; font-weight:600; margin-bottom:.35rem;">Query</label>
            <textarea id="cQuery" name="query" rows="5" style="width:100%; padding:.8rem; border:1px solid #e5e7eb; border-radius:10px; font-family:inherit;" placeholder="How can we help?" required></textarea>
          </div>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid #f1f5f9; padding-top:.75rem;">
            <button type="button" class="page-btn" id="contactCancelBtn">Cancel</button>
            <button type="submit" class="apply-btn" id="contactSendBtn">Send</button>
          </div>
          <!-- Hidden action field so we don’t expose email; handled by serverless/.toml route -->
          <input type="hidden" name="action" value="contact-admin">
        </form>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>
[Block 7/15]

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="dashboard.js"></script>

    <script>
    /* --------------------- GLOBAL VARS --------------------- */
    let universities = [];
    let fuse = null;

    /* --------------------- DATASET LOADER ------------------ */
    async function loadUniversities() {
      const sources = [
        './assets/us_institutions_by_state_2023.json',
        './assets/us_institutions_by_state_2023.min.json',
        '/assets/us_institutions_by_state_2023.json',
        'https://cdn.jsdelivr.net/gh/swetharajan7/StellarRec@main/assets/us_institutions_by_state_2023.json'
      ];
      for (const url of sources) {
        try {
          const resp = await fetch(url);
          if (resp.ok) {
            universities = await resp.json();
            fuse = new Fuse(universities, { keys:['name','city','state'], threshold:0.3 });
            console.log("Loaded dataset from", url);
            return;
          }
        } catch(e) { console.warn("Failed to load", url); }
      }
      toast("Failed to load universities list","error");
    }

    /* --------------------- TABS --------------------- */
    function switchView(view, evt) {
      document.querySelectorAll('.sr-tab').forEach(btn=>{
        btn.setAttribute('aria-selected', btn.id === 'tab-'+view ? 'true':'false');
      });
      document.querySelectorAll('.dropdown-item').forEach(item=>{
        if(item.textContent.includes(view.charAt(0).toUpperCase()+view.slice(1))) {
          item.classList.add('active');
        } else item.classList.remove('active');
      });
      // panels toggle (future use)
      console.log("Switched to view:",view);
      if(evt) evt.stopPropagation();
    }

    /* --------------------- THEME TOGGLE --------------------- */
    function toggleTheme() {
      const isDark = document.body.classList.toggle("dark-theme");
      localStorage.setItem("sr_theme", isDark ? "dark" : "light");
    }
    function initTheme() {
      const saved = localStorage.getItem("sr_theme");
      if(saved==="dark") document.body.classList.add("dark-theme");
    }

    /* --------------------- CONTACT OVERLAY ------------------ */
    const contactOverlay = document.getElementById('contactOverlay');
    const contactForm = document.getElementById('contactForm');
    const contactCancelBtn = document.getElementById('contactCancelBtn');
    const contactCloseBtn = document.getElementById('contactCloseBtn');

    function openContact() {
      contactOverlay.style.display = "flex";
      const panel = contactOverlay.querySelector('div');
      requestAnimationFrame(()=>{
        panel.style.transform="translateY(0)";
        panel.style.opacity="1";
      });
    }
    function closeContact() {
      const panel = contactOverlay.querySelector('div');
      panel.style.transform="translateY(12px)";
      panel.style.opacity="0";
      setTimeout(()=>{ contactOverlay.style.display="none"; },180);
    }
    contactCancelBtn.onclick = closeContact;
    contactCloseBtn.onclick = closeContact;

    contactForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const data = new FormData(contactForm);
      try {
        const res = await fetch("/.netlify/functions/contact", { method:"POST", body:data });
        if(res.ok) { toast("Message sent!","success"); closeContact(); contactForm.reset(); }
        else { toast("Send failed.","error"); }
      } catch(err) { toast("Send failed.","error"); }
    });
    </script>
[Block 8/15]

    /* --------------------- WRITER --------------------- */
    let writerAutosaveTimer = null;

    function writerCmd(cmd){ document.execCommand(cmd,false,null); }

    function stripHtml(html){
      const tmp=document.createElement('div');
      tmp.innerHTML=html||'';
      return tmp.textContent||tmp.innerText||'';
    }

    function draftKey(){
      const sid = (window.studentProfile && (studentProfile.id||studentProfile.email)) || 'default';
      return 'sr_draft_' + sid;
    }

    function saveDraft(quiet=false){
      const bodyHtml = document.getElementById('writerBox').innerHTML || '';
      const title = document.getElementById('writerTitle').value || '';
      const payload = { title, bodyHtml, savedAt: Date.now() };
      try {
        localStorage.setItem(draftKey(), JSON.stringify(payload));
        updateSavedIndicator(payload.savedAt);
        if(!quiet) toast('Draft saved.','success',{ttl:1800});
      } catch(e){ if(!quiet) toast('Could not save draft.','error'); }
    }

    function restoreDraft(silent=false){
      try {
        const raw = localStorage.getItem(draftKey());
        if(!raw){
          if(!silent) toast('No saved draft found.','info');
          updateSavedIndicator(null);
          return;
        }
        const payload = JSON.parse(raw);
        document.getElementById('writerTitle').value = payload.title || '';
        document.getElementById('writerBox').innerHTML = payload.bodyHtml || '';
        updateWriterCounts(); updateSavedIndicator(payload.savedAt || null);
        if(!silent) toast('Draft restored.','success',{ttl:1500});
      } catch(e){ if(!silent) toast('Could not restore draft.','error'); }
    }

    function clearDraft(){
      document.getElementById('writerTitle').value='';
      document.getElementById('writerBox').innerHTML='';
      updateWriterCounts(); updateSavedIndicator(null);
      toast('Editor cleared. (Draft is not deleted until you save.)','info');
    }

    function copyDraft(){
      const title = document.getElementById('writerTitle').value || '';
      const textOnly = stripHtml(document.getElementById('writerBox').innerHTML);
      const text = title ? (title + '\n\n' + textOnly) : textOnly;
      navigator.clipboard.writeText(text)
        .then(()=>toast('Copied to clipboard.','success',{ttl:1200}))
        .catch(()=>toast('Copy failed.','error'));
    }

    function downloadDraft(){
      const safeTitle = (document.getElementById('writerTitle').value || 'recommendation-letter')
        .replace(/[^\w\d-_ ]+/g,'').trim() || 'letter';
      const text = stripHtml(document.getElementById('writerBox').innerHTML);
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const a=document.createElement('a');
      a.download = `${safeTitle}.txt`;
      a.href = URL.createObjectURL(blob);
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function attachDraft(){
      const safeTitle=(document.getElementById('writerTitle').value||'recommendation-letter')
        .replace(/[^\w\d-_ ]+/g,'').trim()||'letter';
      const text = stripHtml(document.getElementById('writerBox').innerHTML).trim();
      if(!text){ toast('Draft is empty.','error'); return; }
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const file = new File([blob], `${safeTitle}.txt`, {type:'text/plain'});
      handleFile(file,true); // allowAny=true so .txt attaches
    }

    function updateWriterCounts(){
      const text = stripHtml(document.getElementById('writerBox').innerHTML);
      const words = text.trim()? text.trim().split(/\s+/).length : 0;
      const chars = text.length;
      document.getElementById('writerCount').textContent = `${words} words • ${chars} chars`;
    }

    function updateSavedIndicator(ts){
      const el = document.getElementById('writerSaved');
      if(!ts){ el.textContent='Not saved'; return; }
      const when = new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      el.textContent = `Saved ${when}`;
    }

    function scheduleAutosave(immediate=false){
      if(!document.getElementById('writerAutosaveToggle').checked) return;
      if(writerAutosaveTimer) clearTimeout(writerAutosaveTimer);
      writerAutosaveTimer = setTimeout(()=>saveDraft(true), immediate?50:600);
    }

    function setupWriter(){
      const box   = document.getElementById('writerBox');
      const title = document.getElementById('writerTitle');
      const autosaveToggle = document.getElementById('writerAutosaveToggle');

      // initial
      restoreDraft(true);
      updateWriterCounts();

      // editing
      box.addEventListener('input', ()=>{ updateWriterCounts(); scheduleAutosave(); });
      title.addEventListener('input', ()=>{ scheduleAutosave(); });

      // autosave toggle
      autosaveToggle.addEventListener('change', ()=>{
        if(autosaveToggle.checked) scheduleAutosave(true);
        else if(writerAutosaveTimer){ clearTimeout(writerAutosaveTimer); writerAutosaveTimer=null; }
      });

      // blur safety
      box.addEventListener('blur', ()=>{ if(document.getElementById('writerAutosaveToggle').checked) saveDraft(true); });
      title.addEventListener('blur', ()=>{ if(document.getElementById('writerAutosaveToggle').checked) saveDraft(true); });
    }
    </script>
[Block 9/15]

    /* --------------------- Upload --------------------- */
    function setupFileUpload(){
      const fileInput = document.getElementById('fileInput');
      const uploadSection = document.getElementById('uploadSection');
      if(!fileInput || !uploadSection) return;

      fileInput.addEventListener('change', handleFileUpload);
      uploadSection.addEventListener('dragover', (e)=>{ e.preventDefault(); uploadSection.classList.add('dragover'); });
      uploadSection.addEventListener('dragleave', ()=> uploadSection.classList.remove('dragover'));
      uploadSection.addEventListener('drop', (e)=>{
        e.preventDefault(); uploadSection.classList.remove('dragover');
        if(e.dataTransfer.files.length>0) handleFile(e.dataTransfer.files[0]);
      });
    }

    function handleFileUpload(e){
      if(e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
    }

    // allowAny=true allows .txt (writer attach) besides .pdf
    function handleFile(file, allowAny=false){
      if(!allowAny && file.type !== 'application/pdf'){
        toast('Please upload a PDF file.','error'); return;
      }
      window.uploadedFile = file;
      const uf = document.getElementById('uploadedFile');
      if(uf) uf.style.display = 'block';
      const nameEl = document.getElementById('fileName');
      const sizeEl = document.getElementById('fileSize');
      if(nameEl) nameEl.textContent = file.name;
      if(sizeEl){
        const sizeMB = (file.size/1024/1024).toFixed(1);
        sizeEl.textContent = `${sizeMB} MB • ${allowAny ? 'Draft attached' : 'Uploaded successfully'}`;
      }
      toast(allowAny ? 'Draft attached to send queue.' : 'PDF attached. Ready to send.','success');
      updateSendButton();
    }

    function removeFile(){
      window.uploadedFile = null;
      const uf = document.getElementById('uploadedFile');
      if(uf) uf.style.display = 'none';
      const fi = document.getElementById('fileInput');
      if(fi) fi.value = '';
      updateSendButton();
    }

    /* --------------------- Search + Autosuggest --------------------- */
    const norm = (s)=> (s||'').toString().trim().toLowerCase();
    let suggestWrap, activeIndex = -1, currentSuggestions = [];

    function debounce(fn, wait=300){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); }; }

    function setupSearch(){
      const searchInput = document.getElementById('universitySearch');
      const searchApplyBtn = document.getElementById('searchApplyBtn');
      if(!searchInput || !searchApplyBtn) return;

      suggestWrap = document.createElement('div');
      suggestWrap.className = 'suggest-popover';
      suggestWrap.id = 'suggestPopover';
      suggestWrap.setAttribute('role','listbox');
      suggestWrap.style.display = 'none';
      searchInput.parentNode.appendChild(suggestWrap);

      const run = (fromApply=false)=>{
        filters.q = searchInput.value.trim().toLowerCase();
        page = 1; flashNextRender = true;
        refreshList();
        if(fromApply) closeSuggest();
      };
      const runDebounced = debounce(()=>{
        run(false);
        renderSuggestions(searchInput.value);
      }, 150);

      searchApplyBtn.addEventListener('click', ()=> run(true));
      searchInput.addEventListener('input', runDebounced);

      searchInput.addEventListener('keydown', (e)=>{
        const hasOpen = suggestWrap && suggestWrap.style.display !== 'none';
        if(e.key === 'Enter'){
          if(hasOpen && activeIndex >= 0 && currentSuggestions[activeIndex]){
            pickSuggestion(currentSuggestions[activeIndex]);
            e.preventDefault();
            return;
          }
          e.preventDefault(); run(true); return;
        }
        if(e.key === 'Escape'){
          e.preventDefault();
          if(hasOpen){ closeSuggest(); return; }
          searchInput.value=''; run(true);
        }
        if(hasOpen && (e.key === 'ArrowDown' || e.key === 'ArrowUp')){
          e.preventDefault();
          const max = currentSuggestions.length - 1;
          if(e.key === 'ArrowDown') activeIndex = (activeIndex + 1 > max) ? 0 : activeIndex + 1;
          if(e.key === 'ArrowUp')   activeIndex = (activeIndex - 1 < 0)   ? max : activeIndex - 1;
          updateActiveSuggestion();
        }
      });

      document.addEventListener('click', (ev)=>{
        if(!suggestWrap) return;
        if(ev.target === suggestWrap || suggestWrap.contains(ev.target)) return;
        if(ev.target === searchInput) return;
        closeSuggest();
      });
    }

    function escapeHtml(s){
      return (s??'').toString()
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function highlight(text, query){
      const q = norm(query);
      if(!q) return text;
      const i = norm(text).indexOf(q);
      if(i < 0) return text;
      return escapeHtml(text.slice(0,i)) +
             `<span class="suggest-highlight">${escapeHtml(text.slice(i, i+q.length))}</span>` +
             escapeHtml(text.slice(i+q.length));
    }

    function renderSuggestions(query){
      if(!suggestWrap) return;
      const q = norm(query);
      if(!q){ closeSuggest(); return; }
      const scored = [];
      for(let i=0;i<universities.length;i++){
        const u = universities[i];
        const nm = norm(u.name||'');
        const ct = norm(u.city||'');
        const st = norm(u.state||'');
        let score = 0;
        if(nm.startsWith(q)) score = 2;
        else if(nm.includes(q)) score = 1.5;
        else if(ct.includes(q) || st.includes(q)) score = 1;
        if(score>0) scored.push([score, u]);
        if(scored.length > 600) break;
      }
      scored.sort((a,b)=> b[0]-a[0] || (a[1].name||'').localeCompare(b[1].name||''));
      const list = scored.slice(0,10).map(x=>x[1]);
      currentSuggestions = list;
      activeIndex = list.length ? 0 : -1;

      if(!list.length){ closeSuggest(); return; }

      suggestWrap.innerHTML = '';
      list.forEach((u, idx)=>{
        const item = document.createElement('div');
        item.className = 'suggest-item';
        item.setAttribute('role','option');
        item.setAttribute('aria-selected', idx===activeIndex ? 'true' : 'false');
        const nm = escapeHtml(u.name || 'Unknown');
        const loc = escapeHtml([u.city,u.state].filter(Boolean).join(', '));
        const marked = highlight(nm, query);
        item.innerHTML = `
          <span class="material-icons" aria-hidden="true" style="font-size:1rem;">school</span>
          <div>
            <div>${marked}</div>
            ${loc ? `<div class="suggest-muted">${loc}</div>` : ''}
          </div>`;
        item.addEventListener('mouseenter', ()=>{ activeIndex=idx; updateActiveSuggestion(); });
        item.addEventListener('click', ()=> pickSuggestion(u));
        suggestWrap.appendChild(item);
      });
      suggestWrap.style.display = 'block';
    }

    function updateActiveSuggestion(){
      if(!suggestWrap) return;
      Array.from(suggestWrap.children).forEach((el,i)=> el.setAttribute('aria-selected', i===activeIndex ? 'true':'false'));
    }

    function closeSuggest(){
      if(!suggestWrap) return;
      suggestWrap.style.display = 'none';
      activeIndex = -1; currentSuggestions = [];
    }

    function pickSuggestion(u){
      const input = document.getElementById('universitySearch');
      input.value = u.name || '';
      filters.q = norm(u.name);
      page = 1; flashNextRender = true;
      refreshList(); closeSuggest();

      const idx = filtered.findIndex(x => String(x.unitid) === String(u.unitid));
      if(idx >= 0){
        page = Math.floor(idx / pageSize) + 1;
        refreshList();
        requestAnimationFrame(()=>{
          const cards = Array.from(document.querySelectorAll('.university-card'));
          const startIdx = (page - 1) * pageSize;
          const card = cards[idx - startIdx];
          if(card){
            card.classList.add('flash');
            setTimeout(()=>card.classList.remove('flash'), 1000);
            card.scrollIntoView({behavior:'smooth', block:'nearest'});
          }
        });
      }
    }

    /* --------------------- Filters + Pagination --------------------- */
    const filters = { q:'', state:'', type:'', level:'', sort:'name_asc' };
    let page = 1, pageSize = 40, flashNextRender = false;
    let universities = [], filtered = [];
    const CACHE_KEY = 'sr_us_institutions_v1';

    function setupFilterHandlers(){
      const stateFilter = document.getElementById('stateFilter');
      const typeFilter  = document.getElementById('typeFilter');
      const levelFilter = document.getElementById('levelFilter');
      const sortBy      = document.getElementById('sortBy');
      const applyBtn    = document.getElementById('filterApplyBtn');

      if(applyBtn){
        applyBtn.addEventListener('click', ()=>{
          filters.state = stateFilter.value;
          filters.type  = typeFilter.value;
          filters.level = levelFilter.value;
          filters.sort  = sortBy.value;
          page = 1; flashNextRender = true;
          refreshList();
        });
      }

      const resetBtn = document.getElementById('resetBtn');
      if(resetBtn){
        resetBtn.addEventListener('click', ()=>{
          document.getElementById('universitySearch').value = '';
          stateFilter.value=''; typeFilter.value=''; levelFilter.value='';
          sortBy.value='name_asc';
          filters.q = filters.state = filters.type = filters.level = '';
          filters.sort = 'name_asc';
          page = 1; flashNextRender = true;
          refreshList();
          toast('Filters reset.','info',{ttl:2000});
        });
      }

      const selectPageBtn = document.getElementById('selectPageBtn');
      if(selectPageBtn){
        selectPageBtn.addEventListener('click', ()=>{
          const start = (page - 1) * pageSize;
          const end   = Math.min(filtered.length, start + pageSize);
          const effective = getEffectiveSelection();
          filtered.slice(start,end).forEach(u => effective.add(u.unitid));
          filtered.slice(start,end).forEach(u=>{
            if(studentUnitIds.has(u.unitid)){ removedByRecommender.delete(u.unitid); }
            else { addedByRecommender.add(u.unitid); }
          });
          renderPage(); updateSelectedList(); updateSendButton();
          toast('Selected all on current page.','success',{ttl:1500});
        });
      }
    }

    function setupPagingHandlers(){
      const prev = document.getElementById('prevPage');
      const next = document.getElementById('nextPage');
      const ps   = document.getElementById('pageSize');
      if(prev){
        prev.addEventListener('click', ()=>{
          const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
          if(page > 1) page--;
          if(page < 1) page = 1;
          refreshList();
        });
      }
      if(next){
        next.addEventListener('click', ()=>{
          const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
          if(page < totalPages) page++;
          refreshList();
        });
      }
      if(ps){
        ps.addEventListener('change', (e)=>{
          pageSize = parseInt(e.target.value,10) || 40;
          page = 1; refreshList();
        });
      }
    }

    function updateMeta(){
      const start = filtered.length ? ((page - 1) * pageSize + 1) : 0;
      const end   = Math.min(filtered.length, page * pageSize);
      const meta = document.getElementById('resultMeta');
      if(meta) meta.textContent = `Showing ${start}-${end} of ${filtered.length} (from ${universities.length} total)`;
    }

    function updatePager(){
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      const info = document.getElementById('pageInfo');
      if(info) info.textContent = `Page ${Math.min(page, totalPages)} of ${totalPages}`;
      const prev = document.getElementById('prevPage');
      const next = document.getElementById('nextPage');
      if(prev) prev.disabled = (page <= 1);
      if(next) next.disabled = (page >= totalPages);
      updateMeta();
    }

    function computeFiltered(){
      filtered = universities.filter(u=>{
        const q = norm(filters.q);
        const qOk = !q || (u.name && norm(u.name).includes(q)) ||
                          (u.city && norm(u.city).includes(q)) ||
                          (u.state && norm(u.state).includes(q));
        const stOk = !filters.state || u.state === filters.state;
        const tyOk = !filters.type  || u.control === filters.type;
        const lvOk = !filters.level || u.level   === filters.level;
        return qOk && stOk && tyOk && lvOk;
      });

      if(filters.sort === 'name_asc'){
        filtered.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      } else if(filters.sort === 'state_asc'){
        filtered.sort((a,b)=> (a.state||'').localeCompare(b.state||'') || (a.name||'').localeCompare(b.name||''));
      }

      populateUniversitySelectOptions(filtered.length ? filtered : universities);
    }

    function refreshList(){
      computeFiltered();
      renderPage();
    }

    function renderPage(){
      const start = (page - 1) * pageSize;
      const end   = start + pageSize;
      const slice = filtered.slice(start, end);
      renderUniversities(slice);
      updatePager();

      const grid = document.getElementById('universityGrid');
      const empty = document.getElementById('emptyState');
      if(filtered.length === 0){
        if(grid) grid.style.display='none';
        if(empty){
          empty.style.display='block';
          const retryBtn = document.getElementById('retryLoadBtn');
          if(retryBtn) retryBtn.style.display='none';
        }
      } else {
        if(empty) empty.style.display='none';
        if(grid) grid.style.display='grid';
      }
    }

    /* --------------------- Render + selection --------------------- */
    let studentProfile = null;
    let studentUnitIds = new Set();
    let addedByRecommender = new Set();
    let removedByRecommender = new Set();

    function getEffectiveSelection(){
      const base = new Set(studentUnitIds);
      removedByRecommender.forEach(id => base.delete(id));
      addedByRecommender.forEach(id => base.add(id));
      return base;
    }

    function renderUniversities(list){
      const grid = document.getElementById('universityGrid');
      if(!grid) return;
      grid.innerHTML = '';
      const frag = document.createDocumentFragment();
      const effective = getEffectiveSelection();

      list.forEach(uni=>{
        const card = document.createElement('div');
        card.className = 'university-card' + (effective.has(uni.unitid) ? ' selected' : '');
        card.setAttribute('role','listitem');
        card.title = uni.sector || uni.control || '';
        card.addEventListener('click', ()=> toggleUniversity(uni.unitid));
        card.innerHTML = `
          <div class="university-header">
            <div class="university-logo">${escapeHtml((uni.name||'?').charAt(0))}</div>
            <div>
              <div class="university-name">${escapeHtml(uni.name || 'Unknown Institution')}</div>
              <div class="university-location">${escapeHtml(uni.city || '')}${(uni.city && uni.state)?', ':''}${escapeHtml(uni.state || '')}</div>
              ${(uni.level || uni.control) ? `<span class="university-pill">${[uni.control, uni.level].filter(Boolean).map(escapeHtml).join(' • ')}</span>` : ''}
            </div>
          </div>`;
        if(flashNextRender){
          card.classList.add('flash');
          setTimeout(()=>card.classList.remove('flash'), 750);
        }
        frag.appendChild(card);
      });

      grid.appendChild(frag);
      if(flashNextRender) flashNextRender=false;
    }

    function toggleUniversity(unitid){
      const allowEdits = document.getElementById('allowEditsToggle')?.checked;

      if(!studentProfile || allowEdits){
        if(studentUnitIds.has(unitid)){
          if(removedByRecommender.has(unitid)) removedByRecommender.delete(unitid);
          else removedByRecommender.add(unitid);
          addedByRecommender.delete(unitid);
        } else {
          if(addedByRecommender.has(unitid)) addedByRecommender.delete(unitid);
          else addedByRecommender.add(unitid);
        }
      } else {
        if(studentUnitIds.has(unitid)){
          if(removedByRecommender.has(unitid)) removedByRecommender.delete(unitid);
          else removedByRecommender.add(unitid);
        } else {
          toast('Student has locked the list. You cannot add new universities.','error');
        }
      }

      renderPage(); updateSelectedList(); updateSendButton();
    }

    function removeFromEffective(unitid){
      if(studentUnitIds.has(unitid)){
        removedByRecommender.add(unitid);
        addedByRecommender.delete(unitid);
      } else {
        addedByRecommender.delete(unitid);
      }
      renderPage(); updateSelectedList(); updateSendButton();
    }

    function updateSelectedList(){
      const container = document.getElementById('selectedList');
      if(!container) return;
      const effective = getEffectiveSelection();

      // count label (if you have a counter element)
      const counter = document.getElementById('selectedCount');
      if(counter) counter.textContent = `${effective.size} universities selected`;

      const chips = [];
      effective.forEach(unitid=>{
        const uni = filtered.find(u=>u.unitid===unitid) || universities.find(u=>u.unitid===unitid);
        const name = uni ? uni.name : 'Unknown';
        const badges = [];
        if(studentUnitIds.has(unitid)) badges.push('<span class="badge badge-student">Student</span>');
        if(addedByRecommender.has(unitid)) badges.push('<span class="badge badge-added">You added</span>');
        if(removedByRecommender.has(unitid)) badges.push('<span class="badge badge-removed">Removed</span>');
        chips.push(`
          <div class="selected-tag">
            ${escapeHtml(name)}
            ${badges.length ? `<span style="margin-left:.35rem; display:inline-flex; gap:.25rem;">${badges.join('')}</span>` : ''}
            <div class="remove-tag" title="Remove from sending" onclick="removeFromEffective(${JSON.stringify(unitid)})">×</div>
          </div>
        `);
      });
      container.innerHTML = chips.join('');
    }

    function updateSendButton(){
      const btn = document.getElementById('sendBtn');
      if(!btn) return;
      const effective = getEffectiveSelection();
      btn.disabled = !(window.uploadedFile && effective.size > 0);
    }
<!-- [11/15] — Student profile, browse-all select, and dataset loader (new JSON path) -->
/* --------------------- Student profile (mock) --------------------- */
async function fetchStudentProfile(studentIdOrEmail) {
  // In production, replace this with a real API call to fetch a student's preselected list
  // For now, pick ~10 random institutions so the UI is functional.
  const picks = [];
  const pool = [...universities].slice(0, 600);
  while (picks.length < 10 && pool.length) {
    const idx = Math.floor(Math.random() * pool.length);
    picks.push(pool[idx].unitid);
    pool.splice(idx, 1);
  }
  return {
    id: studentIdOrEmail,
    email: /@/.test(studentIdOrEmail) ? studentIdOrEmail : (studentIdOrEmail + '@example.edu'),
    name: `Student ${studentIdOrEmail}`,
    allowRecommenderEdits: true,
    selectedUnitIds: picks
  };
}

async function loadStudentProfile(studentIdOrEmail) {
  try {
    const prof = await fetchStudentProfile(studentIdOrEmail);
    studentProfile = prof;
    studentUnitIds = new Set(prof.selectedUnitIds || []);
    addedByRecommender.clear();
    removedByRecommender.clear();

    document.getElementById('studentTitle').textContent = `${prof.name}`;
    document.getElementById('studentMeta').textContent =
      `Preselected: ${studentUnitIds.size} universities • Edits ${prof.allowRecommenderEdits ? 'allowed' : 'locked'}`;
    const editsToggle = document.getElementById('allowEditsToggle');
    if (editsToggle) editsToggle.checked = !!prof.allowRecommenderEdits;

    page = 1;
    refreshList();
    updateSelectedList();
    updateSendButton();
    toast(`Loaded ${prof.name} with ${studentUnitIds.size} preselected universities.`, 'success');
    persistAndSync();
  } catch (err) {
    console.error(err);
    toast('Could not load student profile.', 'error');
  }
}

/* --------------------- Browse-all select --------------------- */
function setupUniversitySelect() {
  populateUniversitySelectOptions(universities);
  const sel = document.getElementById('universitySelect');
  if (!sel) return;

  sel.addEventListener('change', (e) => {
    const val = e.target.value;
    if (!val) return;

    // Clear filters so the selected item is easy to see in the main list
    filters.q = filters.state = filters.type = filters.level = '';
    const qInput = document.getElementById('universitySearch');
    if (qInput) qInput.value = '';
    document.getElementById('stateFilter').value = '';
    document.getElementById('typeFilter').value  = '';
    document.getElementById('levelFilter').value = '';
    refreshList();

    // Jump to the page containing the chosen institution
    const idx = filtered.findIndex(u => String(u.unitid) === String(val));
    if (idx >= 0) {
      page = Math.floor(idx / pageSize) + 1;
      refreshList();
      requestAnimationFrame(() => {
        const cards = Array.from(document.querySelectorAll('.university-card'));
        const startIdx = (page - 1) * pageSize;
        const card = cards[idx - startIdx];
        if (card) {
          card.classList.add('flash');
          setTimeout(() => card.classList.remove('flash'), 1000);
          card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    }

    // Add to effective selection immediately
    const uidNum = Number(val);
    const uid = Number.isNaN(uidNum) ? val : uidNum;
    if (studentUnitIds.has(uid)) {
      removedByRecommender.delete(uid);
    } else {
      addedByRecommender.add(uid);
    }
    updateSelectedList();
    updateSendButton();
    persistAndSync();

    // Reset dropdown to placeholder
    sel.selectedIndex = 0;
  });
}

function populateUniversitySelectOptions(list) {
  const sel = document.getElementById('universitySelect');
  if (!sel) return;
  // Keep the placeholder option
  const placeholder = sel.options[0];
  sel.innerHTML = '';
  sel.appendChild(placeholder);

  const sorted = [...list].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  const frag = document.createDocumentFragment();
  sorted.forEach(u => {
    const opt = document.createElement('option');
    opt.value = u.unitid;
    const loc = [u.city, u.state].filter(Boolean).join(', ');
    opt.textContent = `${u.name || 'Unknown Institution'}${loc ? ' — ' + loc : ''}`;
    frag.appendChild(opt);
  });
  sel.appendChild(frag);
}

/* --------------------- Dataset loader (UPDATED PATH) --------------------- */
const CACHE_KEY = 'sr_us_institutions_v1';
async function loadDataset() {
  try {
    const cached = sessionStorage.getItem(CACHE_KEY);
    if (cached) {
      try {
        const cachedData = JSON.parse(cached);
        if (Array.isArray(cachedData) || (cachedData && typeof cachedData === 'object')) {
          initializeWithData(cachedData);
          return;
        }
      } catch {}
    }

    let data = null;
    // Primary path updated per your request; plus a few safe fallbacks.
    const candidates = [
      'assets/us_institutions_by_state_2023.json',
      './assets/us_institutions_by_state_2023.json',
      '/assets/us_institutions_by_state_2023.json',
      // repo/CDN fallbacks (optional)
      'https://raw.githubusercontent.com/swetharajan7/StellarRec/main/assets/us_institutions_by_state_2023.json',
      'https://cdn.jsdelivr.net/gh/swetharajan7/StellarRec@main/assets/us_institutions_by_state_2023.json'
    ];

    for (const url of candidates) {
      try {
        const bust = url.startsWith('http') ? '' : (url.includes('?') ? '' : `?v=${Date.now()}`);
        const resp = await fetch(url + bust, { credentials: 'omit' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        let txt = await resp.text();
        // sanitize any accidental NaN/Infinity & trailing commas
        txt = txt
          .replace(/\b-?Infinity\b/g, 'null')
          .replace(/\bNaN\b/g, 'null')
          .replace(/,\s*([}\]])/g, '$1');
        data = JSON.parse(txt);
        break;
      } catch (e) { /* try next candidate */ }
    }

    if (!data) throw new Error('No dataset source could be loaded.');
    sessionStorage.setItem(CACHE_KEY, JSON.stringify(data));
    initializeWithData(data);
  } catch (err) {
    console.error('Failed to load university dataset', err);
    const meta = document.getElementById('resultMeta');
    if (meta) meta.textContent = 'Failed to load universities.';
    (window.toast || function(m){alert(m)})(`Failed to load dataset: ${err.message || err}`, 'error');
    const empty = document.getElementById('emptyState');
    if (empty) {
      empty.style.display = 'block';
      const grid = document.getElementById('universityGrid');
      if (grid) grid.style.display = 'none';
      const retryBtn = document.getElementById('retryLoadBtn');
      if (retryBtn) {
        retryBtn.style.display = 'inline-block';
        retryBtn.onclick = () => location.reload();
      }
      const clearBtn = document.getElementById('clearFiltersBtn');
      if (clearBtn) clearBtn.onclick = () => resetAllFilters();
    }
  }
}

function initializeWithData(data) {
  universities = Array.isArray(data)
    ? data
    : (data && typeof data === 'object' ? Object.values(data).flat() : []);

  universities = universities.map(u => ({
    unitid:  u.unitid ?? u.UNITID ?? u.id,
    name:    u.name   ?? u.INSTNM ?? 'Unknown',
    city:    u.city   ?? u.CITY   ?? '',
    state:   u.state  ?? u.STABBR ?? '',
    control: u.control?? u.CONTROL?? '',
    level:   u.level  ?? u.ICLEVEL?? '',
    sector:  u.sector ?? u.SECTOR ?? '',
    website: u.website?? u.WEBADDR?? ''
  }));

  computeFiltered();
  renderPage();
  updateSelectedList();

  // hydrate browse-all label
  const sel = document.getElementById('universitySelect');
  if (sel && sel.options.length > 0) {
    sel.options[0].textContent = `Browse all universities (${universities.length.toLocaleString()})`;
  }
}
<!-- [12/15] — Send recommendation flow -->
/* --------------------- Send recommendation --------------------- */
function setupSendHandler() {
  const sendBtn = document.getElementById('sendBtn');
  if (!sendBtn) return;
  sendBtn.addEventListener('click', () => {
    const effective = getEffectiveSelection();
    if (!window.uploadedFile) {
      toast('Please upload a file before sending.', 'error');
      return;
    }
    if (effective.size === 0) {
      toast('Please select at least one university.', 'error');
      return;
    }
    beginSend(effective);
  });
}

function beginSend(effective) {
  const container = document.getElementById('progressList');
  if (container) container.innerHTML = '';

  // Show progress section
  const sendSection = document.querySelector('.send-section');
  if (sendSection) sendSection.style.display = 'block';

  const unis = [...effective].map(uid =>
    filtered.find(u => u.unitid === uid) || universities.find(u => u.unitid === uid)
  ).filter(Boolean);

  let completed = 0;
  unis.forEach((uni, i) => {
    const div = document.createElement('div');
    div.className = 'delivery-item';
    div.innerHTML = `
      <div class="delivery-status pending">…</div>
      <div>
        <div style="font-weight:600">${escapeHtml(uni.name || 'Unknown')}</div>
        <div style="font-size:.85rem; color:#666">Sending…</div>
      </div>`;
    container.appendChild(div);

    // simulate async delivery
    setTimeout(() => {
      completed++;
      const ok = Math.random() > 0.1; // 90% success
      const statusEl = div.querySelector('.delivery-status');
      const msgEl = div.querySelector('div div:last-child');
      if (ok) {
        statusEl.className = 'delivery-status success';
        statusEl.textContent = '✓';
        msgEl.textContent = 'Delivered successfully';
      } else {
        statusEl.className = 'delivery-status error';
        statusEl.textContent = '!';
        msgEl.textContent = 'Failed to deliver';
      }

      updateProgress(completed, unis.length);

      if (completed === unis.length) {
        toast('Send complete.', 'success');
        showSuccess();
      }
    }, 1200 + i * 600);
  });
}

function updateProgress(done, total) {
  const fill = document.querySelector('.progress-fill');
  const txt = document.querySelector('.progress-text');
  if (!fill || !txt) return;
  const pct = Math.round((done / total) * 100);
  fill.style.width = pct + '%';
  txt.textContent = `Sent ${done} of ${total} (${pct}%)`;
}

function showSuccess() {
  const succ = document.querySelector('.success-section');
  if (succ) succ.style.display = 'block';
}
<!-- [13/15] — Header actions: animated avatar, contact admin, theme toggle -->
/* --------------------- Header avatar, settings, contact admin --------------------- */
(function headerEnhancements(){
  const avatar = document.querySelector('.user-avatar');
  const dropdown = document.getElementById('userDropdown');
  if (!avatar || !dropdown) return;

  // Add a gentle pulse/tilt animation to the avatar on hover/focus
  const style = document.createElement('style');
  style.textContent = `
    @keyframes srPulse { 0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)} }
    .user-avatar.animate { animation: srPulse .8s ease-in-out; }
    .user-dropdown .row-split { margin:.25rem .75rem; border-top:1px solid #f0f0f0; }
    .dropdown-item .right-slot { margin-left:auto; display:flex; align-items:center; gap:.5rem; }
    .theme-toggle { appearance:none; width:40px; height:22px; border-radius:999px; background:#e5e7eb; position:relative; outline: none; border:1px solid #d1d5db; cursor:pointer; }
    .theme-toggle::after { content:''; width:18px; height:18px; border-radius:50%; background:#fff; position:absolute; top:1px; left:1px; transition:.2s; box-shadow:0 1px 3px rgba(0,0,0,.2); }
    .theme-toggle:checked { background:#111827; }
    .theme-toggle:checked::after { left:19px; }
    /* Dark theme quick variables */
    :root { --bg:#f8f9fa; --panel:#fff; --text:#333; --muted:#666; }
    body.sr-dark { --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; }
    body.sr-dark { background:linear-gradient(135deg,#0b1220 0%, #0a0f1a 100%) !important; color:var(--text) !important; }
    body.sr-dark .header { background:linear-gradient(135deg,#0b316d 0%, #3c2e94 100%) !important; }
    body.sr-dark .upload-section,
    body.sr-dark .writer-section,
    body.sr-dark .university-section,
    body.sr-dark .selected-section,
    body.sr-dark .progress-section,
    body.sr-dark .empty-state,
    body.sr-dark .student-bar { background:var(--panel) !important; color:var(--text) !important; border-color:#243145 !important; }
    body.sr-dark .filter-select,
    body.sr-dark .writer-title,
    body.sr-dark .writer-box,
    body.sr-dark .page-btn,
    body.sr-dark .apply-btn { background:#0b1220 !important; color:var(--text) !important; border-color:#243145 !important; }
    body.sr-dark .university-card { background:#0b1220 !important; }
    body.sr-dark .university-card.selected { background:#0c223e !important; border-color:#2463eb !important; }
    body.sr-dark .university-pill { background:#0c223e !important; border-color:#1e3a8a !important; color:#9fb5ff !important; }
    body.sr-dark .toast { background:#0f172a !important; color:#e5e7eb !important; border-color:#1f2a44 !important; }
    body.sr-dark .suggest-popover { background:#0f172a !important; border-color:#1f2a44 !important; }
    body.sr-dark .suggest-item[aria-selected="true"], body.sr-dark .suggest-item:hover { background:#0c223e !important; }
  `;
  document.head.appendChild(style);

  // Add "Settings" and "Contact admin" rows if they don't exist yet
  if (!dropdown.querySelector('[data-sr="settings"]')) {
    const settings = document.createElement('div');
    settings.className = 'dropdown-item';
    settings.setAttribute('data-sr','settings');
    settings.innerHTML = `
      <span class="material-icons">settings</span>
      <div class="view-label">
        <div class="view-name">Settings</div>
        <div class="view-description">Theme and preferences</div>
      </div>
      <div class="right-slot">
        <span class="view-description" style="font-size:.8rem;">Dark</span>
        <input id="themeToggle" type="checkbox" class="theme-toggle" aria-label="Toggle dark theme"/>
      </div>
    `;
    dropdown.appendChild(settings);
  }
  if (!dropdown.querySelector('[data-sr="contact-admin"]')) {
    const div = document.createElement('div');
    div.className = 'dropdown-item';
    div.setAttribute('data-sr','contact-admin');
    div.innerHTML = `
      <span class="material-icons">support_agent</span>
      <div class="view-label">
        <div class="view-name">Contact admin</div>
        <div class="view-description">Get help or report an issue</div>
      </div>
    `;
    dropdown.appendChild(div);
  }

  // Animate avatar briefly when dropdown opens
  avatar.addEventListener('click', () => {
    avatar.classList.add('animate');
    setTimeout(()=>avatar.classList.remove('animate'), 650);
  });

  // Theme load/persist
  const THEME_KEY = 'sr_theme';
  function applyTheme(theme){
    const isDark = theme === 'dark';
    document.body.classList.toggle('sr-dark', isDark);
    const tgl = document.getElementById('themeToggle');
    if (tgl) tgl.checked = isDark;
  }
  function loadTheme(){
    const saved = localStorage.getItem(THEME_KEY) || 'light';
    applyTheme(saved);
  }
  loadTheme();

  dropdown.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'themeToggle') {
      const next = e.target.checked ? 'dark' : 'light';
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
      toast(`Theme: ${next}`, 'info', { ttl: 1200 });
    }
  });

  // Contact admin open/close handlers
  dropdown.querySelector('[data-sr="contact-admin"]').addEventListener('click', () => {
    document.getElementById('contactOverlay')?.classList.add('show');
    document.getElementById('userDropdown')?.classList.remove('show');
    setTimeout(()=> document.getElementById('contactFirst')?.focus(), 60);
  });
  document.getElementById('contactClose')?.addEventListener('click', closeContact);
  function closeContact(){ document.getElementById('contactOverlay')?.classList.remove('show'); }

  // Trap ESC to close overlay
  document.addEventListener('keydown', (ev)=>{
    if (ev.key === 'Escape' && document.getElementById('contactOverlay')?.classList.contains('show')) {
      ev.preventDefault(); closeContact();
    }
  });

  // Contact form submit — Netlify Forms + mailto fallback
  const form = document.getElementById('contactForm');
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('contactSend');
      if (btn) { btn.disabled = true; btn.textContent = 'Sending...'; }

      const data = new FormData(form);

      // If Netlify is present, allow it to capture the form post
      try {
        const resp = await fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams([...data, ['form-name', 'contact-admin']]).toString()
        });
        if (resp.ok) {
          toast('Message sent. We’ll be in touch!', 'success');
          form.reset(); closeContact();
          if (btn) { btn.disabled = false; btn.textContent = 'Send'; }
          return;
        }
      } catch {}

      // Fallback: open default mail client (email not displayed in UI)
      const to = 'swetha.rajan103@gmail.com';
      const subject = encodeURIComponent('StellarRec — Admin Contact');
      const body = encodeURIComponent(
        `First name: ${data.get('first') || ''}\nEmail: ${data.get('email') || ''}\n\nQuery:\n${data.get('query') || ''}`
      );
      window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
      toast('Opening your email client…', 'info', { ttl: 1800 });
      if (btn) { btn.disabled = false; btn.textContent = 'Send'; }
      closeContact();
    });
  }
})();

/* --------------------- Contact Admin overlay styles (inject) --------------------- */
(function injectContactStyles(){
  const css = document.createElement('style');
  css.textContent = `
    .sr-overlay {
      position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.45);
      z-index: 99999; padding: 1rem;
    }
    .sr-overlay.show { display: grid; }
    .sr-card {
      width: min(540px, 94vw); border-radius: 16px; background: #fff; color: #0f172a;
      box-shadow: 0 24px 60px rgba(0,0,0,.22); overflow: hidden;
    }
    body.sr-dark .sr-card { background: #0f172a; color: #e5e7eb; }
    .sr-card-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; border-bottom: 1px solid #e5e7eb; }
    body.sr-dark .sr-card-header { border-color: #1f2a44; }
    .sr-card-title { font-weight: 700; }
    .sr-card-body { padding: 1rem 1.25rem; display: grid; gap: .75rem; }
    .sr-row { display: grid; gap:.5rem; }
    .sr-label { font-size:.9rem; color:#475569; }
    body.sr-dark .sr-label { color:#9fb5ff; }
    .sr-input, .sr-textarea {
      width: 100%; padding: .65rem .8rem; border-radius: 10px; border: 2px solid #e5e7eb; background: #fff; color: #0f172a;
      font: inherit;
    }
    .sr-textarea { min-height: 120px; }
    body.sr-dark .sr-input, body.sr-dark .sr-textarea { background:#0b1220; color:#e5e7eb; border-color:#243145; }
    .sr-actions { display: flex; gap: .5rem; justify-content: flex-end; padding: .75rem 1.25rem 1.25rem; }
    .sr-btn {
      background: #fff; color:#111827; border: 2px solid #e5e7eb; border-radius: 10px; padding: .6rem 1rem; font-weight: 700; cursor: pointer;
    }
    .sr-btn.primary { background: linear-gradient(135deg,#1976d2,#7c4dff); color:#fff; border:none; }
    .sr-btn[disabled] { opacity:.6; cursor:not-allowed; }
    .sr-close { background: transparent; border:none; font-size: 1.15rem; cursor: pointer; }
  `;
  document.head.appendChild(css);
})();
<!-- [13/15] — Contact Admin Overlay HTML -->
<div id="contactOverlay" class="sr-overlay" aria-modal="true" role="dialog" aria-labelledby="contactTitle">
  <div class="sr-card" role="document">
    <div class="sr-card-header">
      <div id="contactTitle" class="sr-card-title">Contact admin</div>
      <button id="contactClose" class="sr-close" aria-label="Close">✕</button>
    </div>
    <form id="contactForm" name="contact-admin" method="post" data-netlify="true">
      <!-- Netlify forms honeypot -->
      <input type="hidden" name="form-name" value="contact-admin" />
      <p style="display:none">
        <label>Don’t fill this out if you’re human: <input name="bot-field" /></label>
      </p>
      <div class="sr-card-body">
        <div class="sr-row">
          <label for="contactFirst" class="sr-label">First name</label>
          <input id="contactFirst" name="first" class="sr-input" placeholder="Your first name" required />
        </div>
        <div class="sr-row">
          <label for="contactEmail" class="sr-label">Email address</label>
          <input id="contactEmail" type="email" name="email" class="sr-input" placeholder="you@example.com" required />
        </div>
        <div class="sr-row">
          <label for="contactQuery" class="sr-label">Query</label>
          <textarea id="contactQuery" name="query" class="sr-textarea" placeholder="How can we help?" required></textarea>
        </div>
      </div>
      <div class="sr-actions">
        <button type="button" class="sr-btn" id="contactCancel" onclick="document.getElementById('contactOverlay').classList.remove('show')">Cancel</button>
        <button type="submit" class="sr-btn primary" id="contactSend">Send</button>
      </div>
    </form>
  </div>
</div>
<!-- [14/15] — Footer (matching index.html style) -->
<script>
/* --------------------- Footer styles (inject) --------------------- */
(function injectFooterStyles(){
  const css = document.createElement('style');
  css.textContent = `
    .sr-footer {
      background: linear-gradient(135deg,#0b316d 0%, #3c2e94 100%);
      color:#fff; margin-top: 48px;
    }
    .sr-footer .wrap {
      max-width: 1200px; margin: 0 auto; padding: 28px 20px;
      display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center;
    }
    .sr-footer .brand {
      display:flex; align-items:center; gap:.55rem; font-weight:800; letter-spacing:.2px;
    }
    .sr-footer .brand .material-icons { font-size: 20px; }
    .sr-footer a { color:#e5e7eb; text-decoration: none; font-weight:600; }
    .sr-footer a:hover { text-decoration: underline; }
    .sr-footer .links { display:flex; gap: 16px; align-items:center; flex-wrap: wrap; }
    .sr-footer small { opacity:.85; }
    .sr-footer .sep { opacity:.35; }
    @media (max-width:768px){
      .sr-footer .wrap{ grid-template-columns: 1fr; text-align: center; }
      .sr-footer .links{ justify-content:center; }
      .sr-footer .brand{ justify-content:center; }
    }
  `;
  document.head.appendChild(css);
})();

/* --------------------- Footer HTML (append) --------------------- */
(function appendFooter(){
  const footer = document.createElement('footer');
  footer.className = 'sr-footer';
  footer.innerHTML = `
    <div class="wrap">
      <div class="brand">
        <span class="material-icons" aria-hidden="true">star</span>
        <span>stellarrec</span>
      </div>
      <div class="links">
        <a href="/" aria-label="Home">Home</a>
        <span class="sep">•</span>
        <a href="/#features" aria-label="Features">Features</a>
        <span class="sep">•</span>
        <a href="/#contact" aria-label="Contact">Contact</a>
      </div>
      <div style="grid-column:1 / -1;">
        <small>© <span id="sr-year"></span> StellarRec. All rights reserved.</small>
      </div>
    </div>
  `;
  document.body.appendChild(footer);
  const y = document.getElementById('sr-year'); if (y) y.textContent = new Date().getFullYear();
})();
</script>
<!-- [15/15] — Init + close -->
<script>
/* --------------------- Initialization --------------------- */
document.addEventListener('DOMContentLoaded', () => {
  // Writer
  setupWriter();
  // Upload
  setupUpload();
  // University search & filters
  setupUniversitySearch();
  setupFilterHandlers();
  // University select dropdown
  setupUniversitySelect();
  // Pagination + bulk
  setupPagination();
  setupBulkImport();
  // Student profile load
  setupStudentLoader();
  // Send handler
  setupSendHandler();
  // Load dataset
  loadDataset();
  // Update tagline hotfix
  const h1 = document.querySelector('.hero-title');
  if (h1) h1.textContent = 'One upload. Unlimited reach.';
});
</script>

</body>
</html>

